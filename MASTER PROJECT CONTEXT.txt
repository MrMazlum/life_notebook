*** MASTER PROJECT CONTEXT: Life Notebook ***
[ROLE] You are an expert Flutter & Firebase developer. I am a student/creator building "Life Notebook," a high-performance productivity app.
[PROJECT AIM] To digitize a physical life-management notebook. The app combines:
    Fixed Schedules (University lectures with Rooms/Instructors).
    Flexible Tasks (Self-study, Gym, Library sessions).
    Tracking Metrics (Finance, Time studied, Pages read, Health). The goal is a professional, Android-first app on the Play Store using clean, lightweight code (ValueNotifier > Bloc/Provider).

[CURRENT STATUS - BETA]
    Core System: STABLE.
        Auth: Google Sign-In robust (Future/await handled).
        Navigation: Persistent tab state fixed.
        Settings: Styled Popup (Dark/Light/Logout).
        Theme: Global ValueNotifier with persistent state.

    Book & Habit Module: POLISHED & CONNECTED.
        Dashboard: "Book Hero" reading tracker + "Calendar Strip" (Weekly view).
        UI Overhaul:
            Calendar: Fixed Date Picker header to Blue. Swapped Grid icon for Calendar icon.
            Notes: Removed slide-to-delete. Added "Pen" edit button. Added professional touch ripples and card shadows.
            Habits: Added "Blue Box" back button. Fixed "Edit Sheet" button alignment.
        Backend: Real-time Firestore streams connected for Habits (Daily Logs) and Notes.

    Health Module: PARTIALLY INTEGRATED.
        Steps: COMPLETE (SharedPrefs + Firestore sync).
        Gym/Nutrition: UI Complete (Grid), backend pending.

    Finance Module: UI COMPLETE (Mock Data).
    Schedule Module: COMPLETE.

lib/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ book_models.dart       
‚îÇ   ‚îú‚îÄ‚îÄ finance_models.dart
‚îÇ   ‚îú‚îÄ‚îÄ health_model.dart
‚îÇ   ‚îî‚îÄ‚îÄ lesson.dart
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ book_page.dart      
‚îÇ   ‚îú‚îÄ‚îÄ dashboard_page.dart
‚îÇ   ‚îú‚îÄ‚îÄ finance_page.dart
‚îÇ   ‚îú‚îÄ‚îÄ health_page.dart
‚îÇ   ‚îú‚îÄ‚îÄ login_page.dart
‚îÇ   ‚îî‚îÄ‚îÄ schedule_page.dart
‚îú‚îÄ‚îÄ widgets/
‚îÇ   ‚îú‚îÄ‚îÄ book/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ all_habits_view.dart 
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ all_notes_view.dart     
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book_details_sheet.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book_hero.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book_search_delegate.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book_summary_view.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar_strip.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ habits_section.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ note_editor_sheet.dart  
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notes_section.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update_progress_dialog.dart
‚îÇ   ‚îú‚îÄ‚îÄ finance/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ add_transaction_dialog.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bucket_list.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ budget_progress_bar.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ edit_monthly_budget_dialog.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ finance_dashboard.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ finance_header.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ past_month_summary.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pie_chart_view.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transaction_list.dart
‚îÇ   ‚îú‚îÄ‚îÄ health/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activity/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activity_card.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exercise_models.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routine_editor.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routine_manager.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ set_editor.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workout_logger.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cards/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ activity.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hydration.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nutrition.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ weight_dialog.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grid.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ plan_view.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ summary_card.dart
‚îÇ   ‚îî‚îÄ‚îÄ schedule/
‚îÇ       ‚îú‚îÄ‚îÄ add_lesson_dialog.dart
‚îÇ       ‚îú‚îÄ‚îÄ calendar_header.dart
‚îÇ       ‚îî‚îÄ‚îÄ class_card.dart
‚îú‚îÄ‚îÄ firebase_options.dart
‚îî‚îÄ‚îÄ main.dart

FILE CONTENTS(SAME QUEUE AS THE HIERARCHY FROM TOP TO THE BOTTOM):
-----------------

book_models.dart:
import 'package:cloud_firestore/cloud_firestore.dart';

class Book {
  final String id;
  final String title;
  final String author;
  final String coverUrl;
  final int totalPages;
  final int currentPage;
  final String status; // 'reading', 'finished', 'wishlist'
  final double progress;

  Book({
    required this.id,
    required this.title,
    required this.author,
    required this.coverUrl,
    required this.totalPages,
    required this.currentPage,
    required this.status,
  }) : progress = totalPages > 0 ? currentPage / totalPages : 0.0;

  factory Book.fromMap(Map<String, dynamic> data, String id) {
    return Book(
      id: id,
      title: data['title'] ?? '',
      author: data['author'] ?? '',
      coverUrl: data['coverUrl'] ?? '',
      totalPages: data['totalPages'] ?? 0,
      currentPage: data['currentPage'] ?? 0,
      status: data['status'] ?? 'wishlist',
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'title': title,
      'author': author,
      'coverUrl': coverUrl,
      'totalPages': totalPages,
      'currentPage': currentPage,
      'status': status,
    };
  }
}

class MindTask {
  String id;
  String title;
  bool isHabit;
  bool isDone;
  int streak; // ‚úÖ ADDED STREAK FIELD

  MindTask({
    required this.id,
    required this.title,
    required this.isHabit,
    required this.isDone,
    this.streak = 0, // Default 0
  });

  Map<String, dynamic> toMap() => {
    'id': id,
    'title': title,
    'isHabit': isHabit,
    'isDone': isDone,
    'streak': streak, // Save streak
  };

  factory MindTask.fromMap(Map<String, dynamic> map) => MindTask(
    id: map['id'] ?? '',
    title: map['title'] ?? '',
    isHabit: map['isHabit'] ?? false,
    isDone: map['isDone'] ?? false,
    streak: map['streak'] ?? 0, // Load streak
  );
}

class MindNote {
  final String id;
  final String title;
  final String body;
  final String tag;
  final DateTime createdAt;

  MindNote({
    required this.id,
    required this.title,
    required this.body,
    required this.tag,
    required this.createdAt,
  });

  Map<String, dynamic> toMap() => {
    'title': title,
    'body': body,
    'tag': tag,
    'createdAt': Timestamp.fromDate(createdAt),
  };

  factory MindNote.fromMap(Map<String, dynamic> map, String id) {
    return MindNote(
      id: id,
      title: map['title'] ?? '',
      body: map['body'] ?? '',
      tag: map['tag'] ?? '',
      createdAt: (map['createdAt'] as Timestamp).toDate(),
    );
  }
}

class BookDailyLog {
  DateTime date;
  int pagesRead;
  int endPage;
  List<MindTask> tasks;

  BookDailyLog({
    DateTime? date,
    this.pagesRead = 0,
    this.endPage = 0,
    List<MindTask>? tasks,
  }) : date = date ?? DateTime.now(),
       this.tasks = tasks ?? [];

  Map<String, dynamic> toMap() => {
    'date': Timestamp.fromDate(date),
    'pagesRead': pagesRead,
    'endPage': endPage,
    'tasks': tasks.map((t) => t.toMap()).toList(),
  };

  factory BookDailyLog.fromMap(Map<String, dynamic> map, DateTime date) {
    return BookDailyLog(
      date: date,
      pagesRead: map['pagesRead'] ?? 0,
      endPage: map['endPage'] ?? 0,
      tasks:
          (map['tasks'] as List<dynamic>?)
              ?.map((t) => MindTask.fromMap(t))
              .toList() ??
          [],
    );
  }
}


finance_models.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

class FinanceBucket {
  final String id;
  final String name;
  final double limit;
  final double spent; // Calculated locally based on transactions
  final int iconCode;
  final int colorValue;
  final bool isFixed;

  FinanceBucket({
    required this.id,
    required this.name,
    required this.limit,
    this.spent = 0.0,
    required this.iconCode,
    required this.colorValue,
    this.isFixed = false,
  });

  IconData get icon => IconData(iconCode, fontFamily: 'MaterialIcons');
  Color get color => Color(colorValue);

  Map<String, dynamic> toMap() {
    return {
      'name': name,
      'limit': limit,
      'iconCode': iconCode,
      'colorValue': colorValue,
      'isFixed': isFixed,
      'userId': 'test_user', // Hardcoded for now
    };
  }

  factory FinanceBucket.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    return FinanceBucket(
      id: doc.id,
      name: data['name'] ?? 'Unknown',
      limit: (data['limit'] ?? 0.0).toDouble(),
      iconCode: data['iconCode'] ?? 57522, // Default icon
      colorValue: data['colorValue'] ?? 4280391411, // Default color (blueish)
      isFixed: data['isFixed'] ?? false,
    );
  }

  FinanceBucket copyWith({double? spent, double? limit}) {
    return FinanceBucket(
      id: id,
      name: name,
      limit: limit ?? this.limit,
      spent: spent ?? this.spent,
      iconCode: iconCode,
      colorValue: colorValue,
      isFixed: isFixed,
    );
  }
}

class FinanceTransaction {
  final String id;
  final String title;
  final double amount;
  final DateTime date;
  final String categoryId;
  final bool isExpense;
  final int? iconCode;
  final int? colorValue;

  FinanceTransaction({
    required this.id,
    required this.title,
    required this.amount,
    required this.date,
    required this.categoryId,
    this.isExpense = true,
    this.iconCode,
    this.colorValue,
  });

  IconData? get icon => iconCode != null
      ? IconData(iconCode!, fontFamily: 'MaterialIcons')
      : null;
  Color? get color => colorValue != null ? Color(colorValue!) : null;

  Map<String, dynamic> toMap() {
    return {
      'title': title,
      'amount': amount,
      'date': Timestamp.fromDate(date),
      'categoryId': categoryId,
      'isExpense': isExpense,
      'iconCode': iconCode,
      'colorValue': colorValue,
      'userId': 'test_user',
    };
  }

  factory FinanceTransaction.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    return FinanceTransaction(
      id: doc.id,
      title: data['title'] ?? '',
      amount: (data['amount'] ?? 0.0).toDouble(),
      date: (data['date'] as Timestamp).toDate(),
      categoryId: data['categoryId'] ?? 'income',
      isExpense: data['isExpense'] ?? true,
      iconCode: data['iconCode'],
      colorValue: data['colorValue'],
    );
  }
}

health_model.dart:
import 'package:cloud_firestore/cloud_firestore.dart';
// IMPORT THE EXERCISE MODELS
import '../widgets/health/activity/exercise_models.dart';

class FoodItem {
  final String name;
  final int calories;
  final int protein;
  final int carbs;
  final int fat;
  final DateTime timestamp;

  FoodItem({
    required this.name,
    required this.calories,
    this.protein = 0,
    this.carbs = 0,
    this.fat = 0,
    required this.timestamp,
  });

  Map<String, dynamic> toMap() {
    return {
      'name': name,
      'calories': calories,
      'protein': protein,
      'carbs': carbs,
      'fat': fat,
      'timestamp': timestamp.toIso8601String(),
    };
  }

  factory FoodItem.fromMap(Map<String, dynamic> map) {
    return FoodItem(
      name: map['name'] ?? '',
      calories: map['calories'] ?? 0,
      protein: map['protein'] ?? 0,
      carbs: map['carbs'] ?? 0,
      fat: map['fat'] ?? 0,
      timestamp: DateTime.tryParse(map['timestamp'] ?? '') ?? DateTime.now(),
    );
  }
}

class HealthDailyLog {
  DateTime date;

  // Activity
  int steps;
  String? workoutName;
  bool isWorkoutDone;
  // NEW: Store the actual exercises performed
  List<ExerciseDetail> workoutLog;
  double weight;

  // Hydration
  int waterGlasses;
  int waterGlassSizeMl;
  int caffeineAmount;

  // Nutrition
  bool useMacros;
  List<FoodItem> foodLog;
  int totalCalories;
  int totalProtein;
  int totalCarbs;
  int totalFat;

  // Mood & Sleep
  int mood;
  double sleepHours;

  HealthDailyLog({
    DateTime? date,
    this.steps = 0,
    this.workoutName,
    this.isWorkoutDone = false,
    List<ExerciseDetail>? workoutLog, // NEW
    this.weight = 0.0,
    this.waterGlasses = 0,
    this.waterGlassSizeMl = 250,
    this.caffeineAmount = 0,
    this.useMacros = false,
    List<FoodItem>? foodLog,
    this.totalCalories = 0,
    this.totalProtein = 0,
    this.totalCarbs = 0,
    this.totalFat = 0,
    this.mood = 3,
    this.sleepHours = 7.0,
  }) : date = date ?? DateTime.now(),
       foodLog = foodLog ?? [],
       workoutLog = workoutLog ?? []; // NEW

  HealthDailyLog copyWith({
    DateTime? date,
    int? steps,
    String? workoutName,
    bool? isWorkoutDone,
    List<ExerciseDetail>? workoutLog, // NEW
    double? weight,
    int? waterGlasses,
    int? waterGlassSizeMl,
    int? caffeineAmount,
    bool? useMacros,
    List<FoodItem>? foodLog,
    int? totalCalories,
    int? totalProtein,
    int? totalCarbs,
    int? totalFat,
    int? mood,
    double? sleepHours,
  }) {
    return HealthDailyLog(
      date: date ?? this.date,
      steps: steps ?? this.steps,
      workoutName: workoutName ?? this.workoutName,
      isWorkoutDone: isWorkoutDone ?? this.isWorkoutDone,
      workoutLog: workoutLog ?? this.workoutLog, // NEW
      weight: weight ?? this.weight,
      waterGlasses: waterGlasses ?? this.waterGlasses,
      waterGlassSizeMl: waterGlassSizeMl ?? this.waterGlassSizeMl,
      caffeineAmount: caffeineAmount ?? this.caffeineAmount,
      useMacros: useMacros ?? this.useMacros,
      foodLog: foodLog ?? this.foodLog,
      totalCalories: totalCalories ?? this.totalCalories,
      totalProtein: totalProtein ?? this.totalProtein,
      totalCarbs: totalCarbs ?? this.totalCarbs,
      totalFat: totalFat ?? this.totalFat,
      mood: mood ?? this.mood,
      sleepHours: sleepHours ?? this.sleepHours,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'date': date.toIso8601String().split('T')[0],
      'steps': steps,
      'workoutName': workoutName,
      'isWorkoutDone': isWorkoutDone,
      'workoutLog': workoutLog.map((e) => e.toMap()).toList(), // NEW
      'weight': weight,
      'waterGlasses': waterGlasses,
      'waterGlassSizeMl': waterGlassSizeMl,
      'caffeineAmount': caffeineAmount,
      'useMacros': useMacros,
      'foodLog': foodLog.map((f) => f.toMap()).toList(),
      'totalCalories': totalCalories,
      'totalProtein': totalProtein,
      'totalCarbs': totalCarbs,
      'totalFat': totalFat,
      'mood': mood,
      'sleepHours': sleepHours,
    };
  }

  factory HealthDailyLog.fromMap(Map<String, dynamic> map, DateTime docDate) {
    var loadedFood = <FoodItem>[];
    if (map['foodLog'] != null) {
      loadedFood = (map['foodLog'] as List)
          .map((e) => FoodItem.fromMap(e))
          .toList();
    }

    // NEW: Load Exercises
    var loadedExercises = <ExerciseDetail>[];
    if (map['workoutLog'] != null) {
      loadedExercises = (map['workoutLog'] as List)
          .map((e) => ExerciseDetail.fromMap(e))
          .toList();
    }

    return HealthDailyLog(
      date: docDate,
      steps: map['steps'] ?? 0,
      workoutName: map['workoutName'],
      isWorkoutDone: map['isWorkoutDone'] ?? false,
      workoutLog: loadedExercises, // NEW
      weight: (map['weight'] ?? 0.0).toDouble(),
      waterGlasses: map['waterGlasses'] ?? 0,
      waterGlassSizeMl: map['waterGlassSizeMl'] ?? 250,
      caffeineAmount: map['caffeineAmount'] ?? 0,
      useMacros: map['useMacros'] ?? false,
      foodLog: loadedFood,
      totalCalories: map['totalCalories'] ?? 0,
      totalProtein: map['totalProtein'] ?? 0,
      totalCarbs: map['totalCarbs'] ?? 0,
      totalFat: map['totalFat'] ?? 0,
      mood: map['mood'] ?? 3,
      sleepHours: (map['sleepHours'] ?? 7.0).toDouble(),
    );
  }
}

lesson.dart:
import 'package:cloud_firestore/cloud_firestore.dart';

class Lesson {
  final String? id;
  final String userId;
  final String name;
  final String room;
  final String instructor;
  final String description;
  final bool isLecture;
  final bool isRecurring;
  final String dayOfWeek; // e.g., "Monday"
  final int startTimeInMinutes;
  final int durationInMinutes;

  // NEW FIELDS
  final List<String> excludeDates; // Dates to skip: ["2026-01-04"]
  final String specificDate; // If NOT recurring: "2026-01-04"

  Lesson({
    this.id,
    required this.userId,
    required this.name,
    this.room = '',
    this.instructor = '',
    this.description = '',
    this.isLecture = true,
    this.isRecurring = true,
    required this.dayOfWeek,
    required this.startTimeInMinutes,
    required this.durationInMinutes,
    this.excludeDates = const [],
    this.specificDate = '',
  });

  // Helpers
  int get endTimeInMinutes => startTimeInMinutes + durationInMinutes;

  String get startTimeString {
    final h = startTimeInMinutes ~/ 60;
    final m = startTimeInMinutes % 60;
    return '${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}';
  }

  String get endTimeString {
    final endMin = startTimeInMinutes + durationInMinutes;
    final h = endMin ~/ 60;
    final m = endMin % 60;
    return '${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}';
  }

  Map<String, dynamic> toMap() {
    return {
      'userId': userId,
      'name': name,
      'room': room,
      'instructor': instructor,
      'description': description,
      'isLecture': isLecture,
      'isRecurring': isRecurring,
      'dayOfWeek': dayOfWeek,
      'startTimeInMinutes': startTimeInMinutes,
      'durationInMinutes': durationInMinutes,
      'excludeDates': excludeDates, // Save to DB
      'specificDate': specificDate, // Save to DB
    };
  }

  factory Lesson.fromFirestore(DocumentSnapshot doc) {
    Map<String, dynamic> data = doc.data() as Map<String, dynamic>;
    return Lesson(
      id: doc.id,
      userId: data['userId'] ?? '',
      name: data['name'] ?? '',
      room: data['room'] ?? '',
      instructor: data['instructor'] ?? '',
      description: data['description'] ?? '',
      isLecture: data['isLecture'] ?? true,
      isRecurring: data['isRecurring'] ?? true,
      dayOfWeek: data['dayOfWeek'] ?? 'Monday',
      startTimeInMinutes: data['startTimeInMinutes'] ?? 0,
      durationInMinutes: data['durationInMinutes'] ?? 60,
      // Load from DB (safely handle lists)
      excludeDates: List<String>.from(data['excludeDates'] ?? []),
      specificDate: data['specificDate'] ?? '',
    );
  }
}

book_page.dart:
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';

import '../models/book_models.dart';
import '../widgets/book/book_hero.dart';
import '../widgets/book/calendar_strip.dart';
import '../widgets/book/book_summary_view.dart';
import '../widgets/book/habits_section.dart';
import '../widgets/book/notes_section.dart';
import '../widgets/book/note_editor_sheet.dart';
import '../widgets/book/all_habits_view.dart';

class BookPage extends StatefulWidget {
  const BookPage({super.key});

  @override
  State<BookPage> createState() => _BookPageState();
}

class _BookPageState extends State<BookPage> {
  // Normalize date to midnight to avoid time mismatches
  DateTime _selectedDate = DateUtils.dateOnly(DateTime.now());
  late PageController _weekPageController;
  final int _initialPage = 1000;
  bool _forceInspectMode = false;

  StreamSubscription<DocumentSnapshot>? _logSubscription;
  BookDailyLog _currentLog = BookDailyLog();

  @override
  void initState() {
    super.initState();
    final initialIndex = _calculatePageForDate(DateTime.now());
    _weekPageController = PageController(initialPage: initialIndex);
    _subscribeToDate(_selectedDate);
  }

  @override
  void dispose() {
    _weekPageController.dispose();
    _logSubscription?.cancel();
    super.dispose();
  }

  // --- üìÖ DATE & SUBSCRIPTION LOGIC ---

  void _subscribeToDate(DateTime date) {
    _logSubscription?.cancel();
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    final normalizedDate = DateUtils.dateOnly(date);
    final dateKey = DateFormat('yyyy-MM-dd').format(normalizedDate);

    _logSubscription = FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('book_logs')
        .doc(dateKey)
        .snapshots()
        .listen((snapshot) {
          if (snapshot.exists && snapshot.data() != null) {
            if (mounted) {
              setState(
                () => _currentLog = BookDailyLog.fromMap(
                  snapshot.data()!,
                  normalizedDate,
                ),
              );
            }
          } else {
            // If no log exists for this date, initialize it (copy habits)
            _initializeDay(normalizedDate);
          }
        });
  }

  // ‚úÖ HABIT REPETITION: Looks for the LATEST log that is BEFORE today
  Future<void> _initializeDay(DateTime date) async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    // Find the closest PAST log
    final prevLogs = await FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('book_logs')
        .where('date', isLessThan: Timestamp.fromDate(date))
        .orderBy('date', descending: true)
        .limit(1)
        .get();

    List<MindTask> inheritedHabits = [];
    if (prevLogs.docs.isNotEmpty) {
      final prevLog = BookDailyLog.fromMap(
        prevLogs.docs.first.data(),
        DateTime.now(),
      );

      inheritedHabits = prevLog.tasks
          .where((t) => t.isHabit)
          .map(
            (t) => MindTask(
              id: t.id, // ‚úÖ KEEP SAME ID TO MAINTAIN STREAK
              title: t.title,
              isHabit: true,
              isDone: false, // Reset done status for new day
              streak: t.isDone
                  ? t.streak
                  : 0, // Carry over streak if done yesterday
            ),
          )
          .toList();
    }

    if (mounted) {
      setState(
        () => _currentLog = BookDailyLog(date: date, tasks: inheritedHabits),
      );
      // Auto-save to create the document so future edits work immediately
      _saveToFirestore();
    }
  }

  // --- üî• FIRESTORE ACTIONS ---

  void _saveToFirestore() {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    final dateKey = DateFormat('yyyy-MM-dd').format(_selectedDate);

    final data = _currentLog.toMap();
    data['date'] = Timestamp.fromDate(_selectedDate); // Needed for sorting

    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('book_logs')
        .doc(dateKey)
        .set(data, SetOptions(merge: true));
  }

  // --- TASKS & HABITS ---

  void _toggleTask(MindTask task) {
    setState(() {
      task.isDone = !task.isDone;
      // Local streak update for immediate feedback
      if (task.isHabit) {
        if (task.isDone)
          task.streak += 1;
        else
          task.streak = (task.streak > 0) ? task.streak - 1 : 0;
      }
    });
    _saveToFirestore();
  }

  Future<void> _addNewTask(String title, bool isHabit) async {
    // Prevent duplicates in current view
    if (_currentLog.tasks.any((t) => t.title == title)) return;

    final newTask = MindTask(
      id: DateTime.now().millisecondsSinceEpoch.toString(),
      title: title,
      isHabit: isHabit,
      isDone: false,
      streak: 0,
    );

    setState(() => _currentLog.tasks.add(newTask));
    _saveToFirestore();

    // If adding a habit, propagate to FUTURE days too
    if (isHabit) {
      await _propagateHabitChange(newTask, isDelete: false);
    }
  }

  Future<void> _deleteTask(MindTask task) async {
    setState(() => _currentLog.tasks.removeWhere((t) => t.id == task.id));
    _saveToFirestore();

    // If deleting a habit, remove from FUTURE days too
    if (task.isHabit) {
      await _propagateHabitChange(task, isDelete: true);
    }
  }

  // ‚úÖ Updates FUTURE logs so habits persist or disappear correctly
  Future<void> _propagateHabitChange(
    MindTask task, {
    required bool isDelete,
  }) async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    final futureLogs = await FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('book_logs')
        .where('date', isGreaterThan: Timestamp.fromDate(_selectedDate))
        .get();

    if (futureLogs.docs.isEmpty) return;

    final batch = FirebaseFirestore.instance.batch();

    for (var doc in futureLogs.docs) {
      BookDailyLog log = BookDailyLog.fromMap(doc.data(), DateTime.now());

      if (isDelete) {
        log.tasks.removeWhere((t) => t.id == task.id);
      } else {
        // Only add if not already present (ID Check)
        if (!log.tasks.any((t) => t.id == task.id)) {
          log.tasks.add(
            MindTask(
              id: task.id,
              title: task.title,
              isHabit: true,
              isDone: false,
              streak: 0,
            ),
          );
        }
      }
      batch.update(doc.reference, {
        'tasks': log.tasks.map((t) => t.toMap()).toList(),
      });
    }
    await batch.commit();
  }

  void _updateTaskTitle(MindTask task, String newTitle) {
    final idx = _currentLog.tasks.indexWhere((t) => t.id == task.id);
    if (idx != -1) {
      setState(() => _currentLog.tasks[idx].title = newTitle);
      _saveToFirestore();
    }
  }

  // --- BOOK PROGRESS ---

  void _updateBookProgress(String bookId, int delta, int absolutePage) {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    setState(() {
      int newPagesRead = _currentLog.pagesRead + delta;
      if (newPagesRead < 0) newPagesRead = 0; // Prevent negative
      _currentLog.pagesRead = newPagesRead;
      _currentLog.endPage = absolutePage;
    });
    _saveToFirestore();

    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('books')
        .doc(bookId)
        .update({
          'currentPage': absolutePage,
          'lastRead': FieldValue.serverTimestamp(),
        });
  }

  // --- UI DIALOGS ---

  void _showInputSheet({required bool isHabit, MindTask? existingTask}) {
    final ctrl = TextEditingController(text: existingTask?.title);
    final isDark = Theme.of(context).brightness == Brightness.dark;

    showModalBottomSheet(
      context: context,
      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
      isScrollControlled: true,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => Padding(
        padding: EdgeInsets.fromLTRB(
          24,
          24,
          24,
          MediaQuery.of(ctx).viewInsets.bottom + 24,
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              existingTask == null
                  ? (isHabit ? "New Habit" : "New Task")
                  : "Edit Item",
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : Colors.black,
              ),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: ctrl,
              autofocus: true,
              textCapitalization: TextCapitalization.sentences,
              style: TextStyle(color: isDark ? Colors.white : Colors.black),
              decoration: InputDecoration(
                hintText: "Title",
                filled: true,
                fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(16),
                  borderSide: BorderSide.none,
                ),
              ),
            ),
            const SizedBox(height: 24),
            Row(
              children: [
                if (existingTask != null) ...[
                  IconButton(
                    onPressed: () {
                      _deleteTask(existingTask);
                      Navigator.pop(ctx);
                    },
                    icon: const Icon(Icons.delete_outline, color: Colors.red),
                  ),
                  const SizedBox(width: 8),
                ],
                Expanded(
                  child: ElevatedButton(
                    onPressed: () {
                      if (ctrl.text.isNotEmpty) {
                        if (existingTask != null)
                          _updateTaskTitle(existingTask, ctrl.text);
                        else
                          _addNewTask(ctrl.text, isHabit);
                        Navigator.pop(ctx);
                      }
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: const Text("Save"),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  void _showAddMenu() {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (ctx) => Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        ),
        child: SafeArea(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey.withValues(alpha: 0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 20),
              Row(
                children: [
                  Expanded(
                    child: _actionBtn(
                      Icons.check_circle_outline,
                      "Add Task",
                      Colors.green,
                      () {
                        Navigator.pop(ctx);
                        _showInputSheet(isHabit: false);
                      },
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: _actionBtn(
                      Icons.repeat,
                      "Add Habit",
                      Colors.purple,
                      () {
                        Navigator.pop(ctx);
                        _showInputSheet(isHabit: true);
                      },
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: _actionBtn(
                      Icons.edit_note_rounded,
                      "Add Note",
                      Colors.blue,
                      () {
                        Navigator.pop(ctx);
                        showModalBottomSheet(
                          context: context,
                          isScrollControlled: true,
                          backgroundColor: Colors.transparent,
                          builder: (_) => const NoteEditorSheet(),
                        );
                      },
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }

  Widget _actionBtn(
    IconData icon,
    String label,
    Color color,
    VoidCallback onTap,
  ) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: 100,
        decoration: BoxDecoration(
          color: Colors.grey.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(color: color.withValues(alpha: 0.3)),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 28, color: color),
            const SizedBox(height: 8),
            Text(
              label,
              style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12),
            ),
          ],
        ),
      ),
    );
  }

  // --- üóìÔ∏è DATE HELPERS ---

  int _calculatePageForDate(DateTime date) {
    final now = DateTime.now();
    final mondayNow = now.subtract(Duration(days: now.weekday - 1));
    final mondayDate = date.subtract(Duration(days: date.weekday - 1));
    return _initialPage + (mondayDate.difference(mondayNow).inDays / 7).round();
  }

  void _onDateSelected(DateTime date) {
    setState(() {
      _selectedDate = DateUtils.dateOnly(date);
      _forceInspectMode = false;
    });
    _subscribeToDate(_selectedDate);
  }

  void _handleBackToToday() {
    _onDateSelected(DateTime.now());
    _weekPageController.animateToPage(
      _calculatePageForDate(DateTime.now()),
      duration: const Duration(milliseconds: 500),
      curve: Curves.easeInOutCubic,
    );
  }

  Future<void> _selectDateFromPicker() async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: _selectedDate,
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
      builder: (context, child) => Theme(
        data: Theme.of(context).copyWith(
          // ‚úÖ CRITICAL FIX: Explicitly set DatePicker Theme properties
          datePickerTheme: const DatePickerThemeData(
            headerBackgroundColor: Colors.blue, // Forces Header to Blue
            headerForegroundColor: Colors.white, // Forces Header Text to White
            backgroundColor: Color(0xFF1E1E1E), // Dark body background
            surfaceTintColor: Colors.transparent,
          ),
          colorScheme: const ColorScheme.dark(
            primary: Colors.blue, // Selection circle color
            onPrimary: Colors.white,
            surface: Color(0xFF1E1E1E),
            onSurface: Colors.white,
          ),
          dialogBackgroundColor: const Color(0xFF1E1E1E),
        ),
        child: child!,
      ),
    );
    if (picked != null) {
      _onDateSelected(picked);
      _weekPageController.jumpToPage(_calculatePageForDate(picked));
    }
  }

  // --- üèóÔ∏è BUILD METHOD ---

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF121212) : const Color(0xFFF5F5F5);
    final isPast = _selectedDate.isBefore(DateUtils.dateOnly(DateTime.now()));

    // PAST VIEW MODE
    if (isPast && !_forceInspectMode) {
      return Scaffold(
        backgroundColor: bgColor,
        appBar: AppBar(toolbarHeight: 0, backgroundColor: bgColor),
        body: Column(
          children: [
            CalendarStrip(
              selectedDate: _selectedDate,
              onDateSelected: _onDateSelected,
              onBackToToday: _handleBackToToday,
              onPickerTap: _selectDateFromPicker,
              isDark: isDark,
              pageController: _weekPageController,
              themeColor: Colors.blue,
            ),
            Expanded(
              child: BookSummaryView(
                log: _currentLog,
                onInspect: () => setState(() => _forceInspectMode = true),
                onBackToToday: _handleBackToToday,
              ),
            ),
          ],
        ),
      );
    }

    final habits = _currentLog.tasks.where((t) => t.isHabit).toList();
    final chores = _currentLog.tasks.where((t) => !t.isHabit).toList();

    return Scaffold(
      backgroundColor: bgColor,
      floatingActionButton: FloatingActionButton(
        onPressed: _showAddMenu,
        backgroundColor: Colors.blue,
        child: const Icon(Icons.add, color: Colors.white),
      ),
      appBar: AppBar(toolbarHeight: 0, backgroundColor: bgColor),
      body: Column(
        children: [
          // 1. CALENDAR
          CalendarStrip(
            selectedDate: _selectedDate,
            onDateSelected: _onDateSelected,
            onBackToToday: _handleBackToToday,
            onPickerTap: _selectDateFromPicker,
            isDark: isDark,
            pageController: _weekPageController,
            themeColor: Colors.blue,
          ),

          // 2. SCROLLABLE CONTENT
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.fromLTRB(20, 10, 20, 100),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // A. BOOK HERO (Active + Up Next)
                  StreamBuilder<QuerySnapshot>(
                    stream: FirebaseFirestore.instance
                        .collection('users')
                        .doc(FirebaseAuth.instance.currentUser?.uid)
                        .collection('books')
                        .where('status', isEqualTo: 'reading')
                        .limit(1)
                        .snapshots(),
                    builder: (context, activeSnapshot) {
                      Book? activeBook;
                      if (activeSnapshot.hasData &&
                          activeSnapshot.data!.docs.isNotEmpty) {
                        final doc = activeSnapshot.data!.docs.first;
                        activeBook = Book.fromMap(
                          doc.data() as Map<String, dynamic>,
                          doc.id,
                        );
                      }
                      return StreamBuilder<QuerySnapshot>(
                        stream: FirebaseFirestore.instance
                            .collection('users')
                            .doc(FirebaseAuth.instance.currentUser?.uid)
                            .collection('books')
                            .where('status', isEqualTo: 'wishlist')
                            .limit(20)
                            .snapshots(),
                        builder: (context, wishlistSnapshot) {
                          final uniqueTitles = <String>{};
                          final upNextBooks =
                              (wishlistSnapshot.data?.docs ?? [])
                                  .map(
                                    (d) => Book.fromMap(
                                      d.data() as Map<String, dynamic>,
                                      d.id,
                                    ),
                                  )
                                  .where(
                                    (b) => uniqueTitles.add(b.title),
                                  ) // Deduplicate visual
                                  .toList();
                          return BookHero(
                            book: activeBook,
                            upNextBooks: upNextBooks,
                            isDark: isDark,
                            onProgressLogged: (delta) {
                              if (activeBook != null)
                                _updateBookProgress(
                                  activeBook.id,
                                  delta,
                                  activeBook.currentPage + delta,
                                );
                            },
                          );
                        },
                      );
                    },
                  ),

                  const SizedBox(height: 24),

                  // B. TASKS (Daily Chores)
                  _buildTasksCard(chores, isDark),

                  const SizedBox(height: 24),

                  // C. HABITS (Streaks)
                  HabitsSection(
                    habits: habits,
                    isDark: isDark,
                    onToggle: _toggleTask,
                    onLongPress: (t) =>
                        _showInputSheet(isHabit: true, existingTask: t),
                    onAddGhost: (title, isHabit) => _addNewTask(title, isHabit),
                    onViewAll: () => Navigator.push(
                      context,
                      MaterialPageRoute(builder: (_) => const AllHabitsView()),
                    ),
                  ),

                  const SizedBox(height: 24),

                  // D. NOTES (Ideas)
                  NotesSection(
                    isDark: isDark,
                    onEditNote: (n) => showModalBottomSheet(
                      context: context,
                      isScrollControlled: true,
                      backgroundColor: Colors.transparent,
                      builder: (_) => NoteEditorSheet(existingNote: n),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // --- LOCAL WIDGETS ---

  Widget _buildTasksCard(List<MindTask> tasks, bool isDark) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: isDark
            ? []
            : [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.05),
                  blurRadius: 10,
                  offset: const Offset(0, 4),
                ),
              ],
      ),
      child: Column(
        children: [
          Row(
            children: [
              const Icon(
                Icons.check_circle_outline,
                size: 16,
                color: Colors.grey,
              ),
              const SizedBox(width: 8),
              const Text(
                "TASKS",
                style: TextStyle(
                  fontSize: 12,
                  fontWeight: FontWeight.bold,
                  color: Colors.grey,
                  letterSpacing: 1.0,
                ),
              ),
              const Spacer(),
              GestureDetector(
                onTap: () => _showInputSheet(isHabit: false),
                child: const Icon(Icons.add, size: 20, color: Colors.blue),
              ),
            ],
          ),
          const SizedBox(height: 12),
          if (tasks.isEmpty) ...[
            _buildGhostTask("Wash dishes", isDark),
            const SizedBox(height: 12),
            _buildGhostTask("Tidy up room", isDark),
          ] else
            ...tasks.map((task) => _buildRealTask(task, isDark)),
        ],
      ),
    );
  }

  Widget _buildGhostTask(String text, bool isDark) {
    return GestureDetector(
      onTap: () => _addNewTask(text, false), // Add on tap
      child: Opacity(
        opacity: 0.3,
        child: Row(
          children: [
            Container(
              width: 24,
              height: 24,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                border: Border.all(color: Colors.grey, width: 2),
              ),
            ),
            const SizedBox(width: 12),
            Text(
              text,
              style: TextStyle(
                fontSize: 15,
                fontStyle: FontStyle.italic,
                color: isDark ? Colors.white : Colors.black87,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRealTask(MindTask task, bool isDark) {
    return GestureDetector(
      onTap: () => _toggleTask(task),
      onLongPress: () => _showInputSheet(isHabit: false, existingTask: task),
      child: Container(
        margin: const EdgeInsets.only(bottom: 12),
        child: Row(
          children: [
            Container(
              width: 24,
              height: 24,
              decoration: BoxDecoration(
                color: task.isDone ? Colors.blue : Colors.transparent,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: task.isDone
                      ? Colors.blue
                      : (isDark ? Colors.grey : Colors.grey.shade400),
                  width: 2,
                ),
              ),
              child: task.isDone
                  ? const Icon(Icons.check, size: 16, color: Colors.white)
                  : null,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                task.title,
                style: TextStyle(
                  fontSize: 15,
                  color: task.isDone
                      ? Colors.white30
                      : (isDark ? Colors.white : Colors.black87),
                  decoration: task.isDone ? TextDecoration.lineThrough : null,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

dashboard_page.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:intl/intl.dart';

class DashboardPage extends StatelessWidget {
  const DashboardPage({super.key});

  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;

    if (user == null) {
      return const Center(child: CircularProgressIndicator());
    }

    return SingleChildScrollView(
      child: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const SizedBox(height: 20),
            // HEADER
            Row(
              children: [
                const CircleAvatar(
                  radius: 24,
                  backgroundColor: Colors.teal,
                  child: Icon(Icons.person, color: Colors.white),
                ),
                const SizedBox(width: 16),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Welcome Back!',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: textColor,
                      ),
                    ),
                    Text(
                      DateFormat('EEEE, MMMM d').format(DateTime.now()),
                      style: TextStyle(color: Colors.grey.shade500),
                    ),
                  ],
                ),
              ],
            ),

            const SizedBox(height: 30),
            Text(
              "Today's Overview",
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: textColor,
              ),
            ),
            const SizedBox(height: 16),

            // 1. HEALTH SUMMARY CARD
            StreamBuilder<DocumentSnapshot>(
              stream: FirebaseFirestore.instance
                  .collection('users')
                  .doc(user.uid)
                  .collection('health_logs')
                  .doc(DateFormat('yyyy-MM-dd').format(DateTime.now()))
                  .snapshots(),
              builder: (context, snapshot) {
                int steps = 0;
                if (snapshot.hasData && snapshot.data!.exists) {
                  final data = snapshot.data!.data() as Map<String, dynamic>;
                  steps = data['steps'] ?? 0;
                }
                return _buildSummaryCard(
                  context,
                  title: "Steps Taken",
                  value: "$steps",
                  subtitle: "Goal: 10,000",
                  icon: Icons.directions_walk,
                  color: Colors.orange,
                  progress: (steps / 10000).clamp(0.0, 1.0),
                );
              },
            ),

            const SizedBox(height: 16),

            // 2. FINANCE SUMMARY CARD
            StreamBuilder<QuerySnapshot>(
              stream: FirebaseFirestore.instance
                  .collection('finance_transactions')
                  .where('userId', isEqualTo: user.uid)
                  .snapshots(),
              builder: (context, snapshot) {
                double balance = 0;
                if (snapshot.hasData) {
                  final docs = snapshot.data!.docs;
                  for (var doc in docs) {
                    final data = doc.data() as Map<String, dynamic>;
                    final amount = (data['amount'] as num).toDouble();
                    final isExpense = data['isExpense'] as bool;
                    if (isExpense) {
                      balance -= amount;
                    } else {
                      balance += amount;
                    }
                  }
                }
                return _buildSummaryCard(
                  context,
                  title: "Wallet Balance",
                  value: "\$${balance.toStringAsFixed(2)}",
                  subtitle: "Total Savings",
                  icon: Icons.account_balance_wallet,
                  color: Colors.green,
                  progress: 1.0,
                  isFinance: true,
                );
              },
            ),

            const SizedBox(height: 16),

            // 3. SCHEDULE SUMMARY CARD
            StreamBuilder<QuerySnapshot>(
              stream: FirebaseFirestore.instance
                  .collection('lessons')
                  .where('userId', isEqualTo: user.uid)
                  .snapshots(),
              builder: (context, snapshot) {
                int eventsToday = 0;
                if (snapshot.hasData) {
                  final nowString = DateFormat(
                    'yyyy-MM-dd',
                  ).format(DateTime.now());
                  final dayName = DateFormat('EEEE').format(DateTime.now());

                  eventsToday = snapshot.data!.docs.where((doc) {
                    final data = doc.data() as Map<String, dynamic>;
                    final isRecurring = data['isRecurring'] as bool;
                    if (isRecurring) {
                      final exclude = List<String>.from(
                        data['excludeDates'] ?? [],
                      );
                      return data['dayOfWeek'] == dayName &&
                          !exclude.contains(nowString);
                    } else {
                      return data['specificDate'] == nowString;
                    }
                  }).length;
                }

                return _buildSummaryCard(
                  context,
                  title: "Schedule",
                  value: "$eventsToday Events",
                  subtitle: "Remaining Today",
                  icon: Icons.calendar_today,
                  color: Colors.deepPurple,
                  progress: 0.0,
                  hideProgress: true,
                );
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSummaryCard(
    BuildContext context, {
    required String title,
    required String value,
    required String subtitle,
    required IconData icon,
    required Color color,
    required double progress,
    bool isFinance = false,
    bool hideProgress = false,
  }) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          if (!isDark)
            BoxShadow(
              color: Colors.grey.withValues(alpha: 0.1),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
        ],
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(icon, color: color, size: 28),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(color: Colors.grey.shade500, fontSize: 12),
                ),
                const SizedBox(height: 4),
                // --- FIX IS BELOW: added \ before $ ---
                Text(
                  value,
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: isFinance && value.startsWith('\$-')
                        ? Colors.red
                        : textColor,
                  ),
                ),
                if (!hideProgress) ...[
                  const SizedBox(height: 8),
                  ClipRRect(
                    borderRadius: BorderRadius.circular(4),
                    child: LinearProgressIndicator(
                      value: progress,
                      backgroundColor: color.withValues(alpha: 0.1),
                      color: color,
                      minHeight: 6,
                    ),
                  ),
                ] else ...[
                  const SizedBox(height: 4),
                  Text(subtitle, style: TextStyle(fontSize: 12, color: color)),
                ],
              ],
            ),
          ),
        ],
      ),
    );
  }
}

finance_page.dart:
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:firebase_auth/firebase_auth.dart'; // <--- IMPORT ADDED

// MODELS
import '../models/finance_models.dart';

// WIDGETS
import '../widgets/finance/add_transaction_dialog.dart';
import '../widgets/finance/past_month_summary.dart';
import '../widgets/finance/finance_dashboard.dart';
import '../widgets/finance/edit_monthly_budget_dialog.dart';
import '../widgets/finance/finance_header.dart';

class FinancePage extends StatefulWidget {
  const FinancePage({super.key});

  @override
  State<FinancePage> createState() => _FinancePageState();
}

class _FinancePageState extends State<FinancePage> {
  DateTime _selectedDate = DateTime.now();
  bool _isInspectingPast = false;
  bool _showChart = false;

  final CollectionReference _bucketsRef = FirebaseFirestore.instance.collection(
    'finance_buckets',
  );
  final CollectionReference _txRef = FirebaseFirestore.instance.collection(
    'finance_transactions',
  );

  // --- INITIALIZATION ---
  @override
  void initState() {
    super.initState();
    _ensureBucketsExist();
  }

  // Create default buckets if user has none
  Future<void> _ensureBucketsExist() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return; // Wait for login

    // Check buckets for REAL user ID
    final snapshot = await _bucketsRef
        .where('userId', isEqualTo: user.uid) // <--- CHECK REAL ID
        .get();

    if (snapshot.docs.isEmpty) {
      final defaults = [
        FinanceBucket(
          id: '',
          name: 'Rent',
          limit: 800,
          iconCode: Icons.home_rounded.codePoint,
          colorValue: Colors.blue.value,
          isFixed: true,
        ),
        FinanceBucket(
          id: '',
          name: 'Groceries',
          limit: 200,
          iconCode: Icons.shopping_cart_rounded.codePoint,
          colorValue: Colors.green.value,
        ),
        FinanceBucket(
          id: '',
          name: 'Dining',
          limit: 150,
          iconCode: Icons.restaurant_rounded.codePoint,
          colorValue: Colors.orange.value,
        ),
        FinanceBucket(
          id: '',
          name: 'Transport',
          limit: 100,
          iconCode: Icons.directions_bus_rounded.codePoint,
          colorValue: Colors.indigo.value,
        ),
        FinanceBucket(
          id: '',
          name: 'Fun',
          limit: 100,
          iconCode: Icons.movie_rounded.codePoint,
          colorValue: Colors.purple.value,
        ),
        FinanceBucket(
          id: '',
          name: 'Subscriptions',
          limit: 60,
          iconCode: Icons.subscriptions_rounded.codePoint,
          colorValue: Colors.teal.value,
          isFixed: true,
        ),
      ];

      for (var b in defaults) {
        // Add userId to the bucket map so it belongs to this user
        final bucketMap = b.toMap();
        bucketMap['userId'] = user.uid; // <--- IMPORTANT: LINK BUCKET TO USER
        await _bucketsRef.add(bucketMap);
      }
    }
  }

  bool get _isCurrentMonth {
    final now = DateTime.now();
    return _selectedDate.year == now.year && _selectedDate.month == now.month;
  }

  bool get _isFutureMonth {
    final now = DateTime.now();
    if (_selectedDate.year > now.year) return true;
    if (_selectedDate.year == now.year && _selectedDate.month > now.month) {
      return true;
    }
    return false;
  }

  void _changeMonth(int offset) {
    setState(() {
      _selectedDate = DateTime(
        _selectedDate.year,
        _selectedDate.month + offset,
        1,
      );
      _isInspectingPast = false;
    });
  }

  // --- UPDATE LIMIT ---
  void _updateBucketLimit(
    String bucketId,
    double currentLimit,
    String name, [
    VoidCallback? onSaved,
  ]) {
    final controller = TextEditingController(
      text: currentLimit.toStringAsFixed(0),
    );
    final isDark = Theme.of(context).brightness == Brightness.dark;

    showDialog(
      context: context,
      builder: (ctx) => Dialog(
        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                "Edit Budget: $name",
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: isDark ? Colors.white : Colors.black,
                ),
              ),
              const SizedBox(height: 16),
              TextField(
                controller: controller,
                keyboardType: TextInputType.number,
                style: TextStyle(
                  color: isDark ? Colors.white : Colors.black,
                  fontSize: 18,
                ),
                decoration: InputDecoration(
                  labelText: "Monthly Limit (\$)",
                  hintText: "e.g. 500",
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(ctx),
                      child: const Text("Cancel"),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () {
                        final newLimit =
                            double.tryParse(controller.text) ?? currentLimit;
                        _bucketsRef.doc(bucketId).update({'limit': newLimit});
                        if (onSaved != null) onSaved();
                        Navigator.pop(ctx);
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.green,
                        foregroundColor: Colors.white,
                      ),
                      child: const Text("Save"),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showEditMonthlyBudgets(List<FinanceBucket> currentBuckets) {
    showDialog(
      context: context,
      builder: (ctx) => EditMonthlyBudgetDialog(
        buckets: currentBuckets,
        onUpdateLimit: _updateBucketLimit,
      ),
    );
  }

  void _onEditTransaction(FinanceTransaction tx, List<FinanceBucket> buckets) {
    showDialog(
      context: context,
      builder: (context) =>
          AddTransactionDialog(buckets: buckets, transactionToEdit: tx),
    );
  }

  void _onAddTransaction(List<FinanceBucket> buckets) {
    showDialog(
      context: context,
      builder: (context) => AddTransactionDialog(buckets: buckets),
    );
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    // GET CURRENT USER
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) {
      return const Center(child: CircularProgressIndicator());
    }

    // 1. STREAM BUCKETS
    return StreamBuilder<QuerySnapshot>(
      stream: _bucketsRef
          .where('userId', isEqualTo: user.uid)
          .snapshots(), // <--- REAL ID
      builder: (context, bucketSnap) {
        if (!bucketSnap.hasData) {
          return const Center(child: CircularProgressIndicator());
        }

        final buckets = bucketSnap.data!.docs
            .map((doc) => FinanceBucket.fromFirestore(doc))
            .toList();

        // 2. STREAM TRANSACTIONS
        return StreamBuilder<QuerySnapshot>(
          stream: _txRef
              .where('userId', isEqualTo: user.uid) // <--- REAL ID
              .orderBy('date', descending: true)
              .snapshots(),
          builder: (context, txSnap) {
            if (!txSnap.hasData) {
              return const Center(child: CircularProgressIndicator());
            }

            final allTransactions = txSnap.data!.docs
                .map((doc) => FinanceTransaction.fromFirestore(doc))
                .toList();

            final monthTransactions = allTransactions.where((t) {
              return t.date.year == _selectedDate.year &&
                  t.date.month == _selectedDate.month;
            }).toList();

            final monthlyExpense = monthTransactions
                .where((t) => t.isExpense)
                .fold(0.0, (sum, t) => sum + t.amount);
            final monthlyIncome = monthTransactions
                .where((t) => !t.isExpense)
                .fold(0.0, (sum, t) => sum + t.amount);

            // Calculate 'spent' for each bucket dynamically
            final calculatedBuckets = buckets.map((bucket) {
              final bucketSpent = monthTransactions
                  .where((t) => t.isExpense && t.categoryId == bucket.id)
                  .fold(0.0, (sum, t) => sum + t.amount);
              return bucket.copyWith(spent: bucketSpent);
            }).toList();

            return Scaffold(
              backgroundColor: Colors.transparent,
              floatingActionButton: _isCurrentMonth
                  ? FloatingActionButton(
                      onPressed: () => _onAddTransaction(calculatedBuckets),
                      backgroundColor: Colors.green,
                      child: const Icon(Icons.add, color: Colors.white),
                    )
                  : null,
              body: SingleChildScrollView(
                physics: const BouncingScrollPhysics(),
                child: Column(
                  children: [
                    FinanceHeader(
                      selectedDate: _selectedDate,
                      onMonthChanged: _changeMonth,
                      isInspectingPast: _isInspectingPast,
                      showChart: _showChart,
                      onChartToggle: (val) => setState(() => _showChart = val),
                      onResetDate: () => setState(() {
                        _selectedDate = DateTime.now();
                        _isInspectingPast = false;
                      }),
                    ),
                    if (!_isCurrentMonth &&
                        !_isFutureMonth &&
                        !_isInspectingPast)
                      PastMonthSummary(
                        selectedDate: _selectedDate,
                        income: monthlyIncome,
                        expense: monthlyExpense,
                        isDark: isDark,
                        onBackToToday: () =>
                            setState(() => _selectedDate = DateTime.now()),
                        onInspect: () =>
                            setState(() => _isInspectingPast = true),
                      )
                    else
                      FinanceDashboard(
                        isDark: isDark,
                        showChart: _showChart,
                        transactions: monthTransactions,
                        buckets: calculatedBuckets,
                        monthlyIncome: monthlyIncome,
                        monthlyExpense: monthlyExpense,
                        onEditTransaction: (tx) =>
                            _onEditTransaction(tx, calculatedBuckets),
                        onUpdateBucketLimit: _updateBucketLimit,
                        onEditAllBudgets: () =>
                            _showEditMonthlyBudgets(calculatedBuckets),
                      ),
                    const SizedBox(height: 80),
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }
}


health_page.dart:
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:pedometer/pedometer.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:firebase_auth/firebase_auth.dart';

import '../models/health_model.dart';
import '../widgets/health/grid.dart';
import '../widgets/health/summary_card.dart';
import '../widgets/health/plan_view.dart'; // NEW IMPORT

class HealthPage extends StatefulWidget {
  const HealthPage({super.key});

  @override
  State<HealthPage> createState() => _HealthPageState();
}

class _HealthPageState extends State<HealthPage> {
  // ... [Keep ALL your existing state variables (streams, controllers, etc.)]
  DateTime _selectedDate = DateTime.now();
  late PageController _weekPageController;
  final int _initialPage = 1000;
  bool _forceInspectMode = false;

  StreamSubscription<DocumentSnapshot>? _firestoreSubscription;
  HealthDailyLog _currentLog = HealthDailyLog();

  @override
  void initState() {
    super.initState();
    final initialIndex = _calculatePageForDate(DateTime.now());
    _weekPageController = PageController(initialPage: initialIndex);
    _loadSavedSteps();
    _subscribeToDate(_selectedDate);
    _initPedometer();
  }

  @override
  void dispose() {
    _weekPageController.dispose();
    _firestoreSubscription?.cancel();
    super.dispose();
  }

  // ... [Keep ALL your existing logic methods (_subscribeToDate, _saveToFirestore, etc.)]
  // (Paste them here exactly as they were in previous steps to avoid breaking logic)
  void _subscribeToDate(DateTime date) {
    _firestoreSubscription?.cancel();
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    final dateKey = DateFormat('yyyy-MM-dd').format(date);
    _firestoreSubscription = FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('health_logs')
        .doc(dateKey)
        .snapshots()
        .listen((snapshot) {
          if (snapshot.exists && snapshot.data() != null) {
            final cloudLog = HealthDailyLog.fromMap(snapshot.data()!, date);
            if (DateUtils.isSameDay(date, DateTime.now())) {
              setState(
                () => _currentLog = cloudLog.copyWith(steps: _currentLog.steps),
              );
            } else {
              setState(() => _currentLog = cloudLog);
            }
          } else {
            if (!DateUtils.isSameDay(date, DateTime.now())) {
              setState(() => _currentLog = HealthDailyLog(date: date));
            }
          }
        });
  }

  Future<void> _loadSavedSteps() async {
    final prefs = await SharedPreferences.getInstance();
    final todayKey = "daily_steps_v2_${DateTime.now().day}";
    if (prefs.containsKey(todayKey)) {
      int savedSteps = prefs.getInt(todayKey) ?? 0;
      if (mounted)
        setState(() => _currentLog = _currentLog.copyWith(steps: savedSteps));
    }
  }

  void _initPedometer() async {
    if (await Permission.activityRecognition.request().isGranted) {
      Pedometer.stepCountStream.listen(_onStepCount).onError(_onStepError);
    }
  }

  void _onStepCount(StepCount event) async {
    int totalSensorSteps = event.steps;
    int todaySteps = await _calculateTodaySteps(totalSensorSteps);
    _saveStepsLocally(todaySteps);
    if (mounted) {
      setState(() => _currentLog = _currentLog.copyWith(steps: todaySteps));
      if (todaySteps % 10 == 0) _saveToFirestore();
    }
  }

  Future<void> _saveStepsLocally(int steps) async {
    final prefs = await SharedPreferences.getInstance();
    final todayKey = "daily_steps_v2_${DateTime.now().day}";
    await prefs.setInt(todayKey, steps);
  }

  Future<int> _calculateTodaySteps(int sensorSteps) async {
    final prefs = await SharedPreferences.getInstance();
    final offsetKey = "steps_offset_v2_${DateTime.now().day}";
    if (!prefs.containsKey(offsetKey))
      await prefs.setInt(offsetKey, sensorSteps);
    int offset = prefs.getInt(offsetKey) ?? sensorSteps;
    int calculated = sensorSteps - offset;
    return calculated < 0 ? sensorSteps : calculated;
  }

  void _onStepError(error) => debugPrint('Pedometer Error: $error');

  void _saveToFirestore() {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    final dateKey = DateFormat('yyyy-MM-dd').format(_selectedDate);
    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('health_logs')
        .doc(dateKey)
        .set(_currentLog.toMap(), SetOptions(merge: true));
  }

  void _updateLog(VoidCallback updateFn) {
    setState(() => updateFn());
    _saveToFirestore();
  }

  int _calculatePageForDate(DateTime date) {
    final now = DateTime.now();
    final mondayNow = now.subtract(Duration(days: now.weekday - 1));
    final mondayDate = date.subtract(Duration(days: date.weekday - 1));
    return _initialPage + (mondayDate.difference(mondayNow).inDays / 7).round();
  }

  DateTime _getMondayForPage(int index) {
    final now = DateTime.now();
    final currentMonday = now.subtract(Duration(days: now.weekday - 1));
    return currentMonday.add(Duration(days: (index - _initialPage) * 7));
  }

  void _onDateSelected(DateTime date) {
    setState(() {
      _selectedDate = date;
      _forceInspectMode = false;
    });
    _subscribeToDate(date);
  }

  Future<void> _selectDateFromPicker(BuildContext context) async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: _selectedDate,
      firstDate: DateTime(2023),
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: const ColorScheme.dark(
              primary: Colors.deepOrange,
              onPrimary: Colors.white,
              surface: Color(0xFF1E1E1E),
              onSurface: Colors.white,
            ),
            datePickerTheme: const DatePickerThemeData(
              headerBackgroundColor: Colors.deepOrange,
              headerForegroundColor: Colors.white,
              backgroundColor: Color(0xFF1E1E1E),
            ),
          ),
          child: child!,
        );
      },
    );

    if (picked != null && picked != _selectedDate) {
      _onDateSelected(picked);
      _weekPageController.animateToPage(
        _calculatePageForDate(picked),
        duration: const Duration(milliseconds: 500),
        curve: Curves.easeInOutCubic,
      );
    }
  }

  void _handleBackToToday(Color themeColor) {
    final now = DateTime.now();
    _onDateSelected(now);
    _weekPageController.animateToPage(
      _calculatePageForDate(now),
      duration: const Duration(milliseconds: 500),
      curve: Curves.easeInOutCubic,
    );
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final themeColor = Colors.deepOrange;
    final textColor = isDark ? Colors.white : Colors.black87;

    final isToday = DateUtils.isSameDay(_selectedDate, DateTime.now());
    final isFuture = _selectedDate.isAfter(DateTime.now()) && !isToday;

    Widget content;

    if (isFuture) {
      // Future: Show Full Page Planner
      content = WorkoutPlanView(
        log: _currentLog,
        onRoutineChanged: (name) =>
            _updateLog(() => _currentLog.workoutName = name),
        onLogUpdated: () => _updateLog(() {}), // Trigger save
      );
    } else if (isToday || _forceInspectMode) {
      // Today/Inspect: Show Grid
      content = _buildGrid();
    } else {
      // Past: Show Summary
      content = HealthSummaryView(
        log: _currentLog,
        onInspectDetails: () => setState(() => _forceInspectMode = true),
        onBackToToday: () => _handleBackToToday(themeColor),
      );
    }

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Column(
        children: [
          _buildHealthHeader(isDark, themeColor, textColor),
          Expanded(child: content),
        ],
      ),
    );
  }

  // _buildGrid helper remains the same...
  Widget _buildGrid() {
    return HealthGrid(
      log: _currentLog,
      onWaterChanged: (val) => _updateLog(() => _currentLog.waterGlasses = val),
      onUpdateGlassSize: (val) =>
          _updateLog(() => _currentLog.waterGlassSizeMl = val),
      onCaffeineChanged: (val) =>
          _updateLog(() => _currentLog.caffeineAmount = val),
      onMoodChanged: (val) => _updateLog(() => _currentLog.mood = val),
      onAddFood: (item) => _updateLog(() {
        _currentLog.foodLog.add(item);
        _currentLog.totalCalories += item.calories;
      }),
      onDietToggle: (val) => _updateLog(() => _currentLog.useMacros = val),
      onStepsChanged: (val) => _updateLog(() => _currentLog.steps = val),
      onWeightChanged: (val) => _updateLog(() => _currentLog.weight = val),
      onRoutineChanged: (val) =>
          _updateLog(() => _currentLog.workoutName = val),
      onWorkoutToggle: (val) =>
          _updateLog(() => _currentLog.isWorkoutDone = val),
      onCaloriesChanged: (val) {},
      onMacrosChanged: (p, c, f) {},
      onExerciseUpdated: () => _updateLog(() {}),
    );
  }

  // Header helper remains the same...
  Widget _buildHealthHeader(bool isDark, Color themeColor, Color textColor) {
    return Container(
      padding: const EdgeInsets.fromLTRB(20, 15, 20, 0),
      child: Column(
        children: [
          SizedBox(
            height: 50,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                GestureDetector(
                  onTap: () => _handleBackToToday(themeColor),
                  child: Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      color: themeColor.withOpacity(0.15),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(
                      Icons.undo_rounded,
                      color: themeColor,
                      size: 24,
                    ),
                  ),
                ),
                Text(
                  DateFormat('MMMM d').format(_selectedDate),
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                    color: textColor,
                  ),
                ),
                GestureDetector(
                  onTap: () => _selectDateFromPicker(context),
                  child: Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      color: themeColor.withOpacity(0.15),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(
                      Icons.calendar_month_rounded,
                      color: themeColor,
                      size: 24,
                    ),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 15),
          SizedBox(
            height: 70,
            child: PageView.builder(
              controller: _weekPageController,
              itemBuilder: (context, index) {
                final monday = _getMondayForPage(index);
                final weekDays = List.generate(
                  7,
                  (i) => monday.add(Duration(days: i)),
                );
                return Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: weekDays
                      .map((date) => _buildDayItem(date, themeColor, isDark))
                      .toList(),
                );
              },
            ),
          ),
          const SizedBox(height: 10),
        ],
      ),
    );
  }

  Widget _buildDayItem(DateTime date, Color themeColor, bool isDark) {
    final isSelected = DateUtils.isSameDay(date, _selectedDate);
    final isToday = DateUtils.isSameDay(date, DateTime.now());
    return Expanded(
      child: GestureDetector(
        onTap: () => _onDateSelected(date),
        child: Container(
          margin: const EdgeInsets.symmetric(horizontal: 3),
          decoration: BoxDecoration(
            color: isSelected
                ? themeColor
                : (isDark ? Colors.white10 : Colors.grey.shade100),
            borderRadius: BorderRadius.circular(16),
            border: isToday && !isSelected
                ? Border.all(color: themeColor.withOpacity(0.5), width: 1.5)
                : null,
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                DateFormat('E').format(date).substring(0, 3),
                style: TextStyle(
                  fontSize: 11,
                  color: isSelected
                      ? Colors.white
                      : (isDark ? Colors.white54 : Colors.grey),
                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                ),
              ),
              const SizedBox(height: 6),
              Text(
                date.day.toString(),
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: isSelected
                      ? Colors.white
                      : (isDark ? Colors.white : Colors.black87),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

login_page.dart:
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:google_sign_in/google_sign_in.dart';

class LoginPage extends StatefulWidget {
  const LoginPage({super.key});

  @override
  State<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends State<LoginPage> {
  bool _isLoading = false;

  Future<void> _signInWithGoogle() async {
    setState(() => _isLoading = true);

    try {
      // 1. Trigger Google Sign In flow
      final GoogleSignInAccount? googleUser = await GoogleSignIn().signIn();

      // If user cancelled the login
      if (googleUser == null) {
        setState(() => _isLoading = false);
        return;
      }

      // 2. Obtain the auth details from the request
      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;
      // 3. Create a new credential
      final OAuthCredential credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      // 4. Sign in to Firebase with the credential
      await FirebaseAuth.instance.signInWithCredential(credential);

      // The stream in main.dart will automatically take you to the Home Page now!
    } catch (e) {
      debugPrint("Error signing in: $e");
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text("Login Failed. Please try again."),
            backgroundColor: Colors.redAccent,
          ),
        );
      }
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    // Determine theme brightness for styling
    final isDark = MediaQuery.of(context).platformBrightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : const Color(0xFFF5F5F5);
    final textColor = isDark ? Colors.white : Colors.black87;

    return Scaffold(
      backgroundColor: bgColor,
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // Logo Icon
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: Colors.green.withOpacity(0.15),
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.auto_stories_rounded,
                  size: 64,
                  color: Colors.green,
                ),
              ),
              const SizedBox(height: 32),

              // App Title
              Text(
                "Life Notebook",
                style: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.bold,
                  color: textColor,
                  letterSpacing: 1.0,
                ),
              ),
              const SizedBox(height: 12),

              // Subtitle
              Text(
                "Your health, finance, and schedule.\nAll in one private place.",
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: isDark ? Colors.white54 : Colors.grey.shade600,
                  fontSize: 16,
                  height: 1.5,
                ),
              ),
              const SizedBox(height: 60),

              // Login Button
              if (_isLoading)
                const CircularProgressIndicator(color: Colors.green)
              else
                SizedBox(
                  width: double.infinity,
                  height: 56,
                  child: ElevatedButton(
                    onPressed: _signInWithGoogle,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: isDark ? Colors.white : Colors.white,
                      foregroundColor: Colors.black87,
                      elevation: 2,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        // We use an Icon here, but in production you usually use the Google Logo image
                        const Icon(Icons.login, color: Colors.blue),
                        const SizedBox(width: 12),
                        const Text(
                          "Continue with Google",
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            fontFamily: 'Roboto', // Google standard font
                          ),
                        ),
                      ],
                    ),
                  ),
                ),

              const SizedBox(height: 24),

              // Privacy Note
              Text(
                "Securely synced with your Google Account.",
                style: TextStyle(
                  color: isDark ? Colors.white24 : Colors.grey.shade400,
                  fontSize: 12,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

schedule_page.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:intl/intl.dart';
import 'package:firebase_auth/firebase_auth.dart'; // IMPORT ADDED
import '../models/lesson.dart';
import '../widgets/schedule/class_card.dart';
import '../widgets/schedule/add_lesson_dialog.dart';
import '../widgets/schedule/calendar_header.dart';

class SchedulePage extends StatefulWidget {
  const SchedulePage({super.key});

  @override
  State<SchedulePage> createState() => _SchedulePageState();
}

class _SchedulePageState extends State<SchedulePage> {
  DateTime _selectedDate = DateTime.now();
  final CollectionReference _lessonsRef = FirebaseFirestore.instance.collection(
    'lessons',
  );
  late Stream<QuerySnapshot> _lessonsStream;
  Map<String, String> _smartCourseDatabase = {};

  @override
  void initState() {
    super.initState();
    // --- NEW: GET CURRENT USER ---
    final user = FirebaseAuth.instance.currentUser;
    if (user != null) {
      _lessonsStream = _lessonsRef
          .where('userId', isEqualTo: user.uid) // <--- QUERY BY REAL ID
          .snapshots();
    } else {
      // Fallback (shouldn't happen if main() awaited login)
      _lessonsStream = const Stream.empty();
    }
  }

  void _saveLessonToFirestore(Lesson lesson) {
    if (lesson.id != null) {
      _lessonsRef.doc(lesson.id).update(lesson.toMap());
    } else {
      _lessonsRef.add(lesson.toMap());
    }
  }

  Future<void> _updateGlobalInstructor(
    String courseName,
    String newInstructor,
  ) async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    final querySnapshot = await _lessonsRef
        .where('userId', isEqualTo: user.uid) // <--- QUERY BY REAL ID
        .where('name', isEqualTo: courseName)
        .get();

    final batch = FirebaseFirestore.instance.batch();
    for (var doc in querySnapshot.docs) {
      batch.update(doc.reference, {'instructor': newInstructor});
    }
    await batch.commit();
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Updated global instructors!')),
      );
    }
  }

  // --- DELETE LOGIC & UI ---

  void _handleDeleteRequest(String lessonId) {
    _lessonsRef.doc(lessonId).get().then((doc) {
      if (doc.exists) {
        final lesson = Lesson.fromFirestore(doc);
        _confirmDeleteLogic(lesson);
      }
    });
  }

  void _confirmDeleteLogic(Lesson lesson) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final dateString = DateFormat('yyyy-MM-dd').format(_selectedDate);

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) {
        return Dialog(
          backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          child: Container(
            constraints: const BoxConstraints(maxWidth: 400),
            padding: const EdgeInsets.all(24.0),
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.redAccent.withOpacity(0.1),
                      shape: BoxShape.circle,
                    ),
                    child: const Icon(
                      Icons.delete_forever,
                      size: 32,
                      color: Colors.redAccent,
                    ),
                  ),
                  const SizedBox(height: 16),
                  Flexible(
                    child: Text(
                      lesson.isRecurring
                          ? "Delete Recurring?"
                          : "Delete Event?",
                      textAlign: TextAlign.center,
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: isDark ? Colors.white : Colors.black,
                      ),
                    ),
                  ),
                  const SizedBox(height: 12),
                  Text(
                    lesson.isRecurring
                        ? "Delete only this session or the entire series?"
                        : "Are you sure you want to delete '${lesson.name}'?",
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      color: isDark ? Colors.white70 : Colors.black54,
                    ),
                  ),
                  const SizedBox(height: 24),
                  if (lesson.isRecurring) ...[
                    Row(
                      children: [
                        Expanded(
                          child: OutlinedButton(
                            style: OutlinedButton.styleFrom(
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              side: BorderSide(
                                color: isDark
                                    ? Colors.white24
                                    : Colors.grey.shade300,
                              ),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onPressed: () {
                              Navigator.pop(ctx);
                              _lessonsRef.doc(lesson.id).update({
                                'excludeDates': FieldValue.arrayUnion([
                                  dateString,
                                ]),
                              });
                            },
                            child: Text(
                              "Only This",
                              textAlign: TextAlign.center,
                              style: TextStyle(
                                color: isDark ? Colors.white70 : Colors.black87,
                                fontSize: 13,
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              backgroundColor: Colors.redAccent,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onPressed: () {
                              Navigator.pop(ctx);
                              _lessonsRef.doc(lesson.id).delete();
                            },
                            child: const Text(
                              "Delete Series",
                              textAlign: TextAlign.center,
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                                fontSize: 13,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ] else ...[
                    Row(
                      children: [
                        Expanded(
                          child: OutlinedButton(
                            style: OutlinedButton.styleFrom(
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              side: BorderSide(
                                color: isDark
                                    ? Colors.white24
                                    : Colors.grey.shade300,
                              ),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onPressed: () => Navigator.pop(ctx),
                            child: Text(
                              "Keep",
                              style: TextStyle(
                                color: isDark ? Colors.white70 : Colors.black87,
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(
                              padding: const EdgeInsets.symmetric(vertical: 12),
                              backgroundColor: Colors.redAccent,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onPressed: () {
                              Navigator.pop(ctx);
                              _lessonsRef.doc(lesson.id).delete();
                            },
                            child: const Text(
                              "Delete",
                              style: TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                  const SizedBox(height: 12),
                  TextButton(
                    onPressed: () => Navigator.pop(ctx),
                    child: Text(
                      "Cancel",
                      style: TextStyle(color: Colors.grey.shade500),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  void _openLessonDialog({Lesson? lesson}) {
    showDialog(
      context: context,
      builder: (_) => AddLessonDialog(
        selectedDate: _selectedDate,
        courseDatabase: _smartCourseDatabase,
        onAddLesson: _saveLessonToFirestore,
        onUpdateGlobal: _updateGlobalInstructor,
        lessonToEdit: lesson,
        onDelete: _handleDeleteRequest,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final accentColor = isDark
        ? Colors.deepPurpleAccent
        : Theme.of(context).primaryColor;
    final dayName = DateFormat('EEEE').format(_selectedDate);
    final dateString = DateFormat('yyyy-MM-dd').format(_selectedDate);

    return Scaffold(
      backgroundColor: Colors.transparent,
      floatingActionButton: FloatingActionButton(
        onPressed: () => _openLessonDialog(),
        backgroundColor: accentColor,
        child: const Icon(Icons.add, color: Colors.white),
      ),
      body: Column(
        children: [
          CalendarHeader(
            selectedDate: _selectedDate,
            onDateSelected: (newDate) =>
                setState(() => _selectedDate = newDate),
          ),
          const SizedBox(height: 10),
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: _lessonsStream,
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(child: CircularProgressIndicator());
                }

                // If no user is logged in yet, snapshot may be empty
                final allLessons =
                    snapshot.data?.docs
                        .map((doc) => Lesson.fromFirestore(doc))
                        .toList() ??
                    [];

                // Refresh Smart Database
                _smartCourseDatabase = {};
                for (var l in allLessons) {
                  if (l.isLecture && l.name.isNotEmpty) {
                    _smartCourseDatabase[l.name] = l.instructor;
                  }
                }

                // Filter Logic
                final daysLessons = allLessons.where((l) {
                  if (l.isRecurring) {
                    return l.dayOfWeek == dayName &&
                        !l.excludeDates.contains(dateString);
                  }
                  return l.specificDate == dateString;
                }).toList();

                daysLessons.sort(
                  (a, b) =>
                      a.startTimeInMinutes.compareTo(b.startTimeInMinutes),
                );

                if (daysLessons.isEmpty) {
                  return Center(
                    child: Text(
                      "No plans for $dayName.",
                      style: TextStyle(color: Colors.grey.withOpacity(0.8)),
                    ),
                  );
                }

                return ListView.builder(
                  padding: const EdgeInsets.all(16),
                  itemCount: daysLessons.length,
                  itemBuilder: (context, index) {
                    final lesson = daysLessons[index];
                    return ClassCard(
                      lesson: lesson,
                      onEdit: () => _openLessonDialog(lesson: lesson),
                    );
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

all_habits_view.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:intl/intl.dart';
import '../../models/book_models.dart';

class AllHabitsView extends StatelessWidget {
  const AllHabitsView({super.key});

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final user = FirebaseAuth.instance.currentUser;
    final dateKey = DateFormat('yyyy-MM-dd').format(DateTime.now());
    final bg = isDark ? const Color(0xFF121212) : const Color(0xFFF5F5F5);
    final cardBg = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    return Scaffold(
      backgroundColor: bg,
      appBar: AppBar(
        title: const Text(
          "All Habits",
          style: TextStyle(fontWeight: FontWeight.w600),
        ),
        backgroundColor: bg,
        surfaceTintColor: Colors.transparent,
        centerTitle: true,
        leading: Center(
          child: IconButton(
            icon: Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: Colors.blue,
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(
                Icons.arrow_back,
                color: Colors.white,
                size: 18,
              ),
            ),
            onPressed: () => Navigator.pop(context),
          ),
        ),
      ),
      body: StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(user?.uid)
            .collection('book_logs')
            .doc(dateKey)
            .snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData || !snapshot.data!.exists) {
            return _buildEmptyState(isDark, "No habits found for today");
          }

          final log = BookDailyLog.fromMap(
            snapshot.data!.data() as Map<String, dynamic>,
            DateTime.now(),
          );
          final habits = log.tasks.where((t) => t.isHabit).toList();

          if (habits.isEmpty) {
            return _buildEmptyState(isDark, "No habits tracked today");
          }

          return ListView.separated(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 24),
            itemCount: habits.length,
            separatorBuilder: (_, __) => const SizedBox(height: 16),
            itemBuilder: (context, index) {
              final habit = habits[index];

              // ‚úÖ PROFESSIONAL CARD DESIGN
              return Container(
                decoration: BoxDecoration(
                  color: cardBg,
                  borderRadius: BorderRadius.circular(20),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(
                        alpha: isDark ? 0.3 : 0.05,
                      ),
                      blurRadius: 10,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Material(
                  color: Colors.transparent,
                  child: InkWell(
                    borderRadius: BorderRadius.circular(20),
                    // Tapping the card opens edit, tapping the circle toggles
                    onTap: () => _showEditDialog(
                      context,
                      user!.uid,
                      dateKey,
                      log,
                      habit,
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Row(
                        children: [
                          // Toggle Checkbox
                          GestureDetector(
                            onTap: () =>
                                _toggleHabit(user!.uid, dateKey, log, habit),
                            child: AnimatedContainer(
                              duration: const Duration(milliseconds: 200),
                              width: 28,
                              height: 28,
                              decoration: BoxDecoration(
                                color: habit.isDone
                                    ? Colors.blue
                                    : Colors.transparent,
                                shape: BoxShape.circle,
                                border: Border.all(
                                  color: habit.isDone
                                      ? Colors.blue
                                      : Colors.grey.shade600,
                                  width: 2,
                                ),
                              ),
                              child: habit.isDone
                                  ? const Icon(
                                      Icons.check,
                                      size: 18,
                                      color: Colors.white,
                                    )
                                  : null,
                            ),
                          ),
                          const SizedBox(width: 16),

                          // Text Info
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  habit.title,
                                  style: TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                    color: isDark
                                        ? Colors.white
                                        : Colors.black87,
                                    decoration: habit.isDone
                                        ? TextDecoration.lineThrough
                                        : null,
                                    decorationColor: Colors.blue,
                                    decorationThickness: 2,
                                  ),
                                ),
                                if (habit.streak > 0)
                                  Padding(
                                    padding: const EdgeInsets.only(top: 4),
                                    child: Row(
                                      children: [
                                        Text(
                                          "${habit.streak} ",
                                          style: const TextStyle(
                                            fontSize: 13,
                                            color: Colors.orange,
                                            fontWeight: FontWeight.bold,
                                          ),
                                        ),
                                        const Icon(
                                          Icons.local_fire_department,
                                          size: 16,
                                          color: Colors.orange,
                                        ),
                                      ],
                                    ),
                                  ),
                              ],
                            ),
                          ),

                          // Edit Icon
                          Icon(
                            Icons.edit_outlined,
                            color: isDark
                                ? Colors.grey.shade600
                                : Colors.grey.shade400,
                            size: 22,
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              );
            },
          );
        },
      ),
    );
  }

  Widget _buildEmptyState(bool isDark, String message) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.check_circle_outline,
            size: 64,
            color: Colors.grey.withValues(alpha: 0.3),
          ),
          const SizedBox(height: 16),
          Text(
            message,
            style: TextStyle(color: isDark ? Colors.white54 : Colors.black54),
          ),
        ],
      ),
    );
  }

  void _toggleHabit(
    String uid,
    String dateKey,
    BookDailyLog log,
    MindTask habit,
  ) {
    final idx = log.tasks.indexWhere((t) => t.id == habit.id);
    if (idx != -1) {
      log.tasks[idx].isDone = !log.tasks[idx].isDone;
      if (log.tasks[idx].isDone)
        log.tasks[idx].streak += 1;
      else
        log.tasks[idx].streak = (log.tasks[idx].streak > 0)
            ? log.tasks[idx].streak - 1
            : 0;
      FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('book_logs')
          .doc(dateKey)
          .update(log.toMap());
    }
  }

  void _showEditDialog(
    BuildContext context,
    String uid,
    String dateKey,
    BookDailyLog log,
    MindTask habit,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final ctrl = TextEditingController(text: habit.title);

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => Padding(
        padding: EdgeInsets.only(
          left: 24,
          right: 24,
          top: 24,
          bottom: MediaQuery.of(ctx).viewInsets.bottom + 24,
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Edit Habit",
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : Colors.black,
              ),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: ctrl,
              style: TextStyle(color: isDark ? Colors.white : Colors.black),
              decoration: InputDecoration(
                labelText: "Habit Title",
                filled: true,
                fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
              ),
            ),
            const SizedBox(height: 30),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                TextButton.icon(
                  onPressed: () {
                    Navigator.pop(ctx);
                    _deleteHabit(context, uid, dateKey, log, habit);
                  },
                  icon: const Icon(Icons.delete, color: Colors.red),
                  label: const Text(
                    "Delete Habit",
                    style: TextStyle(color: Colors.red),
                  ),
                ),
                ElevatedButton(
                  onPressed: () {
                    if (ctrl.text.isNotEmpty) {
                      _updateHabitTitle(uid, dateKey, log, habit, ctrl.text);
                      Navigator.pop(ctx);
                    }
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    padding: const EdgeInsets.symmetric(
                      horizontal: 24,
                      vertical: 12,
                    ),
                  ),
                  child: const Text("Save Changes"),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  void _updateHabitTitle(
    String uid,
    String dateKey,
    BookDailyLog log,
    MindTask habit,
    String newTitle,
  ) {
    final idx = log.tasks.indexWhere((t) => t.id == habit.id);
    if (idx != -1) {
      log.tasks[idx].title = newTitle;
      FirebaseFirestore.instance
          .collection('users')
          .doc(uid)
          .collection('book_logs')
          .doc(dateKey)
          .update(log.toMap());
    }
  }

  void _deleteHabit(
    BuildContext context,
    String uid,
    String dateKey,
    BookDailyLog log,
    MindTask habit,
  ) async {
    log.tasks.removeWhere((t) => t.id == habit.id);
    await FirebaseFirestore.instance
        .collection('users')
        .doc(uid)
        .collection('book_logs')
        .doc(dateKey)
        .update(log.toMap());

    // Future propagation logic (simplified for brevity here, assumed correct from previous)
    final futureLogs = await FirebaseFirestore.instance
        .collection('users')
        .doc(uid)
        .collection('book_logs')
        .where('date', isGreaterThan: Timestamp.now())
        .get();

    final batch = FirebaseFirestore.instance.batch();
    for (var doc in futureLogs.docs) {
      final l = BookDailyLog.fromMap(doc.data(), DateTime.now());
      l.tasks.removeWhere((t) => t.id == habit.id);
      batch.update(doc.reference, {
        'tasks': l.tasks.map((t) => t.toMap()).toList(),
      });
    }
    await batch.commit();
  }
}

all_notes_view.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:intl/intl.dart';
import '../../models/book_models.dart';
import 'note_editor_sheet.dart';

class AllNotesView extends StatelessWidget {
  const AllNotesView({super.key});

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final user = FirebaseAuth.instance.currentUser;
    final bg = isDark ? const Color(0xFF121212) : const Color(0xFFF5F5F5);
    final cardBg = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    return Scaffold(
      backgroundColor: bg,
      appBar: AppBar(
        title: const Text(
          "All Notes",
          style: TextStyle(fontWeight: FontWeight.w600),
        ),
        backgroundColor: bg,
        surfaceTintColor: Colors.transparent,
        centerTitle: true,
        leading: Center(
          child: IconButton(
            icon: Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: Colors.blue,
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(
                Icons.arrow_back,
                color: Colors.white,
                size: 18,
              ),
            ),
            onPressed: () => Navigator.pop(context),
          ),
        ),
      ),
      body: StreamBuilder<QuerySnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(user?.uid)
            .collection('mind_notes')
            .orderBy('createdAt', descending: true)
            .snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) {
            return const Center(child: CircularProgressIndicator());
          }

          final notes = snapshot.data!.docs
              .map(
                (d) => MindNote.fromMap(d.data() as Map<String, dynamic>, d.id),
              )
              .toList();

          if (notes.isEmpty) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.note_alt_outlined,
                    size: 64,
                    color: Colors.grey.withValues(alpha: 0.3),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    "No notes found",
                    style: TextStyle(
                      color: isDark ? Colors.white54 : Colors.black54,
                    ),
                  ),
                ],
              ),
            );
          }

          return ListView.separated(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 24),
            itemCount: notes.length,
            separatorBuilder: (_, __) => const SizedBox(height: 16),
            itemBuilder: (context, index) {
              final note = notes[index];

              // ‚úÖ PROFESSIONAL CARD DESIGN
              return Container(
                decoration: BoxDecoration(
                  color: cardBg,
                  borderRadius: BorderRadius.circular(20),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(
                        alpha: isDark ? 0.3 : 0.05,
                      ),
                      blurRadius: 10,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Material(
                  color: Colors.transparent,
                  child: InkWell(
                    borderRadius: BorderRadius.circular(20),
                    onTap: () {
                      showModalBottomSheet(
                        context: context,
                        isScrollControlled: true,
                        backgroundColor: Colors.transparent,
                        builder: (_) => NoteEditorSheet(existingNote: note),
                      );
                    },
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Row(
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  children: [
                                    Expanded(
                                      child: Text(
                                        note.title,
                                        style: TextStyle(
                                          fontSize: 17,
                                          fontWeight: FontWeight.bold,
                                          color: isDark
                                              ? Colors.white
                                              : Colors.black87,
                                        ),
                                        maxLines: 1,
                                        overflow: TextOverflow.ellipsis,
                                      ),
                                    ),
                                    const SizedBox(width: 8),
                                    Text(
                                      DateFormat(
                                        'MMM d',
                                      ).format(note.createdAt),
                                      style: TextStyle(
                                        fontSize: 12,
                                        fontWeight: FontWeight.w500,
                                        color: isDark
                                            ? Colors.grey.shade600
                                            : Colors.grey.shade400,
                                      ),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  note.body,
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                  style: TextStyle(
                                    fontSize: 14,
                                    height: 1.4,
                                    color: isDark
                                        ? Colors.grey.shade400
                                        : Colors.black54,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(width: 12),
                          // ‚úÖ FIXED: Using Grey Outlined Icon to match Habits page
                          Icon(
                            Icons.edit_outlined,
                            color: isDark
                                ? Colors.grey.shade600
                                : Colors.grey.shade400,
                            size: 22,
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              );
            },
          );
        },
      ),
    );
  }
}

book_details_sheet.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../../models/book_models.dart';
import 'book_search_delegate.dart';

class BookDetailsSheet extends StatefulWidget {
  final Book book;
  const BookDetailsSheet({super.key, required this.book});

  @override
  State<BookDetailsSheet> createState() => _BookDetailsSheetState();
}

class _BookDetailsSheetState extends State<BookDetailsSheet>
    with SingleTickerProviderStateMixin {
  bool _isEditing = false;
  late AnimationController _wiggleController;

  @override
  void initState() {
    super.initState();
    _wiggleController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 300),
    );
  }

  @override
  void dispose() {
    _wiggleController.dispose();
    super.dispose();
  }

  void _toggleEditMode() {
    setState(() {
      _isEditing = !_isEditing;
      if (_isEditing)
        _wiggleController.repeat(reverse: true);
      else
        _wiggleController.reset();
    });
  }

  void _startReadingBook(BuildContext context, Book newBook) async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    final batch = FirebaseFirestore.instance.batch();
    final userBooksRef = FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('books');
    final activeSnapshot = await userBooksRef
        .where('status', isEqualTo: 'reading')
        .get();
    for (var doc in activeSnapshot.docs) {
      if (doc.id != newBook.id)
        batch.update(doc.reference, {'status': 'wishlist'});
    }
    batch.update(userBooksRef.doc(newBook.id), {
      'status': 'reading',
      'lastRead': FieldValue.serverTimestamp(),
    });
    await batch.commit();
    if (context.mounted) Navigator.pop(context);
  }

  void _confirmDelete(Book book) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    showDialog(
      context: context,
      builder: (ctx) => Dialog(
        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.red.withValues(alpha: 0.1),
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.delete_outline,
                  color: Colors.red,
                  size: 32,
                ),
              ),
              const SizedBox(height: 16),
              Text(
                "Delete Book?",
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: isDark ? Colors.white : Colors.black,
                ),
              ),
              const SizedBox(height: 12),
              Text(
                "You have read ${book.currentPage} pages.\nThis cannot be undone.",
                textAlign: TextAlign.center,
                style: const TextStyle(color: Colors.grey, fontSize: 14),
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: TextButton(
                      onPressed: () => Navigator.pop(ctx),
                      child: const Text(
                        "Cancel",
                        style: TextStyle(color: Colors.grey),
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () {
                        Navigator.pop(ctx);
                        _deleteBook(book.id);
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.red,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: const Text("Delete"),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _deleteBook(String bookId) {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('books')
        .doc(bookId)
        .delete();
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF121212) : const Color(0xFFF5F5F5);

    return Scaffold(
      backgroundColor: bgColor,
      appBar: AppBar(
        backgroundColor: bgColor,
        surfaceTintColor: Colors.transparent,
        automaticallyImplyLeading: false,
        leading: Padding(
          padding: const EdgeInsets.all(8.0),
          child: GestureDetector(
            onTap: () => Navigator.pop(context),
            child: Container(
              decoration: BoxDecoration(
                color: Colors.blue,
                borderRadius: BorderRadius.circular(12),
              ),
              child: const Icon(
                Icons.arrow_back,
                color: Colors.white,
                size: 20,
              ),
            ),
          ),
        ),
        actions: [
          if (_isEditing)
            TextButton(
              onPressed: _toggleEditMode,
              child: const Text(
                "Done",
                style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
              ),
            )
          else
            IconButton(
              icon: const Icon(Icons.close),
              onPressed: () => Navigator.pop(context),
            ),
        ],
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (widget.book.id != 'dummy') ...[
                Text(
                  "Currently Reading",
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: isDark ? Colors.white : Colors.black,
                  ),
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Row(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: widget.book.coverUrl.isNotEmpty
                            ? Image.network(
                                widget.book.coverUrl,
                                width: 50,
                                height: 75,
                                fit: BoxFit.cover,
                              )
                            : Container(
                                width: 50,
                                height: 75,
                                color: Colors.grey,
                              ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              widget.book.title,
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                fontSize: 16,
                                color: isDark ? Colors.white : Colors.black,
                              ),
                            ),
                            Text(
                              widget.book.author,
                              style: const TextStyle(color: Colors.grey),
                            ),
                            const SizedBox(height: 8),
                            LinearProgressIndicator(
                              value: widget.book.progress,
                              borderRadius: BorderRadius.circular(4),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              "${(widget.book.progress * 100).toInt()}% Complete",
                              style: const TextStyle(
                                fontSize: 12,
                                color: Colors.blue,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 32),
              ],

              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    "Up Next",
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: isDark ? Colors.white : Colors.black,
                    ),
                  ),
                  if (!_isEditing)
                    IconButton(
                      icon: const Icon(
                        Icons.add_circle_outline,
                        color: Colors.blue,
                      ),
                      onPressed: () => showSearch(
                        context: context,
                        delegate: BookSearchDelegate(),
                      ),
                    ),
                ],
              ),
              const SizedBox(height: 16),

              StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collection('users')
                    .doc(FirebaseAuth.instance.currentUser?.uid)
                    .collection('books')
                    .where('status', isEqualTo: 'wishlist')
                    .snapshots(),
                builder: (context, snapshot) {
                  final uniqueTitles = <String>{};
                  final books = (snapshot.data?.docs ?? [])
                      .map(
                        (d) => Book.fromMap(
                          d.data() as Map<String, dynamic>,
                          d.id,
                        ),
                      )
                      .where((b) => uniqueTitles.add(b.title))
                      .toList();

                  if (books.isEmpty)
                    return Container(
                      padding: const EdgeInsets.all(24),
                      width: double.infinity,
                      decoration: BoxDecoration(
                        border: Border.all(
                          color: Colors.grey.withValues(alpha: 0.1),
                        ),
                        borderRadius: BorderRadius.circular(24),
                      ),
                      child: const Center(
                        child: Text(
                          "Your reading list is empty",
                          style: TextStyle(color: Colors.grey),
                        ),
                      ),
                    );

                  return GridView.builder(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    gridDelegate:
                        const SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 3,
                          childAspectRatio: 0.65,
                          crossAxisSpacing: 16,
                          mainAxisSpacing: 16,
                        ),
                    itemCount: books.length,
                    itemBuilder: (ctx, i) {
                      final b = books[i];
                      return GestureDetector(
                        onLongPress: () {
                          if (!_isEditing) _toggleEditMode();
                        },
                        onTap: () {
                          if (_isEditing)
                            _confirmDelete(b);
                          else
                            showModalBottomSheet(
                              context: context,
                              useSafeArea: true,
                              builder: (c) => SafeArea(
                                child: Padding(
                                  padding: const EdgeInsets.only(bottom: 40),
                                  child: Wrap(
                                    children: [
                                      ListTile(
                                        leading: const Icon(
                                          Icons.play_circle_outline,
                                          color: Colors.blue,
                                        ),
                                        title: const Text("Start Reading"),
                                        onTap: () {
                                          Navigator.pop(c);
                                          _startReadingBook(context, b);
                                        },
                                      ),
                                      ListTile(
                                        leading: const Icon(
                                          Icons.delete_outline,
                                          color: Colors.red,
                                        ),
                                        title: const Text("Delete Book"),
                                        onTap: () {
                                          Navigator.pop(c);
                                          _confirmDelete(b);
                                        },
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            );
                        },
                        child: AnimatedBuilder(
                          animation: _wiggleController,
                          builder: (context, child) => Transform.rotate(
                            angle: _isEditing
                                ? 0.02 *
                                      (i.isEven ? 1 : -1) *
                                      (_wiggleController.value - 0.5)
                                : 0.0,
                            child: child,
                          ),
                          child: Stack(
                            clipBehavior: Clip.none,
                            children: [
                              Column(
                                children: [
                                  Expanded(
                                    child: Container(
                                      decoration: BoxDecoration(
                                        borderRadius: BorderRadius.circular(12),
                                        boxShadow: [
                                          BoxShadow(
                                            color: Colors.black.withValues(
                                              alpha: 0.1,
                                            ),
                                            blurRadius: 4,
                                          ),
                                        ],
                                      ),
                                      child: ClipRRect(
                                        borderRadius: BorderRadius.circular(12),
                                        child: b.coverUrl.isNotEmpty
                                            ? Image.network(
                                                b.coverUrl,
                                                fit: BoxFit.cover,
                                              )
                                            : Container(color: Colors.grey),
                                      ),
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Text(
                                    b.title,
                                    maxLines: 1,
                                    overflow: TextOverflow.ellipsis,
                                    style: TextStyle(
                                      fontSize: 11,
                                      fontWeight: FontWeight.bold,
                                      color: isDark
                                          ? Colors.white
                                          : Colors.black,
                                    ),
                                  ),
                                ],
                              ),
                              if (_isEditing)
                                Positioned(
                                  top: -8,
                                  left: -8,
                                  child: Container(
                                    padding: const EdgeInsets.all(4),
                                    decoration: const BoxDecoration(
                                      color: Colors.red,
                                      shape: BoxShape.circle,
                                    ),
                                    child: const Icon(
                                      Icons.remove,
                                      color: Colors.white,
                                      size: 16,
                                    ),
                                  ),
                                ),
                            ],
                          ),
                        ),
                      );
                    },
                  );
                },
              ),
              const SizedBox(height: 40),
            ],
          ),
        ),
      ),
    );
  }
}

book_hero.dart:
import 'package:flutter/material.dart';
import '../../models/book_models.dart';
import 'book_details_sheet.dart';
import 'update_progress_dialog.dart';

class BookHero extends StatelessWidget {
  final Book? book;
  final List<Book> upNextBooks;
  final bool isDark;
  final Function(int) onProgressLogged;

  const BookHero({
    super.key,
    required this.book,
    this.upNextBooks = const [],
    required this.isDark,
    required this.onProgressLogged,
  });

  @override
  Widget build(BuildContext context) {
    if (book == null) {
      return GestureDetector(
        onTap: () => _openDetails(context),
        child: _buildEmptyState(context),
      );
    }

    return GestureDetector(
      onTap: () => _openDetails(context),
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: isDark
                ? [const Color(0xFF1565C0), const Color(0xFF0D47A1)]
                : [const Color(0xFF42A5F5), const Color(0xFF1976D2)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(28),
          boxShadow: [
            BoxShadow(
              color: Colors.blue.withValues(alpha: 0.3),
              blurRadius: 20,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // COVER IMAGE
                Container(
                  width: 70,
                  height: 105,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    boxShadow: const [
                      BoxShadow(
                        color: Colors.black26,
                        blurRadius: 8,
                        offset: Offset(0, 4),
                      ),
                    ],
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: book!.coverUrl.isNotEmpty
                        ? Image.network(book!.coverUrl, fit: BoxFit.cover)
                        : Container(
                            color: Colors.amber,
                            child: const Icon(Icons.book, color: Colors.white),
                          ),
                  ),
                ),
                const SizedBox(width: 16),

                // DETAILS COLUMN
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // TITLE + BUTTON ROW
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  book!.title,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                    height: 1.1,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  "by ${book!.author}",
                                  style: TextStyle(
                                    color: Colors.white.withValues(alpha: 0.8),
                                    fontSize: 13,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ],
                            ),
                          ),
                          // Compact Log Button
                          SizedBox(
                            height: 30,
                            child: ElevatedButton(
                              onPressed: () => showDialog(
                                context: context,
                                builder: (_) => UpdateProgressDialog(
                                  book: book!,
                                  onUpdate: (c, t) =>
                                      onProgressLogged(c - book!.currentPage),
                                ),
                              ),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.white.withValues(
                                  alpha: 0.25,
                                ),
                                foregroundColor: Colors.white,
                                elevation: 0,
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 10,
                                ),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(8),
                                ),
                              ),
                              child: const Text(
                                "Log",
                                style: TextStyle(
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),

                      // PROGRESS BAR & PERCENTAGE
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          ClipRRect(
                            borderRadius: BorderRadius.circular(10),
                            child: LinearProgressIndicator(
                              value: book!.progress,
                              backgroundColor: Colors.black12,
                              color: Colors.white,
                              minHeight: 6,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            "${(book!.progress * 100).toInt()}% Complete",
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 11,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ],
            ),

            // --- UP NEXT SECTION ---
            if (upNextBooks.isNotEmpty) ...[
              const SizedBox(height: 16),
              Divider(color: Colors.white.withValues(alpha: 0.15), height: 1),
              const SizedBox(height: 12),

              Row(
                children: [
                  Text(
                    "Up Next",
                    style: TextStyle(
                      color: Colors.white.withValues(alpha: 0.9),
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  ),
                  const Spacer(),
                  Icon(
                    Icons.arrow_forward,
                    size: 14,
                    color: Colors.white.withValues(alpha: 0.6),
                  ),
                ],
              ),
              const SizedBox(height: 8),

              SizedBox(
                height: 45,
                child: ListView.builder(
                  scrollDirection: Axis.horizontal,
                  physics: const BouncingScrollPhysics(),
                  itemCount: upNextBooks.length,
                  itemBuilder: (context, index) {
                    final b = upNextBooks[index];
                    return Padding(
                      padding: const EdgeInsets.only(right: 10),
                      child: ClipRRect(
                        borderRadius: BorderRadius.circular(4),
                        child: b.coverUrl.isNotEmpty
                            ? Image.network(
                                b.coverUrl,
                                width: 30,
                                height: 45,
                                fit: BoxFit.cover,
                              )
                            : Container(
                                width: 30,
                                height: 45,
                                color: Colors.white24,
                              ),
                      ),
                    );
                  },
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }

  void _openDetails(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      useSafeArea: true,
      builder: (_) => BookDetailsSheet(
        book:
            book ??
            Book(
              id: 'dummy',
              title: '',
              author: '',
              coverUrl: '',
              totalPages: 0,
              currentPage: 0,
              status: '',
            ),
      ),
    );
  }

  Widget _buildEmptyState(BuildContext context) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(color: Colors.grey.withValues(alpha: 0.1)),
      ),
      child: Column(
        children: [
          Icon(
            Icons.auto_stories_outlined,
            size: 40,
            color: Colors.grey.shade400,
          ),
          const SizedBox(height: 12),
          Text(
            "Tap to view Library & Stats",
            style: TextStyle(color: Colors.grey.shade600),
          ),
        ],
      ),
    );
  }
}

book_search_delegate.dart:
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../../models/book_models.dart';

class BookSearchDelegate extends SearchDelegate {
  // DIRECT API CALL
  Future<List<Book>> _searchGoogleBooks(String query) async {
    if (query.trim().isEmpty) return [];

    final url = Uri.parse(
      'https://www.googleapis.com/books/v1/volumes?q=$query&maxResults=10&printType=books',
    );
    final response = await http.get(url);

    if (response.statusCode == 200) {
      final data = json.decode(response.body);
      if (data['items'] == null) return [];

      return (data['items'] as List).map((item) {
        final volume = item['volumeInfo'];
        String cover = '';
        if (volume['imageLinks'] != null) {
          cover = volume['imageLinks']['thumbnail'] ?? '';
          if (cover.startsWith('http://'))
            cover = cover.replaceFirst('http://', 'https://');
        }

        return Book(
          id: '',
          title: volume['title'] ?? 'Unknown',
          author: (volume['authors'] as List?)?.first ?? 'Unknown',
          coverUrl: cover,
          totalPages: volume['pageCount'] ?? 0,
          currentPage: 0,
          status: 'wishlist', // <--- FIXED: Adds to Up Next by default
        );
      }).toList();
    }
    return [];
  }

  // DIRECT FIREBASE WRITE
  Future<void> _addBookToFirestore(BuildContext context, Book book) async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    final data = book.toMap();
    data['status'] = 'wishlist'; // Ensure it goes to Up Next
    data['lastRead'] = FieldValue.serverTimestamp();

    await FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('books')
        .add(data);

    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Added "${book.title}" to Up Next')),
      );
    }
  }

  @override
  ThemeData appBarTheme(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return Theme.of(context).copyWith(
      appBarTheme: AppBarTheme(
        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        elevation: 0,
      ),
      inputDecorationTheme: const InputDecorationTheme(
        border: InputBorder.none,
      ),
    );
  }

  @override
  List<Widget>? buildActions(BuildContext context) => [
    IconButton(icon: const Icon(Icons.clear), onPressed: () => query = ''),
  ];

  @override
  Widget? buildLeading(BuildContext context) => IconButton(
    icon: const Icon(Icons.arrow_back),
    onPressed: () => close(context, null),
  );

  @override
  Widget buildResults(BuildContext context) => _buildSearchResults(context);

  @override
  Widget buildSuggestions(BuildContext context) => _buildSearchResults(context);

  Widget _buildSearchResults(BuildContext context) {
    if (query.trim().isEmpty) return const SizedBox();

    return FutureBuilder<List<Book>>(
      future: _searchGoogleBooks(query),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Center(child: CircularProgressIndicator());
        }

        final books = snapshot.data ?? [];
        if (books.isEmpty) {
          return const Center(child: Text("No books found"));
        }

        return ListView.separated(
          padding: const EdgeInsets.all(16),
          itemCount: books.length,
          separatorBuilder: (_, __) => const SizedBox(height: 16),
          itemBuilder: (context, index) {
            final book = books[index];
            return ListTile(
              contentPadding: EdgeInsets.zero,
              leading: ClipRRect(
                borderRadius: BorderRadius.circular(4),
                child: book.coverUrl.isNotEmpty
                    ? Image.network(book.coverUrl, width: 40, fit: BoxFit.cover)
                    : Container(width: 40, height: 60, color: Colors.grey),
              ),
              title: Text(
                book.title,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
              ),
              subtitle: Text(
                book.author,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
              ),
              trailing: IconButton(
                icon: const Icon(Icons.add_circle, color: Colors.blue),
                onPressed: () {
                  _addBookToFirestore(context, book);
                  close(context, null);
                },
              ),
            );
          },
        );
      },
    );
  }
}

book_summary_view.dart:
import 'package:flutter/material.dart';
import '../../models/book_models.dart';

class BookSummaryView extends StatelessWidget {
  final BookDailyLog log;
  final VoidCallback onInspect;
  final VoidCallback onBackToToday;

  const BookSummaryView({
    super.key,
    required this.log,
    required this.onInspect,
    required this.onBackToToday,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    // LOGIC FIX: Prevent negative pages if data is corrupted
    final int displayPages = log.pagesRead < 0 ? 0 : log.pagesRead;

    final habitsDone = log.tasks.where((t) => t.isHabit && t.isDone).length;
    final habitsTotal = log.tasks.where((t) => t.isHabit).length;
    final taskCount = log.tasks.where((t) => !t.isHabit).length;
    final tasksDone = log.tasks.where((t) => !t.isHabit && t.isDone).length;

    return Center(
      child: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // 1. HEADER ICON
              Container(
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: Colors.blue.withOpacity(0.1),
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Icons.history_edu,
                  size: 40,
                  color: Colors.blue.shade400,
                ),
              ),
              const SizedBox(height: 16),

              // 2. TITLE & PAGES
              Text(
                "Daily Recap",
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: isDark ? Colors.white : Colors.black,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                "$displayPages Pages Read",
                style: const TextStyle(
                  fontSize: 16,
                  color: Colors.grey,
                  fontWeight: FontWeight.w500,
                ),
              ),

              const SizedBox(height: 32),

              // 3. STATS GRID (Replaces empty text)
              Row(
                children: [
                  Expanded(
                    child: _buildStatCard(
                      "Tasks",
                      "$tasksDone/$taskCount",
                      Icons.check_box_outlined,
                      isDark,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: _buildStatCard(
                      "Habits",
                      "$habitsDone/$habitsTotal",
                      Icons.loop,
                      isDark,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: _buildStatCard(
                      "End Page",
                      "${log.endPage}",
                      Icons.bookmark_outline,
                      isDark,
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 24),

              // 4. HABIT SNAPSHOT (Visual List)
              if (habitsTotal > 0) ...[
                Align(
                  alignment: Alignment.centerLeft,
                  child: Text(
                    "Habit Log",
                    style: TextStyle(
                      color: Colors.grey.shade600,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
                    borderRadius: BorderRadius.circular(20),
                    border: Border.all(color: Colors.grey.withOpacity(0.1)),
                  ),
                  child: Column(
                    children: log.tasks
                        .where((t) => t.isHabit)
                        .map(
                          (h) => Padding(
                            padding: const EdgeInsets.only(bottom: 8.0),
                            child: Row(
                              children: [
                                Icon(
                                  h.isDone ? Icons.check_circle : Icons.cancel,
                                  color: h.isDone ? Colors.green : Colors.grey,
                                  size: 18,
                                ),
                                const SizedBox(width: 12),
                                Text(
                                  h.title,
                                  style: TextStyle(
                                    color: isDark
                                        ? Colors.white70
                                        : Colors.black87,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        )
                        .toList(),
                  ),
                ),
              ],

              const SizedBox(height: 48),

              // 5. ACTIONS
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: onBackToToday,
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(24),
                        ),
                        side: BorderSide(color: Colors.grey.withOpacity(0.5)),
                      ),
                      child: Text(
                        "Back to Today",
                        style: TextStyle(
                          color: isDark ? Colors.white : Colors.black,
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: onInspect,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(24),
                        ),
                      ),
                      child: const Text("Inspect Details"),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildStatCard(
    String label,
    String value,
    IconData icon,
    bool isDark,
  ) {
    return Container(
      padding: const EdgeInsets.symmetric(vertical: 16),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.grey.shade50,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        children: [
          Icon(icon, size: 20, color: Colors.blue),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: isDark ? Colors.white : Colors.black,
            ),
          ),
          const SizedBox(height: 4),
          Text(label, style: const TextStyle(fontSize: 10, color: Colors.grey)),
        ],
      ),
    );
  }
}

calendar_strip.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

class CalendarStrip extends StatelessWidget {
  final DateTime selectedDate;
  final Function(DateTime) onDateSelected;
  final VoidCallback onBackToToday;
  final VoidCallback onPickerTap;
  final bool isDark;
  final PageController pageController;
  final Color themeColor;

  const CalendarStrip({
    super.key,
    required this.selectedDate,
    required this.onDateSelected,
    required this.onBackToToday,
    required this.onPickerTap,
    required this.isDark,
    required this.pageController,
    this.themeColor = Colors.blue,
  });

  DateTime _getMondayForPage(int index) {
    final now = DateTime.now();
    final currentMonday = now.subtract(Duration(days: now.weekday - 1));
    final weeksDiff = index - 1000;
    return currentMonday.add(Duration(days: weeksDiff * 7));
  }

  @override
  Widget build(BuildContext context) {
    final textColor = isDark ? Colors.white : Colors.black87;

    return Container(
      padding: const EdgeInsets.fromLTRB(20, 15, 20, 10),
      color: isDark ? const Color(0xFF121212) : const Color(0xFFF5F5F5),
      child: Column(
        children: [
          SizedBox(
            height: 50,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                GestureDetector(
                  onTap: onBackToToday,
                  child: Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      color: themeColor.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(
                      Icons.undo_rounded,
                      color: themeColor,
                      size: 24,
                    ),
                  ),
                ),
                Text(
                  DateFormat('MMMM d').format(selectedDate),
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                    color: textColor,
                  ),
                ),
                // ‚úÖ CHANGED: Grid Icon -> Calendar Icon
                GestureDetector(
                  onTap: onPickerTap,
                  child: Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      color: themeColor.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(
                      Icons.calendar_month_rounded,
                      color: themeColor,
                      size: 24,
                    ),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 15),
          SizedBox(
            height: 70,
            child: PageView.builder(
              controller: pageController,
              itemBuilder: (context, index) {
                final monday = _getMondayForPage(index);
                final weekDays = List.generate(
                  7,
                  (i) => monday.add(Duration(days: i)),
                );
                return Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: weekDays
                      .map((date) => _buildDayItem(date))
                      .toList(),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDayItem(DateTime date) {
    final isSelected = DateUtils.isSameDay(date, selectedDate);
    final isToday = DateUtils.isSameDay(date, DateTime.now());

    return Expanded(
      child: GestureDetector(
        onTap: () => onDateSelected(date),
        child: Container(
          margin: const EdgeInsets.symmetric(horizontal: 3),
          decoration: BoxDecoration(
            color: isSelected
                ? themeColor
                : (isDark ? Colors.white10 : Colors.grey.shade100),
            borderRadius: BorderRadius.circular(16),
            border: isToday && !isSelected
                ? Border.all(
                    color: themeColor.withValues(alpha: 0.5),
                    width: 1.5,
                  )
                : null,
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                DateFormat('E').format(date).substring(0, 3),
                style: TextStyle(
                  fontSize: 11,
                  color: isSelected
                      ? Colors.white
                      : (isDark ? Colors.white54 : Colors.grey),
                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                ),
              ),
              const SizedBox(height: 6),
              Text(
                date.day.toString(),
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: isSelected
                      ? Colors.white
                      : (isDark ? Colors.white : Colors.black87),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

habits_section.dart:
import 'package:flutter/material.dart';
import '../../models/book_models.dart';

class HabitsSection extends StatelessWidget {
  final List<MindTask> habits;
  final bool isDark;
  final Function(MindTask) onToggle;
  final Function(MindTask) onLongPress;
  final Function(String, bool) onAddGhost;
  final VoidCallback onViewAll;

  const HabitsSection({
    super.key,
    required this.habits,
    required this.isDark,
    required this.onToggle,
    required this.onLongPress,
    required this.onAddGhost,
    required this.onViewAll,
  });

  @override
  Widget build(BuildContext context) {
    final List<Widget> items = [];

    // 1. Add Real Habits
    for (var habit in habits) {
      items.add(_buildHabitPill(habit, context));
    }

    // 2. Add Ghosts if space permits (< 3 items)
    // ‚úÖ ROBUST CHECK: Normalizes text to lower case for comparison
    if (items.length < 3) {
      if (!habits.any((h) => h.title.toLowerCase().contains("read")))
        items.add(_buildGhostPill("Read 10 pages", Icons.book, context));

      if (items.length < 3 &&
          !habits.any((h) => h.title.toLowerCase().contains("relative")))
        items.add(_buildGhostPill("Call a relative", Icons.call, context));

      if (items.length < 3 &&
          !habits.any((h) => h.title.toLowerCase().contains("exercise")))
        items.add(_buildGhostPill("Exercise", Icons.fitness_center, context));
    }

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: isDark
            ? []
            : [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.05),
                  blurRadius: 10,
                  offset: const Offset(0, 4),
                ),
              ],
      ),
      child: Column(
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Icon(Icons.repeat, size: 16, color: Colors.blue.shade400),
                  const SizedBox(width: 8),
                  const Text(
                    "HABITS",
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                      color: Colors.grey,
                      letterSpacing: 1.0,
                    ),
                  ),
                ],
              ),
              GestureDetector(
                onTap: onViewAll,
                child: const Text(
                  "View All",
                  style: TextStyle(
                    color: Colors.blue,
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          SizedBox(
            height: 90,
            child: ListView.separated(
              scrollDirection: Axis.horizontal,
              itemCount: items.length,
              separatorBuilder: (ctx, i) => const SizedBox(width: 12),
              itemBuilder: (ctx, i) => items[i],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHabitPill(MindTask habit, BuildContext context) {
    final isDone = habit.isDone;
    final activeColor = Colors.blue;
    final baseBg = isDark ? const Color(0xFF252525) : Colors.grey.shade50;
    final doneBg = Colors.blue.withValues(alpha: 0.15);

    return GestureDetector(
      onTap: () => onToggle(habit),
      onLongPress: () => onLongPress(habit),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        width: 140,
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: isDone ? doneBg : baseBg,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: isDone
                ? activeColor
                : (isDark ? Colors.white12 : Colors.grey.shade300),
            width: isDone ? 1.5 : 1.0,
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Container(
                  width: 20,
                  height: 20,
                  decoration: BoxDecoration(
                    color: isDone ? activeColor : Colors.transparent,
                    shape: BoxShape.circle,
                    border: Border.all(
                      color: isDone ? activeColor : Colors.grey,
                      width: 2,
                    ),
                  ),
                  child: isDone
                      ? const Icon(Icons.check, size: 14, color: Colors.white)
                      : null,
                ),
                // ‚úÖ STREAK: Number + Fire
                if (isDone)
                  Row(
                    children: [
                      Text(
                        "${habit.streak} ",
                        style: const TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                          color: Colors.orange,
                        ),
                      ),
                      const Icon(
                        Icons.local_fire_department,
                        size: 16,
                        color: Colors.orange,
                      ),
                    ],
                  ),
              ],
            ),
            Text(
              habit.title,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
              style: TextStyle(
                fontWeight: isDone ? FontWeight.bold : FontWeight.w500,
                fontSize: 13,
                color: isDone
                    ? Colors.blue.shade200
                    : (isDark ? Colors.white : Colors.black87),
                decoration: isDone ? TextDecoration.lineThrough : null,
                decorationColor: Colors.blue,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildGhostPill(String text, IconData icon, BuildContext context) {
    return GestureDetector(
      onTap: () => onAddGhost(text, true),
      child: Container(
        width: 140,
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: Colors.transparent,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: Colors.grey.withValues(alpha: 0.3),
            width: 1,
            style: BorderStyle.solid,
          ),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, color: Colors.grey, size: 24),
            const SizedBox(height: 8),
            Text(
              text,
              textAlign: TextAlign.center,
              style: const TextStyle(
                fontSize: 12,
                color: Colors.grey,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

note_editor_sheet.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../../models/book_models.dart';

class NoteEditorSheet extends StatelessWidget {
  final MindNote? existingNote;

  const NoteEditorSheet({super.key, this.existingNote});

  @override
  Widget build(BuildContext context) {
    final tCtrl = TextEditingController(text: existingNote?.title);
    final bCtrl = TextEditingController(text: existingNote?.body);
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      padding: EdgeInsets.only(
        left: 24,
        right: 24,
        top: 24,
        // Safe area for keyboard
        bottom: MediaQuery.of(context).viewInsets.bottom + 40,
      ),
      child: SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: tCtrl,
              textCapitalization: TextCapitalization.sentences,
              style: TextStyle(
                color: isDark ? Colors.white : Colors.black,
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
              decoration: const InputDecoration(
                hintText: "Title",
                border: InputBorder.none,
              ),
            ),
            const Divider(),
            TextField(
              controller: bCtrl,
              textCapitalization: TextCapitalization.sentences,
              maxLines: 5,
              style: TextStyle(color: isDark ? Colors.white : Colors.black),
              decoration: const InputDecoration(
                hintText: "Start typing...",
                border: InputBorder.none,
              ),
            ),
            const SizedBox(height: 20),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                if (existingNote != null)
                  IconButton(
                    onPressed: () {
                      _deleteNote(existingNote!.id);
                      Navigator.pop(context);
                    },
                    icon: const Icon(Icons.delete_outline, color: Colors.red),
                  ),
                const SizedBox(width: 8),
                ElevatedButton(
                  onPressed: () {
                    if (tCtrl.text.isNotEmpty) {
                      if (existingNote != null) {
                        _updateNote(existingNote!, tCtrl.text, bCtrl.text);
                      } else {
                        _addNote(tCtrl.text, bCtrl.text);
                      }
                      Navigator.pop(context);
                    }
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.blue,
                    foregroundColor: Colors.white,
                  ),
                  child: const Text("Save"),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  void _addNote(String title, String body) {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    final newNote = MindNote(
      id: '',
      title: title,
      body: body,
      tag: "General",
      createdAt: DateTime.now(),
    );
    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('mind_notes')
        .add(newNote.toMap());
  }

  void _updateNote(MindNote note, String t, String b) {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('mind_notes')
        .doc(note.id)
        .update({'title': t, 'body': b});
  }

  void _deleteNote(String id) {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('mind_notes')
        .doc(id)
        .delete();
  }
}

notes_section.dart:
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../../models/book_models.dart';
import 'all_notes_view.dart'; // ‚úÖ Correct import

class NotesSection extends StatelessWidget {
  final bool isDark;
  final Function(MindNote?) onEditNote;

  const NotesSection({
    super.key,
    required this.isDark,
    required this.onEditNote,
  });

  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return const SizedBox();

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: isDark
            ? []
            : [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.05),
                  blurRadius: 10,
                  offset: const Offset(0, 4),
                ),
              ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  const Icon(
                    Icons.lightbulb_outline,
                    size: 16,
                    color: Colors.grey,
                  ),
                  const SizedBox(width: 8),
                  const Text(
                    "IDEAS & NOTES",
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                      color: Colors.grey,
                      letterSpacing: 1.0,
                    ),
                  ),
                ],
              ),
              GestureDetector(
                onTap: () => Navigator.push(
                  context,
                  MaterialPageRoute(builder: (_) => const AllNotesView()),
                ),
                child: const Text(
                  "View All",
                  style: TextStyle(
                    color: Colors.blue,
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          StreamBuilder<QuerySnapshot>(
            stream: FirebaseFirestore.instance
                .collection('users')
                .doc(user.uid)
                .collection('mind_notes')
                .orderBy('createdAt', descending: true)
                .limit(2)
                .snapshots(),
            builder: (context, snapshot) {
              final notes = (snapshot.data?.docs ?? [])
                  .map(
                    (d) => MindNote.fromMap(
                      d.data() as Map<String, dynamic>,
                      d.id,
                    ),
                  )
                  .toList();

              return GridView.count(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                crossAxisCount: 2,
                crossAxisSpacing: 12,
                mainAxisSpacing: 12,
                childAspectRatio: 1.1,
                children: [
                  if (notes.isNotEmpty)
                    _buildNoteCard(notes[0], isDark)
                  else
                    _buildGhostCard(
                      "Great Idea...",
                      Icons.lightbulb_outline,
                      isDark,
                      () => onEditNote(null),
                    ),
                  if (notes.length > 1)
                    _buildNoteCard(notes[1], isDark)
                  else
                    _buildGhostCard(
                      "To Remember...",
                      Icons.bookmark_border,
                      isDark,
                      () => onEditNote(null),
                    ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildNoteCard(MindNote note, bool isDark) {
    return GestureDetector(
      onLongPress: () => onEditNote(note),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: isDark ? const Color(0xFF1A2238) : Colors.blue.shade50,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isDark
                ? Colors.blue.withValues(alpha: 0.1)
                : Colors.blue.shade100,
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              note.tag,
              style: TextStyle(
                fontSize: 10,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.blue.shade200 : Colors.blue.shade800,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              note.title,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
              style: TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: 14,
                color: isDark ? Colors.white : Colors.black87,
              ),
            ),
            const SizedBox(height: 4),
            Expanded(
              child: Text(
                note.body,
                style: TextStyle(
                  fontSize: 11,
                  color: isDark
                      ? Colors.blueGrey.shade200
                      : Colors.blueGrey.shade700,
                  height: 1.3,
                ),
                overflow: TextOverflow.fade,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildGhostCard(
    String text,
    IconData icon,
    bool isDark,
    VoidCallback onTap,
  ) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          color: isDark
              ? Colors.white.withValues(alpha: 0.05)
              : Colors.grey.shade100,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isDark ? Colors.white12 : Colors.grey.shade300,
          ),
        ),
        child: Center(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(icon, color: Colors.grey.withValues(alpha: 0.5), size: 28),
              const SizedBox(height: 8),
              Text(
                text,
                style: TextStyle(
                  color: Colors.grey.withValues(alpha: 0.7),
                  fontSize: 11,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

update_progress_dialog.dart:
import 'package:flutter/material.dart';
import '../../models/book_models.dart'; // Ensure this points to your model

class UpdateProgressDialog extends StatefulWidget {
  final Book book;
  final Function(int, int) onUpdate; // Returns (currentPage, totalPages)

  const UpdateProgressDialog({
    super.key,
    required this.book,
    required this.onUpdate,
  });

  @override
  State<UpdateProgressDialog> createState() => _UpdateProgressDialogState();
}

class _UpdateProgressDialogState extends State<UpdateProgressDialog> {
  late double _currentSliderValue;
  late TextEditingController _currentController;
  late TextEditingController _totalController;
  bool _isEditingTotal = false;

  @override
  void initState() {
    super.initState();
    _currentSliderValue = widget.book.currentPage.toDouble();
    _currentController = TextEditingController(
      text: widget.book.currentPage.toString(),
    );
    _totalController = TextEditingController(
      text: widget.book.totalPages.toString(),
    );
  }

  @override
  void dispose() {
    _currentController.dispose();
    _totalController.dispose();
    super.dispose();
  }

  void _handleSliderChange(double value) {
    setState(() {
      _currentSliderValue = value;
      _currentController.text = value.toInt().toString();
    });
  }

  void _save() {
    final int newCurrent =
        int.tryParse(_currentController.text) ?? widget.book.currentPage;
    final int newTotal =
        int.tryParse(_totalController.text) ?? widget.book.totalPages;

    // Safety check
    if (newCurrent > newTotal) {
      // Logic to either block or increase total automatically
      // For now, let's just pass it through, the logic handler can decide
    }

    widget.onUpdate(newCurrent, newTotal);
    Navigator.pop(context);
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black;

    return Dialog(
      backgroundColor: cardColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      child: Padding(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              "Log Progress",
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: textColor,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              widget.book.title,
              style: const TextStyle(color: Colors.grey, fontSize: 14),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 32),

            // EDITABLE NUMBERS ROW
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              crossAxisAlignment: CrossAxisAlignment.baseline,
              textBaseline: TextBaseline.alphabetic,
              children: [
                // Current Page Input
                IntrinsicWidth(
                  child: TextField(
                    controller: _currentController,
                    keyboardType: TextInputType.number,
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 36,
                      fontWeight: FontWeight.w900,
                      color: Colors.blue.shade400,
                    ),
                    decoration: const InputDecoration(
                      border: InputBorder.none,
                      isDense: true,
                    ),
                    onChanged: (val) {
                      final v = double.tryParse(val);
                      if (v != null && v <= widget.book.totalPages) {
                        setState(() => _currentSliderValue = v);
                      }
                    },
                  ),
                ),
                Text(
                  " / ",
                  style: TextStyle(fontSize: 24, color: Colors.grey.shade600),
                ),
                // Total Pages Input
                IntrinsicWidth(
                  child: TextField(
                    controller: _totalController,
                    keyboardType: TextInputType.number,
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: Colors.grey.shade600,
                    ),
                    decoration: const InputDecoration(
                      border: InputBorder.none,
                      isDense: true,
                    ),
                  ),
                ),
              ],
            ),
            const Text(
              "pages read",
              style: TextStyle(fontSize: 12, color: Colors.grey),
            ),

            const SizedBox(height: 24),

            // Slider
            SliderTheme(
              data: SliderThemeData(
                trackHeight: 8,
                thumbShape: const RoundSliderThumbShape(enabledThumbRadius: 12),
                overlayShape: const RoundSliderOverlayShape(overlayRadius: 24),
              ),
              child: Slider(
                value: _currentSliderValue,
                min: 0,
                max:
                    double.tryParse(_totalController.text) ??
                    widget.book.totalPages.toDouble(),
                activeColor: Colors.blue,
                inactiveColor: Colors.blue.withOpacity(0.2),
                onChanged: _handleSliderChange,
              ),
            ),

            const SizedBox(height: 24),

            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _save,
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blue,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: const Text(
                  "Update Progress",
                  style: TextStyle(fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

add_transaction_dialog.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart'; // <--- IMPORT ADDED
import '../../models/finance_models.dart';

class AddTransactionDialog extends StatefulWidget {
  final List<FinanceBucket> buckets;
  final FinanceTransaction? transactionToEdit;

  const AddTransactionDialog({
    super.key,
    required this.buckets,
    this.transactionToEdit,
  });

  @override
  State<AddTransactionDialog> createState() => _AddTransactionDialogState();
}

class _AddTransactionDialogState extends State<AddTransactionDialog> {
  final _titleController = TextEditingController();
  final _amountController = TextEditingController();

  bool _isExpense = true;
  String? _selectedBucketId;
  Map<String, dynamic>? _selectedIncomeCategory;
  DateTime _selectedDate = DateTime.now();

  // Logic for Subscriptions
  bool _showSubscriptionDropdown = false;
  Map<String, dynamic>? _selectedSubscription;

  // --- QUICK OPTIONS ---
  final List<Map<String, dynamic>> _quickAddExpenseOptions = [
    {'icon': '‚òï', 'title': 'Coffee', 'amount': '4.50', 'category': 'Dining'},
    {'icon': 'üçî', 'title': 'Lunch', 'amount': '12.00', 'category': 'Dining'},
    {'icon': 'ü•¶', 'title': 'Market', 'amount': '', 'category': 'Groceries'},
    {'icon': 'üöå', 'title': 'Bus', 'amount': '2.50', 'category': 'Transport'},
  ];

  final List<Map<String, dynamic>> _subscriptionOptions = [
    {'name': 'Netflix', 'icon': Icons.tv_rounded, 'color': Colors.red},
    {
      'name': 'Spotify',
      'icon': Icons.music_note_rounded,
      'color': Colors.green,
    },
    {
      'name': 'YouTube',
      'icon': Icons.play_circle_filled_rounded,
      'color': Colors.redAccent,
    },
    {
      'name': 'Amazon',
      'icon': Icons.shopping_cart_rounded,
      'color': Colors.blue,
    },
    {
      'name': 'Gym',
      'icon': Icons.fitness_center_rounded,
      'color': Colors.orange,
    },
    {
      'name': 'Other',
      'icon': Icons.subscriptions_rounded,
      'color': Colors.grey,
    },
  ];

  final List<Map<String, dynamic>> _incomeOptions = [
    {
      'name': 'Allowance',
      'icon': Icons.sentiment_satisfied_alt_rounded,
      'color': Colors.orange,
    },
    {'name': 'Wage', 'icon': Icons.work_rounded, 'color': Colors.blue},
    {'name': 'Gift', 'icon': Icons.card_giftcard_rounded, 'color': Colors.pink},
    {'name': 'Savings', 'icon': Icons.savings_rounded, 'color': Colors.purple},
    {'name': 'Other', 'icon': Icons.attach_money_rounded, 'color': Colors.teal},
  ];

  @override
  void initState() {
    super.initState();
    if (widget.transactionToEdit != null) {
      final t = widget.transactionToEdit!;
      _titleController.text = t.title;
      _amountController.text = t.amount.toString();
      _selectedDate = t.date;
      _isExpense = t.isExpense;

      if (_isExpense) {
        _selectedBucketId = t.categoryId;
        try {
          final bucket = widget.buckets.firstWhere((b) => b.id == t.categoryId);
          _checkIfSubscription(bucket);
        } catch (_) {}
      } else {
        try {
          final match = _incomeOptions.firstWhere(
            (opt) => opt['name'] == t.title,
          );
          _selectedIncomeCategory = match;
        } catch (_) {
          _selectedIncomeCategory = _incomeOptions.first;
        }
      }
    } else {
      if (widget.buckets.isNotEmpty) {
        _selectedBucketId = widget.buckets.first.id;
        _checkIfSubscription(widget.buckets.first);
      }
      _selectedIncomeCategory = _incomeOptions.first;
    }
  }

  void _checkIfSubscription(FinanceBucket bucket) {
    setState(() {
      _showSubscriptionDropdown = bucket.name == 'Subscriptions';
      if (_showSubscriptionDropdown && _titleController.text.isEmpty) {
        _titleController.clear();
      }
    });
  }

  void _applyQuickAdd(Map<String, dynamic> option) {
    setState(() {
      _titleController.text = option['title'];
      if (option['amount'].isNotEmpty) {
        _amountController.text = option['amount'];
      }
      _isExpense = true;
      _showSubscriptionDropdown = false;
      try {
        final match = widget.buckets.firstWhere(
          (b) => b.name == option['category'],
        );
        _selectedBucketId = match.id;
      } catch (e) {}
    });
  }

  // --- DELETE LOGIC ---
  void _deleteTransaction() {
    showDialog<bool>(
      context: context,
      builder: (ctx) => Dialog(
        backgroundColor: const Color(0xFF1E1E1E),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(
                Icons.delete_forever_rounded,
                size: 48,
                color: Colors.redAccent,
              ),
              const SizedBox(height: 16),
              const Text(
                "Delete Transaction",
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 8),
              const Text(
                "Are you sure? This cannot be undone.",
                textAlign: TextAlign.center,
                style: TextStyle(color: Colors.white54, fontSize: 14),
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(ctx, false),
                      style: OutlinedButton.styleFrom(
                        side: BorderSide(color: Colors.grey.shade700),
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 12),
                      ),
                      child: const Text("Cancel"),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () => Navigator.pop(ctx, true),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.redAccent,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 12),
                      ),
                      child: const Text("Delete"),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    ).then((confirm) {
      if (confirm == true && widget.transactionToEdit != null) {
        FirebaseFirestore.instance
            .collection('finance_transactions')
            .doc(widget.transactionToEdit!.id)
            .delete();
        if (mounted) Navigator.pop(context);
      }
    });
  }

  // --- SAVE LOGIC ---
  void _submit() {
    if (_amountController.text.isEmpty) return;
    if (_isExpense && _selectedBucketId == null) return;

    // --- GET CURRENT USER ---
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) {
      print("No user logged in!");
      return;
    }

    String finalTitle = _titleController.text;
    if (_isExpense &&
        _showSubscriptionDropdown &&
        _selectedSubscription != null) {
      finalTitle = _selectedSubscription!['name'];
    }
    if (!_isExpense && finalTitle.isEmpty && _selectedIncomeCategory != null) {
      finalTitle = _selectedIncomeCategory!['name'];
    }
    if (finalTitle.isEmpty) finalTitle = "Transaction";

    final amount = double.tryParse(_amountController.text) ?? 0.0;

    final Map<String, dynamic> data = {
      'title': finalTitle,
      'amount': amount,
      'isExpense': _isExpense,
      'categoryId': _isExpense ? _selectedBucketId : 'income',
      'date': Timestamp.fromDate(_selectedDate),
      'userId': user.uid, // <--- CHANGED FROM 'test_user' TO REAL ID
    };

    if (!_isExpense && _selectedIncomeCategory != null) {
      data['iconCode'] =
          (_selectedIncomeCategory!['icon'] as IconData).codePoint;
      data['colorValue'] = (_selectedIncomeCategory!['color'] as Color).value;
    }

    try {
      final collection = FirebaseFirestore.instance.collection(
        'finance_transactions',
      );
      if (widget.transactionToEdit != null) {
        collection.doc(widget.transactionToEdit!.id).update(data);
      } else {
        collection.add(data);
      }
      Navigator.pop(context);
    } catch (e) {
      print("Error saving: $e");
    }
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final primaryColor = Colors.green;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;
    final isEditing = widget.transactionToEdit != null;

    return Dialog(
      backgroundColor: bgColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      insetPadding: const EdgeInsets.all(20),
      child: Container(
        padding: const EdgeInsets.all(20),
        child: SingleChildScrollView(
          physics: const BouncingScrollPhysics(),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                isEditing
                    ? "Edit Transaction"
                    : (_isExpense ? "New Expense" : "New Income"),
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: textColor,
                  fontSize: 18,
                ),
              ),
              const SizedBox(height: 20),
              // 1. Toggle Switch
              Container(
                decoration: BoxDecoration(
                  color: isDark ? Colors.grey.shade800 : Colors.grey.shade200,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: GestureDetector(
                        onTap: () => setState(() => _isExpense = true),
                        child: Container(
                          padding: const EdgeInsets.symmetric(vertical: 10),
                          decoration: BoxDecoration(
                            color: _isExpense
                                ? Colors.redAccent.withOpacity(0.2)
                                : Colors.transparent,
                            borderRadius: BorderRadius.circular(12),
                            border: _isExpense
                                ? Border.all(color: Colors.redAccent)
                                : null,
                          ),
                          child: Center(
                            child: Text(
                              "üí∏ Expense",
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: _isExpense
                                    ? Colors.redAccent
                                    : Colors.grey,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                    Expanded(
                      child: GestureDetector(
                        onTap: () => setState(() => _isExpense = false),
                        child: Container(
                          padding: const EdgeInsets.symmetric(vertical: 10),
                          decoration: BoxDecoration(
                            color: !_isExpense
                                ? Colors.green.withOpacity(0.2)
                                : Colors.transparent,
                            borderRadius: BorderRadius.circular(12),
                            border: !_isExpense
                                ? Border.all(color: Colors.green)
                                : null,
                          ),
                          child: Center(
                            child: Text(
                              "üí∞ Income",
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: !_isExpense ? Colors.green : Colors.grey,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 16),
              // 2. QUICK ADD CHIPS
              if (_isExpense) ...[
                SizedBox(
                  height: 40,
                  child: SingleChildScrollView(
                    scrollDirection: Axis.horizontal,
                    child: Row(
                      children: _quickAddExpenseOptions.map((opt) {
                        return Padding(
                          padding: const EdgeInsets.only(right: 8.0),
                          child: ActionChip(
                            backgroundColor: isDark
                                ? Colors.grey.shade800
                                : Colors.grey.shade100,
                            label: Text("${opt['icon']} ${opt['title']}"),
                            padding: const EdgeInsets.symmetric(horizontal: 4),
                            onPressed: () => _applyQuickAdd(opt),
                          ),
                        );
                      }).toList(),
                    ),
                  ),
                ),
                const SizedBox(height: 16),
              ],
              // 3. Amount
              TextField(
                controller: _amountController,
                keyboardType: const TextInputType.numberWithOptions(
                  decimal: true,
                ),
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: textColor,
                ),
                textAlign: TextAlign.center,
                decoration: InputDecoration(
                  prefixText: '\$ ',
                  hintText: '0.00',
                  filled: true,
                  fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide.none,
                  ),
                ),
              ),
              const SizedBox(height: 16),
              // 4. Category
              if (_isExpense)
                DropdownButtonFormField<String>(
                  initialValue: _selectedBucketId,
                  dropdownColor: bgColor,
                  items: widget.buckets.map<DropdownMenuItem<String>>((b) {
                    return DropdownMenuItem(
                      value: b.id,
                      child: Row(
                        children: [
                          Icon(b.icon, size: 18, color: b.color),
                          const SizedBox(width: 8),
                          Text(b.name, style: TextStyle(color: textColor)),
                        ],
                      ),
                    );
                  }).toList(),
                  onChanged: (val) {
                    setState(() {
                      _selectedBucketId = val;
                      if (val != null) {
                        try {
                          final bucket = widget.buckets.firstWhere(
                            (b) => b.id == val,
                          );
                          _checkIfSubscription(bucket);
                        } catch (_) {}
                      }
                    });
                  },
                  decoration: InputDecoration(
                    labelText: "Category",
                    labelStyle: TextStyle(color: Colors.grey.shade500),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade700),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: const BorderSide(color: Colors.green),
                    ),
                  ),
                )
              else
                DropdownButtonFormField<Map<String, dynamic>>(
                  initialValue: _selectedIncomeCategory,
                  dropdownColor: bgColor,
                  items: _incomeOptions.map((cat) {
                    return DropdownMenuItem(
                      value: cat,
                      child: Row(
                        children: [
                          Icon(cat['icon'], size: 16, color: cat['color']),
                          const SizedBox(width: 10),
                          Text(cat['name'], style: TextStyle(color: textColor)),
                        ],
                      ),
                    );
                  }).toList(),
                  onChanged: (val) =>
                      setState(() => _selectedIncomeCategory = val),
                  decoration: InputDecoration(
                    labelText: "Source",
                    labelStyle: TextStyle(color: Colors.grey.shade500),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade700),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: const BorderSide(color: Colors.green),
                    ),
                  ),
                ),
              const SizedBox(height: 12),
              // 5. Title
              if (_isExpense && _showSubscriptionDropdown)
                DropdownButtonFormField<Map<String, dynamic>>(
                  initialValue: _selectedSubscription,
                  dropdownColor: bgColor,
                  items: _subscriptionOptions
                      .map(
                        (s) => DropdownMenuItem(
                          value: s,
                          child: Row(
                            children: [
                              Icon(s['icon'], color: s['color'], size: 20),
                              const SizedBox(width: 10),
                              Text(
                                s['name'],
                                style: TextStyle(color: textColor),
                              ),
                            ],
                          ),
                        ),
                      )
                      .toList(),
                  onChanged: (val) {
                    setState(() {
                      _selectedSubscription = val;
                      if (val != null) _titleController.text = val['name'];
                    });
                  },
                  decoration: InputDecoration(
                    labelText: "Subscription Name",
                    labelStyle: TextStyle(color: Colors.grey.shade500),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade700),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: const BorderSide(color: Colors.green),
                    ),
                  ),
                )
              else
                TextField(
                  controller: _titleController,
                  style: TextStyle(color: textColor),
                  decoration: InputDecoration(
                    labelText: "Title (Optional)",
                    labelStyle: TextStyle(color: Colors.grey.shade500),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide(color: Colors.grey.shade700),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: const BorderSide(color: Colors.green),
                    ),
                    hintText: _isExpense
                        ? "e.g. Burger King"
                        : "e.g. Monthly Allowance",
                    hintStyle: TextStyle(color: Colors.grey.shade600),
                  ),
                ),
              const SizedBox(height: 12),
              // 6. Date
              InkWell(
                onTap: () async {
                  final picked = await showDatePicker(
                    context: context,
                    initialDate: _selectedDate,
                    firstDate: DateTime(2020),
                    lastDate: DateTime(2030),
                    builder: (context, child) => Theme(
                      data: Theme.of(context).copyWith(
                        colorScheme: ColorScheme.dark(
                          primary: primaryColor,
                          onPrimary: Colors.white,
                          surface: const Color(0xFF1E1E1E),
                          onSurface: Colors.white,
                        ),
                      ),
                      child: child!,
                    ),
                  );
                  if (picked != null) setState(() => _selectedDate = picked);
                },
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    vertical: 14,
                    horizontal: 12,
                  ),
                  decoration: BoxDecoration(
                    border: Border.all(color: Colors.grey.shade700),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    children: [
                      Icon(
                        Icons.calendar_today_rounded,
                        size: 18,
                        color: Colors.grey.shade500,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        DateFormat('MMM dd, yyyy').format(_selectedDate),
                        style: TextStyle(color: textColor),
                      ),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 24),
              // 7. Buttons
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.pop(context),
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        side: BorderSide(color: Colors.grey.shade700),
                        foregroundColor: textColor,
                      ),
                      child: const Text("Cancel"),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: _submit,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: primaryColor,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(50),
                        ),
                      ),
                      child: const Text("Save"),
                    ),
                  ),
                ],
              ),
              if (isEditing) ...[
                const SizedBox(height: 16),
                TextButton.icon(
                  onPressed: _deleteTransaction,
                  icon: const Icon(
                    Icons.delete_outline,
                    size: 18,
                    color: Colors.redAccent,
                  ),
                  label: const Text(
                    "Delete Transaction",
                    style: TextStyle(color: Colors.redAccent),
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }
}

bucket_list.dart:
import 'package:flutter/material.dart';
import 'budget_progress_bar.dart';
import '../../models/finance_models.dart'; // Ensure this points to your new file

class BucketList extends StatelessWidget {
  final List<FinanceBucket> buckets;
  final String? selectedBucketId;
  final Function(String?) onBucketSelected;

  const BucketList({
    super.key,
    required this.buckets,
    required this.selectedBucketId,
    required this.onBucketSelected,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    return ListView.builder(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      scrollDirection: Axis.horizontal,
      itemCount: buckets.length,
      itemBuilder: (context, index) {
        final bucket = buckets[index];
        final isSelected = selectedBucketId == bucket.id;

        return GestureDetector(
          onTap: () => onBucketSelected(isSelected ? null : bucket.id),
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            width: 140,
            margin: const EdgeInsets.only(right: 12, bottom: 4, top: 4),
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: isSelected ? bucket.color.withOpacity(0.1) : cardColor,
              borderRadius: BorderRadius.circular(20),
              border: isSelected
                  ? Border.all(color: bucket.color, width: 2)
                  : Border.all(color: Colors.transparent, width: 2),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Icon(bucket.icon, color: bucket.color, size: 28),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      bucket.name,
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                        color: textColor,
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 2),
                    Text(
                      "\$${bucket.spent.toInt()}",
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w900,
                        color: textColor,
                      ),
                    ),
                  ],
                ),
                BudgetProgressBar(
                  spent: bucket.spent,
                  limit: bucket.limit,
                  color: bucket.color,
                  isFixed: bucket.isFixed,
                  showLabels: false,
                ),
              ],
            ),
          ),
        );
      },
    );
  }
}

budget_progress_bar.dart:
import 'package:flutter/material.dart';

class BudgetProgressBar extends StatelessWidget {
  final double spent;
  final double limit;
  final Color color;
  final bool isFixed; // True for Rent, False for Food
  final bool showLabels;
  final double? customIdeal; // NEW: Override the math for the Total Bar

  const BudgetProgressBar({
    super.key,
    required this.spent,
    required this.limit,
    required this.color,
    this.isFixed = false,
    this.showLabels = true,
    this.customIdeal, // NEW
  });

  @override
  Widget build(BuildContext context) {
    if (limit <= 0) return const SizedBox.shrink();

    final isDark = Theme.of(context).brightness == Brightness.dark;

    // 1. Time Calculations
    final now = DateTime.now();
    final daysInMonth = DateUtils.getDaysInMonth(now.year, now.month);
    final dayProgress = now.day / daysInMonth;

    // 2. Money Calculations
    final spendProgress = (spent / limit).clamp(0.0, 1.0);

    // SMART LOGIC: Use custom ideal if provided (for Total Bar), else calculate
    final idealSpend = customIdeal ?? (limit * dayProgress);
    final idealProgress = (idealSpend / limit).clamp(0.0, 1.0);

    final diffAmount = spent - idealSpend;
    final diffPercent = (diffAmount / limit) * 100;

    // 3. Status Logic
    String statusText;
    Color statusColor;

    if (isFixed) {
      // Fixed Logic (Rent)
      if (spent >= limit) {
        statusText = "‚úÖ Paid";
        statusColor = Colors.green;
      } else {
        statusText = "‚è≥ Pending";
        statusColor = Colors.orange;
      }
    } else {
      // Fluid Logic (Food) OR Mixed (Total)
      if (diffPercent > 5) {
        statusText = "‚ö†Ô∏è +${diffPercent.toInt()}% ahead";
        statusColor = Colors.redAccent;
      } else if (diffPercent < -5) {
        statusText = "‚úÖ ${diffPercent.abs().toInt()}% under";
        statusColor = Colors.green;
      } else {
        statusText = "üëå On Track";
        statusColor = Colors.green;
      }
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // THE BAR STACK
        SizedBox(
          height: 12,
          child: LayoutBuilder(
            builder: (context, constraints) {
              final width = constraints.maxWidth;

              return Stack(
                alignment: Alignment.centerLeft,
                children: [
                  // A. Background
                  Container(
                    width: width,
                    decoration: BoxDecoration(
                      color: isDark
                          ? Colors.grey.shade800
                          : Colors.grey.shade200,
                      borderRadius: BorderRadius.circular(6),
                    ),
                  ),

                  // B. Actual Spending
                  AnimatedContainer(
                    duration: const Duration(milliseconds: 500),
                    width: width * spendProgress,
                    decoration: BoxDecoration(
                      color: color,
                      borderRadius: BorderRadius.circular(6),
                    ),
                  ),

                  // C. "Ideal" Line Marker (Show for Fluid or Mixed)
                  if (!isFixed)
                    Positioned(
                      left: (width * idealProgress).clamp(0, width - 2),
                      child: Container(
                        width: 2,
                        height: 12,
                        color: isDark ? Colors.white : Colors.black,
                      ),
                    ),
                ],
              );
            },
          ),
        ),

        // LABELS
        if (showLabels) ...[
          const SizedBox(height: 6),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                "${(spendProgress * 100).toInt()}% used",
                style: TextStyle(
                  fontSize: 11,
                  color: isDark ? Colors.white70 : Colors.black54,
                ),
              ),
              Text(
                statusText,
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.bold,
                  color: statusColor,
                ),
              ),
            ],
          ),
        ],
      ],
    );
  }
}

edit_monthly_budget_dialog.dart:
import 'package:flutter/material.dart';
import '../../models/finance_models.dart';

class EditMonthlyBudgetDialog extends StatefulWidget {
  final List<FinanceBucket> buckets;
  final Function(String, double, String, VoidCallback) onUpdateLimit;

  const EditMonthlyBudgetDialog({
    super.key,
    required this.buckets,
    required this.onUpdateLimit,
  });

  @override
  State<EditMonthlyBudgetDialog> createState() =>
      _EditMonthlyBudgetDialogState();
}

class _EditMonthlyBudgetDialogState extends State<EditMonthlyBudgetDialog> {
  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;
    final totalLimit = widget.buckets.fold(0.0, (sum, b) => sum + b.limit);

    return Dialog(
      backgroundColor: bgColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      insetPadding: const EdgeInsets.all(20),
      child: Container(
        constraints: BoxConstraints(
          maxHeight: MediaQuery.of(context).size.height * 0.8,
        ),
        padding: const EdgeInsets.all(20.0),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              "Monthly Budgets",
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: textColor,
              ),
            ),
            const SizedBox(height: 16),
            Expanded(
              child: ListView.separated(
                shrinkWrap: true,
                itemCount: widget.buckets.length,
                separatorBuilder: (_, __) => const Divider(height: 1),
                itemBuilder: (context, index) {
                  final bucket = widget.buckets[index];
                  return ListTile(
                    contentPadding: EdgeInsets.zero,
                    leading: Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: bucket.color.withOpacity(0.1),
                        shape: BoxShape.circle,
                      ),
                      child: Icon(bucket.icon, size: 18, color: bucket.color),
                    ),
                    title: Text(
                      bucket.name,
                      style: TextStyle(
                        color: textColor,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    trailing: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          "\$${bucket.limit.toStringAsFixed(0)}",
                          style: TextStyle(color: textColor.withOpacity(0.7)),
                        ),
                        const SizedBox(width: 8),
                        Icon(Icons.edit, size: 16, color: Colors.grey.shade500),
                      ],
                    ),
                    onTap: () {
                      widget.onUpdateLimit(
                        bucket.id,
                        bucket.limit,
                        bucket.name,
                        () => setState(() {}),
                      );
                    },
                  );
                },
              ),
            ),
            const Divider(),
            Padding(
              padding: const EdgeInsets.symmetric(vertical: 12.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Text(
                    "Total Budget",
                    style: TextStyle(color: Colors.grey),
                  ),
                  Text(
                    "\$${totalLimit.toStringAsFixed(0)}",
                    style: const TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: Colors.green,
                    ),
                  ),
                ],
              ),
            ),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.green,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                onPressed: () => Navigator.pop(context),
                child: const Text(
                  "Done",
                  style: TextStyle(color: Colors.white),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

finance_dashboard.dart:
import 'package:flutter/material.dart';
import '../../models/finance_models.dart';
import 'budget_progress_bar.dart';
import 'pie_chart_view.dart';
import 'bucket_list.dart';
import 'transaction_list.dart';

enum FilterType { all, income, expense }

class FinanceDashboard extends StatefulWidget {
  final bool isDark;
  final bool showChart;
  final List<FinanceTransaction> transactions;
  final List<FinanceBucket> buckets;
  final double monthlyIncome;
  final double monthlyExpense;
  final Function(FinanceTransaction) onEditTransaction;
  final Function(String, double, String) onUpdateBucketLimit;
  final VoidCallback onEditAllBudgets;

  const FinanceDashboard({
    super.key,
    required this.isDark,
    required this.showChart,
    required this.transactions,
    required this.buckets,
    required this.monthlyIncome,
    required this.monthlyExpense,
    required this.onEditTransaction,
    required this.onUpdateBucketLimit,
    required this.onEditAllBudgets,
  });

  @override
  State<FinanceDashboard> createState() => _FinanceDashboardState();
}

class _FinanceDashboardState extends State<FinanceDashboard> {
  String? _selectedBucketId;
  FilterType _currentFilter = FilterType.all;

  void _toggleFilter(FilterType type) {
    setState(() {
      if (_currentFilter == type) {
        _currentFilter = FilterType.all;
      } else {
        _currentFilter = type;
        _selectedBucketId = null;
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final subTextColor = widget.isDark ? Colors.white54 : Colors.grey;
    final textColor = widget.isDark ? Colors.white : Colors.black87;
    final primaryColor = Colors.green;

    // Filter Logic
    List<FinanceTransaction> displayedTransactions = widget.transactions;
    if (_currentFilter == FilterType.expense) {
      displayedTransactions = displayedTransactions
          .where((t) => t.isExpense)
          .toList();
    } else if (_currentFilter == FilterType.income) {
      displayedTransactions = displayedTransactions
          .where((t) => !t.isExpense)
          .toList();
    }
    if (_selectedBucketId != null) {
      displayedTransactions = displayedTransactions
          .where((t) => t.categoryId == _selectedBucketId)
          .toList();
    }

    final chartTotal = widget.buckets.fold(
      0.0,
      (sum, item) => sum + item.spent,
    );
    final chartData = widget.buckets
        .map((b) => ChartData(b.id, b.name, b.spent, b.color, b.icon))
        .toList();
    final totalBudgetLimit = widget.buckets.fold(
      0.0,
      (sum, b) => sum + b.limit,
    );
    final totalBudgetSpent = widget.buckets.fold(
      0.0,
      (sum, b) => sum + b.spent,
    );

    final now = DateTime.now();
    final daysInMonth = DateUtils.getDaysInMonth(now.year, now.month);
    final timeProgress = (now.day / daysInMonth).clamp(0.0, 1.0);
    double totalIdealSpent = 0.0;

    for (var b in widget.buckets) {
      if (b.isFixed) {
        totalIdealSpent += b.limit;
      } else {
        totalIdealSpent += b.limit * timeProgress;
      }
    }

    FinanceBucket? selectedBucket;
    if (_selectedBucketId != null) {
      try {
        selectedBucket = widget.buckets.firstWhere(
          (b) => b.id == _selectedBucketId,
        );
      } catch (_) {}
    }

    return Column(
      children: [
        // --- SUMMARY CARDS ---
        Padding(
          padding: const EdgeInsets.fromLTRB(20, 10, 20, 0),
          child: Row(
            children: [
              Expanded(
                child: _buildSummaryCard(
                  "Income",
                  widget.monthlyIncome,
                  Colors.green,
                  widget.isDark,
                  FilterType.income,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildSummaryCard(
                  "Expense",
                  widget.monthlyExpense,
                  Colors.redAccent,
                  widget.isDark,
                  FilterType.expense,
                ),
              ),
            ],
          ),
        ),

        // --- TOTAL BUDGET PROGRESS BAR (Only if chart is hidden) ---
        if (!widget.showChart)
          Padding(
            padding: const EdgeInsets.fromLTRB(20, 16, 20, 0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      "Total Monthly Budget",
                      style: TextStyle(fontSize: 12, color: subTextColor),
                    ),
                    GestureDetector(
                      onTap: widget.onEditAllBudgets,
                      child: Container(
                        padding: const EdgeInsets.all(4),
                        color: Colors.transparent,
                        child: Row(
                          children: [
                            Text(
                              "Edit All ",
                              style: TextStyle(
                                fontSize: 10,
                                color: subTextColor,
                              ),
                            ),
                            Icon(Icons.edit, size: 12, color: subTextColor),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                BudgetProgressBar(
                  spent: totalBudgetSpent,
                  limit: totalBudgetLimit,
                  color: primaryColor,
                  isFixed: false,
                  customIdeal: totalIdealSpent,
                ),
              ],
            ),
          ),

        // --- CHART / LIST SWITCHER (FIXED) ---
        SizedBox(
          height: widget.showChart ? 320 : 210,
          child: AnimatedSwitcher(
            duration: const Duration(milliseconds: 300),
            // FIX: This layoutBuilder prevents the overflow during transition
            layoutBuilder: (currentChild, previousChildren) {
              return Stack(
                alignment: Alignment.topCenter,
                children: <Widget>[
                  ...previousChildren,
                  if (currentChild != null) currentChild,
                ],
              );
            },
            child: widget.showChart
                ? PieChartView(
                    key: const ValueKey('chart'),
                    totalSpent: chartTotal,
                    data: chartData,
                    onSectionTap: (id) => setState(() {
                      _selectedBucketId = _selectedBucketId == id ? null : id;
                      _currentFilter = FilterType.all;
                    }),
                  )
                : BucketList(
                    key: const ValueKey('list'),
                    buckets: widget.buckets,
                    selectedBucketId: _selectedBucketId,
                    onBucketSelected: (id) => setState(() {
                      _selectedBucketId = id;
                      _currentFilter = FilterType.all;
                    }),
                  ),
          ),
        ),
        const SizedBox(height: 10),

        // --- HISTORY HEADER ---
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              SizedBox(
                height: 40,
                child: Stack(
                  alignment: Alignment.center,
                  children: [
                    if (selectedBucket != null)
                      Align(
                        alignment: Alignment.centerLeft,
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              selectedBucket.icon,
                              color: selectedBucket.color,
                              size: 20,
                            ),
                            const SizedBox(width: 8),
                            Flexible(
                              child: Text(
                                selectedBucket.name,
                                overflow: TextOverflow.ellipsis,
                                style: TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 18,
                                  color: textColor,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),

                    if (selectedBucket == null)
                      Text(
                        "History",
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: textColor,
                        ),
                      ),

                    if (selectedBucket != null)
                      Align(
                        alignment: Alignment.centerRight,
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            InkWell(
                              onTap: () => widget.onUpdateBucketLimit(
                                selectedBucket!.id,
                                selectedBucket.limit,
                                selectedBucket.name,
                              ),
                              child: Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 8,
                                  vertical: 6,
                                ),
                                decoration: BoxDecoration(
                                  color: widget.isDark
                                      ? Colors.grey.shade800
                                      : Colors.grey.shade200,
                                  borderRadius: BorderRadius.circular(20),
                                ),
                                child: Row(
                                  children: [
                                    Icon(
                                      Icons.edit,
                                      size: 10,
                                      color: textColor.withOpacity(0.7),
                                    ),
                                    const SizedBox(width: 4),
                                    Text(
                                      "Limit",
                                      style: TextStyle(
                                        fontSize: 10,
                                        color: textColor.withOpacity(0.7),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                            const SizedBox(width: 6),
                            InkWell(
                              onTap: () =>
                                  setState(() => _selectedBucketId = null),
                              child: Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 8,
                                  vertical: 6,
                                ),
                                decoration: BoxDecoration(
                                  color: Colors.redAccent.withOpacity(0.1),
                                  borderRadius: BorderRadius.circular(20),
                                ),
                                child: const Row(
                                  children: [
                                    Icon(
                                      Icons.arrow_back,
                                      size: 10,
                                      color: Colors.redAccent,
                                    ),
                                    SizedBox(width: 4),
                                    Text(
                                      "Back",
                                      style: TextStyle(
                                        fontSize: 10,
                                        fontWeight: FontWeight.bold,
                                        color: Colors.redAccent,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                  ],
                ),
              ),
              if (selectedBucket != null) ...[
                const SizedBox(height: 12),
                BudgetProgressBar(
                  spent: selectedBucket.spent,
                  limit: selectedBucket.limit,
                  color: selectedBucket.color,
                  isFixed: selectedBucket.isFixed,
                  showLabels: true,
                ),
                const SizedBox(height: 10),
              ],
            ],
          ),
        ),

        // --- TRANSACTION LIST ---
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: TransactionList(
            transactions: displayedTransactions,
            buckets: widget.buckets,
            isDark: widget.isDark,
            onEdit: widget.onEditTransaction,
          ),
        ),
      ],
    );
  }

  Widget _buildSummaryCard(
    String label,
    double amount,
    Color color,
    bool isDark,
    FilterType type,
  ) {
    bool isSelected = _currentFilter == type;
    Color bg = isSelected ? color.withOpacity(0.2) : color.withOpacity(0.1);
    Color border = isSelected ? color : Colors.transparent;

    return GestureDetector(
      onTap: () => _toggleFilter(type),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
        decoration: BoxDecoration(
          color: bg,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: border, width: 2),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  label,
                  style: TextStyle(
                    color: color,
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                  ),
                ),
                if (isSelected) Icon(Icons.check, size: 12, color: color),
              ],
            ),
            const SizedBox(height: 4),
            Text(
              "\$${amount.toStringAsFixed(0)}",
              style: TextStyle(
                color: isDark ? Colors.white : Colors.black87,
                fontWeight: FontWeight.bold,
                fontSize: 18,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

finance_header.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

class FinanceHeader extends StatelessWidget {
  final DateTime selectedDate;
  final Function(int) onMonthChanged;
  final VoidCallback onResetDate;
  final bool isInspectingPast;
  final bool showChart;
  final Function(bool) onChartToggle;

  const FinanceHeader({
    super.key,
    required this.selectedDate,
    required this.onMonthChanged,
    required this.onResetDate,
    required this.isInspectingPast,
    required this.showChart,
    required this.onChartToggle,
  });

  bool get _isCurrentMonth {
    final now = DateTime.now();
    return selectedDate.year == now.year && selectedDate.month == now.month;
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final primaryColor = Colors.green;
    final subTextColor = isDark ? Colors.white54 : Colors.grey;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Padding(
      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),
      child: SizedBox(
        height: 50,
        child: Stack(
          alignment: Alignment.center,
          children: [
            // 1. LEFT: Back Button (Always Visible)
            Align(
              alignment: Alignment.centerLeft,
              child: GestureDetector(
                onTap: () {
                  if (_isCurrentMonth) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(
                        content: Text("You are already up to date!"),
                        backgroundColor: Colors.green,
                        duration: Duration(seconds: 1),
                      ),
                    );
                  } else {
                    onResetDate();
                  }
                },
                child: Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: primaryColor.withOpacity(0.2),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Icon(
                    Icons.undo_rounded,
                    color: primaryColor,
                    size: 20,
                  ),
                ),
              ),
            ),

            // 2. CENTER: Month Navigator
            Align(
              alignment: Alignment.center,
              child: Transform.translate(
                offset: const Offset(0, -4), // FIX: Shifts text up by 4 pixels
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    IconButton(
                      icon: const Icon(Icons.chevron_left_rounded, size: 28),
                      onPressed: () => onMonthChanged(-1),
                      color: subTextColor,
                    ),
                    Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          "Budget",
                          style: TextStyle(fontSize: 10, color: subTextColor),
                        ),
                        Text(
                          DateFormat('MMMM yyyy').format(selectedDate),
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: textColor,
                          ),
                        ),
                      ],
                    ),
                    IconButton(
                      icon: const Icon(Icons.chevron_right_rounded, size: 28),
                      onPressed: () => onMonthChanged(1),
                      color: subTextColor,
                    ),
                  ],
                ),
              ),
            ),

            // 3. RIGHT: Toggle Buttons (Only if visible)
            if (_isCurrentMonth || isInspectingPast)
              Align(
                alignment: Alignment.centerRight,
                child: Container(
                  decoration: BoxDecoration(
                    color: isDark ? Colors.grey.shade800 : Colors.grey.shade200,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      _buildToggleBtn(
                        Icons.pie_chart_rounded,
                        true,
                        isDark,
                        primaryColor,
                      ),
                      _buildToggleBtn(
                        Icons.view_list_rounded,
                        false,
                        isDark,
                        primaryColor,
                      ),
                    ],
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildToggleBtn(
    IconData icon,
    bool isChartTarget,
    bool isDark,
    Color activeColor,
  ) {
    final isSelected = showChart == isChartTarget;
    return GestureDetector(
      onTap: () => onChartToggle(isChartTarget),
      child: Container(
        padding: const EdgeInsets.all(8),
        decoration: BoxDecoration(
          color: isSelected ? activeColor : Colors.transparent,
          borderRadius: BorderRadius.circular(10),
        ),
        child: Icon(
          icon,
          size: 20,
          color: isSelected
              ? Colors.white
              : (isDark ? Colors.white54 : Colors.black54),
        ),
      ),
    );
  }
}

past_month_summary.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

class PastMonthSummary extends StatelessWidget {
  final DateTime selectedDate;
  final double income;
  final double expense;
  final bool isDark;
  final VoidCallback onBackToToday;
  final VoidCallback onInspect;

  const PastMonthSummary({
    super.key,
    required this.selectedDate,
    required this.income,
    required this.expense,
    required this.isDark,
    required this.onBackToToday,
    required this.onInspect,
  });

  @override
  Widget build(BuildContext context) {
    final textColor = isDark ? Colors.white : Colors.black87;
    final primaryColor = Colors.green;
    final netSavings = income - expense;
    final isPositive = netSavings >= 0;

    return Padding(
      padding: const EdgeInsets.all(20.0),
      child: Column(
        children: [
          const SizedBox(height: 20),
          // Big Summary Card
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: isDark
                    ? [const Color(0xFF1E1E1E), const Color(0xFF252525)]
                    : [Colors.white, Colors.grey.shade50],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              borderRadius: BorderRadius.circular(32),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.05),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              children: [
                Icon(
                  isPositive ? Icons.savings_rounded : Icons.warning_rounded,
                  size: 48,
                  color: isPositive ? Colors.green : Colors.redAccent,
                ),
                const SizedBox(height: 16),
                Text(
                  isPositive ? "Great Job!" : "Over Budget",
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: textColor,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  isPositive
                      ? "You saved \$${netSavings.toStringAsFixed(0)} in ${DateFormat('MMMM').format(selectedDate)}."
                      : "You spent \$${netSavings.abs().toStringAsFixed(0)} more than you earned.",
                  textAlign: TextAlign.center,
                  style: const TextStyle(fontSize: 14, color: Colors.grey),
                ),
                const SizedBox(height: 32),

                // Stats Row
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceAround,
                  children: [
                    _buildStatItem("Income", income, Colors.green),
                    Container(
                      width: 1,
                      height: 40,
                      color: Colors.grey.withOpacity(0.3),
                    ),
                    _buildStatItem("Expense", expense, Colors.redAccent),
                  ],
                ),
              ],
            ),
          ),

          const SizedBox(height: 32),

          // Action Buttons
          Row(
            children: [
              Expanded(
                child: OutlinedButton(
                  onPressed: onBackToToday,
                  style: OutlinedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    side: BorderSide(color: Colors.grey.withOpacity(0.5)),
                  ),
                  child: Text(
                    "Back to Today",
                    style: TextStyle(color: textColor),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: ElevatedButton(
                  onPressed: onInspect,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: primaryColor,
                    padding: const EdgeInsets.symmetric(vertical: 16),
                  ),
                  child: const Text(
                    "Inspect Details",
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildStatItem(String label, double amount, Color color) {
    return Column(
      children: [
        Text(label, style: const TextStyle(fontSize: 12, color: Colors.grey)),
        const SizedBox(height: 4),
        Text(
          "\$${amount.toStringAsFixed(0)}",
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.bold,
            color: color,
          ),
        ),
      ],
    );
  }
}


pie_chart_view.dart:
import 'dart:math';
import 'package:flutter/material.dart';

class ChartData {
  final String id; // Added ID for filtering
  final String name;
  final double amount;
  final Color color;
  final IconData icon;

  ChartData(this.id, this.name, this.amount, this.color, this.icon);
}

class PieChartView extends StatelessWidget {
  final double totalSpent;
  final List<ChartData> data;
  final Function(String) onSectionTap; // Callback for filtering

  const PieChartView({
    super.key,
    required this.totalSpent,
    required this.data,
    required this.onSectionTap,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;

    return SizedBox(
      width: double.infinity,
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          // 1. The Interactive Donut Chart
          GestureDetector(
            onTapUp: (details) {
              _handleTap(details, context);
            },
            child: SizedBox(
              height: 180,
              width: 180,
              child: Stack(
                alignment: Alignment.center,
                children: [
                  CustomPaint(
                    size: const Size(180, 180),
                    painter: _DonutChartPainter(
                      data: data,
                      total: totalSpent,
                      bgColor: isDark
                          ? Colors.grey.shade800
                          : Colors.grey.shade200,
                    ),
                  ),
                  // Center Text
                  Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        "\$${totalSpent.toInt()}",
                        style: TextStyle(
                          fontSize: 26,
                          fontWeight: FontWeight.bold,
                          color: textColor,
                        ),
                      ),
                      Text(
                        "Total",
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey.shade500,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
          const SizedBox(height: 24),

          // 2. The Legend (Clickable too)
          Wrap(
            spacing: 16,
            runSpacing: 10,
            alignment: WrapAlignment.center,
            children: data.map((item) {
              final percent = totalSpent == 0
                  ? 0
                  : (item.amount / totalSpent * 100).toInt();
              return GestureDetector(
                onTap: () => onSectionTap(item.id),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: item.color.withOpacity(0.15),
                        shape: BoxShape.circle,
                      ),
                      child: Icon(item.icon, size: 18, color: item.color),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      item.name,
                      style: TextStyle(
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                        color: textColor,
                      ),
                    ),
                    Text(
                      "$percent%",
                      style: TextStyle(
                        fontSize: 10,
                        color: Colors.grey.shade500,
                      ),
                    ),
                  ],
                ),
              );
            }).toList(),
          ),
        ],
      ),
    );
  }

  // Calculate which slice was tapped based on angle
  void _handleTap(TapUpDetails details, BuildContext context) {
    if (totalSpent == 0) return;

    final RenderBox box = context.findRenderObject() as RenderBox;
    final Offset localOffset = box.globalToLocal(details.globalPosition);
    final Offset center = Offset(box.size.width / 2, 180 / 2); // 180 is height

    // Calculate angle from center
    final dx = localOffset.dx - center.dx;
    final dy = localOffset.dy - center.dy;

    // atan2 returns -pi to +pi. We want 0 to 2pi starting from top (-pi/2)
    double angle = atan2(dy, dx);

    // Adjust so 0 is at the top (12 o'clock)
    angle += pi / 2;
    if (angle < 0) angle += 2 * pi;

    // Find the data segment that contains this angle
    double currentAngle = 0;
    for (var item in data) {
      final sweepAngle = (item.amount / totalSpent) * 2 * pi;
      if (angle >= currentAngle && angle < currentAngle + sweepAngle) {
        onSectionTap(item.id);
        return;
      }
      currentAngle += sweepAngle;
    }
  }
}

class _DonutChartPainter extends CustomPainter {
  final List<ChartData> data;
  final double total;
  final Color bgColor;

  _DonutChartPainter({
    required this.data,
    required this.total,
    required this.bgColor,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final center = Offset(size.width / 2, size.height / 2);
    final radius = min(size.width / 2, size.height / 2);
    const strokeWidth = 20.0;

    final bgPaint = Paint()
      ..color = bgColor
      ..style = PaintingStyle.stroke
      ..strokeWidth = strokeWidth;

    canvas.drawCircle(center, radius - strokeWidth / 2, bgPaint);

    if (total == 0) return;

    // Start from -pi/2 (top)
    double startAngle = -pi / 2;

    for (var item in data) {
      final sweepAngle = (item.amount / total) * 2 * pi;
      final paint = Paint()
        ..color = item.color
        ..style = PaintingStyle.stroke
        ..strokeWidth = strokeWidth
        ..strokeCap = StrokeCap.round;

      if (sweepAngle > 0) {
        // Draw slightly less than full sweep to leave a gap if multiple items
        final gap = data.length > 1 ? 0.05 : 0.0;
        canvas.drawArc(
          Rect.fromCircle(center: center, radius: radius - strokeWidth / 2),
          startAngle + gap / 2,
          sweepAngle - gap,
          false,
          paint,
        );
      }
      startAngle += sweepAngle;
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

transaction_list.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../models/finance_models.dart';

class TransactionList extends StatelessWidget {
  final List<FinanceTransaction> transactions;
  final List<FinanceBucket> buckets;
  final bool isDark;
  final Function(FinanceTransaction) onEdit;

  const TransactionList({
    super.key,
    required this.transactions,
    required this.buckets,
    required this.isDark,
    required this.onEdit,
  });

  @override
  Widget build(BuildContext context) {
    if (transactions.isEmpty) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: Text(
            "No transactions yet.",
            style: TextStyle(color: Colors.grey.shade500),
          ),
        ),
      );
    }

    return ListView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: transactions.length,
      itemBuilder: (context, index) {
        final tx = transactions[index];
        FinanceBucket? bucket;
        if (tx.isExpense) {
          try {
            bucket = buckets.firstWhere((b) => b.id == tx.categoryId);
          } catch (_) {}
        }

        final color = tx.isExpense
            ? (bucket?.color ?? Colors.grey)
            : (tx.color ?? Colors.green);

        final icon = tx.isExpense
            ? (bucket?.icon ?? Icons.category)
            : (tx.icon ?? Icons.attach_money);

        return Container(
          margin: const EdgeInsets.only(bottom: 12),
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(isDark ? 0.3 : 0.05),
                blurRadius: 10,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: color.withOpacity(0.15),
                  shape: BoxShape.circle,
                ),
                child: Icon(icon, color: color, size: 20),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      tx.title,
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                        color: isDark ? Colors.white : Colors.black87,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      DateFormat('MMM d, h:mm a').format(tx.date),
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.grey.shade600,
                      ),
                    ),
                  ],
                ),
              ),
              Row(
                children: [
                  // FIX 3: RESTORED RED COLOR FOR EXPENSES
                  Text(
                    "${tx.isExpense ? '-' : '+'}\$${tx.amount.toStringAsFixed(2)}",
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                      color: tx.isExpense
                          ? Colors
                                .redAccent // Explicitly Red
                          : Colors.green, // Explicitly Green
                    ),
                  ),
                  const SizedBox(width: 12),
                  GestureDetector(
                    onTap: () => onEdit(tx),
                    child: Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: isDark ? Colors.white10 : Colors.grey.shade100,
                        shape: BoxShape.circle,
                      ),
                      child: Icon(
                        Icons.edit_rounded,
                        size: 14,
                        color: isDark ? Colors.white54 : Colors.grey,
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }
}

activity_card.dart:
import 'package:flutter/material.dart';
import '../../../../models/health_model.dart';
import 'routine_manager.dart';
import 'workout_logger.dart';
import 'exercise_models.dart';

class ActivityCard extends StatefulWidget {
  final HealthDailyLog log;
  final Function(String?) onRoutineChanged;
  final Function(bool) onWorkoutToggle;
  final Function(int) onStepsChanged;
  final Function(double) onWeightChanged;
  final Function() onExerciseUpdated;

  // NEW: Flag to change UI behavior for future dates
  final bool isPlanningMode;

  const ActivityCard({
    super.key,
    required this.log,
    required this.onRoutineChanged,
    required this.onWorkoutToggle,
    required this.onStepsChanged,
    required this.onWeightChanged,
    required this.onExerciseUpdated,
    this.isPlanningMode = false, // Default is false (Active mode)
  });

  @override
  State<ActivityCard> createState() => _ActivityCardState();
}

class _ActivityCardState extends State<ActivityCard> {
  int _currentExerciseIndex = 0;
  final Set<int> _completedIndices = {};

  @override
  Widget build(BuildContext context) {
    final hasRoutine = widget.log.workoutName != null;

    if (widget.log.workoutLog.isNotEmpty &&
        _currentExerciseIndex >= widget.log.workoutLog.length) {
      _currentExerciseIndex = 0;
    }

    return Container(
      padding: const EdgeInsets.fromLTRB(8, 12, 8, 12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: widget.log.isWorkoutDone
              ? [const Color(0xFF2E7D32), const Color(0xFF1B5E20)]
              : [const Color(0xFFEF6C00), const Color(0xFFE65100)],
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: (widget.log.isWorkoutDone ? Colors.green : Colors.orange)
                .withOpacity(0.3),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: !hasRoutine
          ? _buildSelectorState(context)
          : (widget.log.workoutLog.isEmpty
                ? _buildLoadingOrEmptyState(context)
                : _buildPlayerState(context)),
    );
  }

  Widget _buildSelectorState(BuildContext context) {
    return GestureDetector(
      onTap: () => _showRoutineManager(context),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.white.withOpacity(0.2),
              shape: BoxShape.circle,
            ),
            child: const Icon(
              Icons.fitness_center_rounded,
              color: Colors.white,
              size: 28,
            ),
          ),
          const SizedBox(height: 12),
          Text(
            widget.isPlanningMode ? "Plan Workout" : "No Routine",
            style: const TextStyle(color: Colors.white70, fontSize: 12),
          ),
          const Text(
            "Tap to Start",
            style: TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
              fontSize: 18,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLoadingOrEmptyState(BuildContext context) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Text(
            "Setting up routine...",
            style: TextStyle(color: Colors.white),
          ),
          TextButton(
            onPressed: () => _showRoutineManager(context),
            child: const Text(
              "Change",
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPlayerState(BuildContext context) {
    final currentExercise = widget.log.workoutLog[_currentExerciseIndex];
    final isFirst = _currentExerciseIndex == 0;
    final isLast = _currentExerciseIndex == widget.log.workoutLog.length - 1;
    final isExerciseDone = _completedIndices.contains(_currentExerciseIndex);
    final doneColor = const Color(0xFF69F0AE);

    return Column(
      children: [
        // 1. HEADER
        GestureDetector(
          onTap: () => _showRoutineManager(context),
          child: Container(
            width: double.infinity,
            padding: const EdgeInsets.symmetric(vertical: 6),
            margin: const EdgeInsets.symmetric(horizontal: 4),
            decoration: BoxDecoration(
              color: Colors.black.withOpacity(0.15),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Flexible(
                  child: Text(
                    widget.log.workoutName!,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
                const SizedBox(width: 4),
                const Icon(
                  Icons.keyboard_arrow_down,
                  color: Colors.white70,
                  size: 14,
                ),
              ],
            ),
          ),
        ),

        const Spacer(),

        // 2. EXERCISE DISPLAY
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            IconButton(
              onPressed: isFirst
                  ? null
                  : () => setState(() => _currentExerciseIndex--),
              icon: Icon(
                Icons.arrow_back_ios_rounded,
                color: isFirst ? Colors.white12 : Colors.white,
                size: 20,
              ),
              padding: EdgeInsets.zero,
              constraints: const BoxConstraints(minWidth: 32, minHeight: 32),
            ),

            Expanded(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  if (isExerciseDone)
                    Icon(Icons.check_circle, color: doneColor, size: 22),
                  if (isExerciseDone) const SizedBox(height: 2),
                  Text(
                    currentExercise.name,
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      color: isExerciseDone ? doneColor : Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      height: 1.1,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),

            IconButton(
              onPressed: isLast
                  ? null
                  : () => setState(() => _currentExerciseIndex++),
              icon: Icon(
                Icons.arrow_forward_ios_rounded,
                color: isLast ? Colors.white12 : Colors.white,
                size: 20,
              ),
              padding: EdgeInsets.zero,
              constraints: const BoxConstraints(minWidth: 32, minHeight: 32),
            ),
          ],
        ),

        const Spacer(),

        // 3. BOTTOM BUTTON (Changes based on Mode)
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 4.0),
          child: GestureDetector(
            // If Planning: Open Routine Manager. If Active: Open Logger.
            onTap: () => widget.isPlanningMode
                ? _showRoutineManager(context)
                : _showLogger(context, currentExercise),
            child: Container(
              height: 36,
              width: double.infinity,
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  // Icon changes based on mode
                  Icon(
                    widget.isPlanningMode
                        ? Icons
                              .edit_note_rounded // Plan icon
                        : (isExerciseDone
                              ? Icons.check_circle
                              : Icons.edit), // Log icon
                    color: Colors.deepOrange,
                    size: 16,
                  ),
                  const SizedBox(width: 6),
                  Text(
                    widget.isPlanningMode
                        ? "Edit Routine" // Text for Future
                        : (isExerciseDone
                              ? "Logs"
                              : "Log Sets"), // Text for Today
                    style: const TextStyle(
                      color: Colors.deepOrange,
                      fontWeight: FontWeight.bold,
                      fontSize: 13,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }

  void _showLogger(BuildContext context, ExerciseDetail exercise) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => WorkoutLoggerSheet(
        exerciseName: exercise.name,
        targetSetCount: exercise.sets.length,
        onComplete: (done) {
          if (done) {
            widget.onExerciseUpdated();
            setState(() {
              _completedIndices.add(_currentExerciseIndex);
              if (_currentExerciseIndex < widget.log.workoutLog.length - 1) {
                _currentExerciseIndex++;
              } else {
                if (_completedIndices.length == widget.log.workoutLog.length) {
                  widget.onWorkoutToggle(true);
                }
              }
            });
          }
        },
      ),
    );
  }

  void _showRoutineManager(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => DraggableScrollableSheet(
        initialChildSize: 0.85,
        maxChildSize: 0.95,
        minChildSize: 0.5,
        expand: false,
        builder: (_, scrollController) => RoutineManagerSheet(
          selectedRoutine: widget.log.workoutName,
          onSelected: (routineName) {
            widget.onRoutineChanged(routineName);
            final List<ExerciseDetail> newExercises =
                _generateExercisesForRoutine(routineName);
            widget.log.workoutLog = newExercises;
            widget.onExerciseUpdated();

            setState(() {
              _currentExerciseIndex = 0;
              _completedIndices.clear();
            });
            Navigator.pop(ctx);
          },
        ),
      ),
    );
  }

  List<ExerciseDetail> _generateExercisesForRoutine(String routineName) {
    if (routineName.contains("Push")) {
      return [
        ExerciseDetail(
          name: "Bench Press",
          sets: [SetDetail(), SetDetail(), SetDetail()],
        ),
        ExerciseDetail(name: "Incline Fly", sets: [SetDetail(), SetDetail()]),
        ExerciseDetail(
          name: "Tricep Pushdown",
          sets: [SetDetail(), SetDetail(), SetDetail()],
        ),
      ];
    } else if (routineName.contains("Pull")) {
      return [
        ExerciseDetail(name: "Pull Ups", sets: [SetDetail(), SetDetail()]),
        ExerciseDetail(
          name: "Barbell Row",
          sets: [SetDetail(), SetDetail(), SetDetail()],
        ),
        ExerciseDetail(name: "Bicep Curl", sets: [SetDetail(), SetDetail()]),
      ];
    } else {
      return [
        ExerciseDetail(
          name: "Squat",
          sets: [SetDetail(), SetDetail(), SetDetail()],
        ),
        ExerciseDetail(name: "Leg Press", sets: [SetDetail(), SetDetail()]),
        ExerciseDetail(
          name: "Calf Raise",
          sets: [SetDetail(), SetDetail(), SetDetail()],
        ),
      ];
    }
  }
}

exercise_models.dart:
// lib/widgets/health/activity/exercise_models.dart

class SetDetail {
  int reps;
  double weight;

  SetDetail({this.reps = 10, this.weight = 0.0});

  // NEW: Convert to Map for Firestore
  Map<String, dynamic> toMap() => {'reps': reps, 'weight': weight};

  // NEW: Create from Map
  factory SetDetail.fromMap(Map<String, dynamic> map) {
    return SetDetail(
      reps: map['reps'] ?? 0,
      weight: (map['weight'] ?? 0).toDouble(),
    );
  }
}

class ExerciseDetail {
  String name;
  List<SetDetail> sets;

  ExerciseDetail({required this.name, List<SetDetail>? sets})
    : sets = sets ?? [SetDetail(), SetDetail(), SetDetail()];

  // NEW: Convert to Map
  Map<String, dynamic> toMap() => {
    'name': name,
    'sets': sets.map((s) => s.toMap()).toList(),
  };

  // NEW: Create from Map
  factory ExerciseDetail.fromMap(Map<String, dynamic> map) {
    return ExerciseDetail(
      name: map['name'] ?? '',
      sets:
          (map['sets'] as List<dynamic>?)
              ?.map((s) => SetDetail.fromMap(s))
              .toList() ??
          [],
    );
  }
}

// Master List (remains the same)
final List<String> masterExerciseList = [
  "Bench Press",
  "Incline Dumbbell Press",
  "Push Ups",
  "Overhead Press",
  "Lateral Raises",
  "Tricep Extensions",
  "Skullcrushers",
  "Dips",
  "Pull Ups",
  "Lat Pulldown",
  "Barbell Row",
  "Dumbbell Row",
  "Face Pulls",
  "Bicep Curls",
  "Hammer Curls",
  "Preacher Curls",
  "Deadlift",
  "Squat",
  "Leg Press",
  "Leg Extension",
  "Hamstring Curl",
  "Lunges",
  "Bulgarian Split Squat",
  "Calf Raises",
  "Hip Thrust",
  "Treadmill Run",
  "Cycling",
  "Elliptical",
  "Jump Rope",
  "Burpees",
  "Plank",
  "Crunch",
  "Leg Raise",
  "Russian Twist",
];

routine_editor.dart:
import 'package:flutter/material.dart';
import 'exercise_models.dart';
import 'set_editor.dart';

class RoutineEditorSheet extends StatefulWidget {
  final String? initialName;
  final Function(String) onSave;

  const RoutineEditorSheet({super.key, this.initialName, required this.onSave});

  @override
  State<RoutineEditorSheet> createState() => _RoutineEditorSheetState();
}

class _RoutineEditorSheetState extends State<RoutineEditorSheet> {
  late TextEditingController _nameCtrl;
  final List<ExerciseDetail> _exercises = [];

  @override
  void initState() {
    super.initState();
    _nameCtrl = TextEditingController(text: widget.initialName ?? "");
    // Mock data for demo if editing
    if (widget.initialName != null && widget.initialName!.isNotEmpty) {
      _exercises.add(
        ExerciseDetail(
          name: "Bench Press",
          sets: [
            SetDetail(weight: 60, reps: 12),
            SetDetail(weight: 65, reps: 10),
          ],
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final inputColor = isDark ? Colors.black26 : Colors.grey.shade100;

    // 1. FORCE HEIGHT (85% of screen)
    final height = MediaQuery.of(context).size.height * 0.85;

    return Container(
      height: height,
      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // HANDLE BAR
          Center(
            child: Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(bottom: 20),
              decoration: BoxDecoration(
                color: Colors.grey.withOpacity(0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
          ),

          // HEADER
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                "Edit Routine",
                style: TextStyle(
                  fontSize: 22,
                  fontWeight: FontWeight.bold,
                  color: textColor,
                ),
              ),
              TextButton(
                onPressed: () {
                  if (_nameCtrl.text.isNotEmpty) widget.onSave(_nameCtrl.text);
                },
                child: const Text(
                  "Save",
                  style: TextStyle(
                    color: Colors.deepOrange,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),

          // ROUTINE NAME INPUT
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
            decoration: BoxDecoration(
              color: inputColor,
              borderRadius: BorderRadius.circular(16),
            ),
            child: TextField(
              controller: _nameCtrl,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: textColor,
              ),
              decoration: const InputDecoration(
                border: InputBorder.none,
                labelText: "Routine Name",
                labelStyle: TextStyle(color: Colors.grey),
              ),
            ),
          ),
          const SizedBox(height: 24),

          // EXERCISE LIST HEADER
          Text(
            "Exercises (${_exercises.length})",
            style: TextStyle(
              color: Colors.grey.shade500,
              fontSize: 14,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 10),

          // DRAGGABLE LIST
          Expanded(
            child: _exercises.isEmpty
                ? Center(
                    child: Text(
                      "No exercises yet.\nTap below to add.",
                      textAlign: TextAlign.center,
                      style: TextStyle(color: Colors.grey.shade600),
                    ),
                  )
                : ReorderableListView(
                    onReorder: (oldIndex, newIndex) {
                      setState(() {
                        if (oldIndex < newIndex) newIndex -= 1;
                        final item = _exercises.removeAt(oldIndex);
                        _exercises.insert(newIndex, item);
                      });
                    },
                    children: [
                      for (int i = 0; i < _exercises.length; i++)
                        _buildExerciseTile(i, _exercises[i], textColor, isDark),
                    ],
                  ),
          ),

          // BIG ADD BUTTON AT BOTTOM
          Padding(
            padding: EdgeInsets.only(
              bottom: MediaQuery.of(context).padding.bottom + 20,
              top: 10,
            ),
            child: SizedBox(
              width: double.infinity,
              height: 55,
              child: ElevatedButton.icon(
                onPressed: () => _showSmartSearch(context),
                icon: const Icon(Icons.add),
                label: const Text(
                  "Add Exercise",
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: inputColor,
                  foregroundColor: Colors.deepOrange,
                  elevation: 0,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildExerciseTile(
    int index,
    ExerciseDetail exercise,
    Color textColor,
    bool isDark,
  ) {
    return Container(
      key: ValueKey("${exercise.name}_$index"),
      margin: const EdgeInsets.only(bottom: 10),
      decoration: BoxDecoration(
        color: isDark ? Colors.white10 : Colors.grey.shade50,
        borderRadius: BorderRadius.circular(16),
      ),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        leading: Icon(Icons.drag_indicator, color: Colors.grey.shade600),
        title: Text(
          exercise.name,
          style: TextStyle(color: textColor, fontWeight: FontWeight.bold),
        ),
        subtitle: Text(
          "${exercise.sets.length} Sets",
          style: TextStyle(
            color: Colors.deepOrange.withOpacity(0.8),
            fontSize: 12,
          ),
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            IconButton(
              icon: const Icon(
                Icons.tune_rounded,
                color: Colors.blue,
                size: 20,
              ),
              onPressed: () => _openSetEditor(exercise),
            ),
            IconButton(
              icon: Icon(
                Icons.close,
                size: 20,
                color: Colors.red.withOpacity(0.7),
              ),
              onPressed: () => setState(() => _exercises.removeAt(index)),
            ),
          ],
        ),
      ),
    );
  }

  void _openSetEditor(ExerciseDetail exercise) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => SetEditorSheet(
        exerciseName: exercise.name,
        initialSets: exercise.sets,
        onSave: (updatedSets) => setState(() => exercise.sets = updatedSets),
      ),
    );
  }

  void _showSmartSearch(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => ExerciseSearchSheet(
        onSelect: (name) {
          setState(() {
            _exercises.add(ExerciseDetail(name: name));
          });
          Navigator.pop(ctx);
        },
      ),
    );
  }
}

// --- MISSING CLASS ADDED BELOW ---

class ExerciseSearchSheet extends StatefulWidget {
  final Function(String) onSelect;
  const ExerciseSearchSheet({super.key, required this.onSelect});

  @override
  State<ExerciseSearchSheet> createState() => _ExerciseSearchSheetState();
}

class _ExerciseSearchSheetState extends State<ExerciseSearchSheet> {
  final TextEditingController _searchCtrl = TextEditingController();
  List<String> _filteredList = [];

  @override
  void initState() {
    super.initState();
    // masterExerciseList comes from exercise_models.dart
    _filteredList = masterExerciseList;
  }

  void _filter(String query) {
    setState(() {
      if (query.isEmpty) {
        _filteredList = masterExerciseList;
      } else {
        _filteredList = masterExerciseList
            .where((ex) => ex.toLowerCase().contains(query.toLowerCase()))
            .toList();
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Padding(
      padding: EdgeInsets.only(
        top: 20,
        left: 20,
        right: 20,
        bottom: MediaQuery.of(context).viewInsets.bottom + 20,
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            "Add Exercise",
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: textColor,
            ),
          ),
          const SizedBox(height: 15),
          TextField(
            controller: _searchCtrl,
            onChanged: _filter,
            autofocus: true,
            style: TextStyle(color: textColor),
            decoration: InputDecoration(
              hintText: "Search...",
              hintStyle: const TextStyle(color: Colors.grey),
              prefixIcon: const Icon(Icons.search, color: Colors.grey),
              filled: true,
              fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
            ),
          ),
          const SizedBox(height: 10),
          SizedBox(
            height: 300,
            child: _filteredList.isEmpty
                ? Center(
                    child: ElevatedButton.icon(
                      onPressed: () {
                        masterExerciseList.add(
                          _searchCtrl.text,
                        ); // Save new exercise to memory
                        widget.onSelect(_searchCtrl.text);
                      },
                      icon: const Icon(Icons.add),
                      label: Text("Create '${_searchCtrl.text}'"),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.deepOrange,
                        foregroundColor: Colors.white,
                      ),
                    ),
                  )
                : ListView.separated(
                    itemCount: _filteredList.length,
                    separatorBuilder: (ctx, i) =>
                        Divider(color: Colors.grey.withOpacity(0.1)),
                    itemBuilder: (ctx, i) {
                      return ListTile(
                        title: Text(
                          _filteredList[i],
                          style: TextStyle(color: textColor),
                        ),
                        trailing: const Icon(
                          Icons.add_circle_outline,
                          color: Colors.deepOrange,
                        ),
                        onTap: () => widget.onSelect(_filteredList[i]),
                      );
                    },
                  ),
          ),
        ],
      ),
    );
  }
}

routine_manager.dart:
// lib/widgets/health/activity/routine_manager.dart

import 'package:flutter/material.dart';
import 'routine_editor.dart';

class RoutineManagerSheet extends StatefulWidget {
  final String? selectedRoutine;
  final Function(String) onSelected;

  const RoutineManagerSheet({
    super.key,
    required this.selectedRoutine,
    required this.onSelected,
  });

  @override
  State<RoutineManagerSheet> createState() => _RoutineManagerSheetState();
}

class _RoutineManagerSheetState extends State<RoutineManagerSheet> {
  final List<String> _userRoutines = [
    "Push Day A",
    "Pull Day A",
    "Legs",
    "Full Body",
  ];
  String? _tempSelected;

  @override
  void initState() {
    super.initState();
    _tempSelected = widget.selectedRoutine;
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Padding(
      padding: const EdgeInsets.all(20.0),
      child: Column(
        children: [
          // HEADER
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                "My Routines",
                style: TextStyle(
                  fontSize: 22,
                  fontWeight: FontWeight.bold,
                  color: textColor,
                ),
              ),
              Row(
                children: [
                  IconButton(
                    icon: const Icon(
                      Icons.add,
                      color: Colors.deepOrange,
                      size: 28,
                    ),
                    onPressed: () => _openEditor(context, null), // Create New
                  ),
                  const SizedBox(width: 8),
                  // CONFIRM BUTTON
                  IconButton(
                    icon: const Icon(
                      Icons.check_circle,
                      color: Colors.green,
                      size: 28,
                    ),
                    onPressed: () {
                      if (_tempSelected != null) {
                        widget.onSelected(_tempSelected!);
                      }
                    },
                  ),
                ],
              ),
            ],
          ),
          const SizedBox(height: 10),
          const Divider(),
          const SizedBox(height: 10),

          // LIST
          Expanded(
            child: ListView.separated(
              itemCount: _userRoutines.length,
              separatorBuilder: (ctx, i) => const SizedBox(height: 12),
              itemBuilder: (ctx, index) {
                final routine = _userRoutines[index];
                final isSelected = routine == _tempSelected;

                return GestureDetector(
                  onTap: () => setState(() => _tempSelected = routine),
                  child: AnimatedContainer(
                    duration: const Duration(milliseconds: 200),
                    decoration: BoxDecoration(
                      color: isDark ? Colors.black26 : Colors.grey.shade100,
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: isSelected
                            ? Colors.deepOrange
                            : Colors.transparent,
                        width: 2,
                      ),
                    ),
                    child: ListTile(
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 4,
                      ),
                      leading: Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          color: isSelected
                              ? Colors.deepOrange
                              : Colors.grey.withOpacity(0.1),
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.fitness_center,
                          color: isSelected ? Colors.white : Colors.grey,
                          size: 20,
                        ),
                      ),
                      title: Text(
                        routine,
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          color: textColor,
                        ),
                      ),
                      trailing: IconButton(
                        icon: const Icon(
                          Icons.edit_outlined,
                          size: 20,
                          color: Colors.grey,
                        ),
                        onPressed: () => _openEditor(context, routine),
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  void _openEditor(BuildContext context, String? routineName) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      builder: (ctx) => RoutineEditorSheet(
        initialName: routineName,
        onSave: (newName) {
          setState(() {
            if (routineName == null) {
              _userRoutines.add(newName);
            }
            // In real app, handle rename logic here
          });
          Navigator.pop(ctx);
        },
      ),
    );
  }
}

set_editor.dart:
import 'package:flutter/material.dart';
import 'exercise_models.dart';

class SetEditorSheet extends StatefulWidget {
  final String exerciseName;
  final List<SetDetail> initialSets;
  final Function(List<SetDetail>) onSave;

  const SetEditorSheet({
    super.key,
    required this.exerciseName,
    required this.initialSets,
    required this.onSave,
  });

  @override
  State<SetEditorSheet> createState() => _SetEditorSheetState();
}

class _SetEditorSheetState extends State<SetEditorSheet> {
  late List<SetDetail> _sets;

  @override
  void initState() {
    super.initState();
    _sets = widget.initialSets
        .map((s) => SetDetail(reps: s.reps, weight: s.weight))
        .toList();
    if (_sets.isEmpty) _sets.add(SetDetail());
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    // 1. FORCE HEIGHT
    final height = MediaQuery.of(context).size.height * 0.85;

    return Container(
      height: height,
      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          // HANDLE
          Center(
            child: Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(bottom: 20),
              decoration: BoxDecoration(
                color: Colors.grey.withOpacity(0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
          ),

          // HEADER
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Text(
                  widget.exerciseName,
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                    color: textColor,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
              TextButton(
                onPressed: () {
                  widget.onSave(_sets);
                  Navigator.pop(context);
                },
                child: const Text(
                  "Save",
                  style: TextStyle(
                    color: Colors.deepOrange,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),

          // TABLE HEADERS
          Row(
            children: [
              SizedBox(
                width: 40,
                child: Center(
                  child: Text(
                    "Set",
                    style: TextStyle(
                      color: Colors.grey.shade500,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              const Spacer(),
              SizedBox(
                width: 90,
                child: Center(
                  child: Text(
                    "kg",
                    style: TextStyle(
                      color: Colors.grey.shade500,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              SizedBox(
                width: 90,
                child: Center(
                  child: Text(
                    "Reps",
                    style: TextStyle(
                      color: Colors.grey.shade500,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 40),
            ],
          ),
          const SizedBox(height: 10),

          // SCROLLABLE LIST
          Expanded(
            child: ListView.builder(
              itemCount: _sets.length,
              itemBuilder: (ctx, index) =>
                  _buildSetRow(index + 1, _sets[index], isDark),
            ),
          ),

          // BUTTON AREA
          Padding(
            padding: EdgeInsets.only(
              bottom: MediaQuery.of(context).padding.bottom + 20,
              top: 10,
            ),
            child: SizedBox(
              width: double.infinity,
              height: 55,
              child: ElevatedButton.icon(
                onPressed: () {
                  setState(() {
                    final lastSet = _sets.last;
                    _sets.add(
                      SetDetail(reps: lastSet.reps, weight: lastSet.weight),
                    );
                  });
                },
                icon: const Icon(Icons.add),
                label: const Text(
                  "Add Set",
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: isDark
                      ? Colors.black26
                      : Colors.grey.shade100,
                  foregroundColor: Colors.deepOrange,
                  elevation: 0,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSetRow(int number, SetDetail set, bool isDark) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6.0),
      child: Row(
        children: [
          // Set Number Bubble
          SizedBox(
            width: 40,
            child: Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: isDark ? Colors.white10 : Colors.grey.shade200,
                shape: BoxShape.circle,
              ),
              child: Center(
                child: Text(
                  "$number",
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: isDark ? Colors.white : Colors.black,
                  ),
                ),
              ),
            ),
          ),
          const Spacer(),

          // Weight Input
          _buildCompactInput(
            set.weight.toString(),
            (val) => set.weight = double.tryParse(val) ?? set.weight,
            isDark,
          ),
          const SizedBox(width: 16),

          // Reps Input
          _buildCompactInput(
            set.reps.toString(),
            (val) => set.reps = int.tryParse(val) ?? set.reps,
            isDark,
          ),

          // Delete
          SizedBox(
            width: 40,
            child: IconButton(
              icon: Icon(
                Icons.close,
                color: Colors.red.withOpacity(0.5),
                size: 20,
              ),
              onPressed: () => setState(() {
                if (_sets.length > 1) _sets.remove(set);
              }),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCompactInput(
    String initial,
    Function(String) onChanged,
    bool isDark,
  ) {
    return SizedBox(
      width: 90,
      child: TextFormField(
        initialValue: initial,
        keyboardType: TextInputType.number,
        textAlign: TextAlign.center,
        style: TextStyle(
          fontWeight: FontWeight.bold,
          fontSize: 18,
          color: isDark ? Colors.white : Colors.black,
        ),
        decoration: InputDecoration(
          contentPadding: const EdgeInsets.symmetric(vertical: 12),
          filled: true,
          fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide.none,
          ),
        ),
        onChanged: onChanged,
      ),
    );
  }
}

workout_logger.dart:
import 'package:flutter/material.dart';
import 'exercise_models.dart';

class WorkoutLoggerSheet extends StatefulWidget {
  final String exerciseName;
  final int targetSetCount;
  final Function(bool) onComplete;

  const WorkoutLoggerSheet({
    super.key,
    required this.exerciseName,
    required this.targetSetCount,
    required this.onComplete,
  });

  @override
  State<WorkoutLoggerSheet> createState() => _WorkoutLoggerSheetState();
}

class _WorkoutLoggerSheetState extends State<WorkoutLoggerSheet> {
  late List<SetDetail> _loggedSets;

  @override
  void initState() {
    super.initState();
    _loggedSets = List.generate(
      widget.targetSetCount,
      (index) => SetDetail(reps: 0, weight: 0.0),
    );
    if (_loggedSets.isEmpty) _loggedSets.add(SetDetail());
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    // FIX: Force height to 85% of screen so it doesn't get cut off
    final height = MediaQuery.of(context).size.height * 0.85;

    return Container(
      height: height,
      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          // HANDLE
          Center(
            child: Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(bottom: 20),
              decoration: BoxDecoration(
                color: Colors.grey.withOpacity(0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
          ),

          // HEADER
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Text(
                  widget.exerciseName,
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                    color: textColor,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
              TextButton(
                onPressed: () {
                  widget.onComplete(true);
                  Navigator.pop(context);
                },
                child: const Text(
                  "Finish",
                  style: TextStyle(
                    color: Colors.deepOrange,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),

          // COLUMN TITLES
          Row(
            children: [
              const SizedBox(width: 40), // Space for Set # badge
              const Spacer(),
              SizedBox(
                width: 80,
                child: Center(
                  child: Text(
                    "kg",
                    style: TextStyle(
                      color: Colors.grey.shade600,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 20),
              SizedBox(
                width: 80,
                child: Center(
                  child: Text(
                    "Reps",
                    style: TextStyle(
                      color: Colors.grey.shade600,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 40), // Space for delete icon
            ],
          ),
          const SizedBox(height: 10),

          // SCROLLABLE LIST
          Expanded(
            child: ListView.separated(
              itemCount: _loggedSets.length,
              separatorBuilder: (ctx, i) => const SizedBox(height: 12),
              itemBuilder: (ctx, index) =>
                  _buildLogRows(index + 1, _loggedSets[index], isDark),
            ),
          ),

          // ADD SET BUTTON (Pinned to bottom of visible area)
          Padding(
            padding: EdgeInsets.only(
              bottom: MediaQuery.of(context).padding.bottom + 20,
              top: 10,
            ),
            child: TextButton.icon(
              onPressed: () {
                setState(() {
                  final last = _loggedSets.isNotEmpty
                      ? _loggedSets.last
                      : SetDetail();
                  _loggedSets.add(
                    SetDetail(reps: last.reps, weight: last.weight),
                  );
                });
              },
              icon: const Icon(Icons.add, color: Colors.deepOrange),
              label: const Text(
                "Add Set",
                style: TextStyle(
                  color: Colors.deepOrange,
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLogRows(int setNum, SetDetail set, bool isDark) {
    return Row(
      children: [
        // Set Badge
        Container(
          width: 40,
          height: 40,
          decoration: BoxDecoration(
            color: isDark ? Colors.white10 : Colors.grey.shade200,
            shape: BoxShape.circle,
          ),
          child: Center(
            child: Text(
              "$setNum",
              style: TextStyle(
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : Colors.black,
              ),
            ),
          ),
        ),
        const Spacer(),
        // Weight
        _buildInput(isDark, (val) => set.weight = double.tryParse(val) ?? 0),
        const SizedBox(width: 20),
        // Reps
        _buildInput(isDark, (val) => set.reps = int.tryParse(val) ?? 0),
        // Delete
        SizedBox(
          width: 40,
          child: IconButton(
            icon: Icon(
              Icons.close,
              color: Colors.red.withOpacity(0.5),
              size: 20,
            ),
            onPressed: () => setState(() {
              if (_loggedSets.length > 1) _loggedSets.remove(set);
            }),
          ),
        ),
      ],
    );
  }

  Widget _buildInput(bool isDark, Function(String) onChange) {
    return SizedBox(
      width: 80,
      child: TextField(
        keyboardType: TextInputType.number,
        textAlign: TextAlign.center,
        style: TextStyle(
          fontWeight: FontWeight.bold,
          fontSize: 18,
          color: isDark ? Colors.white : Colors.black,
        ),
        decoration: InputDecoration(
          contentPadding: const EdgeInsets.symmetric(vertical: 10),
          filled: true,
          fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide.none,
          ),
          hintText: "-",
          hintStyle: TextStyle(color: Colors.grey.withOpacity(0.5)),
        ),
        onChanged: onChange,
      ),
    );
  }
}

activity.dart:
/*
import 'package:flutter/material.dart';
import '../../../models/health_model.dart';

// --- MOCK DATABASE (Session Memory) ---
// This list persists as long as the app is open.
final List<String> _masterExerciseList = [
  "Bench Press",
  "Incline Dumbbell Press",
  "Push Ups",
  "Overhead Press",
  "Lateral Raises",
  "Tricep Extensions",
  "Skullcrushers",
  "Dips",
  "Pull Ups",
  "Lat Pulldown",
  "Barbell Row",
  "Dumbbell Row",
  "Face Pulls",
  "Bicep Curls",
  "Hammer Curls",
  "Preacher Curls",
  "Deadlift",
  "Squat",
  "Leg Press",
  "Leg Extension",
  "Hamstring Curl",
  "Lunges",
  "Bulgarian Split Squat",
  "Calf Raises",
  "Hip Thrust",
  "Treadmill Run",
  "Cycling",
  "Elliptical",
  "Jump Rope",
  "Burpees",
  "Plank",
  "Crunch",
  "Leg Raise",
  "Russian Twist",
];

// --- INTERNAL MODEL FOR EXERCISE DETAILS ---
class ExerciseDetail {
  String name;
  int sets;
  int reps;
  double weight;

  ExerciseDetail({
    required this.name,
    this.sets = 3,
    this.reps = 10,
    this.weight = 0.0,
  });
}

class ActivityCard extends StatelessWidget {
  final HealthDailyLog log;
  final Function(String?) onRoutineChanged;
  final Function(bool) onWorkoutToggle;
  final Function(int) onStepsChanged;
  final Function(double) onWeightChanged;

  const ActivityCard({
    super.key,
    required this.log,
    required this.onRoutineChanged,
    required this.onWorkoutToggle,
    required this.onStepsChanged,
    required this.onWeightChanged,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Column(
      children: [
        // 1. GYM CARD (Routine Picker)
        Container(
          padding: const EdgeInsets.all(20),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: log.isWorkoutDone
                  ? [const Color(0xFF2E7D32), const Color(0xFF1B5E20)]
                  : [const Color(0xFFEF6C00), const Color(0xFFE65100)],
            ),
            borderRadius: BorderRadius.circular(24),
            boxShadow: [
              BoxShadow(
                color: (log.isWorkoutDone ? Colors.green : Colors.orange)
                    .withOpacity(0.3),
                blurRadius: 10,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Row(
            children: [
              GestureDetector(
                onTap: () => onWorkoutToggle(!log.isWorkoutDone),
                child: Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.2),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    log.isWorkoutDone
                        ? Icons.check_rounded
                        : Icons.fitness_center_rounded,
                    color: Colors.white,
                    size: 24,
                  ),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: GestureDetector(
                  onTap: () => _showRoutineManager(context),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        "Current Routine",
                        style: TextStyle(color: Colors.white70, fontSize: 10),
                      ),
                      const SizedBox(height: 2),
                      Row(
                        children: [
                          Expanded(
                            child: Text(
                              log.workoutName ?? "Select Routine",
                              style: const TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                                fontSize: 18,
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                          const Icon(
                            Icons.keyboard_arrow_down_rounded,
                            color: Colors.white70,
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 16),

        // 2. STEPS & WEIGHT ROW
        Row(
          children: [
            Expanded(
              child: _buildValueCard(
                context: context,
                icon: Icons.directions_walk,
                title: "Steps",
                value: "${log.steps}",
                unit: "steps",
                color: Colors.orange,
                bg: cardColor,
                text: textColor,
                onSave: (val) => onStepsChanged(int.parse(val)),
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: _buildValueCard(
                context: context,
                icon: Icons.monitor_weight,
                title: "Weight",
                value: "${log.weight}",
                unit: "kg",
                color: Colors.deepPurple,
                bg: cardColor,
                text: textColor,
                isDouble: true,
                onSave: (val) => onWeightChanged(double.parse(val)),
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildValueCard({
    required BuildContext context,
    required IconData icon,
    required String title,
    required String value,
    required String unit,
    required Color color,
    required Color bg,
    required Color text,
    required Function(String) onSave,
    bool isDouble = false,
  }) {
    return Material(
      color: bg,
      borderRadius: BorderRadius.circular(24),
      child: InkWell(
        borderRadius: BorderRadius.circular(24),
        onTap: () =>
            _showEditDialog(context, title, value, unit, onSave, isDouble),
        child: Container(
          height: 130,
          padding: const EdgeInsets.all(16),
          child: Stack(
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Icon(icon, color: color, size: 28),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        value,
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: text,
                        ),
                      ),
                      Text(
                        title,
                        style: const TextStyle(
                          fontSize: 12,
                          color: Colors.grey,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
              const Positioned(
                top: 0,
                right: 0,
                child: Icon(Icons.edit_rounded, size: 16, color: Colors.grey),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showEditDialog(
    BuildContext context,
    String title,
    String currentVal,
    String unit,
    Function(String) onSave,
    bool isDouble,
  ) {
    final controller = TextEditingController(text: currentVal);
    final isDark = Theme.of(context).brightness == Brightness.dark;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => Padding(
        padding: EdgeInsets.only(
          bottom: MediaQuery.of(ctx).viewInsets.bottom + 20,
          left: 24,
          right: 24,
          top: 24,
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Update $title",
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : Colors.black87,
              ),
            ),
            const SizedBox(height: 20),
            TextField(
              controller: controller,
              keyboardType: TextInputType.numberWithOptions(decimal: isDouble),
              autofocus: true,
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : Colors.black87,
              ),
              decoration: InputDecoration(
                suffixText: unit,
                hintText: "0",
                border: InputBorder.none,
                filled: true,
                fillColor: isDark ? Colors.black26 : Colors.grey.shade100,
                contentPadding: const EdgeInsets.symmetric(
                  horizontal: 16,
                  vertical: 12,
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: const BorderSide(
                    color: Colors.deepOrange,
                    width: 2,
                  ),
                ),
              ),
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              height: 50,
              child: ElevatedButton(
                onPressed: () {
                  if (controller.text.isNotEmpty) onSave(controller.text);
                  Navigator.pop(ctx);
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.deepOrange,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                child: const Text(
                  "Save",
                  style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showRoutineManager(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => DraggableScrollableSheet(
        initialChildSize: 0.85,
        maxChildSize: 0.95,
        minChildSize: 0.5,
        expand: false,
        builder: (_, scrollController) {
          return RoutineManagerSheet(
            selectedRoutine: log.workoutName,
            onSelected: (val) {
              onRoutineChanged(val);
              Navigator.pop(ctx);
            },
          );
        },
      ),
    );
  }
}

// --- ROUTINE MANAGER ---
class RoutineManagerSheet extends StatefulWidget {
  final String? selectedRoutine;
  final Function(String) onSelected;

  const RoutineManagerSheet({
    super.key,
    required this.selectedRoutine,
    required this.onSelected,
  });

  @override
  State<RoutineManagerSheet> createState() => _RoutineManagerSheetState();
}

class _RoutineManagerSheetState extends State<RoutineManagerSheet> {
  String _mode = 'list';
  final List<String> _userRoutines = [
    "Push Day A",
    "Pull Day A",
    "Legs",
    "Full Body",
  ];

  // EDITOR STATE
  final TextEditingController _editorNameCtrl = TextEditingController();
  final List<ExerciseDetail> _currentExercises = []; // Changed to Object list

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Padding(
      padding: const EdgeInsets.all(20.0),
      child: Column(
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              if (_mode == 'editor')
                IconButton(
                  icon: const Icon(Icons.arrow_back, size: 24),
                  onPressed: () => setState(() => _mode = 'list'),
                  padding: EdgeInsets.zero,
                  constraints: const BoxConstraints(),
                ),
              Text(
                _mode == 'list' ? "My Routines" : "Edit Routine",
                style: TextStyle(
                  fontSize: 22,
                  fontWeight: FontWeight.bold,
                  color: textColor,
                ),
              ),
              if (_mode == 'list')
                IconButton(
                  icon: const Icon(
                    Icons.add,
                    color: Colors.deepOrange,
                    size: 28,
                  ),
                  onPressed: () {
                    setState(() {
                      _mode = 'editor';
                      _editorNameCtrl.text = "New Routine";
                      _currentExercises.clear();
                    });
                  },
                )
              else
                TextButton(
                  onPressed: () {
                    if (_editorNameCtrl.text.isNotEmpty) {
                      // Logic to save would go here
                      if (!_userRoutines.contains(_editorNameCtrl.text)) {
                        _userRoutines.add(_editorNameCtrl.text);
                      }
                    }
                    setState(() => _mode = 'list');
                  },
                  child: const Text(
                    "Save",
                    style: TextStyle(
                      color: Colors.deepOrange,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
            ],
          ),
          const SizedBox(height: 10),
          const Divider(),
          const SizedBox(height: 10),
          Expanded(
            child: _mode == 'list'
                ? _buildList(textColor, isDark)
                : _buildEditor(textColor, isDark),
          ),
        ],
      ),
    );
  }

  // --- POLISHED LIST VIEW ---
  Widget _buildList(Color textColor, bool isDark) {
    return ListView.separated(
      itemCount: _userRoutines.length,
      separatorBuilder: (ctx, i) => const SizedBox(height: 12),
      itemBuilder: (ctx, index) {
        final routine = _userRoutines[index];
        final isSelected = routine == widget.selectedRoutine;

        return Container(
          decoration: BoxDecoration(
            color: isDark ? Colors.black26 : Colors.grey.shade100,
            borderRadius: BorderRadius.circular(16),
            border: isSelected
                ? Border.all(color: Colors.deepOrange, width: 1.5)
                : null,
          ),
          child: ListTile(
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 4,
            ),
            leading: Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Colors.deepOrange.withOpacity(0.15),
                shape: BoxShape.circle,
              ),
              child: const Icon(
                Icons.fitness_center,
                color: Colors.deepOrange,
                size: 20,
              ),
            ),
            title: Text(
              routine,
              style: TextStyle(fontWeight: FontWeight.bold, color: textColor),
            ),
            subtitle: const Text(
              "Tap to select",
              style: TextStyle(fontSize: 12, color: Colors.grey),
            ),
            trailing: Row(
              mainAxisSize: MainAxisSize.min, // FIX: Vertical Alignment
              children: [
                IconButton(
                  icon: const Icon(
                    Icons.edit_outlined,
                    size: 20,
                    color: Colors.grey,
                  ),
                  onPressed: () {
                    setState(() {
                      _mode = 'editor';
                      _editorNameCtrl.text = routine;
                      _currentExercises.clear();
                      // Mock loading saved exercises
                      _currentExercises.add(
                        ExerciseDetail(name: "Bench Press"),
                      );
                      _currentExercises.add(
                        ExerciseDetail(name: "Tricep Extensions", sets: 4),
                      );
                    });
                  },
                ),
                const SizedBox(width: 8),
                if (isSelected)
                  const Icon(Icons.check_circle, color: Colors.green, size: 24)
                else
                  IconButton(
                    icon: const Icon(
                      Icons.circle_outlined,
                      color: Colors.grey,
                      size: 24,
                    ),
                    onPressed: () => widget.onSelected(routine),
                  ),
              ],
            ),
          ),
        );
      },
    );
  }

  // --- DETAILED EDITOR VIEW ---
  Widget _buildEditor(Color textColor, bool isDark) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        TextField(
          controller: _editorNameCtrl,
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.bold,
            color: textColor,
          ),
          decoration: const InputDecoration(
            labelText: "Routine Name",
            border: UnderlineInputBorder(),
            contentPadding: EdgeInsets.zero,
          ),
        ),
        const SizedBox(height: 20),

        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              "Exercises (${_currentExercises.length})",
              style: TextStyle(color: Colors.grey.shade600, fontSize: 14),
            ),
            TextButton.icon(
              onPressed: () => _showExerciseSearch(context),
              icon: const Icon(Icons.add, size: 16),
              label: const Text("Add"),
              style: TextButton.styleFrom(foregroundColor: Colors.deepOrange),
            ),
          ],
        ),

        Expanded(
          child: ReorderableListView(
            onReorder: (oldIndex, newIndex) {
              setState(() {
                if (oldIndex < newIndex) newIndex -= 1;
                final item = _currentExercises.removeAt(oldIndex);
                _currentExercises.insert(newIndex, item);
              });
            },
            children: [
              for (int i = 0; i < _currentExercises.length; i++)
                _buildExerciseTile(i, _currentExercises[i], textColor, isDark),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildExerciseTile(
    int index,
    ExerciseDetail exercise,
    Color textColor,
    bool isDark,
  ) {
    return Container(
      key: ValueKey(exercise.name + index.toString()),
      margin: const EdgeInsets.only(bottom: 10),
      decoration: BoxDecoration(
        color: isDark ? Colors.white10 : Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          if (!isDark)
            BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 4),
        ],
      ),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 12),
        leading: const Icon(Icons.drag_handle, color: Colors.grey),
        title: Text(
          exercise.name,
          style: TextStyle(color: textColor, fontWeight: FontWeight.bold),
        ),
        subtitle: Text(
          "${exercise.sets} Sets ‚Ä¢ ${exercise.reps} Reps ‚Ä¢ ${exercise.weight}kg",
          style: TextStyle(
            color: Colors.deepOrange.withOpacity(0.8),
            fontSize: 12,
          ),
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            // SETTINGS BUTTON (Blue Area Logic)
            IconButton(
              icon: const Icon(
                Icons.tune_rounded,
                color: Colors.blue,
                size: 20,
              ),
              onPressed: () => _showSetDetailsDialog(index, exercise),
            ),
            IconButton(
              icon: const Icon(Icons.close, size: 18, color: Colors.red),
              onPressed: () =>
                  setState(() => _currentExercises.removeAt(index)),
            ),
          ],
        ),
      ),
    );
  }

  // --- EXERCISE SEARCH SHEET ---
  void _showExerciseSearch(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => ExerciseSearchSheet(
        onSelect: (exerciseName) {
          setState(
            () => _currentExercises.add(ExerciseDetail(name: exerciseName)),
          );
          Navigator.pop(ctx);
        },
      ),
    );
  }

  // --- SET DETAILS DIALOG ---
  void _showSetDetailsDialog(int index, ExerciseDetail exercise) {
    final setsCtrl = TextEditingController(text: exercise.sets.toString());
    final repsCtrl = TextEditingController(text: exercise.reps.toString());
    final weightCtrl = TextEditingController(text: exercise.weight.toString());
    final isDark = Theme.of(context).brightness == Brightness.dark;

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        title: Text(
          "Target Goals",
          style: TextStyle(color: isDark ? Colors.white : Colors.black87),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildDialogInput("Sets", setsCtrl, isDark),
            const SizedBox(height: 12),
            _buildDialogInput("Reps", repsCtrl, isDark),
            const SizedBox(height: 12),
            _buildDialogInput("Weight (kg)", weightCtrl, isDark),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text("Cancel", style: TextStyle(color: Colors.grey)),
          ),
          TextButton(
            onPressed: () {
              setState(() {
                _currentExercises[index].sets =
                    int.tryParse(setsCtrl.text) ?? 3;
                _currentExercises[index].reps =
                    int.tryParse(repsCtrl.text) ?? 10;
                _currentExercises[index].weight =
                    double.tryParse(weightCtrl.text) ?? 0.0;
              });
              Navigator.pop(ctx);
            },
            child: const Text(
              "Save",
              style: TextStyle(
                color: Colors.deepOrange,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDialogInput(
    String label,
    TextEditingController ctrl,
    bool isDark,
  ) {
    return TextField(
      controller: ctrl,
      keyboardType: TextInputType.number,
      style: TextStyle(color: isDark ? Colors.white : Colors.black87),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(color: Colors.grey),
        enabledBorder: OutlineInputBorder(
          borderSide: BorderSide(color: Colors.grey.withOpacity(0.3)),
        ),
        focusedBorder: const OutlineInputBorder(
          borderSide: BorderSide(color: Colors.deepOrange),
        ),
      ),
    );
  }
}

// --- SMART SEARCH SHEET ---
class ExerciseSearchSheet extends StatefulWidget {
  final Function(String) onSelect;
  const ExerciseSearchSheet({super.key, required this.onSelect});

  @override
  State<ExerciseSearchSheet> createState() => _ExerciseSearchSheetState();
}

class _ExerciseSearchSheetState extends State<ExerciseSearchSheet> {
  final TextEditingController _searchCtrl = TextEditingController();
  List<String> _filteredList = [];

  @override
  void initState() {
    super.initState();
    _filteredList = _masterExerciseList;
  }

  void _filter(String query) {
    setState(() {
      if (query.isEmpty) {
        _filteredList = _masterExerciseList;
      } else {
        _filteredList = _masterExerciseList
            .where((ex) => ex.toLowerCase().contains(query.toLowerCase()))
            .toList();
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    final bgColor = isDark ? Colors.black26 : Colors.grey.shade100;

    return Padding(
      padding: EdgeInsets.only(
        top: 20,
        left: 20,
        right: 20,
        bottom: MediaQuery.of(context).viewInsets.bottom + 20,
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            "Add Exercise",
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: textColor,
            ),
          ),
          const SizedBox(height: 15),
          TextField(
            controller: _searchCtrl,
            onChanged: _filter,
            autofocus: true,
            style: TextStyle(color: textColor),
            decoration: InputDecoration(
              hintText: "Search (e.g. Bench...)",
              hintStyle: const TextStyle(color: Colors.grey),
              prefixIcon: const Icon(Icons.search, color: Colors.grey),
              filled: true,
              fillColor: bgColor,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide.none,
              ),
              contentPadding: const EdgeInsets.symmetric(horizontal: 16),
            ),
          ),
          const SizedBox(height: 10),
          SizedBox(
            height: 300,
            child: _filteredList.isEmpty
                ? Center(
                    child: ElevatedButton.icon(
                      onPressed: () {
                        // LOGIC FIX: MEMORY UPDATE
                        // This ensures Arnold Press is saved for future searches in this session
                        _masterExerciseList.add(_searchCtrl.text);
                        widget.onSelect(_searchCtrl.text);
                      },
                      icon: const Icon(Icons.add),
                      label: Text("Create '${_searchCtrl.text}'"),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.deepOrange,
                        foregroundColor: Colors.white,
                      ),
                    ),
                  )
                : ListView.separated(
                    itemCount: _filteredList.length,
                    separatorBuilder: (ctx, i) =>
                        Divider(color: Colors.grey.withOpacity(0.1)),
                    itemBuilder: (ctx, i) {
                      return ListTile(
                        title: Text(
                          _filteredList[i],
                          style: TextStyle(color: textColor),
                        ),
                        trailing: const Icon(
                          Icons.add_circle_outline,
                          color: Colors.deepOrange,
                        ),
                        onTap: () => widget.onSelect(_filteredList[i]),
                      );
                    },
                  ),
          ),
        ],
      ),
    );
  }
}
*/

hydration.dart:
import 'package:flutter/material.dart';

class HydrationCard extends StatelessWidget {
  final String title;
  final IconData icon;
  final Color color;
  final int value;
  final int multiplier;
  final String unit;
  final VoidCallback onAdd;
  final VoidCallback onRemove;
  final Function(int) onEditMultiplier;

  const HydrationCard({
    super.key,
    required this.title,
    required this.icon,
    required this.color,
    required this.value,
    required this.multiplier,
    required this.unit,
    required this.onAdd,
    required this.onRemove,
    required this.onEditMultiplier,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    final totalAmount = value * multiplier;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: cardColor,
        borderRadius: BorderRadius.circular(24),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Icon(icon, color: color, size: 22),
                  const SizedBox(width: 8),
                  Text(
                    title,
                    style: TextStyle(
                      color: Colors.grey.shade600,
                      fontSize: 13,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              GestureDetector(
                onTap: () => _showConfigSheet(context),
                child: const Icon(
                  Icons.settings_outlined,
                  size: 18,
                  color: Colors.grey,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            "$totalAmount $unit",
            style: TextStyle(
              fontSize: 26,
              fontWeight: FontWeight.bold,
              color: textColor,
            ),
          ), // Bigger
          Text(
            "$value x $multiplier$unit",
            style: const TextStyle(fontSize: 12, color: Colors.grey),
          ), // Bigger
          const Spacer(),
          Container(
            padding: const EdgeInsets.all(4),
            decoration: BoxDecoration(
              color: isDark ? Colors.black26 : Colors.grey.shade100,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                _ctrlBtn(Icons.remove, onRemove, isDark),
                _ctrlBtn(Icons.add, onAdd, isDark),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _ctrlBtn(IconData i, VoidCallback onTap, bool isDark) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(8),
        decoration: BoxDecoration(
          color: isDark ? Colors.white10 : Colors.white,
          shape: BoxShape.circle,
        ),
        child: Icon(i, size: 20, color: color),
      ),
    );
  }

  void _showConfigSheet(BuildContext context) {
    final ctrl = TextEditingController(text: multiplier.toString());
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: bgColor,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) {
        return Padding(
          padding: EdgeInsets.only(
            bottom: MediaQuery.of(ctx).viewInsets.bottom + 20,
            left: 24,
            right: 24,
            top: 24,
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                "Set $title Unit Size",
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: textColor,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                "How much is one tap?",
                style: TextStyle(color: Colors.grey.shade500, fontSize: 14),
              ),
              const SizedBox(height: 20),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                decoration: BoxDecoration(
                  color: isDark ? Colors.black26 : Colors.grey.shade100,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: color.withOpacity(0.3)),
                ),
                child: TextField(
                  controller: ctrl,
                  keyboardType: TextInputType.number,
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: textColor,
                  ),
                  decoration: InputDecoration(
                    border: InputBorder.none,
                    suffixText: unit,
                    suffixStyle: TextStyle(color: Colors.grey, fontSize: 16),
                  ),
                  autofocus: true,
                ),
              ),
              const SizedBox(height: 24),
              SizedBox(
                width: double.infinity,
                height: 55,
                child: ElevatedButton(
                  onPressed: () {
                    if (ctrl.text.isNotEmpty) {
                      onEditMultiplier(int.parse(ctrl.text));
                    }
                    Navigator.pop(ctx);
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: color,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: const Text(
                    "Save Configuration",
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}

weight_dialog.dart:
import 'package:flutter/material.dart';
import '../../../models/health_model.dart';

class NutritionCard extends StatelessWidget {
  final HealthDailyLog log;
  final Function(FoodItem) onAddFood;
  final Function(bool) onDietToggle;

  const NutritionCard({
    super.key,
    required this.log,
    required this.onAddFood,
    required this.onDietToggle,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Container(
      decoration: BoxDecoration(
        color: cardColor,
        borderRadius: BorderRadius.circular(24),
      ),
      child: InkWell(
        onTap: () => _showFoodLog(context),
        borderRadius: BorderRadius.circular(24),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // 1. TOP: Title + Icon
              Row(
                children: [
                  const Icon(
                    Icons.restaurant_menu_rounded,
                    color: Colors.green,
                    size: 28,
                  ),
                  const SizedBox(width: 8),
                  Text(
                    "Nutrition",
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      fontSize: 18,
                      color: textColor,
                    ),
                  ),
                ],
              ),

              // 2. MIDDLE: Calories + Macros
              Expanded(
                child: Center(
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        "${log.totalCalories}",
                        style: TextStyle(
                          fontSize: 34,
                          fontWeight: FontWeight.bold,
                          color: textColor,
                          height: 1.0,
                        ),
                      ),
                      const Text(
                        "kcal",
                        style: TextStyle(fontSize: 14, color: Colors.grey),
                      ),

                      if (log.useMacros) ...[
                        const SizedBox(height: 12),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            _miniMacro("P", log.totalProtein, Colors.red),
                            const SizedBox(width: 16),
                            _miniMacro("C", log.totalCarbs, Colors.blue),
                            const SizedBox(width: 16),
                            _miniMacro("F", log.totalFat, Colors.orange),
                          ],
                        ),
                      ],
                    ],
                  ),
                ),
              ),

              // 3. BOTTOM: Controls
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Transform.scale(
                    scale: 0.8,
                    alignment: Alignment.centerLeft,
                    child: Switch(
                      value: log.useMacros,
                      onChanged: onDietToggle,
                      activeThumbColor: Colors.green,
                      activeTrackColor: Colors.green.withOpacity(0.2),
                      inactiveThumbColor: Colors.grey,
                      inactiveTrackColor: isDark
                          ? Colors.black26
                          : Colors.grey.shade200,
                    ),
                  ),

                  GestureDetector(
                    onTap: () => _showProfessionalAddSheet(context),
                    child: Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: Colors.green.withOpacity(0.1),
                        shape: BoxShape.circle,
                      ),
                      child: const Icon(
                        Icons.add,
                        color: Colors.green,
                        size: 24,
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _miniMacro(String label, int val, Color color) {
    return Column(
      children: [
        Text(
          "$val",
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: color,
            fontSize: 14,
          ),
        ),
        Text(
          label,
          style: TextStyle(
            color: color.withOpacity(0.6),
            fontSize: 10,
            fontWeight: FontWeight.bold,
          ),
        ),
      ],
    );
  }

  void _showProfessionalAddSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => AddFoodSheet(onAdd: onAddFood),
    );
  }

  void _showFoodLog(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => FoodLogSheet(foodLog: log.foodLog),
    );
  }
}

// --- NEW PROFESSIONAL FOOD LOG SHEET ---
class FoodLogSheet extends StatefulWidget {
  final List<FoodItem> foodLog;
  const FoodLogSheet({super.key, required this.foodLog});

  @override
  State<FoodLogSheet> createState() => _FoodLogSheetState();
}

class _FoodLogSheetState extends State<FoodLogSheet> {
  bool _showDetails = false;

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;

    return DraggableScrollableSheet(
      initialChildSize: 0.7,
      maxChildSize: 0.9,
      minChildSize: 0.5,
      expand: false,
      builder: (_, scrollController) {
        return Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            children: [
              // Header
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    "Today's Food Log",
                    style: TextStyle(
                      fontSize: 22,
                      fontWeight: FontWeight.bold,
                      color: textColor,
                    ),
                  ),
                  Row(
                    children: [
                      Text(
                        "Details",
                        style: TextStyle(
                          color: Colors.grey.shade600,
                          fontSize: 12,
                        ),
                      ),
                      const SizedBox(width: 8),
                      Switch(
                        value: _showDetails,
                        onChanged: (val) => setState(() => _showDetails = val),
                        activeThumbColor: Colors.green,
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 20),

              // List
              Expanded(
                child: widget.foodLog.isEmpty
                    ? Center(
                        child: Text(
                          "No food logged yet.",
                          style: TextStyle(color: Colors.grey.shade600),
                        ),
                      )
                    : ListView.separated(
                        controller: scrollController,
                        itemCount: widget.foodLog.length,
                        separatorBuilder: (ctx, i) =>
                            const SizedBox(height: 12),
                        itemBuilder: (ctx, index) {
                          final item = widget.foodLog[index];
                          return Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 16,
                              vertical: 12,
                            ),
                            decoration: BoxDecoration(
                              color: isDark
                                  ? Colors.black26
                                  : Colors.grey.shade100,
                              borderRadius: BorderRadius.circular(16),
                            ),
                            child: Column(
                              children: [
                                Row(
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  children: [
                                    Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          item.name,
                                          style: TextStyle(
                                            fontWeight: FontWeight.bold,
                                            fontSize: 16,
                                            color: textColor,
                                          ),
                                        ),
                                        Text(
                                          "${item.timestamp.hour}:${item.timestamp.minute.toString().padLeft(2, '0')}",
                                          style: const TextStyle(
                                            color: Colors.grey,
                                            fontSize: 12,
                                          ),
                                        ),
                                      ],
                                    ),
                                    Text(
                                      "${item.calories} kcal",
                                      style: TextStyle(
                                        fontSize: 16,
                                        fontWeight: FontWeight.bold,
                                        color: Colors.green.shade400,
                                      ),
                                    ),
                                  ],
                                ),
                                if (_showDetails) ...[
                                  const SizedBox(height: 12),
                                  const Divider(height: 1),
                                  const SizedBox(height: 12),
                                  Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceAround,
                                    children: [
                                      _microTag(
                                        "Protein",
                                        "${item.protein}g",
                                        Colors.red,
                                      ),
                                      _microTag(
                                        "Carbs",
                                        "${item.carbs}g",
                                        Colors.blue,
                                      ),
                                      _microTag(
                                        "Fat",
                                        "${item.fat}g",
                                        Colors.orange,
                                      ),
                                    ],
                                  ),
                                ],
                              ],
                            ),
                          );
                        },
                      ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _microTag(String label, String val, Color color) {
    return Row(
      children: [
        Container(
          width: 8,
          height: 8,
          decoration: BoxDecoration(color: color, shape: BoxShape.circle),
        ),
        const SizedBox(width: 6),
        Text(
          "$label: ",
          style: const TextStyle(color: Colors.grey, fontSize: 12),
        ),
        Text(
          val,
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: color,
            fontSize: 12,
          ),
        ),
      ],
    );
  }
}

// --- ADD FOOD SHEET (Unchanged) ---
class AddFoodSheet extends StatefulWidget {
  final Function(FoodItem) onAdd;
  const AddFoodSheet({super.key, required this.onAdd});

  @override
  State<AddFoodSheet> createState() => _AddFoodSheetState();
}

class _AddFoodSheetState extends State<AddFoodSheet> {
  final nameCtrl = TextEditingController();
  final calCtrl = TextEditingController();
  final pCtrl = TextEditingController();
  final cCtrl = TextEditingController();
  final fCtrl = TextEditingController();
  bool _isDetailed = false;

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    final inputBg = isDark ? Colors.black26 : Colors.grey.shade100;

    return Padding(
      padding: EdgeInsets.only(
        bottom: MediaQuery.of(context).viewInsets.bottom,
      ),
      child: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    "Add Food",
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: textColor,
                    ),
                  ),
                  Row(
                    children: [
                      const Text(
                        "Detailed",
                        style: TextStyle(color: Colors.grey, fontSize: 12),
                      ),
                      Switch(
                        value: _isDetailed,
                        onChanged: (val) => setState(() => _isDetailed = val),
                        activeThumbColor: Colors.green,
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 20),
              _buildInput(nameCtrl, "Food Name", inputBg, textColor),
              const SizedBox(height: 12),
              _buildInput(
                calCtrl,
                "Calories (kcal)",
                inputBg,
                textColor,
                isNum: true,
              ),
              const SizedBox(height: 12),
              if (_isDetailed) ...[
                Row(
                  children: [
                    Expanded(
                      child: _buildInput(
                        pCtrl,
                        "Protein",
                        inputBg,
                        textColor,
                        isNum: true,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: _buildInput(
                        cCtrl,
                        "Carbs",
                        inputBg,
                        textColor,
                        isNum: true,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: _buildInput(
                        fCtrl,
                        "Fat",
                        inputBg,
                        textColor,
                        isNum: true,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
              ],
              const SizedBox(height: 10),
              SizedBox(
                width: double.infinity,
                height: 55,
                child: ElevatedButton(
                  onPressed: () {
                    if (nameCtrl.text.isNotEmpty && calCtrl.text.isNotEmpty) {
                      widget.onAdd(
                        FoodItem(
                          name: nameCtrl.text,
                          calories: int.tryParse(calCtrl.text) ?? 0,
                          protein: int.tryParse(pCtrl.text) ?? 0,
                          carbs: int.tryParse(cCtrl.text) ?? 0,
                          fat: int.tryParse(fCtrl.text) ?? 0,
                          timestamp: DateTime.now(),
                        ),
                      );
                      Navigator.pop(context);
                    }
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.green,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: const Text(
                    "Add to Log",
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                  ),
                ),
              ),
              SizedBox(height: MediaQuery.of(context).padding.bottom + 10),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildInput(
    TextEditingController ctrl,
    String hint,
    Color bg,
    Color text, {
    bool isNum = false,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),
      decoration: BoxDecoration(
        color: bg,
        borderRadius: BorderRadius.circular(12),
      ),
      child: TextField(
        controller: ctrl,
        keyboardType: isNum ? TextInputType.number : TextInputType.text,
        style: TextStyle(color: text),
        decoration: InputDecoration(
          border: InputBorder.none,
          hintText: hint,
          hintStyle: const TextStyle(color: Colors.grey, fontSize: 13),
        ),
      ),
    );
  }
}
weigth_dialog.dart:
import 'package:flutter/material.dart';

class WeightPickerDialog extends StatefulWidget {
  final double initialWeight;
  final Function(double) onWeightChanged;

  const WeightPickerDialog({
    super.key,
    required this.initialWeight,
    required this.onWeightChanged,
  });

  @override
  State<WeightPickerDialog> createState() => _WeightPickerDialogState();
}

class _WeightPickerDialogState extends State<WeightPickerDialog> {
  late double _currentWeight;

  @override
  void initState() {
    super.initState();
    _currentWeight = widget.initialWeight > 0 ? widget.initialWeight : 70.0;
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final color = Colors.deepPurpleAccent;

    return Dialog(
      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              "Update Weight",
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : Colors.black,
              ),
            ),
            const SizedBox(height: 24),
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              crossAxisAlignment: CrossAxisAlignment.baseline,
              textBaseline: TextBaseline.alphabetic,
              children: [
                Text(
                  _currentWeight.toStringAsFixed(1),
                  style: TextStyle(
                    fontSize: 48,
                    fontWeight: FontWeight.bold,
                    color: color,
                  ),
                ),
                const SizedBox(width: 8),
                Text(
                  "kg",
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: isDark ? Colors.grey : Colors.black54,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 24),
            SliderTheme(
              data: SliderTheme.of(context).copyWith(
                activeTrackColor: color,
                inactiveTrackColor: color.withOpacity(0.2),
                thumbColor: color,
                overlayColor: color.withOpacity(0.1),
              ),
              child: Slider(
                value: _currentWeight,
                min: 30.0,
                max: 150.0,
                divisions: 1200,
                label: _currentWeight.toStringAsFixed(1),
                onChanged: (val) {
                  setState(() => _currentWeight = val);
                },
              ),
            ),
            const SizedBox(height: 8),
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                _buildFineTuneBtn(Icons.remove, () {
                  setState(() => _currentWeight -= 0.1);
                }, isDark),
                _buildFineTuneBtn(Icons.add, () {
                  setState(() => _currentWeight += 0.1);
                }, isDark),
              ],
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: color,
                  padding: const EdgeInsets.symmetric(vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                onPressed: () {
                  widget.onWeightChanged(
                    double.parse(_currentWeight.toStringAsFixed(1)),
                  );
                  Navigator.pop(context);
                },
                child: const Text(
                  "Save Entry",
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFineTuneBtn(IconData icon, VoidCallback onTap, bool isDark) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(30),
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: isDark ? Colors.grey.shade800 : Colors.grey.shade200,
          shape: BoxShape.circle,
        ),
        child: Icon(icon, color: isDark ? Colors.white : Colors.black),
      ),
    );
  }
}

grid.dart:
import 'package:flutter/material.dart';
import '../../models/health_model.dart';
import 'cards/nutrition.dart';
import 'cards/hydration.dart';
import 'activity/activity_card.dart';
import 'cards/weight_dialog.dart';

class HealthGrid extends StatelessWidget {
  final HealthDailyLog log;
  final Function(int) onWaterChanged;
  final Function(int) onCaffeineChanged;
  final Function(int) onMoodChanged;
  final Function(bool) onDietToggle;
  final Function(int) onStepsChanged;
  final Function(double) onWeightChanged;
  final Function(String?) onRoutineChanged;
  final Function(bool) onWorkoutToggle;
  final Function(FoodItem) onAddFood;
  final Function(int) onUpdateGlassSize;
  final Function(int) onCaloriesChanged;
  final Function(int, int, int) onMacrosChanged;
  final VoidCallback onExerciseUpdated;

  const HealthGrid({
    super.key,
    required this.log,
    required this.onWaterChanged,
    required this.onCaffeineChanged,
    required this.onMoodChanged,
    required this.onDietToggle,
    required this.onStepsChanged,
    required this.onWeightChanged,
    required this.onRoutineChanged,
    required this.onWorkoutToggle,
    required this.onAddFood,
    required this.onUpdateGlassSize,
    required this.onCaloriesChanged,
    required this.onMacrosChanged,
    required this.onExerciseUpdated,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        children: [
          // GYM & NUTRITION
          IntrinsicHeight(
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                Expanded(
                  child: ActivityCard(
                    log: log,
                    onRoutineChanged: onRoutineChanged,
                    onWorkoutToggle: onWorkoutToggle,
                    onStepsChanged: onStepsChanged,
                    onWeightChanged: onWeightChanged,
                    onExerciseUpdated: onExerciseUpdated,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: NutritionCard(
                    log: log,
                    onAddFood: onAddFood,
                    onDietToggle: onDietToggle,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),

          // STEPS & WEIGHT
          Row(
            children: [
              Expanded(
                child: _buildSimpleCard(
                  context,
                  Icons.directions_walk,
                  "Steps",
                  "${log.steps}",
                  "steps",
                  Colors.orange,
                  cardColor,
                  () => onStepsChanged(log.steps),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(child: _buildWeightCard(context)),
            ],
          ),
          const SizedBox(height: 16),

          // HYDRATION
          Row(
            children: [
              Expanded(
                child: SizedBox(
                  height: 180,
                  child: HydrationCard(
                    title: "Water",
                    icon: Icons.water_drop,
                    color: Colors.blue,
                    value: log.waterGlasses,
                    multiplier: log.waterGlassSizeMl,
                    unit: "ml",
                    onAdd: () => onWaterChanged(log.waterGlasses + 1),
                    onRemove: () => onWaterChanged(
                      log.waterGlasses > 0 ? log.waterGlasses - 1 : 0,
                    ),
                    onEditMultiplier: onUpdateGlassSize,
                  ),
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: SizedBox(
                  height: 180,
                  child: HydrationCard(
                    title: "Caffeine",
                    icon: Icons.coffee,
                    color: Colors.brown,
                    value: log.caffeineAmount,
                    multiplier: 95, // Avg mg per cup
                    unit: "mg",
                    // FIX: Changed +50 to +1 (1 cup)
                    onAdd: () => onCaffeineChanged(log.caffeineAmount + 1),
                    onRemove: () => onCaffeineChanged(
                      log.caffeineAmount > 0 ? log.caffeineAmount - 1 : 0,
                    ),
                    onEditMultiplier: (val) {},
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),

          // MOOD
          Container(
            padding: const EdgeInsets.symmetric(vertical: 16),
            decoration: BoxDecoration(
              color: cardColor,
              borderRadius: BorderRadius.circular(24),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              children: [1, 2, 3, 4, 5].map((level) {
                final isSelected = log.mood == level;
                final emojis = ["üò´", "üòê", "üôÇ", "üòÅ", "ü§©"];
                return GestureDetector(
                  onTap: () => onMoodChanged(level),
                  child: AnimatedScale(
                    scale: isSelected ? 1.2 : 1.0,
                    duration: const Duration(milliseconds: 200),
                    child: Opacity(
                      opacity: isSelected ? 1.0 : 0.5,
                      child: Text(
                        emojis[level - 1],
                        style: const TextStyle(fontSize: 28),
                      ),
                    ),
                  ),
                );
              }).toList(),
            ),
          ),
          const SizedBox(height: 80),
        ],
      ),
    );
  }

  Widget _buildWeightCard(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;

    return Stack(
      children: [
        Container(
          height: 120,
          width: double.infinity,
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: cardColor,
            borderRadius: BorderRadius.circular(24),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Icon(
                Icons.monitor_weight_rounded,
                color: Colors.deepPurple,
                size: 28,
              ),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    "${log.weight}",
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: textColor,
                    ),
                  ),
                  const Text(
                    "kg",
                    style: TextStyle(fontSize: 13, color: Colors.grey),
                  ),
                ],
              ),
            ],
          ),
        ),
        Positioned(
          top: 0,
          right: 0,
          child: IconButton(
            icon: Icon(
              Icons.settings_outlined,
              color: Colors.grey.shade600,
              size: 20,
            ),
            onPressed: () {
              showDialog(
                context: context,
                builder: (context) => WeightPickerDialog(
                  initialWeight: log.weight,
                  onWeightChanged: onWeightChanged,
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildSimpleCard(
    BuildContext context,
    IconData icon,
    String title,
    String value,
    String unit,
    Color color,
    Color bg,
    VoidCallback onTap,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    return Material(
      color: bg,
      borderRadius: BorderRadius.circular(24),
      child: InkWell(
        borderRadius: BorderRadius.circular(24),
        onTap: onTap,
        child: Container(
          height: 120,
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Icon(icon, color: color, size: 28),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    value,
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: textColor,
                    ),
                  ),
                  Text(
                    title,
                    style: const TextStyle(fontSize: 13, color: Colors.grey),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

plan_view.dart:
import 'package:flutter/material.dart';
import '../../models/health_model.dart';
import 'activity/exercise_models.dart';
import 'activity/routine_manager.dart'; // Reuse for routine selection
import 'activity/routine_editor.dart'; // Reuse for exercise search
import 'activity/set_editor.dart'; // Reuse for set editing

class WorkoutPlanView extends StatefulWidget {
  final HealthDailyLog log;
  final Function(String) onRoutineChanged;
  final Function() onLogUpdated;

  const WorkoutPlanView({
    super.key,
    required this.log,
    required this.onRoutineChanged,
    required this.onLogUpdated,
  });

  @override
  State<WorkoutPlanView> createState() => _WorkoutPlanViewState();
}

class _WorkoutPlanViewState extends State<WorkoutPlanView> {
  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black87;
    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final accentColor = Colors.deepOrange;

    final hasRoutine = widget.log.workoutName != null;
    final exercises = widget.log.workoutLog;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. HEADER & ROUTINE SELECTOR
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    "Target Routine",
                    style: TextStyle(
                      color: Colors.grey.shade500,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  GestureDetector(
                    onTap: () => _showRoutineManager(context),
                    child: Row(
                      children: [
                        Text(
                          hasRoutine
                              ? widget.log.workoutName!
                              : "Select Routine",
                          style: TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                            color: hasRoutine ? textColor : Colors.grey,
                          ),
                        ),
                        const SizedBox(width: 8),
                        Icon(
                          Icons.keyboard_arrow_down_rounded,
                          color: accentColor,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              // ADD BUTTON
              Container(
                decoration: BoxDecoration(
                  color: accentColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: IconButton(
                  icon: Icon(Icons.add, color: accentColor),
                  onPressed: () => _showExerciseSearch(context),
                ),
              ),
            ],
          ),

          const SizedBox(height: 20),

          // 2. EXERCISE LIST (Full Page)
          Expanded(
            child: exercises.isEmpty
                ? _buildEmptyState(isDark)
                : ReorderableListView.builder(
                    proxyDecorator: (child, index, animation) {
                      return Material(color: Colors.transparent, child: child);
                    },
                    itemCount: exercises.length,
                    onReorder: (oldIndex, newIndex) {
                      setState(() {
                        if (oldIndex < newIndex) newIndex -= 1;
                        final item = exercises.removeAt(oldIndex);
                        exercises.insert(newIndex, item);
                      });
                      widget.onLogUpdated(); // Save reorder
                    },
                    itemBuilder: (context, index) {
                      final exercise = exercises[index];
                      return _buildExerciseTile(
                        key: ValueKey("${exercise.name}_$index"),
                        exercise: exercise,
                        index: index,
                        isDark: isDark,
                        textColor: textColor,
                      );
                    },
                  ),
          ),
        ],
      ),
    );
  }

  Widget _buildExerciseTile({
    required Key key,
    required ExerciseDetail exercise,
    required int index,
    required bool isDark,
    required Color textColor,
  }) {
    return Container(
      key: key,
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isDark ? Colors.transparent : Colors.grey.shade100,
        ),
        boxShadow: isDark
            ? []
            : [
                BoxShadow(
                  color: Colors.black.withOpacity(0.03),
                  blurRadius: 10,
                  offset: const Offset(0, 4),
                ),
              ],
      ),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        leading: Container(
          padding: const EdgeInsets.all(10),
          decoration: BoxDecoration(
            color: isDark ? Colors.white10 : Colors.grey.shade100,
            shape: BoxShape.circle,
          ),
          child: Text(
            "${index + 1}",
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: isDark ? Colors.white54 : Colors.grey.shade700,
            ),
          ),
        ),
        title: Text(
          exercise.name,
          style: TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 16,
            color: textColor,
          ),
        ),
        subtitle: Text(
          "${exercise.sets.length} Sets Planned",
          style: TextStyle(color: Colors.grey.shade600, fontSize: 13),
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            IconButton(
              icon: const Icon(Icons.edit_note_rounded, color: Colors.blue),
              onPressed: () => _openSetEditor(context, exercise),
            ),
            IconButton(
              icon: Icon(
                Icons.delete_outline_rounded,
                color: Colors.red.withOpacity(0.6),
              ),
              onPressed: () {
                setState(() {
                  widget.log.workoutLog.removeAt(index);
                });
                widget.onLogUpdated();
              },
            ),
            // Drag handle implied by ReorderableListView, but we can add an icon if we want
            const Icon(Icons.drag_handle_rounded, color: Colors.grey, size: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState(bool isDark) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.edit_calendar_rounded,
            size: 60,
            color: Colors.grey.withOpacity(0.3),
          ),
          const SizedBox(height: 16),
          Text(
            "No Exercises Planned",
            style: TextStyle(
              color: Colors.grey.shade500,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            "Select a routine or add exercises manually.",
            style: TextStyle(color: Colors.grey.shade600, fontSize: 14),
          ),
        ],
      ),
    );
  }

  // --- HELPERS (Reusing existing sheets) ---

  void _showRoutineManager(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => DraggableScrollableSheet(
        initialChildSize: 0.6,
        maxChildSize: 0.9,
        minChildSize: 0.4,
        expand: false,
        builder: (_, scrollController) => RoutineManagerSheet(
          selectedRoutine: widget.log.workoutName,
          onSelected: (name) {
            widget.onRoutineChanged(name);

            // Auto-populate logic (Simple version for now)
            if (widget.log.workoutLog.isEmpty) {
              widget.log.workoutLog = _generateDefaultExercises(name);
            }
            widget.onLogUpdated();
            Navigator.pop(ctx);
          },
        ),
      ),
    );
  }

  void _showExerciseSearch(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Theme.of(context).brightness == Brightness.dark
          ? const Color(0xFF1E1E1E)
          : Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (ctx) => ExerciseSearchSheet(
        onSelect: (name) {
          setState(() {
            widget.log.workoutLog.add(ExerciseDetail(name: name));
          });
          widget.onLogUpdated();
          Navigator.pop(ctx);
        },
      ),
    );
  }

  void _openSetEditor(BuildContext context, ExerciseDetail exercise) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => SetEditorSheet(
        exerciseName: exercise.name,
        initialSets: exercise.sets,
        onSave: (updatedSets) {
          setState(() => exercise.sets = updatedSets);
          widget.onLogUpdated();
        },
      ),
    );
  }

  List<ExerciseDetail> _generateDefaultExercises(String routineName) {
    // Basic templates to get started quickly
    if (routineName.contains("Push")) {
      return [
        ExerciseDetail(name: "Bench Press"),
        ExerciseDetail(name: "Overhead Press"),
        ExerciseDetail(name: "Incline Dumbbell Press"),
        ExerciseDetail(name: "Tricep Pushdown"),
      ];
    } else if (routineName.contains("Pull")) {
      return [
        ExerciseDetail(name: "Deadlift"),
        ExerciseDetail(name: "Pull Ups"),
        ExerciseDetail(name: "Barbell Row"),
        ExerciseDetail(name: "Bicep Curl"),
      ];
    } else {
      return [
        ExerciseDetail(name: "Squat"),
        ExerciseDetail(name: "Leg Press"),
        ExerciseDetail(name: "Leg Extension"),
        ExerciseDetail(name: "Calf Raise"),
      ];
    }
  }
}

summary_card.dart:
import 'package:flutter/material.dart';
import '../../models/health_model.dart';
import 'activity/exercise_models.dart';

class HealthSummaryView extends StatelessWidget {
  final HealthDailyLog log;
  final VoidCallback onInspectDetails;
  final VoidCallback onBackToToday;

  const HealthSummaryView({
    super.key,
    required this.log,
    required this.onInspectDetails,
    required this.onBackToToday,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final cardBg = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final textColor = isDark ? Colors.white : Colors.black87;
    const accentColor = Colors.deepOrange;

    final isStepGoalMet = log.steps >= 10000;
    final hasWorkout = log.workoutName != null && log.workoutLog.isNotEmpty;

    return SingleChildScrollView(
      child: Center(
        child: Padding(
          padding: const EdgeInsets.fromLTRB(20, 20, 20, 80),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // 1. HEADER CARD
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: isStepGoalMet
                        ? [Colors.deepOrange, Colors.orange.shade800]
                        : [cardBg, cardBg],
                  ),
                  borderRadius: BorderRadius.circular(30),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black12,
                      blurRadius: 15,
                      offset: const Offset(0, 8),
                    ),
                  ],
                ),
                child: Column(
                  children: [
                    Icon(
                      isStepGoalMet
                          ? Icons.emoji_events
                          : Icons.bar_chart_rounded,
                      size: 48,
                      color: isStepGoalMet ? Colors.white : accentColor,
                    ),
                    const SizedBox(height: 12),
                    Text(
                      isStepGoalMet ? "Goal Crushed!" : "Daily Recap",
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                        color: isStepGoalMet ? Colors.white : textColor,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      "${log.steps} Steps ‚Ä¢ ${log.totalCalories} kcal",
                      style: TextStyle(
                        color: isStepGoalMet ? Colors.white70 : Colors.grey,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 24),

              // 2. WORKOUT LIST (Fixed Alignment)
              if (hasWorkout) ...[
                Align(
                  alignment: Alignment.centerLeft,
                  child: Text(
                    "Workout Log",
                    style: TextStyle(
                      color: Colors.grey.shade500,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                const SizedBox(height: 10),
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: cardBg,
                    borderRadius: BorderRadius.circular(24),
                  ),
                  child: Column(
                    // FIX: This forces everything to the LEFT (Start)
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Container(
                            padding: const EdgeInsets.all(8),
                            decoration: BoxDecoration(
                              color: accentColor.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: const Icon(
                              Icons.fitness_center,
                              color: accentColor,
                              size: 18,
                            ),
                          ),
                          const SizedBox(width: 12),
                          Text(
                            log.workoutName!,
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: textColor,
                              fontSize: 16,
                            ),
                          ),
                        ],
                      ),
                      const Padding(
                        padding: EdgeInsets.symmetric(vertical: 12.0),
                        child: Divider(height: 1),
                      ),
                      ...log.workoutLog.map(
                        (exercise) => Padding(
                          padding: const EdgeInsets.only(bottom: 12.0),
                          child: Column(
                            // FIX: Inner column also sticks to start
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                exercise.name,
                                style: TextStyle(
                                  color: textColor,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Wrap(
                                spacing: 8,
                                children: exercise.sets
                                    .map(
                                      (s) => Text(
                                        "${s.weight.toInt()}kg x ${s.reps}",
                                        style: TextStyle(
                                          color: Colors.grey.shade600,
                                          fontSize: 12,
                                        ),
                                      ),
                                    )
                                    .toList(),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],

              const SizedBox(height: 30),

              // 3. ACTIONS
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: onBackToToday,
                      style: OutlinedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        side: BorderSide(color: Colors.grey.withOpacity(0.3)),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                      ),
                      child: Text(
                        "Back to Today",
                        style: TextStyle(color: textColor),
                      ),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: onInspectDetails,
                      style: ElevatedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        backgroundColor: accentColor,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                      ),
                      child: const Text(
                        "Edit Log",
                        style: TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

add_lesson_dialog.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:firebase_auth/firebase_auth.dart'; // IMPORT ADDED
import '../../models/lesson.dart';

class AddLessonDialog extends StatefulWidget {
  final Map<String, String> courseDatabase;
  final Function(Lesson) onAddLesson;
  final Future<void> Function(String, String) onUpdateGlobal;
  final DateTime selectedDate;
  // Optional parameters for Editing
  final Lesson? lessonToEdit;
  final Function(String)? onDelete;

  const AddLessonDialog({
    super.key,
    required this.courseDatabase,
    required this.onAddLesson,
    required this.onUpdateGlobal,
    required this.selectedDate,
    this.lessonToEdit,
    this.onDelete,
  });

  @override
  State<AddLessonDialog> createState() => _AddLessonDialogState();
}

class _AddLessonDialogState extends State<AddLessonDialog> {
  // Controllers
  late TextEditingController _roomController;
  late TextEditingController _instructorController;
  late TextEditingController _descriptionController;
  late TextEditingController _startTimeController;
  late TextEditingController _courseNameController;

  int _selectedDuration = 60;
  bool _isLecture = true;
  bool _isInstructorLocked = false;
  bool _isRecurring = true;

  final List<int> _durations = [30, 45, 60, 90, 120, 180, 240];

  @override
  void initState() {
    super.initState();
    final edit = widget.lessonToEdit;

    // 1. Pre-fill Controllers
    _roomController = TextEditingController(text: edit?.room ?? '');
    _instructorController = TextEditingController(text: edit?.instructor ?? '');
    _descriptionController = TextEditingController(
      text: edit?.description ?? '',
    );

    // Format start time for the controller
    String initialTimeStr = '';
    if (edit != null) {
      final h = edit.startTimeInMinutes ~/ 60;
      final m = edit.startTimeInMinutes % 60;
      initialTimeStr =
          '${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}';
    }
    _startTimeController = TextEditingController(text: initialTimeStr);
    _courseNameController = TextEditingController(text: edit?.name ?? '');

    // 2. Pre-fill State booleans
    if (edit != null) {
      _isLecture = edit.isLecture;
      _isRecurring = edit.isRecurring;
      _selectedDuration = edit.durationInMinutes;
      if (edit.instructor.isNotEmpty) {
        _isInstructorLocked = true;
      }
    }
  }

  String _toTitleCase(String text) {
    if (text.isEmpty) return text;
    return text
        .split(' ')
        .map((word) {
          if (word.isEmpty) return '';
          return word[0].toUpperCase() + word.substring(1).toLowerCase();
        })
        .join(' ');
  }

  Future<void> _selectTime() async {
    TimeOfDay initial = TimeOfDay.now();
    if (_startTimeController.text.isNotEmpty) {
      try {
        final parts = _startTimeController.text.split(':');
        initial = TimeOfDay(
          hour: int.parse(parts[0]),
          minute: int.parse(parts[1]),
        );
      } catch (_) {}
    }

    final TimeOfDay? picked = await showTimePicker(
      context: context,
      initialTime: initial,
      builder: (context, child) =>
          Theme(data: Theme.of(context), child: child!),
    );
    if (picked != null) {
      setState(() {
        _startTimeController.text =
            '${picked.hour.toString().padLeft(2, '0')}:${picked.minute.toString().padLeft(2, '0')}';
      });
    }
  }

  void _onCourseNameChanged(String value) {
    final key = widget.courseDatabase.keys.firstWhere(
      (k) => k.toLowerCase() == value.toLowerCase(),
      orElse: () => '',
    );

    if (key.isNotEmpty) {
      if (_instructorController.text != widget.courseDatabase[key]!) {
        setState(() {
          _instructorController.text = widget.courseDatabase[key]!;
          _isInstructorLocked = true;
        });
      }
    } else {
      if (_isInstructorLocked && !_isLecture) {
        setState(() => _isInstructorLocked = false);
      }
    }
  }

  // Cancel Button logic included
  Future<bool?> _showProfessionalConfirmDialog(
    BuildContext context,
    String course,
    String oldProf,
    String newProf,
  ) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final primaryColor = Theme.of(context).primaryColor;
    final highlightColor = isDark ? Colors.deepPurpleAccent : primaryColor;

    return showDialog<bool?>(
      context: context,
      barrierDismissible: false,
      builder: (ctx) => Dialog(
        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Container(
          padding: const EdgeInsets.all(24.0),
          child: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: highlightColor.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(Icons.school, size: 32, color: highlightColor),
                ),
                const SizedBox(height: 16),
                Text(
                  "Professor Changed",
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: isDark ? Colors.white : Colors.black,
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  "Update instructor for '$course'?",
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    color: isDark ? Colors.white70 : Colors.black54,
                  ),
                ),
                const SizedBox(height: 20),
                // Comparison Box
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: isDark ? Colors.white10 : Colors.grey.shade100,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                    children: [
                      Expanded(
                        child: Column(
                          children: [
                            const Text(
                              "OLD",
                              style: TextStyle(
                                fontSize: 10,
                                fontWeight: FontWeight.bold,
                                color: Colors.grey,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              oldProf,
                              textAlign: TextAlign.center,
                              overflow: TextOverflow.ellipsis,
                              maxLines: 2,
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: isDark ? Colors.white70 : Colors.black87,
                              ),
                            ),
                          ],
                        ),
                      ),
                      const Padding(
                        padding: EdgeInsets.symmetric(horizontal: 8.0),
                        child: Icon(
                          Icons.arrow_forward,
                          size: 16,
                          color: Colors.grey,
                        ),
                      ),
                      Expanded(
                        child: Column(
                          children: [
                            const Text(
                              "NEW",
                              style: TextStyle(
                                fontSize: 10,
                                fontWeight: FontWeight.bold,
                                color: Colors.grey,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              newProf,
                              textAlign: TextAlign.center,
                              overflow: TextOverflow.ellipsis,
                              maxLines: 2,
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: isDark ? Colors.white : Colors.black,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 24),
                Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        style: OutlinedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          side: BorderSide(
                            color: isDark
                                ? Colors.white24
                                : Colors.grey.shade300,
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        onPressed: () => Navigator.pop(ctx, false),
                        child: Text(
                          "Only This Class",
                          textAlign: TextAlign.center,
                          style: TextStyle(
                            color: isDark ? Colors.white70 : Colors.black87,
                            fontSize: 12,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          backgroundColor: highlightColor,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        onPressed: () => Navigator.pop(ctx, true),
                        child: const Text(
                          "Update All",
                          textAlign: TextAlign.center,
                          style: TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 12,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                TextButton(
                  onPressed: () =>
                      Navigator.pop(ctx, null), // null means cancel
                  child: Text(
                    "Cancel",
                    style: TextStyle(color: Colors.grey.shade500),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _submit() async {
    if (_courseNameController.text.isEmpty ||
        _startTimeController.text.isEmpty) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('Missing Name or Time')));
      return;
    }

    // --- NEW: GET CURRENT USER ---
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) {
      print("No user logged in!");
      return;
    }

    String finalCourseName = _toTitleCase(_courseNameController.text.trim());
    final existingKey = widget.courseDatabase.keys.firstWhere(
      (k) => k.toLowerCase() == finalCourseName.toLowerCase(),
      orElse: () => '',
    );
    if (existingKey.isNotEmpty) finalCourseName = existingKey;

    String finalInstructor = _toTitleCase(_instructorController.text.trim());

    bool performGlobalUpdate = false;

    // Check for professor change
    if (existingKey.isNotEmpty && _isLecture) {
      final oldInstructor = widget.courseDatabase[existingKey]!;
      if (oldInstructor.isNotEmpty && oldInstructor != finalInstructor) {
        final result = await _showProfessionalConfirmDialog(
          context,
          finalCourseName,
          oldInstructor,
          finalInstructor,
        );

        if (result == null) {
          // User clicked Cancel, abort save
          return;
        }
        performGlobalUpdate = result;
      }
    }

    if (performGlobalUpdate) {
      widget.courseDatabase[finalCourseName] = finalInstructor;
    }

    final parts = _startTimeController.text.split(':');
    final startMin = int.parse(parts[0]) * 60 + int.parse(parts[1]);

    final dayName = DateFormat('EEEE').format(widget.selectedDate);
    final dateString = DateFormat('yyyy-MM-dd').format(widget.selectedDate);

    final newLesson = Lesson(
      id: widget.lessonToEdit?.id,
      userId: user.uid, // <--- CHANGED FROM 'test_user' to REAL ID
      name: finalCourseName,
      room: _isLecture ? _roomController.text : '',
      instructor: _isLecture ? finalInstructor : '',
      description: _isLecture ? '' : _descriptionController.text,
      isLecture: _isLecture,
      isRecurring: _isRecurring,
      dayOfWeek: widget.lessonToEdit?.dayOfWeek ?? dayName,
      startTimeInMinutes: startMin,
      durationInMinutes: _selectedDuration,
      specificDate: _isRecurring ? '' : dateString,
      excludeDates: widget.lessonToEdit?.excludeDates ?? [],
    );

    try {
      if (performGlobalUpdate) {
        await widget.onUpdateGlobal(finalCourseName, finalInstructor);
      }
      widget.onAddLesson(newLesson);
      if (mounted) Navigator.of(context).pop();
    } catch (e) {
      debugPrint("Error saving: $e");
    }
  }

  @override
  Widget build(BuildContext context) {
    final isEditing = widget.lessonToEdit != null;
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final primaryColor = Theme.of(context).primaryColor;
    final accentColor = isDark ? Colors.deepPurpleAccent : primaryColor;
    final dayName = DateFormat('EEEE').format(widget.selectedDate);

    return AlertDialog(
      scrollable: true,
      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      title: Center(
        child: Text(
          isEditing ? 'Edit Event' : 'Add Event',
          style: const TextStyle(fontWeight: FontWeight.bold),
        ),
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 24, vertical: 10),
      content: SizedBox(
        width: MediaQuery.of(context).size.width * 0.9,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Row(
              children: [
                Expanded(
                  child: ChoiceChip(
                    label: const Center(child: Text("üéì Class")),
                    selected: _isLecture,
                    onSelected: (val) => setState(() => _isLecture = true),
                    selectedColor: accentColor.withOpacity(0.3),
                    backgroundColor: isDark
                        ? Colors.white10
                        : Colors.grey.shade200,
                    labelStyle: TextStyle(
                      color: _isLecture
                          ? (isDark ? Colors.white : accentColor)
                          : (isDark ? Colors.white70 : Colors.black54),
                      fontWeight: _isLecture
                          ? FontWeight.bold
                          : FontWeight.normal,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(20),
                    ),
                    side: BorderSide(
                      color: _isLecture
                          ? accentColor
                          : (isDark ? Colors.white12 : Colors.grey.shade300),
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: ChoiceChip(
                    label: const Center(child: Text("üìù Task")),
                    selected: !_isLecture,
                    onSelected: (val) => setState(() => _isLecture = false),
                    selectedColor: accentColor.withOpacity(0.3),
                    backgroundColor: isDark
                        ? Colors.white10
                        : Colors.grey.shade200,
                    labelStyle: TextStyle(
                      color: !_isLecture
                          ? (isDark ? Colors.white : accentColor)
                          : (isDark ? Colors.white70 : Colors.black54),
                      fontWeight: !_isLecture
                          ? FontWeight.bold
                          : FontWeight.normal,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(20),
                    ),
                    side: BorderSide(
                      color: !_isLecture
                          ? accentColor
                          : (isDark ? Colors.white12 : Colors.grey.shade300),
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),
              decoration: BoxDecoration(
                color: isDark ? Colors.white10 : Colors.grey.shade100,
                borderRadius: BorderRadius.circular(4),
                border: Border.all(
                  color: isDark ? Colors.white24 : Colors.grey.shade400,
                ),
              ),
              child: Text(
                dayName,
                style: TextStyle(
                  fontSize: 16,
                  color: isDark ? Colors.white70 : Colors.black87,
                ),
              ),
            ),
            const SizedBox(height: 12),
            Autocomplete<String>(
              initialValue: TextEditingValue(
                text: widget.lessonToEdit?.name ?? '',
              ),
              optionsBuilder: (TextEditingValue textEditingValue) {
                if (textEditingValue.text == '') {
                  return const Iterable<String>.empty();
                }
                return widget.courseDatabase.keys.where(
                  (String option) => option.toLowerCase().contains(
                    textEditingValue.text.toLowerCase(),
                  ),
                );
              },
              onSelected: (String selection) => _onCourseNameChanged(selection),
              fieldViewBuilder:
                  (context, controller, focusNode, onFieldSubmitted) {
                    _courseNameController = controller;
                    if (widget.lessonToEdit != null &&
                        controller.text.isEmpty &&
                        _courseNameController.text.isEmpty) {
                      controller.text = widget.lessonToEdit!.name;
                    }
                    return TextField(
                      controller: controller,
                      focusNode: focusNode,
                      onChanged: _onCourseNameChanged,
                      decoration: InputDecoration(
                        labelText: _isLecture ? 'Course Name' : 'Activity Name',
                        hintText: 'e.g. Math or Gym',
                        border: const OutlineInputBorder(),
                        isDense: true,
                        suffixIcon: const Icon(
                          Icons.search,
                          size: 20,
                          color: Colors.grey,
                        ),
                      ),
                    );
                  },
            ),
            const SizedBox(height: 12),
            if (_isLecture) ...[
              TextField(
                controller: _roomController,
                decoration: const InputDecoration(
                  labelText: 'Room',
                  border: OutlineInputBorder(),
                  isDense: true,
                ),
              ),
              const SizedBox(height: 12),
              TextField(
                controller: _instructorController,
                readOnly: _isInstructorLocked,
                decoration: InputDecoration(
                  labelText: 'Instructor',
                  border: const OutlineInputBorder(),
                  isDense: true,
                  filled: _isInstructorLocked,
                  fillColor: isDark ? Colors.white10 : Colors.grey.shade200,
                  suffixIcon: _isInstructorLocked
                      ? IconButton(
                          icon: const Icon(
                            Icons.edit,
                            size: 18,
                            color: Colors.grey,
                          ),
                          onPressed: () =>
                              setState(() => _isInstructorLocked = false),
                        )
                      : null,
                ),
              ),
            ] else ...[
              TextField(
                controller: _descriptionController,
                maxLines: 2,
                decoration: const InputDecoration(
                  labelText: 'Notes',
                  border: OutlineInputBorder(),
                  isDense: true,
                ),
              ),
            ],
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _startTimeController,
                    readOnly: true,
                    onTap: _selectTime,
                    decoration: const InputDecoration(
                      labelText: 'Start',
                      border: OutlineInputBorder(),
                      isDense: true,
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: DropdownButtonFormField<int>(
                    initialValue: _selectedDuration,
                    items: _durations
                        .map(
                          (m) =>
                              DropdownMenuItem(value: m, child: Text('$m m')),
                        )
                        .toList(),
                    onChanged: (v) => setState(() => _selectedDuration = v!),
                    decoration: const InputDecoration(
                      labelText: 'Duration',
                      border: OutlineInputBorder(),
                      isDense: true,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            Theme(
              data: Theme.of(context).copyWith(
                checkboxTheme: CheckboxThemeData(
                  side: BorderSide(
                    color: isDark ? Colors.white70 : Colors.grey,
                    width: 2,
                  ),
                  checkColor: WidgetStateProperty.all(Colors.white),
                ),
              ),
              child: CheckboxListTile(
                contentPadding: EdgeInsets.zero,
                title: Text(
                  "Recurring Event",
                  style: TextStyle(
                    fontSize: 14,
                    color: isDark ? Colors.white70 : Colors.black87,
                  ),
                ),
                subtitle: Text(
                  "Repeat every week",
                  style: TextStyle(fontSize: 12, color: Colors.grey.shade600),
                ),
                value: _isRecurring,
                activeColor: accentColor,
                onChanged: (val) => setState(() => _isRecurring = val ?? true),
                controlAffinity: ListTileControlAffinity.leading,
              ),
            ),
            if (isEditing && widget.onDelete != null) ...[
              const SizedBox(height: 20),
              const Divider(),
              TextButton.icon(
                onPressed: () {
                  widget.onDelete!(widget.lessonToEdit!.id!);
                  Navigator.pop(context);
                },
                icon: const Icon(Icons.delete_forever, color: Colors.red),
                label: const Text(
                  "Delete Event",
                  style: TextStyle(
                    color: Colors.red,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                style: TextButton.styleFrom(
                  padding: const EdgeInsets.symmetric(
                    vertical: 12,
                    horizontal: 16,
                  ),
                ),
              ),
            ],
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('Cancel'),
        ),
        ElevatedButton(
          onPressed: _submit,
          style: ElevatedButton.styleFrom(
            backgroundColor: accentColor,
            foregroundColor: Colors.white,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
          ),
          child: Text(isEditing ? 'Save Changes' : 'Save'),
        ),
      ],
    );
  }
}

calendar_header.dart:
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

class CalendarHeader extends StatefulWidget {
  final DateTime selectedDate;
  final Function(DateTime) onDateSelected;

  const CalendarHeader({
    super.key,
    required this.selectedDate,
    required this.onDateSelected,
  });

  @override
  State<CalendarHeader> createState() => _CalendarHeaderState();
}

class _CalendarHeaderState extends State<CalendarHeader> {
  late PageController _pageController;
  final int _initialPage = 1000;

  @override
  void initState() {
    super.initState();
    final initialIndex = _calculatePageForDate(widget.selectedDate);
    _pageController = PageController(initialPage: initialIndex);
  }

  @override
  void didUpdateWidget(covariant CalendarHeader oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.selectedDate != widget.selectedDate) {
      final targetPage = _calculatePageForDate(widget.selectedDate);
      if (_pageController.hasClients &&
          _pageController.page?.round() != targetPage) {
        _pageController.animateToPage(
          targetPage,
          duration: const Duration(milliseconds: 500),
          curve: Curves.easeInOutCubic,
        );
      }
    }
  }

  int _calculatePageForDate(DateTime date) {
    final now = DateTime.now();
    final mondayNow = now.subtract(Duration(days: now.weekday - 1));
    final mondayDate = date.subtract(Duration(days: date.weekday - 1));
    final diff = mondayDate.difference(mondayNow).inDays;
    final weeksDiff = (diff / 7).round();
    return _initialPage + weeksDiff;
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  DateTime _getMondayForPage(int index) {
    final now = DateTime.now();
    final currentMonday = now.subtract(Duration(days: now.weekday - 1));
    final weeksDiff = index - _initialPage;
    return currentMonday.add(Duration(days: weeksDiff * 7));
  }

  Future<void> _showCalendarPicker(
    BuildContext context,
    Color accentColor,
  ) async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: widget.selectedDate,
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            datePickerTheme: DatePickerThemeData(
              headerBackgroundColor: accentColor,
              headerForegroundColor: Colors.white,
            ),
            colorScheme: ColorScheme.fromSeed(
              seedColor: accentColor,
              brightness: Theme.of(context).brightness,
            ),
          ),
          child: child!,
        );
      },
    );

    if (picked != null) {
      widget.onDateSelected(picked);
    }
  }

  void _handleBackToToday(Color themeColor) {
    if (DateUtils.isSameDay(widget.selectedDate, DateTime.now())) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text("You are already up to date!"),
          backgroundColor: themeColor,
          duration: const Duration(seconds: 1),
        ),
      );
    } else {
      widget.onDateSelected(DateTime.now());
    }
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final textColor = isDark ? Colors.white : Colors.black;
    final themeColor = isDark
        ? Colors.deepPurpleAccent
        : Theme.of(context).primaryColor;

    return Column(
      children: [
        const SizedBox(height: 20), // Top Spacing
        // --- TOP ROW ---
        Padding(
          padding: const EdgeInsets.symmetric(
            horizontal: 20.0,
          ), // STRICT MARGIN
          child: SizedBox(
            height: 50,
            child: Stack(
              alignment: Alignment.center,
              children: [
                // 1. LEFT: Back Button
                Align(
                  alignment: Alignment.centerLeft,
                  child: GestureDetector(
                    onTap: () => _handleBackToToday(themeColor),
                    child: Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: themeColor.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Icon(
                        Icons.undo_rounded,
                        color: themeColor,
                        size: 26,
                      ),
                    ),
                  ),
                ),

                // 2. CENTER: Date Text
                Align(
                  alignment: Alignment.center,
                  child: Text(
                    DateFormat('MMMM d').format(widget.selectedDate),
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: textColor,
                    ),
                  ),
                ),

                // 3. RIGHT: Calendar Picker
                Align(
                  alignment: Alignment.centerRight,
                  child: GestureDetector(
                    onTap: () => _showCalendarPicker(context, themeColor),
                    child: Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: themeColor.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Icon(
                        Icons.calendar_month_rounded,
                        color: themeColor,
                        size: 26,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),

        const SizedBox(height: 20), // Vertical Gap between Title and Days
        // --- BOTTOM ROW: Week Strip ---
        SizedBox(
          height: 70, // Standard height
          child: PageView.builder(
            controller: _pageController,
            onPageChanged: (index) {
              final mondayOfNewPage = _getMondayForPage(index);
              final currentWeekdayOffset = widget.selectedDate.weekday - 1;
              final newDate = mondayOfNewPage.add(
                Duration(days: currentWeekdayOffset),
              );
              widget.onDateSelected(newDate);
            },
            itemBuilder: (context, index) {
              final monday = _getMondayForPage(index);
              final weekDays = List.generate(
                7,
                (i) => monday.add(Duration(days: i)),
              );

              // Padding applied inside here matches the Top Row padding (20.0)
              return Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: weekDays
                      .map((date) => _buildDayItem(date, themeColor, isDark))
                      .toList(),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildDayItem(DateTime date, Color highlightColor, bool isDark) {
    final isSelected =
        date.year == widget.selectedDate.year &&
        date.month == widget.selectedDate.month &&
        date.day == widget.selectedDate.day;

    final isToday = DateUtils.isSameDay(date, DateTime.now());

    return Expanded(
      child: GestureDetector(
        onTap: () => widget.onDateSelected(date),
        child: Container(
          // Margin to separate bubbles
          margin: const EdgeInsets.symmetric(horizontal: 3),
          decoration: BoxDecoration(
            color: isSelected
                ? highlightColor
                : (isDark ? Colors.white10 : Colors.grey.shade100),
            borderRadius: BorderRadius.circular(16),
            border: isToday && !isSelected
                ? Border.all(color: highlightColor.withOpacity(0.5))
                : null,
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                DateFormat('E').format(date).substring(0, 3),
                style: TextStyle(
                  fontSize: 11,
                  color: isSelected ? Colors.white : Colors.grey,
                ),
              ),
              const SizedBox(height: 6),
              Text(
                date.day.toString(),
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: isSelected
                      ? Colors.white
                      : (isDark ? Colors.white : Colors.black87),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class_card.dart:
import 'package:flutter/material.dart';
import '../../models/lesson.dart';

class ClassCard extends StatelessWidget {
  final Lesson lesson;
  final VoidCallback? onEdit; // Renamed from onDelete to onEdit

  const ClassCard({super.key, required this.lesson, this.onEdit});

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final primaryColor = Theme.of(context).primaryColor;
    final textColor = isDark ? Colors.white : Colors.black;
    final subTextColor = isDark ? Colors.white70 : Colors.grey.shade600;
    final cardBgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;
    final typeColor = lesson.isLecture ? primaryColor : Colors.teal;

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // TIME
          SizedBox(
            width: 60,
            child: Column(
              children: [
                Text(
                  lesson.startTimeString,
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                    color: textColor,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  lesson.endTimeString,
                  style: const TextStyle(fontSize: 12, color: Colors.grey),
                ),
              ],
            ),
          ),
          // LINE
          Column(
            children: [
              Container(
                margin: const EdgeInsets.only(top: 8),
                height: 12,
                width: 12,
                decoration: BoxDecoration(
                  color: typeColor,
                  shape: BoxShape.circle,
                ),
              ),
              Container(
                width: 2,
                height: 90,
                color: isDark ? Colors.grey.shade800 : Colors.grey.shade300,
              ),
            ],
          ),
          const SizedBox(width: 12),
          // CARD
          Expanded(
            child: Card(
              color: cardBgColor,
              elevation: 0,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
                side: BorderSide(
                  color: isDark ? Colors.white12 : Colors.grey.shade300,
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(12.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Expanded(
                          child: Text(
                            lesson.name,
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: textColor,
                            ),
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                        // EDIT BUTTON
                        if (onEdit != null)
                          GestureDetector(
                            onTap: onEdit,
                            child: Icon(
                              Icons.edit_outlined,
                              size: 20,
                              color: Colors.grey.shade500,
                            ),
                          ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    if (lesson.isLecture) ...[
                      Row(
                        children: [
                          Icon(
                            Icons.location_on,
                            size: 14,
                            color: subTextColor,
                          ),
                          const SizedBox(width: 4),
                          Text(
                            lesson.room,
                            style: TextStyle(fontSize: 14, color: subTextColor),
                          ),
                          const SizedBox(width: 16),
                          Icon(Icons.person, size: 14, color: subTextColor),
                          const SizedBox(width: 4),
                          Expanded(
                            child: Text(
                              lesson.instructor,
                              style: TextStyle(
                                fontSize: 14,
                                color: subTextColor,
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
                    ] else ...[
                      if (lesson.description.isNotEmpty)
                        Text(
                          lesson.description,
                          style: TextStyle(
                            fontSize: 13,
                            color: subTextColor,
                            fontStyle: FontStyle.italic,
                          ),
                        ),
                    ],
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

firebase_options.dart:
// File generated by FlutterFire CLI.
// ignore_for_file: type=lint
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
///
/// Example:
/// ```dart
/// import 'firebase_options.dart';
/// // ...
/// await Firebase.initializeApp(
///   options: DefaultFirebaseOptions.currentPlatform,
/// );
/// ```
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyCJXT42bw0Tq0gCm3_HZR570TYBSLdgQMg',
    appId: '1:1089895449096:web:7552a7bec7bfe0ab0707bd',
    messagingSenderId: '1089895449096',
    projectId: 'life-notebook-fd44f',
    authDomain: 'life-notebook-fd44f.firebaseapp.com',
    storageBucket: 'life-notebook-fd44f.firebasestorage.app',
    measurementId: 'G-G9Z7116CC2',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyCXrL5LBoh2aqSrTAy0UKiAxD1p_doLQc0',
    appId: '1:1089895449096:android:a1d8f6b7aef839160707bd',
    messagingSenderId: '1089895449096',
    projectId: 'life-notebook-fd44f',
    storageBucket: 'life-notebook-fd44f.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyAMEB2Unanp4pB7tD2zmjK4BXMiBPlpfxQ',
    appId: '1:1089895449096:ios:7c54961c03311a890707bd',
    messagingSenderId: '1089895449096',
    projectId: 'life-notebook-fd44f',
    storageBucket: 'life-notebook-fd44f.firebasestorage.app',
    iosBundleId: 'com.example.notDefterim',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyAMEB2Unanp4pB7tD2zmjK4BXMiBPlpfxQ',
    appId: '1:1089895449096:ios:7c54961c03311a890707bd',
    messagingSenderId: '1089895449096',
    projectId: 'life-notebook-fd44f',
    storageBucket: 'life-notebook-fd44f.firebasestorage.app',
    iosBundleId: 'com.example.notDefterim',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyCJXT42bw0Tq0gCm3_HZR570TYBSLdgQMg',
    appId: '1:1089895449096:web:101ff07c1e0b31180707bd',
    messagingSenderId: '1089895449096',
    projectId: 'life-notebook-fd44f',
    authDomain: 'life-notebook-fd44f.firebaseapp.com',
    storageBucket: 'life-notebook-fd44f.firebasestorage.app',
    measurementId: 'G-4GTBS9CZHM',
  );

}
main.dart:
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'firebase_options.dart';

// PAGE IMPORTS
import 'pages/health_page.dart';
import 'pages/book_page.dart';
import 'pages/finance_page.dart';
import 'pages/schedule_page.dart';
import 'pages/dashboard_page.dart';
import 'pages/login_page.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  runApp(const LifeNotebookApp());
}

// Global Theme Mode Controller
final ValueNotifier<ThemeMode> _themeNotifier = ValueNotifier(ThemeMode.light);

// Global Page Index Controller
final ValueNotifier<int> _pageIndexNotifier = ValueNotifier(2);

// Global Color List
const List<Color> globalPageColors = [
  Colors.deepOrange, // 0: Health
  Colors.blue, // 1: Books
  Colors.teal, // 2: Home
  Colors.green, // 3: Finance
  Colors.deepPurple, // 4: Schedule
];

class LifeNotebookApp extends StatefulWidget {
  const LifeNotebookApp({super.key});

  @override
  State<LifeNotebookApp> createState() => _LifeNotebookAppState();
}

class _LifeNotebookAppState extends State<LifeNotebookApp> {
  @override
  void initState() {
    super.initState();
    _loadUserTheme();
  }

  // --- Load Theme from Firestore ---
  Future<void> _loadUserTheme() async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) return;

      final doc = await FirebaseFirestore.instance
          .collection('users')
          .doc(user.uid)
          .get();

      if (doc.exists &&
          doc.data() != null &&
          doc.data()!.containsKey('isDarkMode')) {
        bool isDark = doc.data()!['isDarkMode'];
        _themeNotifier.value = isDark ? ThemeMode.dark : ThemeMode.light;
      }
    } catch (e) {
      print("Error loading theme: $e");
    }
  }

  @override
  Widget build(BuildContext context) {
    return ValueListenableBuilder<ThemeMode>(
      valueListenable: _themeNotifier,
      builder: (context, ThemeMode currentMode, child) {
        return MaterialApp(
          debugShowCheckedModeBanner: false,
          title: 'Life Notebook',

          // 1. LIGHT THEME
          theme: ThemeData(
            colorScheme: ColorScheme.fromSeed(
              seedColor: Colors.teal,
              brightness: Brightness.light,
            ),
            useMaterial3: true,
            scaffoldBackgroundColor: const Color(0xFFF5F5F5),
            appBarTheme: const AppBarTheme(
              foregroundColor: Colors.white,
              elevation: 0,
            ),
            // Default popup menu style for light mode
            popupMenuTheme: PopupMenuThemeData(
              color: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
              elevation: 10,
            ),
          ),

          // 2. DARK THEME
          darkTheme: ThemeData(
            colorScheme: ColorScheme.fromSeed(
              seedColor: Colors.teal,
              brightness: Brightness.dark,
              surface: const Color(0xFF1E1E1E),
            ),
            useMaterial3: true,
            scaffoldBackgroundColor: const Color(0xFF121212),
            appBarTheme: const AppBarTheme(
              backgroundColor: Color(0xFF1E1E1E),
              foregroundColor: Colors.white,
              elevation: 0,
            ),
            // Default popup menu style for dark mode
            popupMenuTheme: PopupMenuThemeData(
              color: const Color(0xFF1E1E1E),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
              elevation: 10,
            ),
          ),

          themeMode: currentMode,

          // --- AUTH GATE ---
          home: StreamBuilder<User?>(
            stream: FirebaseAuth.instance.authStateChanges(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Scaffold(
                  body: Center(child: CircularProgressIndicator()),
                );
              }
              if (snapshot.hasData) {
                return const HomePage();
              }
              return const LoginPage();
            },
          ),
        );
      },
    );
  }
}

class HomePage extends StatefulWidget {
  const HomePage({super.key});

  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  // We declare the controller here but initialize it in initState
  late final PageController _pageController;

  @override
  void initState() {
    super.initState();
    // Initialize with the current global index so it doesn't reset to dashboard (2)
    _pageController = PageController(initialPage: _pageIndexNotifier.value);
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  void _onItemTapped(int index) {
    _pageIndexNotifier.value = index;
    _pageController.animateToPage(
      index,
      duration: const Duration(milliseconds: 500),
      curve: Curves.easeInOutCubic,
    );
  }

  void _onPageChanged(int index) {
    _pageIndexNotifier.value = index;
  }

  // --- Save Theme to Firestore ---
  void _toggleTheme(bool isCurrentlyDark) {
    final newMode = isCurrentlyDark ? ThemeMode.light : ThemeMode.dark;
    _themeNotifier.value = newMode;

    final user = FirebaseAuth.instance.currentUser;
    if (user != null) {
      FirebaseFirestore.instance.collection('users').doc(user.uid).set({
        'isDarkMode': !isCurrentlyDark,
      }, SetOptions(merge: true));
    }
  }

  // --- Sign Out Function ---
  void _signOut() async {
    await FirebaseAuth.instance.signOut();
  }

  // Your actual pages
  static const List<Widget> _pages = <Widget>[
    HealthPage(),
    BookPage(),
    DashboardPage(),
    FinancePage(),
    SchedulePage(),
  ];

  @override
  Widget build(BuildContext context) {
    return ValueListenableBuilder<ThemeMode>(
      valueListenable: _themeNotifier,
      builder: (context, ThemeMode currentMode, _) {
        final bool isDark = currentMode == ThemeMode.dark;

        return ValueListenableBuilder<int>(
          valueListenable: _pageIndexNotifier,
          builder: (context, int currentIndex, _) {
            final Color activeColor = globalPageColors[currentIndex];

            return Scaffold(
              appBar: AppBar(
                backgroundColor: isDark ? const Color(0xFF1E1E1E) : activeColor,
                title: Text(
                  'Life Notebook',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: isDark ? activeColor : Colors.white,
                  ),
                ),
                centerTitle: true,
                iconTheme: IconThemeData(
                  color: isDark ? activeColor : Colors.white,
                ),

                // === NEW STYLED SETTINGS MENU ===
                leading: Theme(
                  // Override specific theme data just for this popup to ensure it matches the cards
                  data: Theme.of(context).copyWith(
                    popupMenuTheme: PopupMenuThemeData(
                      color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(20),
                        side: isDark
                            ? BorderSide(color: Colors.grey.withOpacity(0.1))
                            : BorderSide.none,
                      ),
                      elevation: 10,
                    ),
                  ),
                  child: PopupMenuButton<String>(
                    icon: const Icon(Icons.settings_rounded),
                    tooltip: 'Settings',
                    offset: const Offset(
                      10,
                      50,
                    ), // Shifts menu slightly for better placement
                    onSelected: (String value) {
                      if (value == 'theme') {
                        _toggleTheme(isDark);
                      } else if (value == 'logout') {
                        _signOut();
                      }
                    },
                    itemBuilder: (BuildContext context) =>
                        <PopupMenuEntry<String>>[
                          // 1. Theme Toggle
                          PopupMenuItem<String>(
                            value: 'theme',
                            child: Row(
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(8),
                                  decoration: BoxDecoration(
                                    color: isDark
                                        ? Colors.grey[800]
                                        : Colors.grey[200],
                                    shape: BoxShape.circle,
                                  ),
                                  child: Icon(
                                    isDark
                                        ? Icons.light_mode_rounded
                                        : Icons.dark_mode_rounded,
                                    color: isDark
                                        ? Colors.yellow
                                        : Colors.grey[800],
                                    size: 18,
                                  ),
                                ),
                                const SizedBox(width: 12),
                                Text(
                                  isDark ? 'Light Mode' : 'Dark Mode',
                                  style: const TextStyle(
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ],
                            ),
                          ),

                          const PopupMenuDivider(),

                          // 2. Log Out
                          PopupMenuItem<String>(
                            value: 'logout',
                            child: Row(
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(8),
                                  decoration: BoxDecoration(
                                    color: Colors.red.withOpacity(0.1),
                                    shape: BoxShape.circle,
                                  ),
                                  child: const Icon(
                                    Icons.logout_rounded,
                                    color: Colors.red,
                                    size: 18,
                                  ),
                                ),
                                const SizedBox(width: 12),
                                const Text(
                                  'Log Out',
                                  style: TextStyle(
                                    color: Colors.red,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                  ),
                ),

                actions: [], // Cleared old actions
              ),

              body: PageView(
                controller: _pageController,
                onPageChanged: _onPageChanged,
                children: _pages,
              ),

              bottomNavigationBar: BottomAppBar(
                color: isDark ? const Color(0xFF1E1E1E) : Colors.white,
                elevation: 20,
                height: 70,
                padding: EdgeInsets.zero,
                child: Row(
                  children: <Widget>[
                    Expanded(
                      child: _buildNavButton(
                        icon: Icons.favorite_rounded,
                        index: 0,
                        label: 'Health',
                        activeColor: activeColor,
                        currentIndex: currentIndex,
                      ),
                    ),
                    Expanded(
                      child: _buildNavButton(
                        icon: Icons.menu_book_rounded,
                        index: 1,
                        label: 'Books',
                        activeColor: activeColor,
                        currentIndex: currentIndex,
                      ),
                    ),

                    Expanded(
                      child: Center(
                        child: _buildCenterHomeButton(
                          currentIndex: currentIndex,
                          activeColor: activeColor,
                          isDark: isDark,
                        ),
                      ),
                    ),

                    Expanded(
                      child: _buildNavButton(
                        icon: Icons.account_balance_wallet_rounded,
                        index: 3,
                        label: 'Finance',
                        activeColor: activeColor,
                        currentIndex: currentIndex,
                      ),
                    ),
                    Expanded(
                      child: _buildNavButton(
                        icon: Icons.calendar_month_rounded,
                        index: 4,
                        label: 'Schedule',
                        activeColor: activeColor,
                        currentIndex: currentIndex,
                      ),
                    ),
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }

  Widget _buildNavButton({
    required IconData icon,
    required int index,
    required String label,
    required Color activeColor,
    required int currentIndex,
  }) {
    final bool isSelected = currentIndex == index;
    final Color inactiveColor = Colors.grey;

    return InkWell(
      onTap: () => _onItemTapped(index),
      borderRadius: BorderRadius.circular(50),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12.0, vertical: 8.0),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon,
              color: isSelected ? activeColor : inactiveColor,
              size: 26,
            ),
            const SizedBox(height: 2),
            Text(
              label,
              style: TextStyle(
                fontSize: 10,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                color: isSelected ? activeColor : inactiveColor,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCenterHomeButton({
    required int currentIndex,
    required Color activeColor,
    required bool isDark,
  }) {
    final bool isSelected = currentIndex == 2;
    return GestureDetector(
      onTap: () => _onItemTapped(2),
      child: Container(
        width: 50,
        height: 50,
        decoration: BoxDecoration(
          color: isSelected ? activeColor : Colors.transparent,
          shape: BoxShape.circle,
          border: isSelected
              ? null
              : Border.all(color: Colors.grey.withOpacity(0.5), width: 2),
        ),
        child: Icon(
          Icons.home_rounded,
          color: isSelected ? Colors.white : Colors.grey,
          size: 30,
        ),
      ),
    );
  }
}

