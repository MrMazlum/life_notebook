*** MASTER PROJECT CONTEXT: Life Notebook ***

[ROLE]
You are an expert Flutter & Firebase developer.
I am a student/creator building "Life Notebook," a high-performance productivity app.

[PROJECT AIM]
To digitize a physical life-management notebook.
The app combines:
1. Fixed Schedules (University lectures with Rooms/Instructors).
2. Flexible Tasks (Self-study, Gym, Library sessions).
3. Tracking Metrics (Finance, Time studied, Pages read, Health).
The goal is a professional, Android-first app on the Play Store using clean, lightweight code (ValueNotifier > Bloc/Provider).

[CURRENT STATUS - BETA]
- Firebase: Connected (Firestore & Auth enabled).
- Schedule Module: COMPLETE.
  - Infinite scrolling, Month Picker, Auto-fill professors, Recurring events.
- Finance Module: UI COMPLETE (Mock Data).
  - Income vs Expense, Pacing Bar, Category Limits, Quick-Add.
- Health Module: GRID VIEW COMPLETE.
  - Gym: "Workout Player" UI with Set/Rep logging, Routine Manager, and Smart Search.
  - Nutrition: Macro/Simple toggle, Professional Food Log, Quick Add.
  - Hydration: Smart Unit settings.
  - Layout: Compact 2x2 Tracker Grid.

[FILE STRUCTURE]
lib/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ lesson.dart
â”‚   â”œâ”€â”€ finance_models.dart
â”‚   â””â”€â”€ health_model.dart
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ finance_page.dart
â”‚   â”œâ”€â”€ health_page.dart   <-- MAIN HEALTH TAB
â”‚   â””â”€â”€ schedule_page.dart
â”œâ”€â”€ widgets/
â”‚   â”œâ”€â”€ finance/
â”‚   â”‚   â””â”€â”€ ... (Finance widgets)
â”‚   â”œâ”€â”€ health/            <-- NEW STRUCTURE
â”‚   â”‚   â”œâ”€â”€ activity/
â”‚   â”‚   â”‚   â”œâ”€â”€ activity_card.dart   (The Player)
â”‚   â”‚   â”‚   â”œâ”€â”€ routine_manager.dart (Routine Picker)
â”‚   â”‚   â”‚   â”œâ”€â”€ routine_editor.dart  (Create/Edit Routine)
â”‚   â”‚   â”‚   â”œâ”€â”€ workout_logger.dart  (Log Sets Sheet)
â”‚   â”‚   â”‚   â””â”€â”€ exercise_models.dart
â”‚   â”‚   â”œâ”€â”€ cards/
â”‚   â”‚   â”‚   â”œâ”€â”€ nutrition.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ hydration.dart
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ grid.dart      (The Dashboard View)
â”‚   â”‚   â”œâ”€â”€ list.dart      (The Timeline View - Pending)
â”‚   â”‚   â””â”€â”€ hero.dart      (The Stats View - Pending)
â”‚   â””â”€â”€ schedule/
â”‚       â””â”€â”€ ...
â””â”€â”€ main.dart

[FUTURE WORK / TODO]

1. Health Module (Remaining Views):
   A. List View (The Journal):
      - Concept: A vertical timeline (Chat log style).
      - Logic: Needs 'Timestamp' for every action (e.g., "09:30 AM - Drank 250ml", "18:00 - Finished Push Day").
      - UI: Group items by time. Use small icons. No "Edit" buttons, just a history log.
   
   B. Hero View (The Motivator):
      - Concept: High-level stats and visualization.
      - Components:
        - Top: Activity Rings (Apple Watch style) for Calories/Steps/Workout.
        - Middle: Body Composition (Weight Trend Line Graph).
        - Bottom: "Badges" or "Streaks" (e.g., "ðŸ”¥ 5 Day Gym Streak").

2. Backend Integration:
   - Connect Finance UI to Firestore StreamBuilder.
   - Connect Health UI to Firestore (Save DailyLogs per date document).

3. Remaining Modules:
   - Build `book_page.dart` (Reading Tracker).





finance_models.dart:

import 'package:flutter/material.dart';

import 'package:cloud_firestore/cloud_firestore.dart';


class FinanceBucket {

  final String id;

  final String name;

  final double limit;

  final double spent; // We calculate this locally, we don't store it

  final int iconCode; // Store icon as int

  final int colorValue; // Store color as int

  final bool isFixed;


  FinanceBucket({

    required this.id,

    required this.name,

    required this.limit,

    this.spent = 0.0,

    required this.iconCode,

    required this.colorValue,

    this.isFixed = false,

  });


  // Helper to get actual IconData object

  IconData get icon => IconData(iconCode, fontFamily: 'MaterialIcons');

  // Helper to get actual Color object

  Color get color => Color(colorValue);


  // Convert to Firestore Map

  Map<String, dynamic> toMap() {

    return {

      'name': name,

      'limit': limit,

      'iconCode': iconCode,

      'colorValue': colorValue,

      'isFixed': isFixed,

      'userId': 'test_user',

    };

  }


  // Create from Firestore Document

  factory FinanceBucket.fromFirestore(DocumentSnapshot doc) {

    final data = doc.data() as Map<String, dynamic>;

    return FinanceBucket(

      id: doc.id,

      name: data['name'] ?? '',

      limit: (data['limit'] ?? 0.0).toDouble(),

      iconCode: data['iconCode'] ?? 57522, // Default icon code

      colorValue: data['colorValue'] ?? 4280391411, // Default color value

      isFixed: data['isFixed'] ?? false,

    );

  }


  FinanceBucket copyWith({double? spent, double? limit}) {

    return FinanceBucket(

      id: id,

      name: name,

      limit: limit ?? this.limit,

      spent: spent ?? this.spent,

      iconCode: iconCode,

      colorValue: colorValue,

      isFixed: isFixed,

    );

  }

}


class FinanceTransaction {

  final String id;

  final String title;

  final double amount;

  final DateTime date;

  final String categoryId; // Points to a Bucket ID or 'income'

  final bool isExpense;

  final int? iconCode; // For income/custom sources

  final int? colorValue; // For income/custom sources


  FinanceTransaction({

    required this.id,

    required this.title,

    required this.amount,

    required this.date,

    required this.categoryId,

    this.isExpense = true,

    this.iconCode,

    this.colorValue,

  });


  IconData? get icon => iconCode != null

      ? IconData(iconCode!, fontFamily: 'MaterialIcons')

      : null;

  Color? get color => colorValue != null ? Color(colorValue!) : null;


  Map<String, dynamic> toMap() {

    return {

      'title': title,

      'amount': amount,

      'date': Timestamp.fromDate(date),

      'categoryId': categoryId,

      'isExpense': isExpense,

      'iconCode': iconCode,

      'colorValue': colorValue,

      'userId': 'test_user',

    };

  }


  factory FinanceTransaction.fromFirestore(DocumentSnapshot doc) {

    final data = doc.data() as Map<String, dynamic>;

    return FinanceTransaction(

      id: doc.id,

      title: data['title'] ?? '',

      amount: (data['amount'] ?? 0.0).toDouble(),

      date: (data['date'] as Timestamp).toDate(),

      categoryId: data['categoryId'] ?? 'income',

      isExpense: data['isExpense'] ?? true,

      iconCode: data['iconCode'],

      colorValue: data['colorValue'],

    );

  }

}




health_model.dart:

import 'package:flutter/material.dart';


class FoodItem {

  final String name;

  final int calories;

  final int protein;

  final int carbs;

  final int fat;

  final DateTime timestamp;


  FoodItem({

    required this.name,

    required this.calories,

    this.protein = 0,

    this.carbs = 0,

    this.fat = 0,

    required this.timestamp,

  });


  // NEW: Convert to Firestore Map

  Map<String, dynamic> toMap() {

    return {

      'name': name,

      'calories': calories,

      'protein': protein,

      'carbs': carbs,

      'fat': fat,

      'timestamp': timestamp.toIso8601String(),

    };

  }

}


class HealthDailyLog {

  DateTime date;


  // Activity

  int steps;

  String? workoutName;

  bool isWorkoutDone;

  double weight;


  // Hydration

  int waterGlasses;

  int waterGlassSizeMl;

  int caffeineAmount;


  // Nutrition

  bool useMacros;

  List<FoodItem> foodLog;

  int totalCalories;

  int totalProtein;

  int totalCarbs;

  int totalFat;


  // Mood & Sleep

  int mood;

  double sleepHours;


  HealthDailyLog({

    DateTime? date,

    this.steps = 0,

    this.workoutName,

    this.isWorkoutDone = false,

    this.weight = 0.0,

    this.waterGlasses = 0,

    this.waterGlassSizeMl = 250,

    this.caffeineAmount = 0,

    this.useMacros = false,

    List<FoodItem>? foodLog,

    this.totalCalories = 0,

    this.totalProtein = 0,

    this.totalCarbs = 0,

    this.totalFat = 0,

    this.mood = 3,

    this.sleepHours = 7.0,

  }) : date = date ?? DateTime.now(),

       foodLog = foodLog ?? [];


  HealthDailyLog copyWith({

    DateTime? date,

    int? steps,

    String? workoutName,

    bool? isWorkoutDone,

    double? weight,

    int? waterGlasses,

    int? waterGlassSizeMl,

    int? caffeineAmount,

    bool? useMacros,

    List<FoodItem>? foodLog,

    int? totalCalories,

    int? totalProtein,

    int? totalCarbs,

    int? totalFat,

    int? mood,

    double? sleepHours,

  }) {

    return HealthDailyLog(

      date: date ?? this.date,

      steps: steps ?? this.steps,

      workoutName: workoutName ?? this.workoutName,

      isWorkoutDone: isWorkoutDone ?? this.isWorkoutDone,

      weight: weight ?? this.weight,

      waterGlasses: waterGlasses ?? this.waterGlasses,

      waterGlassSizeMl: waterGlassSizeMl ?? this.waterGlassSizeMl,

      caffeineAmount: caffeineAmount ?? this.caffeineAmount,

      useMacros: useMacros ?? this.useMacros,

      foodLog: foodLog ?? this.foodLog,

      totalCalories: totalCalories ?? this.totalCalories,

      totalProtein: totalProtein ?? this.totalProtein,

      totalCarbs: totalCarbs ?? this.totalCarbs,

      totalFat: totalFat ?? this.totalFat,

      mood: mood ?? this.mood,

      sleepHours: sleepHours ?? this.sleepHours,

    );

  }


  // NEW: Convert entire Log to Firestore Map

  Map<String, dynamic> toMap() {

    return {

      'date': date.toIso8601String().split('T')[0], // Store as YYYY-MM-DD

      'steps': steps,

      'workoutName': workoutName,

      'isWorkoutDone': isWorkoutDone,

      'weight': weight,

      'waterGlasses': waterGlasses,

      'waterGlassSizeMl': waterGlassSizeMl,

      'caffeineAmount': caffeineAmount,

      'useMacros': useMacros,

      'foodLog': foodLog.map((f) => f.toMap()).toList(),

      'totalCalories': totalCalories,

      'totalProtein': totalProtein,

      'totalCarbs': totalCarbs,

      'totalFat': totalFat,

      'mood': mood,

      'sleepHours': sleepHours,

    };

  }

}


lesson.dart:

import 'package:cloud_firestore/cloud_firestore.dart';


class Lesson {

  final String? id;

  final String userId;

  final String name;

  final String room;

  final String instructor;

  final String description;

  final bool isLecture;

  final bool isRecurring;

  final String dayOfWeek; // e.g., "Monday"

  final int startTimeInMinutes;

  final int durationInMinutes;


  // NEW FIELDS

  final List<String> excludeDates; // Dates to skip: ["2026-01-04"]

  final String specificDate; // If NOT recurring: "2026-01-04"


  Lesson({

    this.id,

    required this.userId,

    required this.name,

    this.room = '',

    this.instructor = '',

    this.description = '',

    this.isLecture = true,

    this.isRecurring = true,

    required this.dayOfWeek,

    required this.startTimeInMinutes,

    required this.durationInMinutes,

    this.excludeDates = const [],

    this.specificDate = '',

  });


  // Helpers

  int get endTimeInMinutes => startTimeInMinutes + durationInMinutes;


  String get startTimeString {

    final h = startTimeInMinutes ~/ 60;

    final m = startTimeInMinutes % 60;

    return '${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}';

  }


  String get endTimeString {

    final endMin = startTimeInMinutes + durationInMinutes;

    final h = endMin ~/ 60;

    final m = endMin % 60;

    return '${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}';

  }


  Map<String, dynamic> toMap() {

    return {

      'userId': userId,

      'name': name,

      'room': room,

      'instructor': instructor,

      'description': description,

      'isLecture': isLecture,

      'isRecurring': isRecurring,

      'dayOfWeek': dayOfWeek,

      'startTimeInMinutes': startTimeInMinutes,

      'durationInMinutes': durationInMinutes,

      'excludeDates': excludeDates, // Save to DB

      'specificDate': specificDate, // Save to DB

    };

  }


  factory Lesson.fromFirestore(DocumentSnapshot doc) {

    Map<String, dynamic> data = doc.data() as Map<String, dynamic>;

    return Lesson(

      id: doc.id,

      userId: data['userId'] ?? '',

      name: data['name'] ?? '',

      room: data['room'] ?? '',

      instructor: data['instructor'] ?? '',

      description: data['description'] ?? '',

      isLecture: data['isLecture'] ?? true,

      isRecurring: data['isRecurring'] ?? true,

      dayOfWeek: data['dayOfWeek'] ?? 'Monday',

      startTimeInMinutes: data['startTimeInMinutes'] ?? 0,

      durationInMinutes: data['durationInMinutes'] ?? 60,

      // Load from DB (safely handle lists)

      excludeDates: List<String>.from(data['excludeDates'] ?? []),

      specificDate: data['specificDate'] ?? '',

    );

  }

}


book_page.dart:

import 'package:flutter/material.dart';


class BookPage extends StatelessWidget {

  const BookPage({super.key});


  @override

  Widget build(BuildContext context) {

    return SingleChildScrollView(

      child: Center(

        child: Padding(

          padding: const EdgeInsets.all(16.0),

          child: Text(

            'ðŸ“š Reading List will be listed here',

            style: TextStyle(fontSize: 24),

            textAlign: TextAlign.center,

          ),

        ),

      ),

    );

  }

}


dashboard_page.dart:

import 'package:flutter/material.dart';


class DashboardPage extends StatelessWidget {

  const DashboardPage({super.key});


  @override

  Widget build(BuildContext context) {

    return SingleChildScrollView(

      child: Center(

        child: Padding(

          padding: const EdgeInsets.all(16.0),

          child: Column(

            mainAxisAlignment: MainAxisAlignment.center,

            children: [

              Icon(

                Icons.home_rounded,

                size: 100,

                color: Colors.deepPurple.shade200,

              ),

              const SizedBox(height: 20),

              const Text(

                'Welcome Home!',

                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),

                textAlign: TextAlign.center,

              ),

              const SizedBox(height: 10),

              const Text(

                'Your daily summary will be here.', // Ä°leride buraya Ã¶zetleri koyacaÄŸÄ±z

                style: TextStyle(color: Colors.grey),

                textAlign: TextAlign.center,

              ),

            ],

          ),

        ),

      ),

    );

  }

}


finance_page.dart:

import 'package:cloud_firestore/cloud_firestore.dart';

import 'package:flutter/material.dart';

import 'package:intl/intl.dart'; // Still needed for logic


// MODELS

import '../models/finance_models.dart';


// WIDGETS

import '../widgets/finance/add_transaction_dialog.dart';

import '../widgets/finance/past_month_summary.dart';

import '../widgets/finance/finance_dashboard.dart';

import '../widgets/finance/edit_monthly_budget_dialog.dart';

import '../widgets/finance/finance_header.dart'; // NEW IMPORT


class FinancePage extends StatefulWidget {

  const FinancePage({super.key});


  @override

  State<FinancePage> createState() => _FinancePageState();

}


class _FinancePageState extends State<FinancePage> {

  DateTime _selectedDate = DateTime.now();

  bool _isInspectingPast = false;

  bool _showChart = false;


  // --- HARDCODED BUCKETS (Will move to Firestore later) ---

  List<FinanceBucket> _baseBuckets = [

    FinanceBucket(

      id: '2',

      name: 'Rent',

      limit: 800.0,

      spent: 0,

      iconCode: Icons.home_rounded.codePoint,

      colorValue: Colors.blue.value,

      isFixed: true,

    ),

    FinanceBucket(

      id: '5',

      name: 'Subscriptions',

      limit: 60.0,

      spent: 0,

      iconCode: Icons.subscriptions_rounded.codePoint,

      colorValue: Colors.teal.value,

      isFixed: true,

    ),

    FinanceBucket(

      id: '1',

      name: 'Dining',

      limit: 150.0,

      spent: 0,

      iconCode: Icons.restaurant_rounded.codePoint,

      colorValue: Colors.orange.value,

    ),

    FinanceBucket(

      id: '6',

      name: 'Groceries',

      limit: 200.0,

      spent: 0,

      iconCode: Icons.shopping_cart_rounded.codePoint,

      colorValue: Colors.green.value,

    ),

    FinanceBucket(

      id: '4',

      name: 'Transport',

      limit: 100.0,

      spent: 0,

      iconCode: Icons.directions_bus_rounded.codePoint,

      colorValue: Colors.indigo.value,

    ),

    FinanceBucket(

      id: '3',

      name: 'Fun',

      limit: 100.0,

      spent: 0,

      iconCode: Icons.movie_rounded.codePoint,

      colorValue: Colors.purple.value,

    ),

  ];


  bool get _isCurrentMonth {

    final now = DateTime.now();

    return _selectedDate.year == now.year && _selectedDate.month == now.month;

  }


  bool get _isFutureMonth {

    final now = DateTime.now();

    if (_selectedDate.year > now.year) return true;

    if (_selectedDate.year == now.year && _selectedDate.month > now.month)

      return true;

    return false;

  }


  void _changeMonth(int offset) {

    setState(() {

      _selectedDate = DateTime(

        _selectedDate.year,

        _selectedDate.month + offset,

        1,

      );

      _isInspectingPast = false;

    });

  }


  // --- SHOW ALL BUDGETS DIALOG ---

  void _showEditMonthlyBudgets() {

    showDialog(

      context: context,

      builder: (ctx) => EditMonthlyBudgetDialog(

        buckets: _baseBuckets,

        onUpdateLimit: _updateBucketLimit,

      ),

    );

  }


  // --- UPDATE SINGLE BUCKET LIMIT ---

  void _updateBucketLimit(

    String bucketId,

    double currentLimit,

    String name, [

    VoidCallback? onSaved,

  ]) {

    final controller = TextEditingController(

      text: currentLimit.toStringAsFixed(0),

    );

    final isDark = Theme.of(context).brightness == Brightness.dark;


    showDialog(

      context: context,

      builder: (ctx) => Dialog(

        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,

        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),

        child: Padding(

          padding: const EdgeInsets.all(24.0),

          child: Column(

            mainAxisSize: MainAxisSize.min,

            crossAxisAlignment: CrossAxisAlignment.start,

            children: [

              Text(

                "Edit Budget: $name",

                style: TextStyle(

                  fontSize: 18,

                  fontWeight: FontWeight.bold,

                  color: isDark ? Colors.white : Colors.black,

                ),

              ),

              const SizedBox(height: 16),

              TextField(

                controller: controller,

                keyboardType: TextInputType.number,

                style: TextStyle(

                  color: isDark ? Colors.white : Colors.black,

                  fontSize: 18,

                ),

                decoration: InputDecoration(

                  labelText: "Monthly Limit (\$)",

                  labelStyle: TextStyle(color: Colors.grey.shade500),

                  enabledBorder: OutlineInputBorder(

                    borderRadius: BorderRadius.circular(12),

                    borderSide: BorderSide(color: Colors.grey.shade700),

                  ),

                  focusedBorder: OutlineInputBorder(

                    borderRadius: BorderRadius.circular(12),

                    borderSide: const BorderSide(color: Colors.green),

                  ),

                ),

              ),

              const SizedBox(height: 24),

              Row(

                children: [

                  Expanded(

                    child: OutlinedButton(

                      onPressed: () => Navigator.pop(ctx),

                      style: OutlinedButton.styleFrom(

                        padding: const EdgeInsets.symmetric(vertical: 14),

                        side: BorderSide(color: Colors.grey.shade700),

                        foregroundColor: isDark ? Colors.white : Colors.black,

                      ),

                      child: const Text("Cancel"),

                    ),

                  ),

                  const SizedBox(width: 12),

                  Expanded(

                    child: ElevatedButton(

                      onPressed: () {

                        final newLimit =

                            double.tryParse(controller.text) ?? currentLimit;

                        setState(() {

                          final index = _baseBuckets.indexWhere(

                            (b) => b.id == bucketId,

                          );

                          if (index != -1) {

                            _baseBuckets[index] = _baseBuckets[index].copyWith(

                              limit: newLimit,

                            );

                          }

                        });

                        if (onSaved != null) onSaved();

                        Navigator.pop(ctx);

                      },

                      style: ElevatedButton.styleFrom(

                        backgroundColor: Colors.green,

                        foregroundColor: Colors.white,

                        padding: const EdgeInsets.symmetric(vertical: 14),

                        shape: RoundedRectangleBorder(

                          borderRadius: BorderRadius.circular(50),

                        ),

                      ),

                      child: const Text("Save"),

                    ),

                  ),

                ],

              ),

            ],

          ),

        ),

      ),

    );

  }


  void _onEditTransaction(FinanceTransaction tx) {

    showDialog(

      context: context,

      builder: (context) =>

          AddTransactionDialog(buckets: _baseBuckets, transactionToEdit: tx),

    );

  }


  void _onAddTransaction() {

    showDialog(

      context: context,

      builder: (context) => AddTransactionDialog(buckets: _baseBuckets),

    );

  }


  List<FinanceTransaction> _mapSnapshotToTransactions(QuerySnapshot snapshot) {

    return snapshot.docs.map((doc) {

      final data = doc.data() as Map<String, dynamic>;

      return FinanceTransaction(

        id: doc.id,

        title: data['title'] ?? 'Unknown',

        amount: (data['amount'] ?? 0.0).toDouble(),

        date: (data['date'] as Timestamp).toDate(),

        categoryId: data['categoryId'] ?? 'others',

        isExpense: data['isExpense'] ?? true,

        iconCode: data['iconCode'],

        colorValue: data['colorValue'],

      );

    }).toList();

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final primaryColor = Colors.green;


    return Scaffold(

      backgroundColor: Colors.transparent,

      floatingActionButton: _isCurrentMonth

          ? FloatingActionButton(

              onPressed: _onAddTransaction,

              backgroundColor: primaryColor,

              child: const Icon(Icons.add, color: Colors.white),

            )

          : null,

      body: StreamBuilder<QuerySnapshot>(

        stream: FirebaseFirestore.instance

            .collection('finance_transactions')

            .where('userId', isEqualTo: 'test_user')

            .orderBy('date', descending: true)

            .snapshots(),

        builder: (context, snapshot) {

          if (snapshot.hasError)

            return Center(child: Text("Error: ${snapshot.error}"));

          if (!snapshot.hasData)

            return const Center(child: CircularProgressIndicator());


          final allTransactions = _mapSnapshotToTransactions(snapshot.data!);


          final monthTransactions = allTransactions.where((t) {

            return t.date.year == _selectedDate.year &&

                t.date.month == _selectedDate.month;

          }).toList();


          final monthlyExpense = monthTransactions

              .where((t) => t.isExpense)

              .fold(0.0, (sum, t) => sum + t.amount);

          final monthlyIncome = monthTransactions

              .where((t) => !t.isExpense)

              .fold(0.0, (sum, t) => sum + t.amount);


          final calculatedBuckets = _baseBuckets.map((bucket) {

            final bucketSpent = monthTransactions

                .where((t) => t.isExpense && t.categoryId == bucket.id)

                .fold(0.0, (sum, t) => sum + t.amount);

            return bucket.copyWith(spent: bucketSpent);

          }).toList();


          return SingleChildScrollView(

            physics: const BouncingScrollPhysics(),

            child: Column(

              crossAxisAlignment: CrossAxisAlignment.start,

              children: [

                // --- NEW HEADER WIDGET ---

                FinanceHeader(

                  selectedDate: _selectedDate,

                  onMonthChanged: _changeMonth,

                  isInspectingPast: _isInspectingPast,

                  showChart: _showChart,

                  onChartToggle: (val) => setState(() => _showChart = val),

                  onResetDate: () => setState(() {

                    _selectedDate = DateTime.now();

                    _isInspectingPast = false;

                  }),

                ),


                if (!_isCurrentMonth && !_isFutureMonth && !_isInspectingPast)

                  PastMonthSummary(

                    selectedDate: _selectedDate,

                    income: monthlyIncome,

                    expense: monthlyExpense,

                    isDark: isDark,

                    onBackToToday: () =>

                        setState(() => _selectedDate = DateTime.now()),

                    onInspect: () => setState(() => _isInspectingPast = true),

                  )

                else

                  FinanceDashboard(

                    isDark: isDark,

                    showChart: _showChart,

                    transactions: monthTransactions,

                    buckets: calculatedBuckets,

                    monthlyIncome: monthlyIncome,

                    monthlyExpense: monthlyExpense,

                    onEditTransaction: _onEditTransaction,

                    onUpdateBucketLimit: _updateBucketLimit,

                    onEditAllBudgets: _showEditMonthlyBudgets,

                  ),

                const SizedBox(height: 80),

              ],

            ),

          );

        },

      ),

    );

  }

}


health_page.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';

import 'package:pedometer/pedometer.dart';

import 'package:permission_handler/permission_handler.dart';

import 'package:cloud_firestore/cloud_firestore.dart';

import 'package:shared_preferences/shared_preferences.dart';


import '../models/health_model.dart';

import '../widgets/health/grid.dart';

import '../widgets/health/list.dart';

import '../widgets/health/hero.dart';


enum HealthViewType { grid, list, hero }


class HealthPage extends StatefulWidget {

  const HealthPage({super.key});


  @override

  State<HealthPage> createState() => _HealthPageState();

}


class _HealthPageState extends State<HealthPage> {

  // --- STATE ---

  DateTime _selectedDate = DateTime.now();

  HealthViewType _currentView = HealthViewType.grid;

  late PageController _weekPageController;

  final int _initialPage = 1000;


  // Pedometer Streams

  late Stream<StepCount> _stepCountStream;


  // --- DATA ---

  HealthDailyLog _currentLog = HealthDailyLog(

    waterGlasses: 5,

    waterGlassSizeMl: 250,

    steps: 0,

    weight: 72.5,

    workoutName: "Push Day A",

    isWorkoutDone: false,

    mood: 3,

    caffeineAmount: 1,

    foodLog: [],

  );


  @override

  void initState() {

    super.initState();

    final initialIndex = _calculatePageForDate(DateTime.now());

    _weekPageController = PageController(initialPage: initialIndex);


    // 1. LOAD SAVED STEPS IMMEDIATELY (Fixes the "0" on startup)

    _loadSavedSteps();


    // 2. START LISTENING TO SENSOR

    _initPedometer();

  }


  @override

  void dispose() {

    _weekPageController.dispose();

    super.dispose();

  }


  // --- NEW: DIRECT SENSOR LOGIC ---


  // A. Load steps from local storage so the UI isn't empty on launch

  Future<void> _loadSavedSteps() async {

    final prefs = await SharedPreferences.getInstance();

    final todayKey = "steps_day_${DateTime.now().day}"; // Unique key for today


    // If we have data for TODAY, load it into the UI immediately

    if (prefs.containsKey(todayKey)) {

      int savedSteps = prefs.getInt(todayKey) ?? 0;

      if (mounted) {

        setState(() {

          _currentLog = _currentLog.copyWith(steps: savedSteps);

        });

      }

    }

  }


  void _initPedometer() async {

    if (await Permission.activityRecognition.request().isGranted) {

      _stepCountStream = Pedometer.stepCountStream;

      _stepCountStream.listen(_onStepCount).onError(_onStepError);

    } else {

      debugPrint("Step Permission Denied");

    }

  }


  void _onStepCount(StepCount event) async {

    // The sensor gives "Total steps since reboot"

    int totalSensorSteps = event.steps;

    int todaySteps = await _calculateTodaySteps(totalSensorSteps);


    // Save locally immediately (Source of Truth)

    _saveStepsLocally(todaySteps);


    if (mounted) {

      setState(() {

        _currentLog = _currentLog.copyWith(steps: todaySteps);

      });

      // Fire-and-forget cloud save (throttle this in production)

      if (todaySteps % 10 == 0) _saveToFirestore();

    }

  }


  // Save the calculated "Today Steps" to storage

  Future<void> _saveStepsLocally(int steps) async {

    final prefs = await SharedPreferences.getInstance();

    final todayKey = "steps_day_${DateTime.now().day}";

    await prefs.setInt(todayKey, steps);

  }


  Future<int> _calculateTodaySteps(int sensorSteps) async {

    final prefs = await SharedPreferences.getInstance();


    // Key to store the sensor value at the START of the day

    final offsetKey = "steps_offset_day_${DateTime.now().day}";


    // Is this the first time we are reading steps TODAY?

    if (!prefs.containsKey(offsetKey)) {

      // Yes: The current sensor value is our baseline (0 steps for today)

      await prefs.setInt(offsetKey, sensorSteps);

    }


    int offset = prefs.getInt(offsetKey) ?? sensorSteps;

    int calculated = sensorSteps - offset;


    // Handle reboot case (Sensor resets to 0, making calculated negative)

    if (calculated < 0) {

      // Reset offset to 0 so we just count the new sensor steps

      await prefs.setInt(offsetKey, 0);

      return sensorSteps;

    }


    return calculated;

  }


  void _onStepError(error) {

    debugPrint('Pedometer Error: $error');

  }

  // -----------------------------


  // --- FIRE-AND-FORGET PERSISTENCE ---

  void _saveToFirestore() {

    final user = "test_user";

    final dateKey = DateFormat('yyyy-MM-dd').format(_selectedDate);


    FirebaseFirestore.instance

        .collection('users')

        .doc(user)

        .collection('health_logs')

        .doc(dateKey)

        .set(_currentLog.toMap(), SetOptions(merge: true))

        .catchError((e) => debugPrint("Firestore Sync Error: $e"));

  }


  void _updateLog(VoidCallback updateFn) {

    setState(() {

      updateFn();

    });

    _saveToFirestore();

  }


  // --- DATE LOGIC ---

  int _calculatePageForDate(DateTime date) {

    final now = DateTime.now();

    final mondayNow = now.subtract(Duration(days: now.weekday - 1));

    final mondayDate = date.subtract(Duration(days: date.weekday - 1));

    final diff = mondayDate.difference(mondayNow).inDays;

    return _initialPage + (diff / 7).round();

  }


  DateTime _getMondayForPage(int index) {

    final now = DateTime.now();

    final currentMonday = now.subtract(Duration(days: now.weekday - 1));

    final weeksDiff = index - _initialPage;

    return currentMonday.add(Duration(days: weeksDiff * 7));

  }


  void _onDateSelected(DateTime date) {

    setState(() => _selectedDate = date);

  }


  void _handleBackToToday(Color themeColor) {

    final now = DateTime.now();

    if (DateUtils.isSameDay(_selectedDate, now)) {

      ScaffoldMessenger.of(context).showSnackBar(

        SnackBar(

          content: const Text("You are already up to date!"),

          backgroundColor: themeColor,

          duration: const Duration(seconds: 1),

        ),

      );

    } else {

      setState(() => _selectedDate = now);

      final targetPage = _calculatePageForDate(now);

      _weekPageController.animateToPage(

        targetPage,

        duration: const Duration(milliseconds: 500),

        curve: Curves.easeInOutCubic,

      );

    }

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final themeColor = Colors.deepOrange;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Scaffold(

      backgroundColor: Colors.transparent,

      body: Column(

        children: [

          _buildHealthHeader(isDark, themeColor, textColor),

          Expanded(

            child: AnimatedSwitcher(

              duration: const Duration(milliseconds: 300),

              child: KeyedSubtree(

                key: ValueKey(_currentView),

                child: _buildCurrentView(),

              ),

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildCurrentView() {

    switch (_currentView) {

      case HealthViewType.grid:

        return HealthGrid(

          log: _currentLog,

          onWaterChanged: (val) =>

              _updateLog(() => _currentLog.waterGlasses = val),

          onUpdateGlassSize: (val) =>

              _updateLog(() => _currentLog.waterGlassSizeMl = val),

          onCaffeineChanged: (val) =>

              _updateLog(() => _currentLog.caffeineAmount = val),

          onMoodChanged: (val) => _updateLog(() => _currentLog.mood = val),

          onAddFood: (item) => _updateLog(() {

            _currentLog.foodLog.add(item);

            _currentLog.totalCalories += item.calories;

            _currentLog.totalProtein += item.protein;

            _currentLog.totalCarbs += item.carbs;

            _currentLog.totalFat += item.fat;

          }),

          onDietToggle: (val) => _updateLog(() => _currentLog.useMacros = val),

          onStepsChanged: (val) => _updateLog(() => _currentLog.steps = val),

          onWeightChanged: (val) => _updateLog(() => _currentLog.weight = val),

          onRoutineChanged: (val) =>

              _updateLog(() => _currentLog.workoutName = val),

          onWorkoutToggle: (val) =>

              _updateLog(() => _currentLog.isWorkoutDone = val),

          onCaloriesChanged: (val) {},

          onMacrosChanged: (p, c, f) {},

        );


      case HealthViewType.list:

        return HealthList(

          log: _currentLog,

          onWorkoutToggle: (val) =>

              _updateLog(() => _currentLog.isWorkoutDone = val),

        );


      case HealthViewType.hero:

        return HealthHero(log: _currentLog);

    }

  }


  Widget _buildHealthHeader(bool isDark, Color themeColor, Color textColor) {

    return Container(

      padding: const EdgeInsets.fromLTRB(20, 15, 20, 0),

      child: Column(

        children: [

          SizedBox(

            height: 50,

            child: Row(

              mainAxisAlignment: MainAxisAlignment.spaceBetween,

              children: [

                GestureDetector(

                  onTap: () => _handleBackToToday(themeColor),

                  child: Container(

                    padding: const EdgeInsets.all(10),

                    decoration: BoxDecoration(

                      color: themeColor.withOpacity(0.15),

                      borderRadius: BorderRadius.circular(12),

                    ),

                    child: Icon(

                      Icons.undo_rounded,

                      color: themeColor,

                      size: 24,

                    ),

                  ),

                ),

                Text(

                  DateFormat('MMMM d').format(_selectedDate),

                  style: TextStyle(

                    fontSize: 22,

                    fontWeight: FontWeight.bold,

                    color: textColor,

                  ),

                ),

                Container(

                  height: 44,

                  decoration: BoxDecoration(

                    color: isDark ? Colors.grey.shade800 : Colors.grey.shade200,

                    borderRadius: BorderRadius.circular(14),

                  ),

                  padding: const EdgeInsets.all(4),

                  child: Row(

                    children: [

                      _buildToggleBtn(

                        Icons.grid_view_rounded,

                        HealthViewType.grid,

                        themeColor,

                        isDark,

                      ),

                      const SizedBox(width: 4),

                      _buildToggleBtn(

                        Icons.view_list_rounded,

                        HealthViewType.list,

                        themeColor,

                        isDark,

                      ),

                      const SizedBox(width: 4),

                      _buildToggleBtn(

                        Icons.donut_large_rounded,

                        HealthViewType.hero,

                        themeColor,

                        isDark,

                      ),

                    ],

                  ),

                ),

              ],

            ),

          ),

          const SizedBox(height: 15),

          SizedBox(

            height: 70,

            child: PageView.builder(

              controller: _weekPageController,

              itemBuilder: (context, index) {

                final monday = _getMondayForPage(index);

                final weekDays = List.generate(

                  7,

                  (i) => monday.add(Duration(days: i)),

                );

                return Row(

                  mainAxisAlignment: MainAxisAlignment.spaceBetween,

                  children: weekDays

                      .map((date) => _buildDayItem(date, themeColor, isDark))

                      .toList(),

                );

              },

            ),

          ),

          const SizedBox(height: 10),

        ],

      ),

    );

  }


  Widget _buildToggleBtn(

    IconData icon,

    HealthViewType type,

    Color activeColor,

    bool isDark,

  ) {

    final isSelected = _currentView == type;

    return GestureDetector(

      onTap: () => setState(() => _currentView = type),

      child: Container(

        width: 36,

        height: 36,

        decoration: BoxDecoration(

          color: isSelected ? activeColor : Colors.transparent,

          borderRadius: BorderRadius.circular(10),

        ),

        child: Icon(

          icon,

          size: 20,

          color: isSelected

              ? Colors.white

              : (isDark ? Colors.white54 : Colors.grey),

        ),

      ),

    );

  }


  Widget _buildDayItem(DateTime date, Color themeColor, bool isDark) {

    final isSelected = DateUtils.isSameDay(date, _selectedDate);

    final isToday = DateUtils.isSameDay(date, DateTime.now());

    return Expanded(

      child: GestureDetector(

        onTap: () => _onDateSelected(date),

        child: Container(

          margin: const EdgeInsets.symmetric(horizontal: 3),

          decoration: BoxDecoration(

            color: isSelected

                ? themeColor

                : (isDark ? Colors.white10 : Colors.grey.shade100),

            borderRadius: BorderRadius.circular(16),

            border: isToday && !isSelected

                ? Border.all(color: themeColor.withOpacity(0.5), width: 1.5)

                : null,

          ),

          child: Column(

            mainAxisAlignment: MainAxisAlignment.center,

            children: [

              Text(

                DateFormat('E').format(date).substring(0, 3),

                style: TextStyle(

                  fontSize: 11,

                  color: isSelected

                      ? Colors.white

                      : (isDark ? Colors.white54 : Colors.grey),

                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,

                ),

              ),

              const SizedBox(height: 6),

              Text(

                date.day.toString(),

                style: TextStyle(

                  fontSize: 16,

                  fontWeight: FontWeight.bold,

                  color: isSelected

                      ? Colors.white

                      : (isDark ? Colors.white : Colors.black87),

                ),

              ),

            ],

          ),

        ),

      ),

    );

  }

}


schedule_page.dart:

import 'package:flutter/material.dart';

import 'package:cloud_firestore/cloud_firestore.dart';

import 'package:intl/intl.dart';

import '../models/lesson.dart';

import '../widgets/schedule/class_card.dart';

import '../widgets/schedule/add_lesson_dialog.dart';

import '../widgets/schedule/calendar_header.dart';


class SchedulePage extends StatefulWidget {

  const SchedulePage({super.key});


  @override

  State<SchedulePage> createState() => _SchedulePageState();

}


class _SchedulePageState extends State<SchedulePage> {

  DateTime _selectedDate = DateTime.now();

  final CollectionReference _lessonsRef = FirebaseFirestore.instance.collection(

    'lessons',

  );

  late Stream<QuerySnapshot> _lessonsStream;

  Map<String, String> _smartCourseDatabase = {};


  @override

  void initState() {

    super.initState();

    _lessonsStream = _lessonsRef

        .where('userId', isEqualTo: 'test_user')

        .snapshots();

  }


  void _saveLessonToFirestore(Lesson lesson) {

    if (lesson.id != null) {

      _lessonsRef.doc(lesson.id).update(lesson.toMap());

    } else {

      _lessonsRef.add(lesson.toMap());

    }

  }


  Future<void> _updateGlobalInstructor(

    String courseName,

    String newInstructor,

  ) async {

    final querySnapshot = await _lessonsRef

        .where('userId', isEqualTo: 'test_user')

        .where('name', isEqualTo: courseName)

        .get();

    final batch = FirebaseFirestore.instance.batch();

    for (var doc in querySnapshot.docs) {

      batch.update(doc.reference, {'instructor': newInstructor});

    }

    await batch.commit();

    if (mounted) {

      ScaffoldMessenger.of(context).showSnackBar(

        const SnackBar(content: Text('Updated global instructors!')),

      );

    }

  }


  // --- DELETE LOGIC & UI ---


  void _handleDeleteRequest(String lessonId) {

    _lessonsRef.doc(lessonId).get().then((doc) {

      if (doc.exists) {

        final lesson = Lesson.fromFirestore(doc);

        _confirmDeleteLogic(lesson);

      }

    });

  }


  // UPDATED: Now shows a beautiful dialog for both recurring and one-time events

  void _confirmDeleteLogic(Lesson lesson) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final dateString = DateFormat('yyyy-MM-dd').format(_selectedDate);


    // Common styling for the delete dialog to match "Professor Changed"

    showDialog(

      context: context,

      barrierDismissible: false,

      builder: (ctx) {

        return Dialog(

          backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,

          shape: RoundedRectangleBorder(

            borderRadius: BorderRadius.circular(20),

          ),

          child: Container(

            constraints: const BoxConstraints(maxWidth: 400),

            padding: const EdgeInsets.all(24.0),

            child: SingleChildScrollView(

              child: Column(

                mainAxisSize: MainAxisSize.min,

                children: [

                  // Icon

                  Container(

                    padding: const EdgeInsets.all(12),

                    decoration: BoxDecoration(

                      color: Colors.redAccent.withOpacity(0.1),

                      shape: BoxShape.circle,

                    ),

                    child: const Icon(

                      Icons.delete_forever,

                      size: 32,

                      color: Colors.redAccent,

                    ),

                  ),

                  const SizedBox(height: 16),


                  // Title

                  Flexible(

                    child: Text(

                      lesson.isRecurring

                          ? "Delete Recurring?"

                          : "Delete Event?",

                      textAlign: TextAlign.center,

                      style: TextStyle(

                        fontSize: 20,

                        fontWeight: FontWeight.bold,

                        color: isDark ? Colors.white : Colors.black,

                      ),

                    ),

                  ),

                  const SizedBox(height: 12),


                  // Subtitle

                  Text(

                    lesson.isRecurring

                        ? "Delete only this session or the entire series?"

                        : "Are you sure you want to delete '${lesson.name}'?",

                    textAlign: TextAlign.center,

                    style: TextStyle(

                      color: isDark ? Colors.white70 : Colors.black54,

                    ),

                  ),

                  const SizedBox(height: 24),


                  // Buttons

                  if (lesson.isRecurring) ...[

                    // RECURRING BUTTONS

                    Row(

                      children: [

                        Expanded(

                          child: OutlinedButton(

                            style: OutlinedButton.styleFrom(

                              padding: const EdgeInsets.symmetric(vertical: 12),

                              side: BorderSide(

                                color: isDark

                                    ? Colors.white24

                                    : Colors.grey.shade300,

                              ),

                              shape: RoundedRectangleBorder(

                                borderRadius: BorderRadius.circular(12),

                              ),

                            ),

                            onPressed: () {

                              Navigator.pop(ctx); // Close dialog

                              _lessonsRef.doc(lesson.id).update({

                                'excludeDates': FieldValue.arrayUnion([

                                  dateString,

                                ]),

                              });

                            },

                            child: Text(

                              "Only This",

                              textAlign: TextAlign.center,

                              style: TextStyle(

                                color: isDark ? Colors.white70 : Colors.black87,

                                fontSize: 13,

                              ),

                            ),

                          ),

                        ),

                        const SizedBox(width: 12),

                        Expanded(

                          child: ElevatedButton(

                            style: ElevatedButton.styleFrom(

                              padding: const EdgeInsets.symmetric(vertical: 12),

                              backgroundColor: Colors.redAccent,

                              shape: RoundedRectangleBorder(

                                borderRadius: BorderRadius.circular(12),

                              ),

                            ),

                            onPressed: () {

                              Navigator.pop(ctx);

                              // This deletes the doc, so it wipes past & future.

                              // Renaming button to "Delete Series" for clarity.

                              _lessonsRef.doc(lesson.id).delete();

                            },

                            child: const Text(

                              "Delete Series",

                              textAlign: TextAlign.center,

                              style: TextStyle(

                                color: Colors.white,

                                fontWeight: FontWeight.bold,

                                fontSize: 13,

                              ),

                            ),

                          ),

                        ),

                      ],

                    ),

                  ] else ...[

                    // ONE-TIME EVENT BUTTONS

                    Row(

                      children: [

                        Expanded(

                          child: OutlinedButton(

                            style: OutlinedButton.styleFrom(

                              padding: const EdgeInsets.symmetric(vertical: 12),

                              side: BorderSide(

                                color: isDark

                                    ? Colors.white24

                                    : Colors.grey.shade300,

                              ),

                              shape: RoundedRectangleBorder(

                                borderRadius: BorderRadius.circular(12),

                              ),

                            ),

                            onPressed: () => Navigator.pop(ctx), // Just cancel

                            child: Text(

                              "Keep",

                              style: TextStyle(

                                color: isDark ? Colors.white70 : Colors.black87,

                              ),

                            ),

                          ),

                        ),

                        const SizedBox(width: 12),

                        Expanded(

                          child: ElevatedButton(

                            style: ElevatedButton.styleFrom(

                              padding: const EdgeInsets.symmetric(vertical: 12),

                              backgroundColor: Colors.redAccent,

                              shape: RoundedRectangleBorder(

                                borderRadius: BorderRadius.circular(12),

                              ),

                            ),

                            onPressed: () {

                              Navigator.pop(ctx);

                              _lessonsRef.doc(lesson.id).delete();

                            },

                            child: const Text(

                              "Delete",

                              style: TextStyle(

                                color: Colors.white,

                                fontWeight: FontWeight.bold,

                              ),

                            ),

                          ),

                        ),

                      ],

                    ),

                  ],


                  const SizedBox(height: 12),


                  // MAIN CANCEL BUTTON (Bottom)

                  TextButton(

                    onPressed: () => Navigator.pop(ctx),

                    child: Text(

                      "Cancel",

                      style: TextStyle(color: Colors.grey.shade500),

                    ),

                  ),

                ],

              ),

            ),

          ),

        );

      },

    );

  }


  void _openLessonDialog({Lesson? lesson}) {

    showDialog(

      context: context,

      builder: (_) => AddLessonDialog(

        selectedDate: _selectedDate,

        courseDatabase: _smartCourseDatabase,

        onAddLesson: _saveLessonToFirestore,

        onUpdateGlobal: _updateGlobalInstructor,

        lessonToEdit: lesson,

        onDelete: _handleDeleteRequest,

      ),

    );

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final accentColor = isDark

        ? Colors.deepPurpleAccent

        : Theme.of(context).primaryColor;

    final dayName = DateFormat('EEEE').format(_selectedDate);

    final dateString = DateFormat('yyyy-MM-dd').format(_selectedDate);


    return Scaffold(

      backgroundColor: Colors.transparent,

      floatingActionButton: FloatingActionButton(

        onPressed: () => _openLessonDialog(), // ADD MODE

        backgroundColor: accentColor,

        child: const Icon(Icons.add, color: Colors.white),

      ),

      body: Column(

        children: [

          CalendarHeader(

            selectedDate: _selectedDate,

            onDateSelected: (newDate) =>

                setState(() => _selectedDate = newDate),

          ),

          const SizedBox(height: 10),

          Expanded(

            child: StreamBuilder<QuerySnapshot>(

              stream: _lessonsStream,

              builder: (context, snapshot) {

                if (snapshot.connectionState == ConnectionState.waiting) {

                  return const Center(child: CircularProgressIndicator());

                }


                final allLessons =

                    snapshot.data?.docs

                        .map((doc) => Lesson.fromFirestore(doc))

                        .toList() ??

                    [];


                // Refresh Smart Database

                _smartCourseDatabase = {};

                for (var l in allLessons) {

                  if (l.isLecture && l.name.isNotEmpty) {

                    _smartCourseDatabase[l.name] = l.instructor;

                  }

                }


                // Filter Logic

                final daysLessons = allLessons.where((l) {

                  if (l.isRecurring) {

                    return l.dayOfWeek == dayName &&

                        !l.excludeDates.contains(dateString);

                  }

                  return l.specificDate == dateString;

                }).toList();


                daysLessons.sort(

                  (a, b) =>

                      a.startTimeInMinutes.compareTo(b.startTimeInMinutes),

                );


                if (daysLessons.isEmpty) {

                  return Center(

                    child: Text(

                      "No plans for $dayName.",

                      style: TextStyle(color: Colors.grey.withOpacity(0.8)),

                    ),

                  );

                }


                return ListView.builder(

                  padding: const EdgeInsets.all(16),

                  itemCount: daysLessons.length,

                  itemBuilder: (context, index) {

                    final lesson = daysLessons[index];

                    return ClassCard(

                      lesson: lesson,

                      onEdit: () =>

                          _openLessonDialog(lesson: lesson), // EDIT MODE

                    );

                  },

                );

              },

            ),

          ),

        ],

      ),

    );

  }

}


add_transaction_dialog.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';

import 'package:cloud_firestore/cloud_firestore.dart';

import '../../models/finance_models.dart';


class AddTransactionDialog extends StatefulWidget {

  final List<FinanceBucket> buckets;

  final FinanceTransaction? transactionToEdit;


  const AddTransactionDialog({

    super.key,

    required this.buckets,

    this.transactionToEdit,

  });


  @override

  State<AddTransactionDialog> createState() => _AddTransactionDialogState();

}


class _AddTransactionDialogState extends State<AddTransactionDialog> {

  final _titleController = TextEditingController();

  final _amountController = TextEditingController();


  bool _isExpense = true;

  String? _selectedBucketId;

  Map<String, dynamic>? _selectedIncomeCategory;

  DateTime _selectedDate = DateTime.now();


  // Logic for Subscriptions

  bool _showSubscriptionDropdown = false;

  Map<String, dynamic>? _selectedSubscription;


  // Loading state (Visual only now, since we close instantly)

  bool _isLoading = false;


  // --- QUICK OPTIONS ---

  final List<Map<String, dynamic>> _quickAddExpenseOptions = [

    {'icon': 'â˜•', 'title': 'Coffee', 'amount': '4.50', 'category': 'Dining'},

    {'icon': 'ðŸ”', 'title': 'Lunch', 'amount': '12.00', 'category': 'Dining'},

    {'icon': 'ðŸ¥¦', 'title': 'Market', 'amount': '', 'category': 'Groceries'},

    {'icon': 'ðŸšŒ', 'title': 'Bus', 'amount': '2.50', 'category': 'Transport'},

  ];


  final List<Map<String, dynamic>> _subscriptionOptions = [

    {'name': 'Netflix', 'icon': Icons.tv_rounded, 'color': Colors.red},

    {

      'name': 'Spotify',

      'icon': Icons.music_note_rounded,

      'color': Colors.green,

    },

    {

      'name': 'YouTube',

      'icon': Icons.play_circle_filled_rounded,

      'color': Colors.redAccent,

    },

    {

      'name': 'Amazon',

      'icon': Icons.shopping_cart_rounded,

      'color': Colors.blue,

    },

    {

      'name': 'Gym',

      'icon': Icons.fitness_center_rounded,

      'color': Colors.orange,

    },

    {

      'name': 'Other',

      'icon': Icons.subscriptions_rounded,

      'color': Colors.grey,

    },

  ];


  final List<Map<String, dynamic>> _incomeOptions = [

    {

      'name': 'Allowance',

      'icon': Icons.sentiment_satisfied_alt_rounded,

      'color': Colors.orange,

    },

    {'name': 'Wage', 'icon': Icons.work_rounded, 'color': Colors.blue},

    {'name': 'Gift', 'icon': Icons.card_giftcard_rounded, 'color': Colors.pink},

    {'name': 'Savings', 'icon': Icons.savings_rounded, 'color': Colors.purple},

    {'name': 'Other', 'icon': Icons.attach_money_rounded, 'color': Colors.teal},

  ];


  @override

  void initState() {

    super.initState();

    if (widget.transactionToEdit != null) {

      final t = widget.transactionToEdit!;

      _titleController.text = t.title;

      _amountController.text = t.amount.toString();

      _selectedDate = t.date;

      _isExpense = t.isExpense;


      if (_isExpense) {

        _selectedBucketId = t.categoryId;

        try {

          final bucket = widget.buckets.firstWhere((b) => b.id == t.categoryId);

          _checkIfSubscription(bucket);

        } catch (_) {}

      } else {

        _selectedIncomeCategory = _incomeOptions.first;

      }

    } else {

      if (widget.buckets.isNotEmpty) {

        _selectedBucketId = widget.buckets.first.id;

        _checkIfSubscription(widget.buckets.first);

      }

      _selectedIncomeCategory = _incomeOptions.first;

    }

  }


  void _checkIfSubscription(FinanceBucket bucket) {

    setState(() {

      _showSubscriptionDropdown = bucket.name == 'Subscriptions';

      if (_showSubscriptionDropdown && _titleController.text.isEmpty) {

        _titleController.clear();

      }

    });

  }


  void _applyQuickAdd(Map<String, dynamic> option) {

    setState(() {

      _titleController.text = option['title'];

      if (option['amount'].isNotEmpty) {

        _amountController.text = option['amount'];

      }

      _isExpense = true;

      _showSubscriptionDropdown = false;

      try {

        final match = widget.buckets.firstWhere(

          (b) => b.name == option['category'],

        );

        _selectedBucketId = match.id;

      } catch (e) {

        // No match found

      }

    });

  }


  // --- DELETE LOGIC (Fire and Forget) ---

  void _deleteTransaction() {

    // 1. Show Confirmation Dialog

    showDialog<bool>(

      context: context,

      builder: (ctx) => Dialog(

        backgroundColor: const Color(0xFF1E1E1E),

        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),

        child: Padding(

          padding: const EdgeInsets.all(24.0),

          child: Column(

            mainAxisSize: MainAxisSize.min,

            children: [

              const Icon(

                Icons.delete_forever_rounded,

                size: 48,

                color: Colors.redAccent,

              ),

              const SizedBox(height: 16),

              const Text(

                "Delete Transaction",

                style: TextStyle(

                  color: Colors.white,

                  fontSize: 20,

                  fontWeight: FontWeight.bold,

                ),

              ),

              const SizedBox(height: 8),

              const Text(

                "Are you sure? This cannot be undone.",

                textAlign: TextAlign.center,

                style: TextStyle(color: Colors.white54, fontSize: 14),

              ),

              const SizedBox(height: 24),

              Row(

                children: [

                  Expanded(

                    child: OutlinedButton(

                      onPressed: () => Navigator.pop(ctx, false),

                      style: OutlinedButton.styleFrom(

                        side: BorderSide(color: Colors.grey.shade700),

                        foregroundColor: Colors.white,

                        padding: const EdgeInsets.symmetric(vertical: 12),

                      ),

                      child: const Text("Cancel"),

                    ),

                  ),

                  const SizedBox(width: 12),

                  Expanded(

                    child: ElevatedButton(

                      onPressed: () => Navigator.pop(ctx, true),

                      style: ElevatedButton.styleFrom(

                        backgroundColor: Colors.redAccent,

                        foregroundColor: Colors.white,

                        padding: const EdgeInsets.symmetric(vertical: 12),

                      ),

                      child: const Text("Delete"),

                    ),

                  ),

                ],

              ),

            ],

          ),

        ),

      ),

    ).then((confirm) {

      // 2. If confirmed, delete without waiting

      if (confirm == true && widget.transactionToEdit != null) {

        // FIRE AND FORGET: No 'await' here

        FirebaseFirestore.instance

            .collection('finance_transactions')

            .doc(widget.transactionToEdit!.id)

            .delete();


        // Close the main dialog immediately

        if (mounted) Navigator.pop(context);

      }

    });

  }


  // --- SAVE LOGIC (Fire and Forget) ---

  void _submit() {

    if (_amountController.text.isEmpty) return;

    if (_isExpense && _selectedBucketId == null) return;


    // We don't need isLoading anymore because we close instantly

    // setState(() => _isLoading = true);


    String finalTitle = _titleController.text;

    if (_isExpense &&

        _showSubscriptionDropdown &&

        _selectedSubscription != null) {

      finalTitle = _selectedSubscription!['name'];

    }

    if (!_isExpense && finalTitle.isEmpty && _selectedIncomeCategory != null) {

      finalTitle = _selectedIncomeCategory!['name'];

    }

    if (finalTitle.isEmpty) finalTitle = "Transaction";


    final amount = double.tryParse(_amountController.text) ?? 0.0;


    final Map<String, dynamic> data = {

      'title': finalTitle,

      'amount': amount,

      'isExpense': _isExpense,

      'categoryId': _isExpense ? _selectedBucketId : 'income',

      'date': Timestamp.fromDate(_selectedDate),

      'userId': 'test_user',

    };


    if (!_isExpense && _selectedIncomeCategory != null) {

      data['iconCode'] =

          (_selectedIncomeCategory!['icon'] as IconData).codePoint;

      data['colorValue'] = (_selectedIncomeCategory!['color'] as Color).value;

    }


    try {

      final collection = FirebaseFirestore.instance.collection(

        'finance_transactions',

      );


      // FIRE AND FORGET: We do NOT use 'await' here.

      if (widget.transactionToEdit != null) {

        collection.doc(widget.transactionToEdit!.id).update(data);

      } else {

        collection.add(data);

      }


      // Close immediately. Firebase will sync when it can.

      Navigator.pop(context);

    } catch (e) {

      print("Error saving: $e");

    }

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final primaryColor = Colors.green;

    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;

    final isEditing = widget.transactionToEdit != null;


    return Dialog(

      backgroundColor: bgColor,

      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),

      insetPadding: const EdgeInsets.all(20),

      child: Container(

        padding: const EdgeInsets.all(20),

        child: SingleChildScrollView(

          physics: const BouncingScrollPhysics(),

          child: Column(

            mainAxisSize: MainAxisSize.min,

            children: [

              Text(

                isEditing

                    ? "Edit Transaction"

                    : (_isExpense ? "New Expense" : "New Income"),

                style: TextStyle(

                  fontWeight: FontWeight.bold,

                  color: textColor,

                  fontSize: 18,

                ),

              ),

              const SizedBox(height: 20),


              // 1. Toggle Switch

              Container(

                decoration: BoxDecoration(

                  color: isDark ? Colors.grey.shade800 : Colors.grey.shade200,

                  borderRadius: BorderRadius.circular(12),

                ),

                child: Row(

                  children: [

                    Expanded(

                      child: GestureDetector(

                        onTap: () => setState(() => _isExpense = true),

                        child: Container(

                          padding: const EdgeInsets.symmetric(vertical: 10),

                          decoration: BoxDecoration(

                            color: _isExpense

                                ? Colors.redAccent.withOpacity(0.2)

                                : Colors.transparent,

                            borderRadius: BorderRadius.circular(12),

                            border: _isExpense

                                ? Border.all(color: Colors.redAccent)

                                : null,

                          ),

                          child: Center(

                            child: Text(

                              "ðŸ’¸ Expense",

                              style: TextStyle(

                                fontWeight: FontWeight.bold,

                                color: _isExpense

                                    ? Colors.redAccent

                                    : Colors.grey,

                              ),

                            ),

                          ),

                        ),

                      ),

                    ),

                    Expanded(

                      child: GestureDetector(

                        onTap: () => setState(() => _isExpense = false),

                        child: Container(

                          padding: const EdgeInsets.symmetric(vertical: 10),

                          decoration: BoxDecoration(

                            color: !_isExpense

                                ? Colors.green.withOpacity(0.2)

                                : Colors.transparent,

                            borderRadius: BorderRadius.circular(12),

                            border: !_isExpense

                                ? Border.all(color: Colors.green)

                                : null,

                          ),

                          child: Center(

                            child: Text(

                              "ðŸ’° Income",

                              style: TextStyle(

                                fontWeight: FontWeight.bold,

                                color: !_isExpense ? Colors.green : Colors.grey,

                              ),

                            ),

                          ),

                        ),

                      ),

                    ),

                  ],

                ),

              ),

              const SizedBox(height: 16),


              // 2. QUICK ADD CHIPS

              if (_isExpense) ...[

                SizedBox(

                  height: 40,

                  child: SingleChildScrollView(

                    scrollDirection: Axis.horizontal,

                    child: Row(

                      children: _quickAddExpenseOptions.map((opt) {

                        return Padding(

                          padding: const EdgeInsets.only(right: 8.0),

                          child: ActionChip(

                            backgroundColor: isDark

                                ? Colors.grey.shade800

                                : Colors.grey.shade100,

                            label: Text("${opt['icon']} ${opt['title']}"),

                            padding: const EdgeInsets.symmetric(horizontal: 4),

                            onPressed: () => _applyQuickAdd(opt),

                          ),

                        );

                      }).toList(),

                    ),

                  ),

                ),

                const SizedBox(height: 16),

              ],


              // 3. Amount Input

              TextField(

                controller: _amountController,

                keyboardType: const TextInputType.numberWithOptions(

                  decimal: true,

                ),

                style: TextStyle(

                  fontSize: 24,

                  fontWeight: FontWeight.bold,

                  color: textColor,

                ),

                textAlign: TextAlign.center,

                decoration: InputDecoration(

                  prefixText: '\$ ',

                  hintText: '0.00',

                  filled: true,

                  fillColor: isDark ? Colors.black26 : Colors.grey.shade100,

                  border: OutlineInputBorder(

                    borderRadius: BorderRadius.circular(12),

                    borderSide: BorderSide.none,

                  ),

                ),

              ),

              const SizedBox(height: 16),


              // 4. Category Dropdown

              if (_isExpense)

                DropdownButtonFormField<String>(

                  value: _selectedBucketId,

                  dropdownColor: bgColor,

                  items: widget.buckets.map<DropdownMenuItem<String>>((b) {

                    return DropdownMenuItem(

                      value: b.id,

                      child: Row(

                        children: [

                          Icon(b.icon, size: 18, color: b.color),

                          const SizedBox(width: 8),

                          Text(b.name, style: TextStyle(color: textColor)),

                        ],

                      ),

                    );

                  }).toList(),

                  onChanged: (val) {

                    setState(() {

                      _selectedBucketId = val;

                      if (val != null) {

                        try {

                          final bucket = widget.buckets.firstWhere(

                            (b) => b.id == val,

                          );

                          _checkIfSubscription(bucket);

                        } catch (_) {}

                      }

                    });

                  },

                  decoration: InputDecoration(

                    labelText: "Category",

                    labelStyle: TextStyle(color: Colors.grey.shade500),

                    enabledBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: BorderSide(color: Colors.grey.shade700),

                    ),

                    focusedBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: const BorderSide(color: Colors.green),

                    ),

                  ),

                )

              else

                DropdownButtonFormField<Map<String, dynamic>>(

                  value: _selectedIncomeCategory,

                  dropdownColor: bgColor,

                  items: _incomeOptions.map((cat) {

                    return DropdownMenuItem(

                      value: cat,

                      child: Row(

                        children: [

                          Icon(cat['icon'], size: 16, color: cat['color']),

                          const SizedBox(width: 10),

                          Text(cat['name'], style: TextStyle(color: textColor)),

                        ],

                      ),

                    );

                  }).toList(),

                  onChanged: (val) =>

                      setState(() => _selectedIncomeCategory = val),

                  decoration: InputDecoration(

                    labelText: "Source",

                    labelStyle: TextStyle(color: Colors.grey.shade500),

                    enabledBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: BorderSide(color: Colors.grey.shade700),

                    ),

                    focusedBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: const BorderSide(color: Colors.green),

                    ),

                  ),

                ),

              const SizedBox(height: 12),


              // 5. Title / Subscription

              if (_isExpense && _showSubscriptionDropdown)

                DropdownButtonFormField<Map<String, dynamic>>(

                  value: _selectedSubscription,

                  dropdownColor: bgColor,

                  items: _subscriptionOptions

                      .map(

                        (s) => DropdownMenuItem(

                          value: s,

                          child: Row(

                            children: [

                              Icon(s['icon'], color: s['color'], size: 20),

                              const SizedBox(width: 10),

                              Text(

                                s['name'],

                                style: TextStyle(color: textColor),

                              ),

                            ],

                          ),

                        ),

                      )

                      .toList(),

                  onChanged: (val) {

                    setState(() {

                      _selectedSubscription = val;

                      if (val != null) _titleController.text = val['name'];

                    });

                  },

                  decoration: InputDecoration(

                    labelText: "Subscription Name",

                    labelStyle: TextStyle(color: Colors.grey.shade500),

                    enabledBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: BorderSide(color: Colors.grey.shade700),

                    ),

                    focusedBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: const BorderSide(color: Colors.green),

                    ),

                  ),

                )

              else

                TextField(

                  controller: _titleController,

                  style: TextStyle(color: textColor),

                  decoration: InputDecoration(

                    labelText: "Title (Optional)",

                    labelStyle: TextStyle(color: Colors.grey.shade500),

                    enabledBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: BorderSide(color: Colors.grey.shade700),

                    ),

                    focusedBorder: OutlineInputBorder(

                      borderRadius: BorderRadius.circular(12),

                      borderSide: const BorderSide(color: Colors.green),

                    ),

                    hintText: _isExpense

                        ? "e.g. Burger King"

                        : "e.g. Monthly Allowance",

                    hintStyle: TextStyle(color: Colors.grey.shade600),

                  ),

                ),

              const SizedBox(height: 12),


              // 6. Date Picker

              InkWell(

                onTap: () async {

                  final picked = await showDatePicker(

                    context: context,

                    initialDate: _selectedDate,

                    firstDate: DateTime(2020),

                    lastDate: DateTime(2030),

                    builder: (context, child) {

                      return Theme(

                        data: Theme.of(context).copyWith(

                          colorScheme: ColorScheme.dark(

                            primary: primaryColor,

                            onPrimary: Colors.white,

                            surface: const Color(0xFF1E1E1E),

                            onSurface: Colors.white,

                          ),

                        ),

                        child: child!,

                      );

                    },

                  );

                  if (picked != null) setState(() => _selectedDate = picked);

                },

                child: Container(

                  padding: const EdgeInsets.symmetric(

                    vertical: 14,

                    horizontal: 12,

                  ),

                  decoration: BoxDecoration(

                    border: Border.all(color: Colors.grey.shade700),

                    borderRadius: BorderRadius.circular(12),

                  ),

                  child: Row(

                    children: [

                      Icon(

                        Icons.calendar_today_rounded,

                        size: 18,

                        color: Colors.grey.shade500,

                      ),

                      const SizedBox(width: 8),

                      Text(

                        DateFormat('MMM dd, yyyy').format(_selectedDate),

                        style: TextStyle(color: textColor),

                      ),

                    ],

                  ),

                ),

              ),


              const SizedBox(height: 24),


              // 7. Buttons

              Row(

                children: [

                  Expanded(

                    child: OutlinedButton(

                      onPressed: () => Navigator.pop(context),

                      style: OutlinedButton.styleFrom(

                        padding: const EdgeInsets.symmetric(vertical: 14),

                        side: BorderSide(color: Colors.grey.shade700),

                        foregroundColor: textColor,

                      ),

                      child: const Text("Cancel"),

                    ),

                  ),

                  const SizedBox(width: 12),

                  Expanded(

                    child: ElevatedButton(

                      // NO LOADING CHECK - WE SUBMIT AND CLOSE

                      onPressed: _submit,

                      style: ElevatedButton.styleFrom(

                        backgroundColor: primaryColor,

                        foregroundColor: Colors.white,

                        padding: const EdgeInsets.symmetric(vertical: 14),

                        shape: RoundedRectangleBorder(

                          borderRadius: BorderRadius.circular(50),

                        ),

                      ),

                      child: const Text("Save"),

                    ),

                  ),

                ],

              ),


              if (isEditing) ...[

                const SizedBox(height: 16),

                TextButton.icon(

                  onPressed: _deleteTransaction,

                  icon: const Icon(

                    Icons.delete_outline,

                    size: 18,

                    color: Colors.redAccent,

                  ),

                  label: const Text(

                    "Delete Transaction",

                    style: TextStyle(color: Colors.redAccent),

                  ),

                ),

              ],

            ],

          ),

        ),

      ),

    );

  }

}


bucket_list.dart:

import 'package:flutter/material.dart';

import 'budget_progress_bar.dart';

import '../../models/finance_models.dart'; // Ensure this points to your new file


class BucketList extends StatelessWidget {

  final List<FinanceBucket> buckets;

  final String? selectedBucketId;

  final Function(String?) onBucketSelected;


  const BucketList({

    super.key,

    required this.buckets,

    required this.selectedBucketId,

    required this.onBucketSelected,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    return ListView.builder(

      padding: const EdgeInsets.symmetric(horizontal: 16),

      scrollDirection: Axis.horizontal,

      itemCount: buckets.length,

      itemBuilder: (context, index) {

        final bucket = buckets[index];

        final isSelected = selectedBucketId == bucket.id;


        return GestureDetector(

          onTap: () => onBucketSelected(isSelected ? null : bucket.id),

          child: AnimatedContainer(

            duration: const Duration(milliseconds: 300),

            width: 140,

            margin: const EdgeInsets.only(right: 12, bottom: 4, top: 4),

            padding: const EdgeInsets.all(16),

            decoration: BoxDecoration(

              color: isSelected ? bucket.color.withOpacity(0.1) : cardColor,

              borderRadius: BorderRadius.circular(20),

              border: isSelected

                  ? Border.all(color: bucket.color, width: 2)

                  : Border.all(color: Colors.transparent, width: 2),

            ),

            child: Column(

              crossAxisAlignment: CrossAxisAlignment.start,

              mainAxisAlignment: MainAxisAlignment.spaceBetween,

              children: [

                Icon(bucket.icon, color: bucket.color, size: 28),

                Column(

                  crossAxisAlignment: CrossAxisAlignment.start,

                  children: [

                    Text(

                      bucket.name,

                      style: TextStyle(

                        fontWeight: FontWeight.bold,

                        fontSize: 14,

                        color: textColor,

                      ),

                      maxLines: 1,

                      overflow: TextOverflow.ellipsis,

                    ),

                    const SizedBox(height: 2),

                    Text(

                      "\$${bucket.spent.toInt()}",

                      style: TextStyle(

                        fontSize: 18,

                        fontWeight: FontWeight.w900,

                        color: textColor,

                      ),

                    ),

                  ],

                ),

                BudgetProgressBar(

                  spent: bucket.spent,

                  limit: bucket.limit,

                  color: bucket.color,

                  isFixed: bucket.isFixed,

                  showLabels: false,

                ),

              ],

            ),

          ),

        );

      },

    );

  }

}


budget_progress_bar.dart:

import 'package:flutter/material.dart';


class BudgetProgressBar extends StatelessWidget {

  final double spent;

  final double limit;

  final Color color;

  final bool isFixed; // True for Rent, False for Food

  final bool showLabels;

  final double? customIdeal; // NEW: Override the math for the Total Bar


  const BudgetProgressBar({

    super.key,

    required this.spent,

    required this.limit,

    required this.color,

    this.isFixed = false,

    this.showLabels = true,

    this.customIdeal, // NEW

  });


  @override

  Widget build(BuildContext context) {

    if (limit <= 0) return const SizedBox.shrink();


    final isDark = Theme.of(context).brightness == Brightness.dark;


    // 1. Time Calculations

    final now = DateTime.now();

    final daysInMonth = DateUtils.getDaysInMonth(now.year, now.month);

    final dayProgress = now.day / daysInMonth;


    // 2. Money Calculations

    final spendProgress = (spent / limit).clamp(0.0, 1.0);


    // SMART LOGIC: Use custom ideal if provided (for Total Bar), else calculate

    final idealSpend = customIdeal ?? (limit * dayProgress);

    final idealProgress = (idealSpend / limit).clamp(0.0, 1.0);


    final diffAmount = spent - idealSpend;

    final diffPercent = (diffAmount / limit) * 100;


    // 3. Status Logic

    String statusText;

    Color statusColor;


    if (isFixed) {

      // Fixed Logic (Rent)

      if (spent >= limit) {

        statusText = "âœ… Paid";

        statusColor = Colors.green;

      } else {

        statusText = "â³ Pending";

        statusColor = Colors.orange;

      }

    } else {

      // Fluid Logic (Food) OR Mixed (Total)

      if (diffPercent > 5) {

        statusText = "âš ï¸ +${diffPercent.toInt()}% ahead";

        statusColor = Colors.redAccent;

      } else if (diffPercent < -5) {

        statusText = "âœ… ${diffPercent.abs().toInt()}% under";

        statusColor = Colors.green;

      } else {

        statusText = "ðŸ‘Œ On Track";

        statusColor = Colors.green;

      }

    }


    return Column(

      crossAxisAlignment: CrossAxisAlignment.start,

      children: [

        // THE BAR STACK

        SizedBox(

          height: 12,

          child: LayoutBuilder(

            builder: (context, constraints) {

              final width = constraints.maxWidth;


              return Stack(

                alignment: Alignment.centerLeft,

                children: [

                  // A. Background

                  Container(

                    width: width,

                    decoration: BoxDecoration(

                      color: isDark

                          ? Colors.grey.shade800

                          : Colors.grey.shade200,

                      borderRadius: BorderRadius.circular(6),

                    ),

                  ),


                  // B. Actual Spending

                  AnimatedContainer(

                    duration: const Duration(milliseconds: 500),

                    width: width * spendProgress,

                    decoration: BoxDecoration(

                      color: color,

                      borderRadius: BorderRadius.circular(6),

                    ),

                  ),


                  // C. "Ideal" Line Marker (Show for Fluid or Mixed)

                  if (!isFixed)

                    Positioned(

                      left: (width * idealProgress).clamp(0, width - 2),

                      child: Container(

                        width: 2,

                        height: 12,

                        color: isDark ? Colors.white : Colors.black,

                      ),

                    ),

                ],

              );

            },

          ),

        ),


        // LABELS

        if (showLabels) ...[

          const SizedBox(height: 6),

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Text(

                "${(spendProgress * 100).toInt()}% used",

                style: TextStyle(

                  fontSize: 11,

                  color: isDark ? Colors.white70 : Colors.black54,

                ),

              ),

              Text(

                statusText,

                style: TextStyle(

                  fontSize: 11,

                  fontWeight: FontWeight.bold,

                  color: statusColor,

                ),

              ),

            ],

          ),

        ],

      ],

    );

  }

}


edit_monthly_budget.dart:

import 'package:flutter/material.dart';

import '../../models/finance_models.dart';


class EditMonthlyBudgetDialog extends StatefulWidget {

  final List<FinanceBucket> buckets;

  final Function(String, double, String, VoidCallback) onUpdateLimit;


  const EditMonthlyBudgetDialog({

    super.key,

    required this.buckets,

    required this.onUpdateLimit,

  });


  @override

  State<EditMonthlyBudgetDialog> createState() =>

      _EditMonthlyBudgetDialogState();

}


class _EditMonthlyBudgetDialogState extends State<EditMonthlyBudgetDialog> {

  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;

    final totalLimit = widget.buckets.fold(0.0, (sum, b) => sum + b.limit);


    return Dialog(

      backgroundColor: bgColor,

      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),

      insetPadding: const EdgeInsets.all(20),

      child: Container(

        padding: const EdgeInsets.all(20.0),

        // FIX 1: Wrap in SingleChildScrollView to prevent keyboard overflow

        child: SingleChildScrollView(

          child: Column(

            mainAxisSize: MainAxisSize.min,

            children: [

              Text(

                "Monthly Budgets",

                style: TextStyle(

                  fontSize: 20,

                  fontWeight: FontWeight.bold,

                  color: textColor,

                ),

              ),

              const SizedBox(height: 16),

              // Use a limited height list or shrinkWrap

              ListView.separated(

                shrinkWrap: true, // Important for dialogs

                physics:

                    const NeverScrollableScrollPhysics(), // Scroll the parent, not this list

                itemCount: widget.buckets.length,

                separatorBuilder: (_, __) => const Divider(height: 1),

                itemBuilder: (context, index) {

                  final bucket = widget.buckets[index];

                  return ListTile(

                    contentPadding: EdgeInsets.zero,

                    leading: Container(

                      padding: const EdgeInsets.all(8),

                      decoration: BoxDecoration(

                        color: bucket.color.withOpacity(0.1),

                        shape: BoxShape.circle,

                      ),

                      child: Icon(bucket.icon, size: 18, color: bucket.color),

                    ),

                    title: Text(

                      bucket.name,

                      style: TextStyle(

                        color: textColor,

                        fontWeight: FontWeight.bold,

                      ),

                    ),

                    trailing: Row(

                      mainAxisSize: MainAxisSize.min,

                      children: [

                        Text(

                          "\$${bucket.limit.toStringAsFixed(0)}",

                          style: TextStyle(color: textColor.withOpacity(0.7)),

                        ),

                        const SizedBox(width: 8),

                        Icon(Icons.edit, size: 16, color: Colors.grey.shade500),

                      ],

                    ),

                    onTap: () {

                      widget.onUpdateLimit(

                        bucket.id,

                        bucket.limit,

                        bucket.name,

                        () => setState(() {}), // Refresh this dialog after save

                      );

                    },

                  );

                },

              ),

              const Divider(),

              Padding(

                padding: const EdgeInsets.symmetric(vertical: 12.0),

                child: Row(

                  mainAxisAlignment: MainAxisAlignment.spaceBetween,

                  children: [

                    const Text(

                      "Total Budget",

                      style: TextStyle(color: Colors.grey),

                    ),

                    Text(

                      "\$${totalLimit.toStringAsFixed(0)}",

                      style: TextStyle(

                        fontSize: 18,

                        fontWeight: FontWeight.bold,

                        color: Colors.green,

                      ),

                    ),

                  ],

                ),

              ),

              SizedBox(

                width: double.infinity,

                child: ElevatedButton(

                  style: ElevatedButton.styleFrom(

                    backgroundColor: Colors.green,

                    shape: RoundedRectangleBorder(

                      borderRadius: BorderRadius.circular(12),

                    ),

                  ),

                  onPressed: () => Navigator.pop(context),

                  child: const Text(

                    "Done",

                    style: TextStyle(color: Colors.white),

                  ),

                ),

              ),

            ],

          ),

        ),

      ),

    );

  }

}


finance_dashboard.dart:

import 'package:flutter/material.dart';

import '../../models/finance_models.dart';

import 'budget_progress_bar.dart';

import 'pie_chart_view.dart';

import 'bucket_list.dart';

import 'transaction_list.dart';


enum FilterType { all, income, expense }


class FinanceDashboard extends StatefulWidget {

  final bool isDark;

  final bool showChart;

  final List<FinanceTransaction> transactions;

  final List<FinanceBucket> buckets;

  final double monthlyIncome;

  final double monthlyExpense;

  final Function(FinanceTransaction) onEditTransaction;

  final Function(String, double, String) onUpdateBucketLimit;

  final VoidCallback onEditAllBudgets;


  const FinanceDashboard({

    super.key,

    required this.isDark,

    required this.showChart,

    required this.transactions,

    required this.buckets,

    required this.monthlyIncome,

    required this.monthlyExpense,

    required this.onEditTransaction,

    required this.onUpdateBucketLimit,

    required this.onEditAllBudgets,

  });


  @override

  State<FinanceDashboard> createState() => _FinanceDashboardState();

}


class _FinanceDashboardState extends State<FinanceDashboard> {

  String? _selectedBucketId;

  FilterType _currentFilter = FilterType.all;


  void _toggleFilter(FilterType type) {

    setState(() {

      if (_currentFilter == type) {

        _currentFilter = FilterType.all;

      } else {

        _currentFilter = type;

        _selectedBucketId = null;

      }

    });

  }


  @override

  Widget build(BuildContext context) {

    final subTextColor = widget.isDark ? Colors.white54 : Colors.grey;

    final textColor = widget.isDark ? Colors.white : Colors.black87;

    final primaryColor = Colors.green;


    // Filter Logic

    List<FinanceTransaction> displayedTransactions = widget.transactions;

    if (_currentFilter == FilterType.expense) {

      displayedTransactions = displayedTransactions

          .where((t) => t.isExpense)

          .toList();

    } else if (_currentFilter == FilterType.income) {

      displayedTransactions = displayedTransactions

          .where((t) => !t.isExpense)

          .toList();

    }

    if (_selectedBucketId != null) {

      displayedTransactions = displayedTransactions

          .where((t) => t.categoryId == _selectedBucketId)

          .toList();

    }


    final chartTotal = widget.buckets.fold(

      0.0,

      (sum, item) => sum + item.spent,

    );

    final chartData = widget.buckets

        .map((b) => ChartData(b.id, b.name, b.spent, b.color, b.icon))

        .toList();

    final totalBudgetLimit = widget.buckets.fold(

      0.0,

      (sum, b) => sum + b.limit,

    );

    final totalBudgetSpent = widget.buckets.fold(

      0.0,

      (sum, b) => sum + b.spent,

    );


    final now = DateTime.now();

    final daysInMonth = DateUtils.getDaysInMonth(now.year, now.month);

    final timeProgress = (now.day / daysInMonth).clamp(0.0, 1.0);

    double totalIdealSpent = 0.0;


    for (var b in widget.buckets) {

      if (b.isFixed) {

        totalIdealSpent += b.limit;

      } else {

        totalIdealSpent += b.limit * timeProgress;

      }

    }


    FinanceBucket? selectedBucket;

    if (_selectedBucketId != null) {

      try {

        selectedBucket = widget.buckets.firstWhere(

          (b) => b.id == _selectedBucketId,

        );

      } catch (_) {}

    }


    return Column(

      children: [

        // --- SUMMARY CARDS ---

        Padding(

          padding: const EdgeInsets.fromLTRB(20, 10, 20, 0),

          child: Row(

            children: [

              Expanded(

                child: _buildSummaryCard(

                  "Income",

                  widget.monthlyIncome,

                  Colors.green,

                  widget.isDark,

                  FilterType.income,

                ),

              ),

              const SizedBox(width: 12),

              Expanded(

                child: _buildSummaryCard(

                  "Expense",

                  widget.monthlyExpense,

                  Colors.redAccent,

                  widget.isDark,

                  FilterType.expense,

                ),

              ),

            ],

          ),

        ),


        // --- TOTAL BUDGET PROGRESS BAR (Only if chart is hidden) ---

        if (!widget.showChart)

          Padding(

            padding: const EdgeInsets.fromLTRB(20, 16, 20, 0),

            child: Column(

              crossAxisAlignment: CrossAxisAlignment.start,

              children: [

                Row(

                  mainAxisAlignment: MainAxisAlignment.spaceBetween,

                  children: [

                    Text(

                      "Total Monthly Budget",

                      style: TextStyle(fontSize: 12, color: subTextColor),

                    ),

                    GestureDetector(

                      onTap: widget.onEditAllBudgets,

                      child: Container(

                        padding: const EdgeInsets.all(4),

                        color: Colors.transparent,

                        child: Row(

                          children: [

                            Text(

                              "Edit All ",

                              style: TextStyle(

                                fontSize: 10,

                                color: subTextColor,

                              ),

                            ),

                            Icon(Icons.edit, size: 12, color: subTextColor),

                          ],

                        ),

                      ),

                    ),

                  ],

                ),

                const SizedBox(height: 8),

                BudgetProgressBar(

                  spent: totalBudgetSpent,

                  limit: totalBudgetLimit,

                  color: primaryColor,

                  isFixed: false,

                  customIdeal: totalIdealSpent,

                ),

              ],

            ),

          ),


        // --- CHART / LIST SWITCHER (FIXED) ---

        SizedBox(

          height: widget.showChart ? 320 : 210,

          child: AnimatedSwitcher(

            duration: const Duration(milliseconds: 300),

            // FIX: This layoutBuilder prevents the overflow during transition

            layoutBuilder: (currentChild, previousChildren) {

              return Stack(

                alignment: Alignment.topCenter,

                children: <Widget>[

                  ...previousChildren,

                  if (currentChild != null) currentChild,

                ],

              );

            },

            child: widget.showChart

                ? PieChartView(

                    key: const ValueKey('chart'),

                    totalSpent: chartTotal,

                    data: chartData,

                    onSectionTap: (id) => setState(() {

                      _selectedBucketId = _selectedBucketId == id ? null : id;

                      _currentFilter = FilterType.all;

                    }),

                  )

                : BucketList(

                    key: const ValueKey('list'),

                    buckets: widget.buckets,

                    selectedBucketId: _selectedBucketId,

                    onBucketSelected: (id) => setState(() {

                      _selectedBucketId = id;

                      _currentFilter = FilterType.all;

                    }),

                  ),

          ),

        ),

        const SizedBox(height: 10),


        // --- HISTORY HEADER ---

        Padding(

          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),

          child: Column(

            crossAxisAlignment: CrossAxisAlignment.start,

            children: [

              SizedBox(

                height: 40,

                child: Stack(

                  alignment: Alignment.center,

                  children: [

                    if (selectedBucket != null)

                      Align(

                        alignment: Alignment.centerLeft,

                        child: Row(

                          mainAxisSize: MainAxisSize.min,

                          children: [

                            Icon(

                              selectedBucket.icon,

                              color: selectedBucket.color,

                              size: 20,

                            ),

                            const SizedBox(width: 8),

                            Flexible(

                              child: Text(

                                selectedBucket.name,

                                overflow: TextOverflow.ellipsis,

                                style: TextStyle(

                                  fontWeight: FontWeight.bold,

                                  fontSize: 18,

                                  color: textColor,

                                ),

                              ),

                            ),

                          ],

                        ),

                      ),


                    if (selectedBucket == null)

                      Text(

                        "History",

                        style: TextStyle(

                          fontSize: 18,

                          fontWeight: FontWeight.bold,

                          color: textColor,

                        ),

                      ),


                    if (selectedBucket != null)

                      Align(

                        alignment: Alignment.centerRight,

                        child: Row(

                          mainAxisSize: MainAxisSize.min,

                          children: [

                            InkWell(

                              onTap: () => widget.onUpdateBucketLimit(

                                selectedBucket!.id,

                                selectedBucket.limit,

                                selectedBucket.name,

                              ),

                              child: Container(

                                padding: const EdgeInsets.symmetric(

                                  horizontal: 8,

                                  vertical: 6,

                                ),

                                decoration: BoxDecoration(

                                  color: widget.isDark

                                      ? Colors.grey.shade800

                                      : Colors.grey.shade200,

                                  borderRadius: BorderRadius.circular(20),

                                ),

                                child: Row(

                                  children: [

                                    Icon(

                                      Icons.edit,

                                      size: 10,

                                      color: textColor.withOpacity(0.7),

                                    ),

                                    const SizedBox(width: 4),

                                    Text(

                                      "Limit",

                                      style: TextStyle(

                                        fontSize: 10,

                                        color: textColor.withOpacity(0.7),

                                      ),

                                    ),

                                  ],

                                ),

                              ),

                            ),

                            const SizedBox(width: 6),

                            InkWell(

                              onTap: () =>

                                  setState(() => _selectedBucketId = null),

                              child: Container(

                                padding: const EdgeInsets.symmetric(

                                  horizontal: 8,

                                  vertical: 6,

                                ),

                                decoration: BoxDecoration(

                                  color: Colors.redAccent.withOpacity(0.1),

                                  borderRadius: BorderRadius.circular(20),

                                ),

                                child: const Row(

                                  children: [

                                    Icon(

                                      Icons.arrow_back,

                                      size: 10,

                                      color: Colors.redAccent,

                                    ),

                                    SizedBox(width: 4),

                                    Text(

                                      "Back",

                                      style: TextStyle(

                                        fontSize: 10,

                                        fontWeight: FontWeight.bold,

                                        color: Colors.redAccent,

                                      ),

                                    ),

                                  ],

                                ),

                              ),

                            ),

                          ],

                        ),

                      ),

                  ],

                ),

              ),

              if (selectedBucket != null) ...[

                const SizedBox(height: 12),

                BudgetProgressBar(

                  spent: selectedBucket.spent,

                  limit: selectedBucket.limit,

                  color: selectedBucket.color,

                  isFixed: selectedBucket.isFixed,

                  showLabels: true,

                ),

                const SizedBox(height: 10),

              ],

            ],

          ),

        ),


        // --- TRANSACTION LIST ---

        Padding(

          padding: const EdgeInsets.symmetric(horizontal: 16),

          child: TransactionList(

            transactions: displayedTransactions,

            buckets: widget.buckets,

            isDark: widget.isDark,

            onEdit: widget.onEditTransaction,

          ),

        ),

      ],

    );

  }


  Widget _buildSummaryCard(

    String label,

    double amount,

    Color color,

    bool isDark,

    FilterType type,

  ) {

    bool isSelected = _currentFilter == type;

    Color bg = isSelected ? color.withOpacity(0.2) : color.withOpacity(0.1);

    Color border = isSelected ? color : Colors.transparent;


    return GestureDetector(

      onTap: () => _toggleFilter(type),

      child: AnimatedContainer(

        duration: const Duration(milliseconds: 200),

        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),

        decoration: BoxDecoration(

          color: bg,

          borderRadius: BorderRadius.circular(16),

          border: Border.all(color: border, width: 2),

        ),

        child: Column(

          crossAxisAlignment: CrossAxisAlignment.start,

          children: [

            Row(

              mainAxisAlignment: MainAxisAlignment.spaceBetween,

              children: [

                Text(

                  label,

                  style: TextStyle(

                    color: color,

                    fontWeight: FontWeight.bold,

                    fontSize: 12,

                  ),

                ),

                if (isSelected) Icon(Icons.check, size: 12, color: color),

              ],

            ),

            const SizedBox(height: 4),

            Text(

              "\$${amount.toStringAsFixed(0)}",

              style: TextStyle(

                color: isDark ? Colors.white : Colors.black87,

                fontWeight: FontWeight.bold,

                fontSize: 18,

              ),

            ),

          ],

        ),

      ),

    );

  }

}


finance_header.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';


class FinanceHeader extends StatelessWidget {

  final DateTime selectedDate;

  final Function(int) onMonthChanged;

  final VoidCallback onResetDate;

  final bool isInspectingPast;

  final bool showChart;

  final Function(bool) onChartToggle;


  const FinanceHeader({

    super.key,

    required this.selectedDate,

    required this.onMonthChanged,

    required this.onResetDate,

    required this.isInspectingPast,

    required this.showChart,

    required this.onChartToggle,

  });


  bool get _isCurrentMonth {

    final now = DateTime.now();

    return selectedDate.year == now.year && selectedDate.month == now.month;

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final primaryColor = Colors.green;

    final subTextColor = isDark ? Colors.white54 : Colors.grey;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Padding(

      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),

      child: SizedBox(

        height: 50,

        child: Stack(

          alignment: Alignment.center,

          children: [

            // 1. LEFT: Back Button (Always Visible)

            Align(

              alignment: Alignment.centerLeft,

              child: GestureDetector(

                onTap: () {

                  if (_isCurrentMonth) {

                    ScaffoldMessenger.of(context).showSnackBar(

                      const SnackBar(

                        content: Text("You are already up to date!"),

                        backgroundColor: Colors.green,

                        duration: Duration(seconds: 1),

                      ),

                    );

                  } else {

                    onResetDate();

                  }

                },

                child: Container(

                  padding: const EdgeInsets.all(10),

                  decoration: BoxDecoration(

                    color: primaryColor.withOpacity(0.2),

                    borderRadius: BorderRadius.circular(12),

                  ),

                  child: Icon(

                    Icons.undo_rounded,

                    color: primaryColor,

                    size: 20,

                  ),

                ),

              ),

            ),


            // 2. CENTER: Month Navigator

            Align(

              alignment: Alignment.center,

              child: Transform.translate(

                offset: const Offset(0, -4), // FIX: Shifts text up by 4 pixels

                child: Row(

                  mainAxisSize: MainAxisSize.min,

                  children: [

                    IconButton(

                      icon: const Icon(Icons.chevron_left_rounded, size: 28),

                      onPressed: () => onMonthChanged(-1),

                      color: subTextColor,

                    ),

                    Column(

                      mainAxisSize: MainAxisSize.min,

                      children: [

                        Text(

                          "Budget",

                          style: TextStyle(fontSize: 10, color: subTextColor),

                        ),

                        Text(

                          DateFormat('MMMM yyyy').format(selectedDate),

                          style: TextStyle(

                            fontSize: 18,

                            fontWeight: FontWeight.bold,

                            color: textColor,

                          ),

                        ),

                      ],

                    ),

                    IconButton(

                      icon: const Icon(Icons.chevron_right_rounded, size: 28),

                      onPressed: () => onMonthChanged(1),

                      color: subTextColor,

                    ),

                  ],

                ),

              ),

            ),


            // 3. RIGHT: Toggle Buttons (Only if visible)

            if (_isCurrentMonth || isInspectingPast)

              Align(

                alignment: Alignment.centerRight,

                child: Container(

                  decoration: BoxDecoration(

                    color: isDark ? Colors.grey.shade800 : Colors.grey.shade200,

                    borderRadius: BorderRadius.circular(12),

                  ),

                  child: Row(

                    mainAxisSize: MainAxisSize.min,

                    children: [

                      _buildToggleBtn(

                        Icons.pie_chart_rounded,

                        true,

                        isDark,

                        primaryColor,

                      ),

                      _buildToggleBtn(

                        Icons.view_list_rounded,

                        false,

                        isDark,

                        primaryColor,

                      ),

                    ],

                  ),

                ),

              ),

          ],

        ),

      ),

    );

  }


  Widget _buildToggleBtn(

    IconData icon,

    bool isChartTarget,

    bool isDark,

    Color activeColor,

  ) {

    final isSelected = showChart == isChartTarget;

    return GestureDetector(

      onTap: () => onChartToggle(isChartTarget),

      child: Container(

        padding: const EdgeInsets.all(8),

        decoration: BoxDecoration(

          color: isSelected ? activeColor : Colors.transparent,

          borderRadius: BorderRadius.circular(10),

        ),

        child: Icon(

          icon,

          size: 20,

          color: isSelected

              ? Colors.white

              : (isDark ? Colors.white54 : Colors.black54),

        ),

      ),

    );

  }

}


past_month_summary.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';


class PastMonthSummary extends StatelessWidget {

  final DateTime selectedDate;

  final double income;

  final double expense;

  final bool isDark;

  final VoidCallback onBackToToday;

  final VoidCallback onInspect;


  const PastMonthSummary({

    super.key,

    required this.selectedDate,

    required this.income,

    required this.expense,

    required this.isDark,

    required this.onBackToToday,

    required this.onInspect,

  });


  @override

  Widget build(BuildContext context) {

    final textColor = isDark ? Colors.white : Colors.black87;

    final primaryColor = Colors.green;

    final netSavings = income - expense;

    final isPositive = netSavings >= 0;


    return Padding(

      padding: const EdgeInsets.all(20.0),

      child: Column(

        children: [

          const SizedBox(height: 20),

          // Big Summary Card

          Container(

            width: double.infinity,

            padding: const EdgeInsets.all(24),

            decoration: BoxDecoration(

              gradient: LinearGradient(

                colors: isDark

                    ? [const Color(0xFF1E1E1E), const Color(0xFF252525)]

                    : [Colors.white, Colors.grey.shade50],

                begin: Alignment.topLeft,

                end: Alignment.bottomRight,

              ),

              borderRadius: BorderRadius.circular(32),

              boxShadow: [

                BoxShadow(

                  color: Colors.black.withOpacity(0.05),

                  blurRadius: 20,

                  offset: const Offset(0, 10),

                ),

              ],

            ),

            child: Column(

              children: [

                Icon(

                  isPositive ? Icons.savings_rounded : Icons.warning_rounded,

                  size: 48,

                  color: isPositive ? Colors.green : Colors.redAccent,

                ),

                const SizedBox(height: 16),

                Text(

                  isPositive ? "Great Job!" : "Over Budget",

                  style: TextStyle(

                    fontSize: 24,

                    fontWeight: FontWeight.bold,

                    color: textColor,

                  ),

                ),

                const SizedBox(height: 8),

                Text(

                  isPositive

                      ? "You saved \$${netSavings.toStringAsFixed(0)} in ${DateFormat('MMMM').format(selectedDate)}."

                      : "You spent \$${netSavings.abs().toStringAsFixed(0)} more than you earned.",

                  textAlign: TextAlign.center,

                  style: const TextStyle(fontSize: 14, color: Colors.grey),

                ),

                const SizedBox(height: 32),


                // Stats Row

                Row(

                  mainAxisAlignment: MainAxisAlignment.spaceAround,

                  children: [

                    _buildStatItem("Income", income, Colors.green),

                    Container(

                      width: 1,

                      height: 40,

                      color: Colors.grey.withOpacity(0.3),

                    ),

                    _buildStatItem("Expense", expense, Colors.redAccent),

                  ],

                ),

              ],

            ),

          ),


          const SizedBox(height: 32),


          // Action Buttons

          Row(

            children: [

              Expanded(

                child: OutlinedButton(

                  onPressed: onBackToToday,

                  style: OutlinedButton.styleFrom(

                    padding: const EdgeInsets.symmetric(vertical: 16),

                    side: BorderSide(color: Colors.grey.withOpacity(0.5)),

                  ),

                  child: Text(

                    "Back to Today",

                    style: TextStyle(color: textColor),

                  ),

                ),

              ),

              const SizedBox(width: 16),

              Expanded(

                child: ElevatedButton(

                  onPressed: onInspect,

                  style: ElevatedButton.styleFrom(

                    backgroundColor: primaryColor,

                    padding: const EdgeInsets.symmetric(vertical: 16),

                  ),

                  child: const Text(

                    "Inspect Details",

                    style: TextStyle(

                      color: Colors.white,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

              ),

            ],

          ),

        ],

      ),

    );

  }


  Widget _buildStatItem(String label, double amount, Color color) {

    return Column(

      children: [

        Text(label, style: const TextStyle(fontSize: 12, color: Colors.grey)),

        const SizedBox(height: 4),

        Text(

          "\$${amount.toStringAsFixed(0)}",

          style: TextStyle(

            fontSize: 20,

            fontWeight: FontWeight.bold,

            color: color,

          ),

        ),

      ],

    );

  }

}


pie_chart_view.dart:

import 'dart:math';

import 'package:flutter/material.dart';


class ChartData {

  final String id; // Added ID for filtering

  final String name;

  final double amount;

  final Color color;

  final IconData icon;


  ChartData(this.id, this.name, this.amount, this.color, this.icon);

}


class PieChartView extends StatelessWidget {

  final double totalSpent;

  final List<ChartData> data;

  final Function(String) onSectionTap; // Callback for filtering


  const PieChartView({

    super.key,

    required this.totalSpent,

    required this.data,

    required this.onSectionTap,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;


    return SizedBox(

      width: double.infinity,

      child: Column(

        mainAxisAlignment: MainAxisAlignment.center,

        crossAxisAlignment: CrossAxisAlignment.center,

        children: [

          // 1. The Interactive Donut Chart

          GestureDetector(

            onTapUp: (details) {

              _handleTap(details, context);

            },

            child: SizedBox(

              height: 180,

              width: 180,

              child: Stack(

                alignment: Alignment.center,

                children: [

                  CustomPaint(

                    size: const Size(180, 180),

                    painter: _DonutChartPainter(

                      data: data,

                      total: totalSpent,

                      bgColor: isDark

                          ? Colors.grey.shade800

                          : Colors.grey.shade200,

                    ),

                  ),

                  // Center Text

                  Column(

                    mainAxisSize: MainAxisSize.min,

                    children: [

                      Text(

                        "\$${totalSpent.toInt()}",

                        style: TextStyle(

                          fontSize: 26,

                          fontWeight: FontWeight.bold,

                          color: textColor,

                        ),

                      ),

                      Text(

                        "Total",

                        style: TextStyle(

                          fontSize: 12,

                          color: Colors.grey.shade500,

                        ),

                      ),

                    ],

                  ),

                ],

              ),

            ),

          ),

          const SizedBox(height: 24),


          // 2. The Legend (Clickable too)

          Wrap(

            spacing: 16,

            runSpacing: 10,

            alignment: WrapAlignment.center,

            children: data.map((item) {

              final percent = totalSpent == 0

                  ? 0

                  : (item.amount / totalSpent * 100).toInt();

              return GestureDetector(

                onTap: () => onSectionTap(item.id),

                child: Column(

                  mainAxisSize: MainAxisSize.min,

                  children: [

                    Container(

                      padding: const EdgeInsets.all(8),

                      decoration: BoxDecoration(

                        color: item.color.withOpacity(0.15),

                        shape: BoxShape.circle,

                      ),

                      child: Icon(item.icon, size: 18, color: item.color),

                    ),

                    const SizedBox(height: 4),

                    Text(

                      item.name,

                      style: TextStyle(

                        fontSize: 12,

                        fontWeight: FontWeight.bold,

                        color: textColor,

                      ),

                    ),

                    Text(

                      "$percent%",

                      style: TextStyle(

                        fontSize: 10,

                        color: Colors.grey.shade500,

                      ),

                    ),

                  ],

                ),

              );

            }).toList(),

          ),

        ],

      ),

    );

  }


  // Calculate which slice was tapped based on angle

  void _handleTap(TapUpDetails details, BuildContext context) {

    if (totalSpent == 0) return;


    final RenderBox box = context.findRenderObject() as RenderBox;

    final Offset localOffset = box.globalToLocal(details.globalPosition);

    final Offset center = Offset(box.size.width / 2, 180 / 2); // 180 is height


    // Calculate angle from center

    final dx = localOffset.dx - center.dx;

    final dy = localOffset.dy - center.dy;


    // atan2 returns -pi to +pi. We want 0 to 2pi starting from top (-pi/2)

    double angle = atan2(dy, dx);


    // Adjust so 0 is at the top (12 o'clock)

    angle += pi / 2;

    if (angle < 0) angle += 2 * pi;


    // Find the data segment that contains this angle

    double currentAngle = 0;

    for (var item in data) {

      final sweepAngle = (item.amount / totalSpent) * 2 * pi;

      if (angle >= currentAngle && angle < currentAngle + sweepAngle) {

        onSectionTap(item.id);

        return;

      }

      currentAngle += sweepAngle;

    }

  }

}


class _DonutChartPainter extends CustomPainter {

  final List<ChartData> data;

  final double total;

  final Color bgColor;


  _DonutChartPainter({

    required this.data,

    required this.total,

    required this.bgColor,

  });


  @override

  void paint(Canvas canvas, Size size) {

    final center = Offset(size.width / 2, size.height / 2);

    final radius = min(size.width / 2, size.height / 2);

    const strokeWidth = 20.0;


    final bgPaint = Paint()

      ..color = bgColor

      ..style = PaintingStyle.stroke

      ..strokeWidth = strokeWidth;


    canvas.drawCircle(center, radius - strokeWidth / 2, bgPaint);


    if (total == 0) return;


    // Start from -pi/2 (top)

    double startAngle = -pi / 2;


    for (var item in data) {

      final sweepAngle = (item.amount / total) * 2 * pi;

      final paint = Paint()

        ..color = item.color

        ..style = PaintingStyle.stroke

        ..strokeWidth = strokeWidth

        ..strokeCap = StrokeCap.round;


      if (sweepAngle > 0) {

        // Draw slightly less than full sweep to leave a gap if multiple items

        final gap = data.length > 1 ? 0.05 : 0.0;

        canvas.drawArc(

          Rect.fromCircle(center: center, radius: radius - strokeWidth / 2),

          startAngle + gap / 2,

          sweepAngle - gap,

          false,

          paint,

        );

      }

      startAngle += sweepAngle;

    }

  }


  @override

  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;

}


transaction_list.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';

import '../../models/finance_models.dart';


class TransactionList extends StatelessWidget {

  final List<FinanceTransaction> transactions;

  final List<FinanceBucket> buckets;

  final bool isDark;

  final Function(FinanceTransaction) onEdit;


  const TransactionList({

    super.key,

    required this.transactions,

    required this.buckets,

    required this.isDark,

    required this.onEdit,

  });


  @override

  Widget build(BuildContext context) {

    if (transactions.isEmpty) {

      return Center(

        child: Padding(

          padding: const EdgeInsets.all(32.0),

          child: Text(

            "No transactions yet.",

            style: TextStyle(color: Colors.grey.shade500),

          ),

        ),

      );

    }


    return ListView.builder(

      shrinkWrap: true,

      physics: const NeverScrollableScrollPhysics(),

      itemCount: transactions.length,

      itemBuilder: (context, index) {

        final tx = transactions[index];

        FinanceBucket? bucket;

        if (tx.isExpense) {

          try {

            bucket = buckets.firstWhere((b) => b.id == tx.categoryId);

          } catch (_) {}

        }


        final color = tx.isExpense

            ? (bucket?.color ?? Colors.grey)

            : (tx.color ?? Colors.green);


        final icon = tx.isExpense

            ? (bucket?.icon ?? Icons.category)

            : (tx.icon ?? Icons.attach_money);


        return Container(

          margin: const EdgeInsets.only(bottom: 12),

          padding: const EdgeInsets.all(16),

          decoration: BoxDecoration(

            color: isDark ? const Color(0xFF1E1E1E) : Colors.white,

            borderRadius: BorderRadius.circular(20),

            boxShadow: [

              BoxShadow(

                color: Colors.black.withOpacity(isDark ? 0.3 : 0.05),

                blurRadius: 10,

                offset: const Offset(0, 4),

              ),

            ],

          ),

          child: Row(

            children: [

              Container(

                padding: const EdgeInsets.all(10),

                decoration: BoxDecoration(

                  color: color.withOpacity(0.15),

                  shape: BoxShape.circle,

                ),

                child: Icon(icon, color: color, size: 20),

              ),

              const SizedBox(width: 16),

              Expanded(

                child: Column(

                  crossAxisAlignment: CrossAxisAlignment.start,

                  children: [

                    Text(

                      tx.title,

                      style: TextStyle(

                        fontWeight: FontWeight.bold,

                        fontSize: 16,

                        color: isDark ? Colors.white : Colors.black87,

                      ),

                    ),

                    const SizedBox(height: 4),

                    Text(

                      DateFormat('MMM d, h:mm a').format(tx.date),

                      style: TextStyle(

                        fontSize: 12,

                        color: Colors.grey.shade600,

                      ),

                    ),

                  ],

                ),

              ),

              Row(

                children: [

                  // FIX 3: RESTORED RED COLOR FOR EXPENSES

                  Text(

                    "${tx.isExpense ? '-' : '+'}\$${tx.amount.toStringAsFixed(2)}",

                    style: TextStyle(

                      fontWeight: FontWeight.bold,

                      fontSize: 16,

                      color: tx.isExpense

                          ? Colors

                                .redAccent // Explicitly Red

                          : Colors.green, // Explicitly Green

                    ),

                  ),

                  const SizedBox(width: 12),

                  GestureDetector(

                    onTap: () => onEdit(tx),

                    child: Container(

                      padding: const EdgeInsets.all(8),

                      decoration: BoxDecoration(

                        color: isDark ? Colors.white10 : Colors.grey.shade100,

                        shape: BoxShape.circle,

                      ),

                      child: Icon(

                        Icons.edit_rounded,

                        size: 14,

                        color: isDark ? Colors.white54 : Colors.grey,

                      ),

                    ),

                  ),

                ],

              ),

            ],

          ),

        );

      },

    );

  }

}


activity_card.dart:

import 'package:flutter/material.dart';

import '../../../../models/health_model.dart';

import 'routine_manager.dart';

import 'workout_logger.dart';

import 'exercise_models.dart';


class ActivityCard extends StatefulWidget {

  final HealthDailyLog log;

  final Function(String?) onRoutineChanged;

  final Function(bool) onWorkoutToggle;

  final Function(int) onStepsChanged;

  final Function(double) onWeightChanged;


  const ActivityCard({

    super.key,

    required this.log,

    required this.onRoutineChanged,

    required this.onWorkoutToggle,

    required this.onStepsChanged,

    required this.onWeightChanged,

  });


  @override

  State<ActivityCard> createState() => _ActivityCardState();

}


class _ActivityCardState extends State<ActivityCard> {

  int _currentExerciseIndex = 0;


  // MOCK DATA

  final List<ExerciseDetail> _activeExercises = [

    ExerciseDetail(

      name: "Bench Press",

      sets: [SetDetail(), SetDetail(), SetDetail()],

    ),

    ExerciseDetail(name: "Incline Fly", sets: [SetDetail(), SetDetail()]),

    ExerciseDetail(

      name: "Tricep Pushdown",

      sets: [SetDetail(), SetDetail(), SetDetail(), SetDetail()],

    ),

  ];


  final Set<int> _completedIndices = {};


  @override

  Widget build(BuildContext context) {

    final hasRoutine = widget.log.workoutName != null;


    return Container(

      // REDUCED PADDING: Content pushes closer to edges

      padding: const EdgeInsets.fromLTRB(8, 12, 8, 12),

      decoration: BoxDecoration(

        gradient: LinearGradient(

          colors: widget.log.isWorkoutDone

              ? [const Color(0xFF2E7D32), const Color(0xFF1B5E20)]

              : [const Color(0xFFEF6C00), const Color(0xFFE65100)],

        ),

        borderRadius: BorderRadius.circular(24),

        boxShadow: [

          BoxShadow(

            color: (widget.log.isWorkoutDone ? Colors.green : Colors.orange)

                .withOpacity(0.3),

            blurRadius: 10,

            offset: const Offset(0, 4),

          ),

        ],

      ),

      child: !hasRoutine

          ? _buildSelectorState(context)

          : _buildPlayerState(context),

    );

  }


  Widget _buildSelectorState(BuildContext context) {

    return GestureDetector(

      onTap: () => _showRoutineManager(context),

      child: Column(

        mainAxisAlignment: MainAxisAlignment.center,

        children: [

          Container(

            padding: const EdgeInsets.all(12),

            decoration: BoxDecoration(

              color: Colors.white.withOpacity(0.2),

              shape: BoxShape.circle,

            ),

            child: const Icon(

              Icons.fitness_center_rounded,

              color: Colors.white,

              size: 28,

            ),

          ),

          const SizedBox(height: 12),

          const Text(

            "No Routine",

            style: TextStyle(color: Colors.white70, fontSize: 12),

          ),

          const Text(

            "Tap to Start",

            style: TextStyle(

              color: Colors.white,

              fontWeight: FontWeight.bold,

              fontSize: 18,

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildPlayerState(BuildContext context) {

    final currentExercise = _activeExercises[_currentExerciseIndex];

    final isFirst = _currentExerciseIndex == 0;

    final isLast = _currentExerciseIndex == _activeExercises.length - 1;

    final isExerciseDone = _completedIndices.contains(_currentExerciseIndex);

    final doneColor = const Color(0xFF69F0AE);


    return Column(

      children: [

        // 1. HEADER BUTTON (Top Edge)

        GestureDetector(

          onTap: () => _showRoutineManager(context),

          child: Container(

            width: double.infinity,

            padding: const EdgeInsets.symmetric(vertical: 6),

            margin: const EdgeInsets.symmetric(horizontal: 4),

            decoration: BoxDecoration(

              color: Colors.black.withOpacity(0.15),

              borderRadius: BorderRadius.circular(12),

            ),

            child: Row(

              mainAxisAlignment: MainAxisAlignment.center,

              children: [

                Flexible(

                  child: Text(

                    widget.log.workoutName!,

                    style: const TextStyle(

                      color: Colors.white,

                      fontSize: 12,

                      fontWeight: FontWeight.bold,

                    ),

                    overflow: TextOverflow.ellipsis,

                  ),

                ),

                const SizedBox(width: 4),

                const Icon(

                  Icons.keyboard_arrow_down,

                  color: Colors.white70,

                  size: 14,

                ),

              ],

            ),

          ),

        ),


        // Pushes the content apart

        const Spacer(),


        // 2. MIDDLE: ARROWS + TEXT (Centered vertically in available space)

        Row(

          mainAxisAlignment: MainAxisAlignment.spaceBetween,

          children: [

            IconButton(

              onPressed: isFirst

                  ? null

                  : () => setState(() => _currentExerciseIndex--),

              icon: Icon(

                Icons.arrow_back_ios_rounded,

                color: isFirst ? Colors.white12 : Colors.white,

                size: 20,

              ),

              padding: EdgeInsets.zero,

              visualDensity: VisualDensity.compact,

              constraints: const BoxConstraints(minWidth: 32, minHeight: 32),

            ),


            Expanded(

              child: Padding(

                padding: const EdgeInsets.symmetric(horizontal: 2.0),

                child: Column(

                  mainAxisSize: MainAxisSize.min,

                  children: [

                    if (isExerciseDone)

                      Icon(Icons.check_circle, color: doneColor, size: 22),

                    if (isExerciseDone) const SizedBox(height: 2),

                    Text(

                      currentExercise.name,

                      textAlign: TextAlign.center,

                      style: TextStyle(

                        color: isExerciseDone ? doneColor : Colors.white,

                        fontSize: 18, // Reduced font for better fit

                        fontWeight: FontWeight.bold,

                        height: 1.1,

                      ),

                      maxLines: 2,

                      overflow: TextOverflow.ellipsis,

                    ),

                  ],

                ),

              ),

            ),


            IconButton(

              onPressed: isLast

                  ? null

                  : () => setState(() => _currentExerciseIndex++),

              icon: Icon(

                Icons.arrow_forward_ios_rounded,

                color: isLast ? Colors.white12 : Colors.white,

                size: 20,

              ),

              padding: EdgeInsets.zero,

              visualDensity: VisualDensity.compact,

              constraints: const BoxConstraints(minWidth: 32, minHeight: 32),

            ),

          ],

        ),


        const Spacer(),


        // 3. BOTTOM: LOG BUTTON (Bottom Edge)

        Padding(

          padding: const EdgeInsets.symmetric(horizontal: 4.0),

          child: GestureDetector(

            onTap: () => _showLogger(context, currentExercise),

            child: Container(

              height: 36,

              width: double.infinity,

              decoration: BoxDecoration(

                color: Colors.white,

                borderRadius: BorderRadius.circular(12),

              ),

              child: Row(

                mainAxisAlignment: MainAxisAlignment.center,

                children: [

                  Icon(

                    isExerciseDone ? Icons.check_circle : Icons.edit,

                    color: Colors.deepOrange,

                    size: 14,

                  ),

                  const SizedBox(width: 6),

                  Text(

                    isExerciseDone ? "Logs" : "Log Sets",

                    style: const TextStyle(

                      color: Colors.deepOrange,

                      fontWeight: FontWeight.bold,

                      fontSize: 13,

                    ),

                  ),

                ],

              ),

            ),

          ),

        ),

      ],

    );

  }


  void _showLogger(BuildContext context, ExerciseDetail exercise) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Colors.transparent,

      builder: (ctx) => WorkoutLoggerSheet(

        exerciseName: exercise.name,

        targetSetCount: exercise.sets.length,

        onComplete: (done) {

          if (done) {

            setState(() {

              _completedIndices.add(_currentExerciseIndex);

              if (_currentExerciseIndex < _activeExercises.length - 1) {

                _currentExerciseIndex++;

              } else {

                if (_completedIndices.length == _activeExercises.length) {

                  widget.onWorkoutToggle(true);

                }

              }

            });

          }

        },

      ),

    );

  }


  void _showRoutineManager(BuildContext context) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => DraggableScrollableSheet(

        initialChildSize: 0.85,

        maxChildSize: 0.95,

        minChildSize: 0.5,

        expand: false,

        builder: (_, scrollController) => RoutineManagerSheet(

          selectedRoutine: widget.log.workoutName,

          onSelected: (val) {

            widget.onRoutineChanged(val);

            setState(() {

              _currentExerciseIndex = 0;

              _completedIndices.clear();

            });

            Navigator.pop(ctx);

          },

        ),

      ),

    );

  }

}


exercise_models.dart:

// lib/widgets/health/activity/exercise_models.dart


class SetDetail {

  int reps;

  double weight;


  SetDetail({this.reps = 10, this.weight = 0.0});

}


class ExerciseDetail {

  String name;

  List<SetDetail> sets;


  ExerciseDetail({required this.name, List<SetDetail>? sets})

    : sets = sets ?? [SetDetail(), SetDetail(), SetDetail()]; // Default 3 sets

}


// Master List of Exercises (In-Memory Database)

final List<String> masterExerciseList = [

  "Bench Press",

  "Incline Dumbbell Press",

  "Push Ups",

  "Overhead Press",

  "Lateral Raises",

  "Tricep Extensions",

  "Skullcrushers",

  "Dips",

  "Pull Ups",

  "Lat Pulldown",

  "Barbell Row",

  "Dumbbell Row",

  "Face Pulls",

  "Bicep Curls",

  "Hammer Curls",

  "Preacher Curls",

  "Deadlift",

  "Squat",

  "Leg Press",

  "Leg Extension",

  "Hamstring Curl",

  "Lunges",

  "Bulgarian Split Squat",

  "Calf Raises",

  "Hip Thrust",

  "Treadmill Run",

  "Cycling",

  "Elliptical",

  "Jump Rope",

  "Burpees",

  "Plank",

  "Crunch",

  "Leg Raise",

  "Russian Twist",

];


routine_editor.dart:

import 'package:flutter/material.dart';

import 'exercise_models.dart';

import 'set_editor.dart';


class RoutineEditorSheet extends StatefulWidget {

  final String? initialName;

  final Function(String) onSave;


  const RoutineEditorSheet({super.key, this.initialName, required this.onSave});


  @override

  State<RoutineEditorSheet> createState() => _RoutineEditorSheetState();

}


class _RoutineEditorSheetState extends State<RoutineEditorSheet> {

  late TextEditingController _nameCtrl;

  final List<ExerciseDetail> _exercises = [];


  @override

  void initState() {

    super.initState();

    _nameCtrl = TextEditingController(text: widget.initialName ?? "");

    // Mock data for demo if editing

    if (widget.initialName != null && widget.initialName!.isNotEmpty) {

      _exercises.add(

        ExerciseDetail(

          name: "Bench Press",

          sets: [

            SetDetail(weight: 60, reps: 12),

            SetDetail(weight: 65, reps: 10),

          ],

        ),

      );

    }

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;

    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final inputColor = isDark ? Colors.black26 : Colors.grey.shade100;


    // 1. FORCE HEIGHT (85% of screen)

    final height = MediaQuery.of(context).size.height * 0.85;


    return Container(

      height: height,

      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),

      decoration: BoxDecoration(

        color: bgColor,

        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),

      ),

      child: Column(

        crossAxisAlignment: CrossAxisAlignment.start,

        children: [

          // HANDLE BAR

          Center(

            child: Container(

              width: 40,

              height: 4,

              margin: const EdgeInsets.only(bottom: 20),

              decoration: BoxDecoration(

                color: Colors.grey.withOpacity(0.3),

                borderRadius: BorderRadius.circular(2),

              ),

            ),

          ),


          // HEADER

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Text(

                "Edit Routine",

                style: TextStyle(

                  fontSize: 22,

                  fontWeight: FontWeight.bold,

                  color: textColor,

                ),

              ),

              TextButton(

                onPressed: () {

                  if (_nameCtrl.text.isNotEmpty) widget.onSave(_nameCtrl.text);

                },

                child: const Text(

                  "Save",

                  style: TextStyle(

                    color: Colors.deepOrange,

                    fontWeight: FontWeight.bold,

                    fontSize: 16,

                  ),

                ),

              ),

            ],

          ),

          const SizedBox(height: 20),


          // ROUTINE NAME INPUT

          Container(

            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),

            decoration: BoxDecoration(

              color: inputColor,

              borderRadius: BorderRadius.circular(16),

            ),

            child: TextField(

              controller: _nameCtrl,

              style: TextStyle(

                fontSize: 18,

                fontWeight: FontWeight.bold,

                color: textColor,

              ),

              decoration: const InputDecoration(

                border: InputBorder.none,

                labelText: "Routine Name",

                labelStyle: TextStyle(color: Colors.grey),

              ),

            ),

          ),

          const SizedBox(height: 24),


          // EXERCISE LIST HEADER

          Text(

            "Exercises (${_exercises.length})",

            style: TextStyle(

              color: Colors.grey.shade500,

              fontSize: 14,

              fontWeight: FontWeight.bold,

            ),

          ),

          const SizedBox(height: 10),


          // DRAGGABLE LIST

          Expanded(

            child: _exercises.isEmpty

                ? Center(

                    child: Text(

                      "No exercises yet.\nTap below to add.",

                      textAlign: TextAlign.center,

                      style: TextStyle(color: Colors.grey.shade600),

                    ),

                  )

                : ReorderableListView(

                    onReorder: (oldIndex, newIndex) {

                      setState(() {

                        if (oldIndex < newIndex) newIndex -= 1;

                        final item = _exercises.removeAt(oldIndex);

                        _exercises.insert(newIndex, item);

                      });

                    },

                    children: [

                      for (int i = 0; i < _exercises.length; i++)

                        _buildExerciseTile(i, _exercises[i], textColor, isDark),

                    ],

                  ),

          ),


          // BIG ADD BUTTON AT BOTTOM

          Padding(

            padding: EdgeInsets.only(

              bottom: MediaQuery.of(context).padding.bottom + 20,

              top: 10,

            ),

            child: SizedBox(

              width: double.infinity,

              height: 55,

              child: ElevatedButton.icon(

                onPressed: () => _showSmartSearch(context),

                icon: const Icon(Icons.add),

                label: const Text(

                  "Add Exercise",

                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),

                ),

                style: ElevatedButton.styleFrom(

                  backgroundColor: inputColor,

                  foregroundColor: Colors.deepOrange,

                  elevation: 0,

                  shape: RoundedRectangleBorder(

                    borderRadius: BorderRadius.circular(16),

                  ),

                ),

              ),

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildExerciseTile(

    int index,

    ExerciseDetail exercise,

    Color textColor,

    bool isDark,

  ) {

    return Container(

      key: ValueKey("${exercise.name}_$index"),

      margin: const EdgeInsets.only(bottom: 10),

      decoration: BoxDecoration(

        color: isDark ? Colors.white10 : Colors.grey.shade50,

        borderRadius: BorderRadius.circular(16),

      ),

      child: ListTile(

        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),

        leading: Icon(Icons.drag_indicator, color: Colors.grey.shade600),

        title: Text(

          exercise.name,

          style: TextStyle(color: textColor, fontWeight: FontWeight.bold),

        ),

        subtitle: Text(

          "${exercise.sets.length} Sets",

          style: TextStyle(

            color: Colors.deepOrange.withOpacity(0.8),

            fontSize: 12,

          ),

        ),

        trailing: Row(

          mainAxisSize: MainAxisSize.min,

          children: [

            IconButton(

              icon: const Icon(

                Icons.tune_rounded,

                color: Colors.blue,

                size: 20,

              ),

              onPressed: () => _openSetEditor(exercise),

            ),

            IconButton(

              icon: Icon(

                Icons.close,

                size: 20,

                color: Colors.red.withOpacity(0.7),

              ),

              onPressed: () => setState(() => _exercises.removeAt(index)),

            ),

          ],

        ),

      ),

    );

  }


  void _openSetEditor(ExerciseDetail exercise) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Colors.transparent,

      builder: (ctx) => SetEditorSheet(

        exerciseName: exercise.name,

        initialSets: exercise.sets,

        onSave: (updatedSets) => setState(() => exercise.sets = updatedSets),

      ),

    );

  }


  void _showSmartSearch(BuildContext context) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => ExerciseSearchSheet(

        onSelect: (name) {

          setState(() {

            _exercises.add(ExerciseDetail(name: name));

          });

          Navigator.pop(ctx);

        },

      ),

    );

  }

}


// --- MISSING CLASS ADDED BELOW ---


class ExerciseSearchSheet extends StatefulWidget {

  final Function(String) onSelect;

  const ExerciseSearchSheet({super.key, required this.onSelect});


  @override

  State<ExerciseSearchSheet> createState() => _ExerciseSearchSheetState();

}


class _ExerciseSearchSheetState extends State<ExerciseSearchSheet> {

  final TextEditingController _searchCtrl = TextEditingController();

  List<String> _filteredList = [];


  @override

  void initState() {

    super.initState();

    // masterExerciseList comes from exercise_models.dart

    _filteredList = masterExerciseList;

  }


  void _filter(String query) {

    setState(() {

      if (query.isEmpty) {

        _filteredList = masterExerciseList;

      } else {

        _filteredList = masterExerciseList

            .where((ex) => ex.toLowerCase().contains(query.toLowerCase()))

            .toList();

      }

    });

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Padding(

      padding: EdgeInsets.only(

        top: 20,

        left: 20,

        right: 20,

        bottom: MediaQuery.of(context).viewInsets.bottom + 20,

      ),

      child: Column(

        mainAxisSize: MainAxisSize.min,

        crossAxisAlignment: CrossAxisAlignment.start,

        children: [

          Text(

            "Add Exercise",

            style: TextStyle(

              fontSize: 20,

              fontWeight: FontWeight.bold,

              color: textColor,

            ),

          ),

          const SizedBox(height: 15),

          TextField(

            controller: _searchCtrl,

            onChanged: _filter,

            autofocus: true,

            style: TextStyle(color: textColor),

            decoration: InputDecoration(

              hintText: "Search...",

              hintStyle: const TextStyle(color: Colors.grey),

              prefixIcon: const Icon(Icons.search, color: Colors.grey),

              filled: true,

              fillColor: isDark ? Colors.black26 : Colors.grey.shade100,

              border: OutlineInputBorder(

                borderRadius: BorderRadius.circular(12),

                borderSide: BorderSide.none,

              ),

            ),

          ),

          const SizedBox(height: 10),

          SizedBox(

            height: 300,

            child: _filteredList.isEmpty

                ? Center(

                    child: ElevatedButton.icon(

                      onPressed: () {

                        masterExerciseList.add(

                          _searchCtrl.text,

                        ); // Save new exercise to memory

                        widget.onSelect(_searchCtrl.text);

                      },

                      icon: const Icon(Icons.add),

                      label: Text("Create '${_searchCtrl.text}'"),

                      style: ElevatedButton.styleFrom(

                        backgroundColor: Colors.deepOrange,

                        foregroundColor: Colors.white,

                      ),

                    ),

                  )

                : ListView.separated(

                    itemCount: _filteredList.length,

                    separatorBuilder: (ctx, i) =>

                        Divider(color: Colors.grey.withOpacity(0.1)),

                    itemBuilder: (ctx, i) {

                      return ListTile(

                        title: Text(

                          _filteredList[i],

                          style: TextStyle(color: textColor),

                        ),

                        trailing: const Icon(

                          Icons.add_circle_outline,

                          color: Colors.deepOrange,

                        ),

                        onTap: () => widget.onSelect(_filteredList[i]),

                      );

                    },

                  ),

          ),

        ],

      ),

    );

  }

}


routine_manager.dart:

// lib/widgets/health/activity/routine_manager.dart


import 'package:flutter/material.dart';

import 'routine_editor.dart';


class RoutineManagerSheet extends StatefulWidget {

  final String? selectedRoutine;

  final Function(String) onSelected;


  const RoutineManagerSheet({

    super.key,

    required this.selectedRoutine,

    required this.onSelected,

  });


  @override

  State<RoutineManagerSheet> createState() => _RoutineManagerSheetState();

}


class _RoutineManagerSheetState extends State<RoutineManagerSheet> {

  final List<String> _userRoutines = [

    "Push Day A",

    "Pull Day A",

    "Legs",

    "Full Body",

  ];

  String? _tempSelected;


  @override

  void initState() {

    super.initState();

    _tempSelected = widget.selectedRoutine;

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Padding(

      padding: const EdgeInsets.all(20.0),

      child: Column(

        children: [

          // HEADER

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Text(

                "My Routines",

                style: TextStyle(

                  fontSize: 22,

                  fontWeight: FontWeight.bold,

                  color: textColor,

                ),

              ),

              Row(

                children: [

                  IconButton(

                    icon: const Icon(

                      Icons.add,

                      color: Colors.deepOrange,

                      size: 28,

                    ),

                    onPressed: () => _openEditor(context, null), // Create New

                  ),

                  const SizedBox(width: 8),

                  // CONFIRM BUTTON

                  IconButton(

                    icon: const Icon(

                      Icons.check_circle,

                      color: Colors.green,

                      size: 28,

                    ),

                    onPressed: () {

                      if (_tempSelected != null)

                        widget.onSelected(_tempSelected!);

                    },

                  ),

                ],

              ),

            ],

          ),

          const SizedBox(height: 10),

          const Divider(),

          const SizedBox(height: 10),


          // LIST

          Expanded(

            child: ListView.separated(

              itemCount: _userRoutines.length,

              separatorBuilder: (ctx, i) => const SizedBox(height: 12),

              itemBuilder: (ctx, index) {

                final routine = _userRoutines[index];

                final isSelected = routine == _tempSelected;


                return GestureDetector(

                  onTap: () => setState(() => _tempSelected = routine),

                  child: AnimatedContainer(

                    duration: const Duration(milliseconds: 200),

                    decoration: BoxDecoration(

                      color: isDark ? Colors.black26 : Colors.grey.shade100,

                      borderRadius: BorderRadius.circular(16),

                      border: Border.all(

                        color: isSelected

                            ? Colors.deepOrange

                            : Colors.transparent,

                        width: 2,

                      ),

                    ),

                    child: ListTile(

                      contentPadding: const EdgeInsets.symmetric(

                        horizontal: 16,

                        vertical: 4,

                      ),

                      leading: Container(

                        padding: const EdgeInsets.all(10),

                        decoration: BoxDecoration(

                          color: isSelected

                              ? Colors.deepOrange

                              : Colors.grey.withOpacity(0.1),

                          shape: BoxShape.circle,

                        ),

                        child: Icon(

                          Icons.fitness_center,

                          color: isSelected ? Colors.white : Colors.grey,

                          size: 20,

                        ),

                      ),

                      title: Text(

                        routine,

                        style: TextStyle(

                          fontWeight: FontWeight.bold,

                          color: textColor,

                        ),

                      ),

                      trailing: IconButton(

                        icon: const Icon(

                          Icons.edit_outlined,

                          size: 20,

                          color: Colors.grey,

                        ),

                        onPressed: () => _openEditor(context, routine),

                      ),

                    ),

                  ),

                );

              },

            ),

          ),

        ],

      ),

    );

  }


  void _openEditor(BuildContext context, String? routineName) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      builder: (ctx) => RoutineEditorSheet(

        initialName: routineName,

        onSave: (newName) {

          setState(() {

            if (routineName == null) {

              _userRoutines.add(newName);

            }

            // In real app, handle rename logic here

          });

          Navigator.pop(ctx);

        },

      ),

    );

  }

}


set_editor.dart:

import 'package:flutter/material.dart';

import 'exercise_models.dart';


class SetEditorSheet extends StatefulWidget {

  final String exerciseName;

  final List<SetDetail> initialSets;

  final Function(List<SetDetail>) onSave;


  const SetEditorSheet({

    super.key,

    required this.exerciseName,

    required this.initialSets,

    required this.onSave,

  });


  @override

  State<SetEditorSheet> createState() => _SetEditorSheetState();

}


class _SetEditorSheetState extends State<SetEditorSheet> {

  late List<SetDetail> _sets;


  @override

  void initState() {

    super.initState();

    _sets = widget.initialSets

        .map((s) => SetDetail(reps: s.reps, weight: s.weight))

        .toList();

    if (_sets.isEmpty) _sets.add(SetDetail());

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;

    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;


    // 1. FORCE HEIGHT

    final height = MediaQuery.of(context).size.height * 0.85;


    return Container(

      height: height,

      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),

      decoration: BoxDecoration(

        color: bgColor,

        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),

      ),

      child: Column(

        children: [

          // HANDLE

          Center(

            child: Container(

              width: 40,

              height: 4,

              margin: const EdgeInsets.only(bottom: 20),

              decoration: BoxDecoration(

                color: Colors.grey.withOpacity(0.3),

                borderRadius: BorderRadius.circular(2),

              ),

            ),

          ),


          // HEADER

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Expanded(

                child: Text(

                  widget.exerciseName,

                  style: TextStyle(

                    fontSize: 22,

                    fontWeight: FontWeight.bold,

                    color: textColor,

                  ),

                  overflow: TextOverflow.ellipsis,

                ),

              ),

              TextButton(

                onPressed: () {

                  widget.onSave(_sets);

                  Navigator.pop(context);

                },

                child: const Text(

                  "Save",

                  style: TextStyle(

                    color: Colors.deepOrange,

                    fontWeight: FontWeight.bold,

                    fontSize: 16,

                  ),

                ),

              ),

            ],

          ),

          const SizedBox(height: 20),


          // TABLE HEADERS

          Row(

            children: [

              SizedBox(

                width: 40,

                child: Center(

                  child: Text(

                    "Set",

                    style: TextStyle(

                      color: Colors.grey.shade500,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

              ),

              const Spacer(),

              SizedBox(

                width: 90,

                child: Center(

                  child: Text(

                    "kg",

                    style: TextStyle(

                      color: Colors.grey.shade500,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

              ),

              const SizedBox(width: 16),

              SizedBox(

                width: 90,

                child: Center(

                  child: Text(

                    "Reps",

                    style: TextStyle(

                      color: Colors.grey.shade500,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

              ),

              const SizedBox(width: 40),

            ],

          ),

          const SizedBox(height: 10),


          // SCROLLABLE LIST

          Expanded(

            child: ListView.builder(

              itemCount: _sets.length,

              itemBuilder: (ctx, index) =>

                  _buildSetRow(index + 1, _sets[index], isDark),

            ),

          ),


          // BUTTON AREA

          Padding(

            padding: EdgeInsets.only(

              bottom: MediaQuery.of(context).padding.bottom + 20,

              top: 10,

            ),

            child: SizedBox(

              width: double.infinity,

              height: 55,

              child: ElevatedButton.icon(

                onPressed: () {

                  setState(() {

                    final lastSet = _sets.last;

                    _sets.add(

                      SetDetail(reps: lastSet.reps, weight: lastSet.weight),

                    );

                  });

                },

                icon: const Icon(Icons.add),

                label: const Text(

                  "Add Set",

                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),

                ),

                style: ElevatedButton.styleFrom(

                  backgroundColor: isDark

                      ? Colors.black26

                      : Colors.grey.shade100,

                  foregroundColor: Colors.deepOrange,

                  elevation: 0,

                  shape: RoundedRectangleBorder(

                    borderRadius: BorderRadius.circular(16),

                  ),

                ),

              ),

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildSetRow(int number, SetDetail set, bool isDark) {

    return Padding(

      padding: const EdgeInsets.symmetric(vertical: 6.0),

      child: Row(

        children: [

          // Set Number Bubble

          SizedBox(

            width: 40,

            child: Container(

              padding: const EdgeInsets.all(8),

              decoration: BoxDecoration(

                color: isDark ? Colors.white10 : Colors.grey.shade200,

                shape: BoxShape.circle,

              ),

              child: Center(

                child: Text(

                  "$number",

                  style: TextStyle(

                    fontWeight: FontWeight.bold,

                    color: isDark ? Colors.white : Colors.black,

                  ),

                ),

              ),

            ),

          ),

          const Spacer(),


          // Weight Input

          _buildCompactInput(

            set.weight.toString(),

            (val) => set.weight = double.tryParse(val) ?? set.weight,

            isDark,

          ),

          const SizedBox(width: 16),


          // Reps Input

          _buildCompactInput(

            set.reps.toString(),

            (val) => set.reps = int.tryParse(val) ?? set.reps,

            isDark,

          ),


          // Delete

          SizedBox(

            width: 40,

            child: IconButton(

              icon: Icon(

                Icons.close,

                color: Colors.red.withOpacity(0.5),

                size: 20,

              ),

              onPressed: () => setState(() {

                if (_sets.length > 1) _sets.remove(set);

              }),

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildCompactInput(

    String initial,

    Function(String) onChanged,

    bool isDark,

  ) {

    return SizedBox(

      width: 90,

      child: TextFormField(

        initialValue: initial,

        keyboardType: TextInputType.number,

        textAlign: TextAlign.center,

        style: TextStyle(

          fontWeight: FontWeight.bold,

          fontSize: 18,

          color: isDark ? Colors.white : Colors.black,

        ),

        decoration: InputDecoration(

          contentPadding: const EdgeInsets.symmetric(vertical: 12),

          filled: true,

          fillColor: isDark ? Colors.black26 : Colors.grey.shade100,

          border: OutlineInputBorder(

            borderRadius: BorderRadius.circular(12),

            borderSide: BorderSide.none,

          ),

        ),

        onChanged: onChanged,

      ),

    );

  }

}


workout_logger.dart:

import 'package:flutter/material.dart';

import 'exercise_models.dart';


class WorkoutLoggerSheet extends StatefulWidget {

  final String exerciseName;

  final int targetSetCount;

  final Function(bool) onComplete;


  const WorkoutLoggerSheet({

    super.key,

    required this.exerciseName,

    required this.targetSetCount,

    required this.onComplete,

  });


  @override

  State<WorkoutLoggerSheet> createState() => _WorkoutLoggerSheetState();

}


class _WorkoutLoggerSheetState extends State<WorkoutLoggerSheet> {

  late List<SetDetail> _loggedSets;


  @override

  void initState() {

    super.initState();

    _loggedSets = List.generate(

      widget.targetSetCount,

      (index) => SetDetail(reps: 0, weight: 0.0),

    );

    if (_loggedSets.isEmpty) _loggedSets.add(SetDetail());

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;

    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;


    // FIX: Force height to 85% of screen so it doesn't get cut off

    final height = MediaQuery.of(context).size.height * 0.85;


    return Container(

      height: height,

      padding: const EdgeInsets.fromLTRB(20, 20, 20, 0),

      decoration: BoxDecoration(

        color: bgColor,

        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),

      ),

      child: Column(

        children: [

          // HANDLE

          Center(

            child: Container(

              width: 40,

              height: 4,

              margin: const EdgeInsets.only(bottom: 20),

              decoration: BoxDecoration(

                color: Colors.grey.withOpacity(0.3),

                borderRadius: BorderRadius.circular(2),

              ),

            ),

          ),


          // HEADER

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Expanded(

                child: Text(

                  widget.exerciseName,

                  style: TextStyle(

                    fontSize: 22,

                    fontWeight: FontWeight.bold,

                    color: textColor,

                  ),

                  overflow: TextOverflow.ellipsis,

                ),

              ),

              TextButton(

                onPressed: () {

                  widget.onComplete(true);

                  Navigator.pop(context);

                },

                child: const Text(

                  "Finish",

                  style: TextStyle(

                    color: Colors.deepOrange,

                    fontWeight: FontWeight.bold,

                    fontSize: 16,

                  ),

                ),

              ),

            ],

          ),

          const SizedBox(height: 20),


          // COLUMN TITLES

          Row(

            children: [

              const SizedBox(width: 40), // Space for Set # badge

              const Spacer(),

              SizedBox(

                width: 80,

                child: Center(

                  child: Text(

                    "kg",

                    style: TextStyle(

                      color: Colors.grey.shade600,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

              ),

              const SizedBox(width: 20),

              SizedBox(

                width: 80,

                child: Center(

                  child: Text(

                    "Reps",

                    style: TextStyle(

                      color: Colors.grey.shade600,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

              ),

              const SizedBox(width: 40), // Space for delete icon

            ],

          ),

          const SizedBox(height: 10),


          // SCROLLABLE LIST

          Expanded(

            child: ListView.separated(

              itemCount: _loggedSets.length,

              separatorBuilder: (ctx, i) => const SizedBox(height: 12),

              itemBuilder: (ctx, index) =>

                  _buildLogRows(index + 1, _loggedSets[index], isDark),

            ),

          ),


          // ADD SET BUTTON (Pinned to bottom of visible area)

          Padding(

            padding: EdgeInsets.only(

              bottom: MediaQuery.of(context).padding.bottom + 20,

              top: 10,

            ),

            child: TextButton.icon(

              onPressed: () {

                setState(() {

                  final last = _loggedSets.isNotEmpty

                      ? _loggedSets.last

                      : SetDetail();

                  _loggedSets.add(

                    SetDetail(reps: last.reps, weight: last.weight),

                  );

                });

              },

              icon: const Icon(Icons.add, color: Colors.deepOrange),

              label: const Text(

                "Add Set",

                style: TextStyle(

                  color: Colors.deepOrange,

                  fontSize: 16,

                  fontWeight: FontWeight.bold,

                ),

              ),

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildLogRows(int setNum, SetDetail set, bool isDark) {

    return Row(

      children: [

        // Set Badge

        Container(

          width: 40,

          height: 40,

          decoration: BoxDecoration(

            color: isDark ? Colors.white10 : Colors.grey.shade200,

            shape: BoxShape.circle,

          ),

          child: Center(

            child: Text(

              "$setNum",

              style: TextStyle(

                fontWeight: FontWeight.bold,

                color: isDark ? Colors.white : Colors.black,

              ),

            ),

          ),

        ),

        const Spacer(),

        // Weight

        _buildInput(isDark, (val) => set.weight = double.tryParse(val) ?? 0),

        const SizedBox(width: 20),

        // Reps

        _buildInput(isDark, (val) => set.reps = int.tryParse(val) ?? 0),

        // Delete

        SizedBox(

          width: 40,

          child: IconButton(

            icon: Icon(

              Icons.close,

              color: Colors.red.withOpacity(0.5),

              size: 20,

            ),

            onPressed: () => setState(() {

              if (_loggedSets.length > 1) _loggedSets.remove(set);

            }),

          ),

        ),

      ],

    );

  }


  Widget _buildInput(bool isDark, Function(String) onChange) {

    return SizedBox(

      width: 80,

      child: TextField(

        keyboardType: TextInputType.number,

        textAlign: TextAlign.center,

        style: TextStyle(

          fontWeight: FontWeight.bold,

          fontSize: 18,

          color: isDark ? Colors.white : Colors.black,

        ),

        decoration: InputDecoration(

          contentPadding: const EdgeInsets.symmetric(vertical: 10),

          filled: true,

          fillColor: isDark ? Colors.black26 : Colors.grey.shade100,

          border: OutlineInputBorder(

            borderRadius: BorderRadius.circular(12),

            borderSide: BorderSide.none,

          ),

          hintText: "-",

          hintStyle: TextStyle(color: Colors.grey.withOpacity(0.5)),

        ),

        onChanged: onChange,

      ),

    );

  }

}


activity.dart:

/*

import 'package:flutter/material.dart';

import '../../../models/health_model.dart';


// --- MOCK DATABASE (Session Memory) ---

// This list persists as long as the app is open.

final List<String> _masterExerciseList = [

  "Bench Press",

  "Incline Dumbbell Press",

  "Push Ups",

  "Overhead Press",

  "Lateral Raises",

  "Tricep Extensions",

  "Skullcrushers",

  "Dips",

  "Pull Ups",

  "Lat Pulldown",

  "Barbell Row",

  "Dumbbell Row",

  "Face Pulls",

  "Bicep Curls",

  "Hammer Curls",

  "Preacher Curls",

  "Deadlift",

  "Squat",

  "Leg Press",

  "Leg Extension",

  "Hamstring Curl",

  "Lunges",

  "Bulgarian Split Squat",

  "Calf Raises",

  "Hip Thrust",

  "Treadmill Run",

  "Cycling",

  "Elliptical",

  "Jump Rope",

  "Burpees",

  "Plank",

  "Crunch",

  "Leg Raise",

  "Russian Twist",

];


// --- INTERNAL MODEL FOR EXERCISE DETAILS ---

class ExerciseDetail {

  String name;

  int sets;

  int reps;

  double weight;


  ExerciseDetail({

    required this.name,

    this.sets = 3,

    this.reps = 10,

    this.weight = 0.0,

  });

}


class ActivityCard extends StatelessWidget {

  final HealthDailyLog log;

  final Function(String?) onRoutineChanged;

  final Function(bool) onWorkoutToggle;

  final Function(int) onStepsChanged;

  final Function(double) onWeightChanged;


  const ActivityCard({

    super.key,

    required this.log,

    required this.onRoutineChanged,

    required this.onWorkoutToggle,

    required this.onStepsChanged,

    required this.onWeightChanged,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Column(

      children: [

        // 1. GYM CARD (Routine Picker)

        Container(

          padding: const EdgeInsets.all(20),

          decoration: BoxDecoration(

            gradient: LinearGradient(

              colors: log.isWorkoutDone

                  ? [const Color(0xFF2E7D32), const Color(0xFF1B5E20)]

                  : [const Color(0xFFEF6C00), const Color(0xFFE65100)],

            ),

            borderRadius: BorderRadius.circular(24),

            boxShadow: [

              BoxShadow(

                color: (log.isWorkoutDone ? Colors.green : Colors.orange)

                    .withOpacity(0.3),

                blurRadius: 10,

                offset: const Offset(0, 4),

              ),

            ],

          ),

          child: Row(

            children: [

              GestureDetector(

                onTap: () => onWorkoutToggle(!log.isWorkoutDone),

                child: Container(

                  padding: const EdgeInsets.all(12),

                  decoration: BoxDecoration(

                    color: Colors.white.withOpacity(0.2),

                    shape: BoxShape.circle,

                  ),

                  child: Icon(

                    log.isWorkoutDone

                        ? Icons.check_rounded

                        : Icons.fitness_center_rounded,

                    color: Colors.white,

                    size: 24,

                  ),

                ),

              ),

              const SizedBox(width: 16),

              Expanded(

                child: GestureDetector(

                  onTap: () => _showRoutineManager(context),

                  child: Column(

                    crossAxisAlignment: CrossAxisAlignment.start,

                    children: [

                      const Text(

                        "Current Routine",

                        style: TextStyle(color: Colors.white70, fontSize: 10),

                      ),

                      const SizedBox(height: 2),

                      Row(

                        children: [

                          Expanded(

                            child: Text(

                              log.workoutName ?? "Select Routine",

                              style: const TextStyle(

                                color: Colors.white,

                                fontWeight: FontWeight.bold,

                                fontSize: 18,

                              ),

                              overflow: TextOverflow.ellipsis,

                            ),

                          ),

                          const Icon(

                            Icons.keyboard_arrow_down_rounded,

                            color: Colors.white70,

                          ),

                        ],

                      ),

                    ],

                  ),

                ),

              ),

            ],

          ),

        ),

        const SizedBox(height: 16),


        // 2. STEPS & WEIGHT ROW

        Row(

          children: [

            Expanded(

              child: _buildValueCard(

                context: context,

                icon: Icons.directions_walk,

                title: "Steps",

                value: "${log.steps}",

                unit: "steps",

                color: Colors.orange,

                bg: cardColor,

                text: textColor,

                onSave: (val) => onStepsChanged(int.parse(val)),

              ),

            ),

            const SizedBox(width: 16),

            Expanded(

              child: _buildValueCard(

                context: context,

                icon: Icons.monitor_weight,

                title: "Weight",

                value: "${log.weight}",

                unit: "kg",

                color: Colors.deepPurple,

                bg: cardColor,

                text: textColor,

                isDouble: true,

                onSave: (val) => onWeightChanged(double.parse(val)),

              ),

            ),

          ],

        ),

      ],

    );

  }


  Widget _buildValueCard({

    required BuildContext context,

    required IconData icon,

    required String title,

    required String value,

    required String unit,

    required Color color,

    required Color bg,

    required Color text,

    required Function(String) onSave,

    bool isDouble = false,

  }) {

    return Material(

      color: bg,

      borderRadius: BorderRadius.circular(24),

      child: InkWell(

        borderRadius: BorderRadius.circular(24),

        onTap: () =>

            _showEditDialog(context, title, value, unit, onSave, isDouble),

        child: Container(

          height: 130,

          padding: const EdgeInsets.all(16),

          child: Stack(

            children: [

              Column(

                crossAxisAlignment: CrossAxisAlignment.start,

                mainAxisAlignment: MainAxisAlignment.spaceBetween,

                children: [

                  Icon(icon, color: color, size: 28),

                  Column(

                    crossAxisAlignment: CrossAxisAlignment.start,

                    children: [

                      Text(

                        value,

                        style: TextStyle(

                          fontSize: 18,

                          fontWeight: FontWeight.bold,

                          color: text,

                        ),

                      ),

                      Text(

                        title,

                        style: const TextStyle(

                          fontSize: 12,

                          color: Colors.grey,

                        ),

                      ),

                    ],

                  ),

                ],

              ),

              const Positioned(

                top: 0,

                right: 0,

                child: Icon(Icons.edit_rounded, size: 16, color: Colors.grey),

              ),

            ],

          ),

        ),

      ),

    );

  }


  void _showEditDialog(

    BuildContext context,

    String title,

    String currentVal,

    String unit,

    Function(String) onSave,

    bool isDouble,

  ) {

    final controller = TextEditingController(text: currentVal);

    final isDark = Theme.of(context).brightness == Brightness.dark;


    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => Padding(

        padding: EdgeInsets.only(

          bottom: MediaQuery.of(ctx).viewInsets.bottom + 20,

          left: 24,

          right: 24,

          top: 24,

        ),

        child: Column(

          mainAxisSize: MainAxisSize.min,

          crossAxisAlignment: CrossAxisAlignment.start,

          children: [

            Text(

              "Update $title",

              style: TextStyle(

                fontSize: 20,

                fontWeight: FontWeight.bold,

                color: isDark ? Colors.white : Colors.black87,

              ),

            ),

            const SizedBox(height: 20),

            TextField(

              controller: controller,

              keyboardType: TextInputType.numberWithOptions(decimal: isDouble),

              autofocus: true,

              style: TextStyle(

                fontSize: 24,

                fontWeight: FontWeight.bold,

                color: isDark ? Colors.white : Colors.black87,

              ),

              decoration: InputDecoration(

                suffixText: unit,

                hintText: "0",

                border: InputBorder.none,

                filled: true,

                fillColor: isDark ? Colors.black26 : Colors.grey.shade100,

                contentPadding: const EdgeInsets.symmetric(

                  horizontal: 16,

                  vertical: 12,

                ),

                enabledBorder: OutlineInputBorder(

                  borderRadius: BorderRadius.circular(12),

                  borderSide: BorderSide.none,

                ),

                focusedBorder: OutlineInputBorder(

                  borderRadius: BorderRadius.circular(12),

                  borderSide: const BorderSide(

                    color: Colors.deepOrange,

                    width: 2,

                  ),

                ),

              ),

            ),

            const SizedBox(height: 24),

            SizedBox(

              width: double.infinity,

              height: 50,

              child: ElevatedButton(

                onPressed: () {

                  if (controller.text.isNotEmpty) onSave(controller.text);

                  Navigator.pop(ctx);

                },

                style: ElevatedButton.styleFrom(

                  backgroundColor: Colors.deepOrange,

                  foregroundColor: Colors.white,

                  shape: RoundedRectangleBorder(

                    borderRadius: BorderRadius.circular(12),

                  ),

                ),

                child: const Text(

                  "Save",

                  style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),

                ),

              ),

            ),

          ],

        ),

      ),

    );

  }


  void _showRoutineManager(BuildContext context) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => DraggableScrollableSheet(

        initialChildSize: 0.85,

        maxChildSize: 0.95,

        minChildSize: 0.5,

        expand: false,

        builder: (_, scrollController) {

          return RoutineManagerSheet(

            selectedRoutine: log.workoutName,

            onSelected: (val) {

              onRoutineChanged(val);

              Navigator.pop(ctx);

            },

          );

        },

      ),

    );

  }

}


// --- ROUTINE MANAGER ---

class RoutineManagerSheet extends StatefulWidget {

  final String? selectedRoutine;

  final Function(String) onSelected;


  const RoutineManagerSheet({

    super.key,

    required this.selectedRoutine,

    required this.onSelected,

  });


  @override

  State<RoutineManagerSheet> createState() => _RoutineManagerSheetState();

}


class _RoutineManagerSheetState extends State<RoutineManagerSheet> {

  String _mode = 'list';

  final List<String> _userRoutines = [

    "Push Day A",

    "Pull Day A",

    "Legs",

    "Full Body",

  ];


  // EDITOR STATE

  final TextEditingController _editorNameCtrl = TextEditingController();

  final List<ExerciseDetail> _currentExercises = []; // Changed to Object list


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Padding(

      padding: const EdgeInsets.all(20.0),

      child: Column(

        children: [

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              if (_mode == 'editor')

                IconButton(

                  icon: const Icon(Icons.arrow_back, size: 24),

                  onPressed: () => setState(() => _mode = 'list'),

                  padding: EdgeInsets.zero,

                  constraints: const BoxConstraints(),

                ),

              Text(

                _mode == 'list' ? "My Routines" : "Edit Routine",

                style: TextStyle(

                  fontSize: 22,

                  fontWeight: FontWeight.bold,

                  color: textColor,

                ),

              ),

              if (_mode == 'list')

                IconButton(

                  icon: const Icon(

                    Icons.add,

                    color: Colors.deepOrange,

                    size: 28,

                  ),

                  onPressed: () {

                    setState(() {

                      _mode = 'editor';

                      _editorNameCtrl.text = "New Routine";

                      _currentExercises.clear();

                    });

                  },

                )

              else

                TextButton(

                  onPressed: () {

                    if (_editorNameCtrl.text.isNotEmpty) {

                      // Logic to save would go here

                      if (!_userRoutines.contains(_editorNameCtrl.text)) {

                        _userRoutines.add(_editorNameCtrl.text);

                      }

                    }

                    setState(() => _mode = 'list');

                  },

                  child: const Text(

                    "Save",

                    style: TextStyle(

                      color: Colors.deepOrange,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ),

            ],

          ),

          const SizedBox(height: 10),

          const Divider(),

          const SizedBox(height: 10),

          Expanded(

            child: _mode == 'list'

                ? _buildList(textColor, isDark)

                : _buildEditor(textColor, isDark),

          ),

        ],

      ),

    );

  }


  // --- POLISHED LIST VIEW ---

  Widget _buildList(Color textColor, bool isDark) {

    return ListView.separated(

      itemCount: _userRoutines.length,

      separatorBuilder: (ctx, i) => const SizedBox(height: 12),

      itemBuilder: (ctx, index) {

        final routine = _userRoutines[index];

        final isSelected = routine == widget.selectedRoutine;


        return Container(

          decoration: BoxDecoration(

            color: isDark ? Colors.black26 : Colors.grey.shade100,

            borderRadius: BorderRadius.circular(16),

            border: isSelected

                ? Border.all(color: Colors.deepOrange, width: 1.5)

                : null,

          ),

          child: ListTile(

            contentPadding: const EdgeInsets.symmetric(

              horizontal: 16,

              vertical: 4,

            ),

            leading: Container(

              padding: const EdgeInsets.all(10),

              decoration: BoxDecoration(

                color: Colors.deepOrange.withOpacity(0.15),

                shape: BoxShape.circle,

              ),

              child: const Icon(

                Icons.fitness_center,

                color: Colors.deepOrange,

                size: 20,

              ),

            ),

            title: Text(

              routine,

              style: TextStyle(fontWeight: FontWeight.bold, color: textColor),

            ),

            subtitle: const Text(

              "Tap to select",

              style: TextStyle(fontSize: 12, color: Colors.grey),

            ),

            trailing: Row(

              mainAxisSize: MainAxisSize.min, // FIX: Vertical Alignment

              children: [

                IconButton(

                  icon: const Icon(

                    Icons.edit_outlined,

                    size: 20,

                    color: Colors.grey,

                  ),

                  onPressed: () {

                    setState(() {

                      _mode = 'editor';

                      _editorNameCtrl.text = routine;

                      _currentExercises.clear();

                      // Mock loading saved exercises

                      _currentExercises.add(

                        ExerciseDetail(name: "Bench Press"),

                      );

                      _currentExercises.add(

                        ExerciseDetail(name: "Tricep Extensions", sets: 4),

                      );

                    });

                  },

                ),

                const SizedBox(width: 8),

                if (isSelected)

                  const Icon(Icons.check_circle, color: Colors.green, size: 24)

                else

                  IconButton(

                    icon: const Icon(

                      Icons.circle_outlined,

                      color: Colors.grey,

                      size: 24,

                    ),

                    onPressed: () => widget.onSelected(routine),

                  ),

              ],

            ),

          ),

        );

      },

    );

  }


  // --- DETAILED EDITOR VIEW ---

  Widget _buildEditor(Color textColor, bool isDark) {

    return Column(

      crossAxisAlignment: CrossAxisAlignment.start,

      children: [

        TextField(

          controller: _editorNameCtrl,

          style: TextStyle(

            fontSize: 20,

            fontWeight: FontWeight.bold,

            color: textColor,

          ),

          decoration: const InputDecoration(

            labelText: "Routine Name",

            border: UnderlineInputBorder(),

            contentPadding: EdgeInsets.zero,

          ),

        ),

        const SizedBox(height: 20),


        Row(

          mainAxisAlignment: MainAxisAlignment.spaceBetween,

          children: [

            Text(

              "Exercises (${_currentExercises.length})",

              style: TextStyle(color: Colors.grey.shade600, fontSize: 14),

            ),

            TextButton.icon(

              onPressed: () => _showExerciseSearch(context),

              icon: const Icon(Icons.add, size: 16),

              label: const Text("Add"),

              style: TextButton.styleFrom(foregroundColor: Colors.deepOrange),

            ),

          ],

        ),


        Expanded(

          child: ReorderableListView(

            onReorder: (oldIndex, newIndex) {

              setState(() {

                if (oldIndex < newIndex) newIndex -= 1;

                final item = _currentExercises.removeAt(oldIndex);

                _currentExercises.insert(newIndex, item);

              });

            },

            children: [

              for (int i = 0; i < _currentExercises.length; i++)

                _buildExerciseTile(i, _currentExercises[i], textColor, isDark),

            ],

          ),

        ),

      ],

    );

  }


  Widget _buildExerciseTile(

    int index,

    ExerciseDetail exercise,

    Color textColor,

    bool isDark,

  ) {

    return Container(

      key: ValueKey(exercise.name + index.toString()),

      margin: const EdgeInsets.only(bottom: 10),

      decoration: BoxDecoration(

        color: isDark ? Colors.white10 : Colors.white,

        borderRadius: BorderRadius.circular(12),

        boxShadow: [

          if (!isDark)

            BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 4),

        ],

      ),

      child: ListTile(

        contentPadding: const EdgeInsets.symmetric(horizontal: 12),

        leading: const Icon(Icons.drag_handle, color: Colors.grey),

        title: Text(

          exercise.name,

          style: TextStyle(color: textColor, fontWeight: FontWeight.bold),

        ),

        subtitle: Text(

          "${exercise.sets} Sets â€¢ ${exercise.reps} Reps â€¢ ${exercise.weight}kg",

          style: TextStyle(

            color: Colors.deepOrange.withOpacity(0.8),

            fontSize: 12,

          ),

        ),

        trailing: Row(

          mainAxisSize: MainAxisSize.min,

          children: [

            // SETTINGS BUTTON (Blue Area Logic)

            IconButton(

              icon: const Icon(

                Icons.tune_rounded,

                color: Colors.blue,

                size: 20,

              ),

              onPressed: () => _showSetDetailsDialog(index, exercise),

            ),

            IconButton(

              icon: const Icon(Icons.close, size: 18, color: Colors.red),

              onPressed: () =>

                  setState(() => _currentExercises.removeAt(index)),

            ),

          ],

        ),

      ),

    );

  }


  // --- EXERCISE SEARCH SHEET ---

  void _showExerciseSearch(BuildContext context) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => ExerciseSearchSheet(

        onSelect: (exerciseName) {

          setState(

            () => _currentExercises.add(ExerciseDetail(name: exerciseName)),

          );

          Navigator.pop(ctx);

        },

      ),

    );

  }


  // --- SET DETAILS DIALOG ---

  void _showSetDetailsDialog(int index, ExerciseDetail exercise) {

    final setsCtrl = TextEditingController(text: exercise.sets.toString());

    final repsCtrl = TextEditingController(text: exercise.reps.toString());

    final weightCtrl = TextEditingController(text: exercise.weight.toString());

    final isDark = Theme.of(context).brightness == Brightness.dark;


    showDialog(

      context: context,

      builder: (ctx) => AlertDialog(

        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,

        title: Text(

          "Target Goals",

          style: TextStyle(color: isDark ? Colors.white : Colors.black87),

        ),

        content: Column(

          mainAxisSize: MainAxisSize.min,

          children: [

            _buildDialogInput("Sets", setsCtrl, isDark),

            const SizedBox(height: 12),

            _buildDialogInput("Reps", repsCtrl, isDark),

            const SizedBox(height: 12),

            _buildDialogInput("Weight (kg)", weightCtrl, isDark),

          ],

        ),

        actions: [

          TextButton(

            onPressed: () => Navigator.pop(ctx),

            child: const Text("Cancel", style: TextStyle(color: Colors.grey)),

          ),

          TextButton(

            onPressed: () {

              setState(() {

                _currentExercises[index].sets =

                    int.tryParse(setsCtrl.text) ?? 3;

                _currentExercises[index].reps =

                    int.tryParse(repsCtrl.text) ?? 10;

                _currentExercises[index].weight =

                    double.tryParse(weightCtrl.text) ?? 0.0;

              });

              Navigator.pop(ctx);

            },

            child: const Text(

              "Save",

              style: TextStyle(

                color: Colors.deepOrange,

                fontWeight: FontWeight.bold,

              ),

            ),

          ),

        ],

      ),

    );

  }


  Widget _buildDialogInput(

    String label,

    TextEditingController ctrl,

    bool isDark,

  ) {

    return TextField(

      controller: ctrl,

      keyboardType: TextInputType.number,

      style: TextStyle(color: isDark ? Colors.white : Colors.black87),

      decoration: InputDecoration(

        labelText: label,

        labelStyle: const TextStyle(color: Colors.grey),

        enabledBorder: OutlineInputBorder(

          borderSide: BorderSide(color: Colors.grey.withOpacity(0.3)),

        ),

        focusedBorder: const OutlineInputBorder(

          borderSide: BorderSide(color: Colors.deepOrange),

        ),

      ),

    );

  }

}


// --- SMART SEARCH SHEET ---

class ExerciseSearchSheet extends StatefulWidget {

  final Function(String) onSelect;

  const ExerciseSearchSheet({super.key, required this.onSelect});


  @override

  State<ExerciseSearchSheet> createState() => _ExerciseSearchSheetState();

}


class _ExerciseSearchSheetState extends State<ExerciseSearchSheet> {

  final TextEditingController _searchCtrl = TextEditingController();

  List<String> _filteredList = [];


  @override

  void initState() {

    super.initState();

    _filteredList = _masterExerciseList;

  }


  void _filter(String query) {

    setState(() {

      if (query.isEmpty) {

        _filteredList = _masterExerciseList;

      } else {

        _filteredList = _masterExerciseList

            .where((ex) => ex.toLowerCase().contains(query.toLowerCase()))

            .toList();

      }

    });

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;

    final bgColor = isDark ? Colors.black26 : Colors.grey.shade100;


    return Padding(

      padding: EdgeInsets.only(

        top: 20,

        left: 20,

        right: 20,

        bottom: MediaQuery.of(context).viewInsets.bottom + 20,

      ),

      child: Column(

        mainAxisSize: MainAxisSize.min,

        crossAxisAlignment: CrossAxisAlignment.start,

        children: [

          Text(

            "Add Exercise",

            style: TextStyle(

              fontSize: 20,

              fontWeight: FontWeight.bold,

              color: textColor,

            ),

          ),

          const SizedBox(height: 15),

          TextField(

            controller: _searchCtrl,

            onChanged: _filter,

            autofocus: true,

            style: TextStyle(color: textColor),

            decoration: InputDecoration(

              hintText: "Search (e.g. Bench...)",

              hintStyle: const TextStyle(color: Colors.grey),

              prefixIcon: const Icon(Icons.search, color: Colors.grey),

              filled: true,

              fillColor: bgColor,

              border: OutlineInputBorder(

                borderRadius: BorderRadius.circular(12),

                borderSide: BorderSide.none,

              ),

              contentPadding: const EdgeInsets.symmetric(horizontal: 16),

            ),

          ),

          const SizedBox(height: 10),

          SizedBox(

            height: 300,

            child: _filteredList.isEmpty

                ? Center(

                    child: ElevatedButton.icon(

                      onPressed: () {

                        // LOGIC FIX: MEMORY UPDATE

                        // This ensures Arnold Press is saved for future searches in this session

                        _masterExerciseList.add(_searchCtrl.text);

                        widget.onSelect(_searchCtrl.text);

                      },

                      icon: const Icon(Icons.add),

                      label: Text("Create '${_searchCtrl.text}'"),

                      style: ElevatedButton.styleFrom(

                        backgroundColor: Colors.deepOrange,

                        foregroundColor: Colors.white,

                      ),

                    ),

                  )

                : ListView.separated(

                    itemCount: _filteredList.length,

                    separatorBuilder: (ctx, i) =>

                        Divider(color: Colors.grey.withOpacity(0.1)),

                    itemBuilder: (ctx, i) {

                      return ListTile(

                        title: Text(

                          _filteredList[i],

                          style: TextStyle(color: textColor),

                        ),

                        trailing: const Icon(

                          Icons.add_circle_outline,

                          color: Colors.deepOrange,

                        ),

                        onTap: () => widget.onSelect(_filteredList[i]),

                      );

                    },

                  ),

          ),

        ],

      ),

    );

  }

}

*/


hydration.dart:

import 'package:flutter/material.dart';


class HydrationCard extends StatelessWidget {

  final String title;

  final IconData icon;

  final Color color;

  final int value;

  final int multiplier;

  final String unit;

  final VoidCallback onAdd;

  final VoidCallback onRemove;

  final Function(int) onEditMultiplier;


  const HydrationCard({

    super.key,

    required this.title,

    required this.icon,

    required this.color,

    required this.value,

    required this.multiplier,

    required this.unit,

    required this.onAdd,

    required this.onRemove,

    required this.onEditMultiplier,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    final totalAmount = value * multiplier;


    return Container(

      padding: const EdgeInsets.all(16),

      decoration: BoxDecoration(

        color: cardColor,

        borderRadius: BorderRadius.circular(24),

      ),

      child: Column(

        crossAxisAlignment: CrossAxisAlignment.start,

        children: [

          Row(

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Row(

                children: [

                  Icon(icon, color: color, size: 22),

                  const SizedBox(width: 8),

                  Text(

                    title,

                    style: TextStyle(

                      color: Colors.grey.shade600,

                      fontSize: 13,

                      fontWeight: FontWeight.bold,

                    ),

                  ),

                ],

              ),

              GestureDetector(

                onTap: () => _showConfigSheet(context),

                child: const Icon(

                  Icons.settings_outlined,

                  size: 18,

                  color: Colors.grey,

                ),

              ),

            ],

          ),

          const SizedBox(height: 12),

          Text(

            "$totalAmount $unit",

            style: TextStyle(

              fontSize: 26,

              fontWeight: FontWeight.bold,

              color: textColor,

            ),

          ), // Bigger

          Text(

            "$value x $multiplier$unit",

            style: const TextStyle(fontSize: 12, color: Colors.grey),

          ), // Bigger

          const Spacer(),

          Container(

            padding: const EdgeInsets.all(4),

            decoration: BoxDecoration(

              color: isDark ? Colors.black26 : Colors.grey.shade100,

              borderRadius: BorderRadius.circular(16),

            ),

            child: Row(

              mainAxisAlignment: MainAxisAlignment.spaceBetween,

              children: [

                _ctrlBtn(Icons.remove, onRemove, isDark),

                _ctrlBtn(Icons.add, onAdd, isDark),

              ],

            ),

          ),

        ],

      ),

    );

  }


  Widget _ctrlBtn(IconData i, VoidCallback onTap, bool isDark) {

    return GestureDetector(

      onTap: onTap,

      child: Container(

        padding: const EdgeInsets.all(8),

        decoration: BoxDecoration(

          color: isDark ? Colors.white10 : Colors.white,

          shape: BoxShape.circle,

        ),

        child: Icon(i, size: 20, color: color),

      ),

    );

  }


  void _showConfigSheet(BuildContext context) {

    final ctrl = TextEditingController(text: multiplier.toString());

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final bgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: bgColor,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) {

        return Padding(

          padding: EdgeInsets.only(

            bottom: MediaQuery.of(ctx).viewInsets.bottom + 20,

            left: 24,

            right: 24,

            top: 24,

          ),

          child: Column(

            mainAxisSize: MainAxisSize.min,

            crossAxisAlignment: CrossAxisAlignment.start,

            children: [

              Text(

                "Set $title Unit Size",

                style: TextStyle(

                  fontSize: 20,

                  fontWeight: FontWeight.bold,

                  color: textColor,

                ),

              ),

              const SizedBox(height: 8),

              Text(

                "How much is one tap?",

                style: TextStyle(color: Colors.grey.shade500, fontSize: 14),

              ),

              const SizedBox(height: 20),

              Container(

                padding: const EdgeInsets.symmetric(horizontal: 16),

                decoration: BoxDecoration(

                  color: isDark ? Colors.black26 : Colors.grey.shade100,

                  borderRadius: BorderRadius.circular(16),

                  border: Border.all(color: color.withOpacity(0.3)),

                ),

                child: TextField(

                  controller: ctrl,

                  keyboardType: TextInputType.number,

                  style: TextStyle(

                    fontSize: 24,

                    fontWeight: FontWeight.bold,

                    color: textColor,

                  ),

                  decoration: InputDecoration(

                    border: InputBorder.none,

                    suffixText: unit,

                    suffixStyle: TextStyle(color: Colors.grey, fontSize: 16),

                  ),

                  autofocus: true,

                ),

              ),

              const SizedBox(height: 24),

              SizedBox(

                width: double.infinity,

                height: 55,

                child: ElevatedButton(

                  onPressed: () {

                    if (ctrl.text.isNotEmpty)

                      onEditMultiplier(int.parse(ctrl.text));

                    Navigator.pop(ctx);

                  },

                  style: ElevatedButton.styleFrom(

                    backgroundColor: color,

                    foregroundColor: Colors.white,

                    shape: RoundedRectangleBorder(

                      borderRadius: BorderRadius.circular(16),

                    ),

                  ),

                  child: const Text(

                    "Save Configuration",

                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),

                  ),

                ),

              ),

            ],

          ),

        );

      },

    );

  }

}


nutrition.dart:

import 'package:flutter/material.dart';

import '../../../models/health_model.dart';


class NutritionCard extends StatelessWidget {

  final HealthDailyLog log;

  final Function(FoodItem) onAddFood;

  final Function(bool) onDietToggle;


  const NutritionCard({

    super.key,

    required this.log,

    required this.onAddFood,

    required this.onDietToggle,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Container(

      decoration: BoxDecoration(

        color: cardColor,

        borderRadius: BorderRadius.circular(24),

      ),

      child: InkWell(

        onTap: () => _showFoodLog(context),

        borderRadius: BorderRadius.circular(24),

        child: Padding(

          padding: const EdgeInsets.all(16),

          child: Column(

            crossAxisAlignment: CrossAxisAlignment.start,

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              // 1. TOP: Title + Icon

              Row(

                children: [

                  const Icon(

                    Icons.restaurant_menu_rounded,

                    color: Colors.green,

                    size: 28,

                  ),

                  const SizedBox(width: 8),

                  Text(

                    "Nutrition",

                    style: TextStyle(

                      fontWeight: FontWeight.bold,

                      fontSize: 18,

                      color: textColor,

                    ),

                  ),

                ],

              ),


              // 2. MIDDLE: Calories + Macros

              Expanded(

                child: Center(

                  child: Column(

                    mainAxisSize: MainAxisSize.min,

                    children: [

                      Text(

                        "${log.totalCalories}",

                        style: TextStyle(

                          fontSize: 34,

                          fontWeight: FontWeight.bold,

                          color: textColor,

                          height: 1.0,

                        ),

                      ),

                      const Text(

                        "kcal",

                        style: TextStyle(fontSize: 14, color: Colors.grey),

                      ),


                      if (log.useMacros) ...[

                        const SizedBox(height: 12),

                        Row(

                          mainAxisAlignment: MainAxisAlignment.center,

                          children: [

                            _miniMacro("P", log.totalProtein, Colors.red),

                            const SizedBox(width: 16),

                            _miniMacro("C", log.totalCarbs, Colors.blue),

                            const SizedBox(width: 16),

                            _miniMacro("F", log.totalFat, Colors.orange),

                          ],

                        ),

                      ],

                    ],

                  ),

                ),

              ),


              // 3. BOTTOM: Controls

              Row(

                mainAxisAlignment: MainAxisAlignment.spaceBetween,

                children: [

                  Transform.scale(

                    scale: 0.8,

                    alignment: Alignment.centerLeft,

                    child: Switch(

                      value: log.useMacros,

                      onChanged: onDietToggle,

                      activeColor: Colors.green,

                      activeTrackColor: Colors.green.withOpacity(0.2),

                      inactiveThumbColor: Colors.grey,

                      inactiveTrackColor: isDark

                          ? Colors.black26

                          : Colors.grey.shade200,

                    ),

                  ),


                  GestureDetector(

                    onTap: () => _showProfessionalAddSheet(context),

                    child: Container(

                      padding: const EdgeInsets.all(8),

                      decoration: BoxDecoration(

                        color: Colors.green.withOpacity(0.1),

                        shape: BoxShape.circle,

                      ),

                      child: const Icon(

                        Icons.add,

                        color: Colors.green,

                        size: 24,

                      ),

                    ),

                  ),

                ],

              ),

            ],

          ),

        ),

      ),

    );

  }


  Widget _miniMacro(String label, int val, Color color) {

    return Column(

      children: [

        Text(

          "$val",

          style: TextStyle(

            fontWeight: FontWeight.bold,

            color: color,

            fontSize: 14,

          ),

        ),

        Text(

          label,

          style: TextStyle(

            color: color.withOpacity(0.6),

            fontSize: 10,

            fontWeight: FontWeight.bold,

          ),

        ),

      ],

    );

  }


  void _showProfessionalAddSheet(BuildContext context) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => AddFoodSheet(onAdd: onAddFood),

    );

  }


  void _showFoodLog(BuildContext context) {

    showModalBottomSheet(

      context: context,

      isScrollControlled: true,

      backgroundColor: Theme.of(context).brightness == Brightness.dark

          ? const Color(0xFF1E1E1E)

          : Colors.white,

      shape: const RoundedRectangleBorder(

        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),

      ),

      builder: (ctx) => FoodLogSheet(foodLog: log.foodLog),

    );

  }

}


// --- NEW PROFESSIONAL FOOD LOG SHEET ---

class FoodLogSheet extends StatefulWidget {

  final List<FoodItem> foodLog;

  const FoodLogSheet({super.key, required this.foodLog});


  @override

  State<FoodLogSheet> createState() => _FoodLogSheetState();

}


class _FoodLogSheetState extends State<FoodLogSheet> {

  bool _showDetails = false;


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;


    return DraggableScrollableSheet(

      initialChildSize: 0.7,

      maxChildSize: 0.9,

      minChildSize: 0.5,

      expand: false,

      builder: (_, scrollController) {

        return Padding(

          padding: const EdgeInsets.all(20),

          child: Column(

            children: [

              // Header

              Row(

                mainAxisAlignment: MainAxisAlignment.spaceBetween,

                children: [

                  Text(

                    "Today's Food Log",

                    style: TextStyle(

                      fontSize: 22,

                      fontWeight: FontWeight.bold,

                      color: textColor,

                    ),

                  ),

                  Row(

                    children: [

                      Text(

                        "Details",

                        style: TextStyle(

                          color: Colors.grey.shade600,

                          fontSize: 12,

                        ),

                      ),

                      const SizedBox(width: 8),

                      Switch(

                        value: _showDetails,

                        onChanged: (val) => setState(() => _showDetails = val),

                        activeColor: Colors.green,

                      ),

                    ],

                  ),

                ],

              ),

              const SizedBox(height: 20),


              // List

              Expanded(

                child: widget.foodLog.isEmpty

                    ? Center(

                        child: Text(

                          "No food logged yet.",

                          style: TextStyle(color: Colors.grey.shade600),

                        ),

                      )

                    : ListView.separated(

                        controller: scrollController,

                        itemCount: widget.foodLog.length,

                        separatorBuilder: (ctx, i) =>

                            const SizedBox(height: 12),

                        itemBuilder: (ctx, index) {

                          final item = widget.foodLog[index];

                          return Container(

                            padding: const EdgeInsets.symmetric(

                              horizontal: 16,

                              vertical: 12,

                            ),

                            decoration: BoxDecoration(

                              color: isDark

                                  ? Colors.black26

                                  : Colors.grey.shade100,

                              borderRadius: BorderRadius.circular(16),

                            ),

                            child: Column(

                              children: [

                                Row(

                                  mainAxisAlignment:

                                      MainAxisAlignment.spaceBetween,

                                  children: [

                                    Column(

                                      crossAxisAlignment:

                                          CrossAxisAlignment.start,

                                      children: [

                                        Text(

                                          item.name,

                                          style: TextStyle(

                                            fontWeight: FontWeight.bold,

                                            fontSize: 16,

                                            color: textColor,

                                          ),

                                        ),

                                        Text(

                                          "${item.timestamp.hour}:${item.timestamp.minute.toString().padLeft(2, '0')}",

                                          style: const TextStyle(

                                            color: Colors.grey,

                                            fontSize: 12,

                                          ),

                                        ),

                                      ],

                                    ),

                                    Text(

                                      "${item.calories} kcal",

                                      style: TextStyle(

                                        fontSize: 16,

                                        fontWeight: FontWeight.bold,

                                        color: Colors.green.shade400,

                                      ),

                                    ),

                                  ],

                                ),

                                if (_showDetails) ...[

                                  const SizedBox(height: 12),

                                  const Divider(height: 1),

                                  const SizedBox(height: 12),

                                  Row(

                                    mainAxisAlignment:

                                        MainAxisAlignment.spaceAround,

                                    children: [

                                      _microTag(

                                        "Protein",

                                        "${item.protein}g",

                                        Colors.red,

                                      ),

                                      _microTag(

                                        "Carbs",

                                        "${item.carbs}g",

                                        Colors.blue,

                                      ),

                                      _microTag(

                                        "Fat",

                                        "${item.fat}g",

                                        Colors.orange,

                                      ),

                                    ],

                                  ),

                                ],

                              ],

                            ),

                          );

                        },

                      ),

              ),

            ],

          ),

        );

      },

    );

  }


  Widget _microTag(String label, String val, Color color) {

    return Row(

      children: [

        Container(

          width: 8,

          height: 8,

          decoration: BoxDecoration(color: color, shape: BoxShape.circle),

        ),

        const SizedBox(width: 6),

        Text(

          "$label: ",

          style: const TextStyle(color: Colors.grey, fontSize: 12),

        ),

        Text(

          val,

          style: TextStyle(

            fontWeight: FontWeight.bold,

            color: color,

            fontSize: 12,

          ),

        ),

      ],

    );

  }

}


// --- ADD FOOD SHEET (Unchanged) ---

class AddFoodSheet extends StatefulWidget {

  final Function(FoodItem) onAdd;

  const AddFoodSheet({super.key, required this.onAdd});


  @override

  State<AddFoodSheet> createState() => _AddFoodSheetState();

}


class _AddFoodSheetState extends State<AddFoodSheet> {

  final nameCtrl = TextEditingController();

  final calCtrl = TextEditingController();

  final pCtrl = TextEditingController();

  final cCtrl = TextEditingController();

  final fCtrl = TextEditingController();

  bool _isDetailed = false;


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;

    final inputBg = isDark ? Colors.black26 : Colors.grey.shade100;


    return Padding(

      padding: EdgeInsets.only(

        bottom: MediaQuery.of(context).viewInsets.bottom,

      ),

      child: SingleChildScrollView(

        child: Padding(

          padding: const EdgeInsets.all(20),

          child: Column(

            mainAxisSize: MainAxisSize.min,

            crossAxisAlignment: CrossAxisAlignment.start,

            children: [

              Row(

                mainAxisAlignment: MainAxisAlignment.spaceBetween,

                children: [

                  Text(

                    "Add Food",

                    style: TextStyle(

                      fontSize: 20,

                      fontWeight: FontWeight.bold,

                      color: textColor,

                    ),

                  ),

                  Row(

                    children: [

                      const Text(

                        "Detailed",

                        style: TextStyle(color: Colors.grey, fontSize: 12),

                      ),

                      Switch(

                        value: _isDetailed,

                        onChanged: (val) => setState(() => _isDetailed = val),

                        activeColor: Colors.green,

                      ),

                    ],

                  ),

                ],

              ),

              const SizedBox(height: 20),

              _buildInput(nameCtrl, "Food Name", inputBg, textColor),

              const SizedBox(height: 12),

              _buildInput(

                calCtrl,

                "Calories (kcal)",

                inputBg,

                textColor,

                isNum: true,

              ),

              const SizedBox(height: 12),

              if (_isDetailed) ...[

                Row(

                  children: [

                    Expanded(

                      child: _buildInput(

                        pCtrl,

                        "Protein",

                        inputBg,

                        textColor,

                        isNum: true,

                      ),

                    ),

                    const SizedBox(width: 12),

                    Expanded(

                      child: _buildInput(

                        cCtrl,

                        "Carbs",

                        inputBg,

                        textColor,

                        isNum: true,

                      ),

                    ),

                    const SizedBox(width: 12),

                    Expanded(

                      child: _buildInput(

                        fCtrl,

                        "Fat",

                        inputBg,

                        textColor,

                        isNum: true,

                      ),

                    ),

                  ],

                ),

                const SizedBox(height: 20),

              ],

              const SizedBox(height: 10),

              SizedBox(

                width: double.infinity,

                height: 55,

                child: ElevatedButton(

                  onPressed: () {

                    if (nameCtrl.text.isNotEmpty && calCtrl.text.isNotEmpty) {

                      widget.onAdd(

                        FoodItem(

                          name: nameCtrl.text,

                          calories: int.tryParse(calCtrl.text) ?? 0,

                          protein: int.tryParse(pCtrl.text) ?? 0,

                          carbs: int.tryParse(cCtrl.text) ?? 0,

                          fat: int.tryParse(fCtrl.text) ?? 0,

                          timestamp: DateTime.now(),

                        ),

                      );

                      Navigator.pop(context);

                    }

                  },

                  style: ElevatedButton.styleFrom(

                    backgroundColor: Colors.green,

                    foregroundColor: Colors.white,

                    shape: RoundedRectangleBorder(

                      borderRadius: BorderRadius.circular(16),

                    ),

                  ),

                  child: const Text(

                    "Add to Log",

                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),

                  ),

                ),

              ),

              SizedBox(height: MediaQuery.of(context).padding.bottom + 10),

            ],

          ),

        ),

      ),

    );

  }


  Widget _buildInput(

    TextEditingController ctrl,

    String hint,

    Color bg,

    Color text, {

    bool isNum = false,

  }) {

    return Container(

      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),

      decoration: BoxDecoration(

        color: bg,

        borderRadius: BorderRadius.circular(12),

      ),

      child: TextField(

        controller: ctrl,

        keyboardType: isNum ? TextInputType.number : TextInputType.text,

        style: TextStyle(color: text),

        decoration: InputDecoration(

          border: InputBorder.none,

          hintText: hint,

          hintStyle: const TextStyle(color: Colors.grey, fontSize: 13),

        ),

      ),

    );

  }

}


grid.dart:

import 'package:flutter/material.dart';

import '../../models/health_model.dart';


// IMPORTS

import 'cards/nutrition.dart';

import 'cards/hydration.dart';

import 'activity/activity_card.dart';


class HealthGrid extends StatelessWidget {

  final HealthDailyLog log;

  final Function(int) onWaterChanged;

  final Function(int) onCaffeineChanged;

  final Function(int) onMoodChanged;

  final Function(bool) onDietToggle;

  final Function(int) onStepsChanged;

  final Function(double) onWeightChanged;

  final Function(String?) onRoutineChanged;

  final Function(bool) onWorkoutToggle;

  final Function(FoodItem) onAddFood;

  final Function(int) onUpdateGlassSize;


  final Function(int) onCaloriesChanged;

  final Function(int, int, int) onMacrosChanged;


  const HealthGrid({

    super.key,

    required this.log,

    required this.onWaterChanged,

    required this.onCaffeineChanged,

    required this.onMoodChanged,

    required this.onDietToggle,

    required this.onStepsChanged,

    required this.onWeightChanged,

    required this.onRoutineChanged,

    required this.onWorkoutToggle,

    required this.onAddFood,

    required this.onUpdateGlassSize,

    required this.onCaloriesChanged,

    required this.onMacrosChanged,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;


    return SingleChildScrollView(

      padding: const EdgeInsets.all(20),

      child: Column(

        children: [

          // --- ROW 1: GYM & NUTRITION (THE NEW LAYOUT) ---

          IntrinsicHeight(

            // Ensures both cards stretch to same height

            child: Row(

              crossAxisAlignment: CrossAxisAlignment.stretch,

              children: [

                // GYM CARD (Half Width)

                Expanded(

                  child: ActivityCard(

                    log: log,

                    onRoutineChanged: onRoutineChanged,

                    onWorkoutToggle: onWorkoutToggle,

                    onStepsChanged: onStepsChanged,

                    onWeightChanged: onWeightChanged,

                  ),

                ),

                const SizedBox(width: 16),

                // NUTRITION CARD (Half Width)

                Expanded(

                  child: NutritionCard(

                    log: log,

                    onAddFood: onAddFood,

                    onDietToggle: onDietToggle,

                  ),

                ),

              ],

            ),

          ),


          const SizedBox(height: 16),


          // --- ROW 2: STEPS & WEIGHT ---

          Row(

            children: [

              Expanded(

                child: _buildSimpleCard(

                  context,

                  Icons.directions_walk,

                  "Steps",

                  "${log.steps}",

                  "steps",

                  Colors.orange,

                  cardColor,

                  () => onStepsChanged(log.steps), // Placeholder tap

                ),

              ),

              const SizedBox(width: 16),

              Expanded(

                child: _buildSimpleCard(

                  context,

                  Icons.monitor_weight,

                  "Weight",

                  "${log.weight}",

                  "kg",

                  Colors.deepPurple,

                  cardColor,

                  () => onWeightChanged(log.weight), // Placeholder tap

                ),

              ),

            ],

          ),


          const SizedBox(height: 16),


          // --- ROW 3: HYDRATION ---

          Row(

            children: [

              Expanded(

                child: SizedBox(

                  height: 180,

                  child: HydrationCard(

                    title: "Water",

                    icon: Icons.water_drop,

                    color: Colors.blue,

                    value: log.waterGlasses,

                    multiplier: log.waterGlassSizeMl,

                    unit: "ml",

                    onAdd: () => onWaterChanged(log.waterGlasses + 1),

                    onRemove: () => onWaterChanged(

                      log.waterGlasses > 0 ? log.waterGlasses - 1 : 0,

                    ),

                    onEditMultiplier: onUpdateGlassSize,

                  ),

                ),

              ),

              const SizedBox(width: 16),

              Expanded(

                child: SizedBox(

                  height: 180,

                  child: HydrationCard(

                    title: "Caffeine",

                    icon: Icons.coffee,

                    color: Colors.brown,

                    value: log.caffeineAmount,

                    multiplier: 95,

                    unit: "mg",

                    onAdd: () => onCaffeineChanged(log.caffeineAmount + 1),

                    onRemove: () => onCaffeineChanged(

                      log.caffeineAmount > 0 ? log.caffeineAmount - 1 : 0,

                    ),

                    onEditMultiplier: (val) {},

                  ),

                ),

              ),

            ],

          ),

          const SizedBox(height: 16),


          // --- MOOD TRACKER ---

          Container(

            padding: const EdgeInsets.symmetric(vertical: 16),

            decoration: BoxDecoration(

              color: cardColor,

              borderRadius: BorderRadius.circular(24),

            ),

            child: Row(

              mainAxisAlignment: MainAxisAlignment.spaceAround,

              children: [1, 2, 3, 4, 5].map((level) {

                final isSelected = log.mood == level;

                final emojis = ["ðŸ˜«", "ðŸ˜", "ðŸ™‚", "ðŸ˜", "ðŸ¤©"];

                return GestureDetector(

                  onTap: () => onMoodChanged(level),

                  child: AnimatedScale(

                    scale: isSelected ? 1.2 : 1.0,

                    duration: const Duration(milliseconds: 200),

                    child: Opacity(

                      opacity: isSelected ? 1.0 : 0.5,

                      child: Text(

                        emojis[level - 1],

                        style: const TextStyle(fontSize: 28),

                      ),

                    ),

                  ),

                );

              }).toList(),

            ),

          ),


          const SizedBox(height: 80),

        ],

      ),

    );

  }


  // Simple Card Builder for Steps/Weight (to keep code clean)

  Widget _buildSimpleCard(

    BuildContext context,

    IconData icon,

    String title,

    String value,

    String unit,

    Color color,

    Color bg,

    VoidCallback onTap,

  ) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black87;


    return Material(

      color: bg,

      borderRadius: BorderRadius.circular(24),

      child: InkWell(

        borderRadius: BorderRadius.circular(24),

        onTap: onTap,

        child: Container(

          height: 120,

          padding: const EdgeInsets.all(16),

          child: Column(

            crossAxisAlignment: CrossAxisAlignment.start,

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            children: [

              Icon(icon, color: color, size: 28),

              Column(

                crossAxisAlignment: CrossAxisAlignment.start,

                children: [

                  Text(

                    value,

                    style: TextStyle(

                      fontSize: 24,

                      fontWeight: FontWeight.bold,

                      color: textColor,

                    ),

                  ),

                  Text(

                    title,

                    style: const TextStyle(fontSize: 13, color: Colors.grey),

                  ),

                ],

              ),

            ],

          ),

        ),

      ),

    );

  }

}


hero.dart:

import 'package:flutter/material.dart';

import '../../models/health_model.dart';


class HealthHero extends StatelessWidget {

  final HealthDailyLog log;


  const HealthHero({super.key, required this.log});


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    return SingleChildScrollView(

      padding: const EdgeInsets.all(20),

      child: Column(

        children: [

          // HERO SECTION

          Container(

            padding: const EdgeInsets.all(24),

            decoration: BoxDecoration(

              color: cardColor,

              borderRadius: BorderRadius.circular(30),

              border: Border.all(color: Colors.grey.withOpacity(0.1)),

            ),

            child: Column(

              children: [

                Text(

                  "Activity Score",

                  style: TextStyle(color: Colors.grey.shade600),

                ),

                const SizedBox(height: 20),

                SizedBox(

                  height: 200,

                  width: 200,

                  child: Stack(

                    alignment: Alignment.center,

                    children: [

                      // Steps Ring

                      SizedBox(

                        height: 180,

                        width: 180,

                        child: CircularProgressIndicator(

                          value: (log.steps / 10000).clamp(0.0, 1.0),

                          strokeWidth: 14,

                          color: Colors.green,

                          backgroundColor: Colors.green.withOpacity(0.1),

                          strokeCap: StrokeCap.round,

                        ),

                      ),

                      // Calories Ring

                      SizedBox(

                        height: 130,

                        width: 130,

                        child: CircularProgressIndicator(

                          value: (log.totalCalories / 2400).clamp(0.0, 1.0),

                          strokeWidth: 14,

                          color: Colors.blue,

                          backgroundColor: Colors.blue.withOpacity(0.1),

                          strokeCap: StrokeCap.round,

                        ),

                      ),

                      // Water Ring

                      SizedBox(

                        height: 80,

                        width: 80,

                        child: CircularProgressIndicator(

                          value: (log.waterGlasses / 8).clamp(0.0, 1.0),

                          strokeWidth: 14,

                          color: Colors.orange,

                          backgroundColor: Colors.orange.withOpacity(0.1),

                          strokeCap: StrokeCap.round,

                        ),

                      ),

                      const Icon(

                        Icons.bolt_rounded,

                        size: 32,

                        color: Colors.grey,

                      ),

                    ],

                  ),

                ),

                const SizedBox(height: 24),

                Row(

                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,

                  children: [

                    _buildHeroLegend(

                      "Steps",

                      "${log.steps}",

                      Colors.green,

                      textColor,

                    ),

                    _buildHeroLegend(

                      "Cals",

                      "${log.totalCalories}",

                      Colors.blue,

                      textColor,

                    ),

                    _buildHeroLegend(

                      "Water",

                      "${(log.waterGlasses * 0.25)}L",

                      Colors.orange,

                      textColor,

                    ),

                  ],

                ),

              ],

            ),

          ),

          const SizedBox(height: 20),


          // WEIGHT TILE

          Container(

            padding: const EdgeInsets.all(20),

            decoration: BoxDecoration(

              color: cardColor,

              borderRadius: BorderRadius.circular(20),

            ),

            child: Row(

              mainAxisAlignment: MainAxisAlignment.spaceBetween,

              children: [

                Row(

                  children: [

                    Icon(Icons.monitor_weight_rounded, color: textColor),

                    const SizedBox(width: 12),

                    Text(

                      "Weight Tracker",

                      style: TextStyle(

                        fontWeight: FontWeight.bold,

                        color: textColor,

                      ),

                    ),

                  ],

                ),

                Text(

                  "${log.weight} kg",

                  style: TextStyle(

                    fontSize: 18,

                    fontWeight: FontWeight.bold,

                    color: textColor,

                  ),

                ),

              ],

            ),

          ),

          const SizedBox(height: 80),

        ],

      ),

    );

  }


  // --- MISSING HELPER ---

  Widget _buildHeroLegend(String label, String val, Color color, Color text) {

    return Column(

      children: [

        Text(

          val,

          style: TextStyle(

            fontWeight: FontWeight.bold,

            fontSize: 18,

            color: text,

          ),

        ),

        Row(

          children: [

            Container(

              width: 6,

              height: 6,

              decoration: BoxDecoration(color: color, shape: BoxShape.circle),

            ),

            const SizedBox(width: 4),

            Text(

              label,

              style: const TextStyle(fontSize: 12, color: Colors.grey),

            ),

          ],

        ),

      ],

    );

  }

}


list.dart:

import 'package:flutter/material.dart';

import '../../models/health_model.dart';


class HealthList extends StatelessWidget {

  final HealthDailyLog log;

  final Function(bool) onWorkoutToggle;


  const HealthList({

    super.key,

    required this.log,

    required this.onWorkoutToggle,

  });


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final cardColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final textColor = isDark ? Colors.white : Colors.black87;


    return SingleChildScrollView(

      padding: const EdgeInsets.all(20),

      child: Column(

        children: [

          // GYM HERO CARD

          GestureDetector(

            onTap: () => onWorkoutToggle(!log.isWorkoutDone),

            child: AnimatedContainer(

              duration: const Duration(milliseconds: 300),

              width: double.infinity,

              padding: const EdgeInsets.all(20),

              decoration: BoxDecoration(

                gradient: LinearGradient(

                  colors: log.isWorkoutDone

                      ? [const Color(0xFF2E7D32), const Color(0xFF1B5E20)]

                      : [const Color(0xFF43A047), const Color(0xFF2E7D32)],

                ),

                borderRadius: BorderRadius.circular(20),

                boxShadow: log.isWorkoutDone

                    ? []

                    : [

                        BoxShadow(

                          color: Colors.green.withOpacity(0.4),

                          blurRadius: 10,

                          offset: const Offset(0, 4),

                        ),

                      ],

              ),

              child: Row(

                children: [

                  Container(

                    padding: const EdgeInsets.all(12),

                    decoration: BoxDecoration(

                      color: Colors.white.withOpacity(0.2),

                      shape: BoxShape.circle,

                    ),

                    child: Icon(

                      log.isWorkoutDone ? Icons.check : Icons.fitness_center,

                      color: Colors.white,

                    ),

                  ),

                  const SizedBox(width: 15),

                  Column(

                    crossAxisAlignment: CrossAxisAlignment.start,

                    children: [

                      Text(

                        log.workoutName ?? "No Routine Selected",

                        style: const TextStyle(

                          color: Colors.white,

                          fontWeight: FontWeight.bold,

                          fontSize: 16,

                        ),

                      ),

                      Text(

                        log.isWorkoutDone ? "Completed" : "Tap to complete",

                        style: const TextStyle(

                          color: Colors.white70,

                          fontSize: 12,

                        ),

                      ),

                    ],

                  ),

                  const Spacer(),

                  if (!log.isWorkoutDone)

                    const Icon(Icons.chevron_right, color: Colors.white70),

                ],

              ),

            ),

          ),

          const SizedBox(height: 20),


          // LIST ITEMS

          _buildListRow(

            "Water Intake",

            "${(log.waterGlasses * (log.waterGlassSizeMl / 1000)).toStringAsFixed(2)} L",

            log.waterGlasses / 8,

            Colors.blue,

            Icons.water_drop,

            cardColor,

            textColor,

          ),

          const SizedBox(height: 12),

          _buildListRow(

            "Steps Walked",

            "${log.steps} / 10k",

            log.steps / 10000,

            Colors.orange,

            Icons.directions_walk,

            cardColor,

            textColor,

          ),

          const SizedBox(height: 12),

          _buildListRow(

            "Calories",

            "${log.totalCalories} / 2,400",

            log.totalCalories / 2400,

            Colors.red,

            Icons.local_fire_department,

            cardColor,

            textColor,

          ),

          const SizedBox(height: 12),

          _buildListRow(

            "Sleep",

            "${log.sleepHours}h",

            0.8,

            Colors.deepPurple,

            Icons.bedtime,

            cardColor,

            textColor,

          ),


          const SizedBox(height: 80),

        ],

      ),

    );

  }


  // --- MISSING HELPER ---

  Widget _buildListRow(

    String title,

    String value,

    double progress,

    Color color,

    IconData icon,

    Color bg,

    Color text,

  ) {

    return Container(

      padding: const EdgeInsets.all(16),

      decoration: BoxDecoration(

        color: bg,

        borderRadius: BorderRadius.circular(20),

      ),

      child: Column(

        children: [

          Row(

            children: [

              Icon(icon, color: color, size: 20),

              const SizedBox(width: 12),

              Text(

                title,

                style: TextStyle(fontWeight: FontWeight.bold, color: text),

              ),

              const Spacer(),

              Text(

                value,

                style: const TextStyle(color: Colors.grey, fontSize: 12),

              ),

            ],

          ),

          const SizedBox(height: 12),

          ClipRRect(

            borderRadius: BorderRadius.circular(4),

            child: LinearProgressIndicator(

              value: progress.clamp(0.0, 1.0),

              minHeight: 6,

              backgroundColor: color.withOpacity(0.1),

              color: color,

            ),

          ),

        ],

      ),

    );

  }

}


add_lesson_dialog.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';

import '../../models/lesson.dart';


class AddLessonDialog extends StatefulWidget {

  final Map<String, String> courseDatabase;

  final Function(Lesson) onAddLesson;

  final Future<void> Function(String, String) onUpdateGlobal;

  final DateTime selectedDate;

  // Optional parameters for Editing

  final Lesson? lessonToEdit;

  final Function(String)? onDelete;


  const AddLessonDialog({

    super.key,

    required this.courseDatabase,

    required this.onAddLesson,

    required this.onUpdateGlobal,

    required this.selectedDate,

    this.lessonToEdit,

    this.onDelete,

  });


  @override

  State<AddLessonDialog> createState() => _AddLessonDialogState();

}


class _AddLessonDialogState extends State<AddLessonDialog> {

  // Controllers

  late TextEditingController _roomController;

  late TextEditingController _instructorController;

  late TextEditingController _descriptionController;

  late TextEditingController _startTimeController;

  late TextEditingController _courseNameController;


  int _selectedDuration = 60;

  bool _isLecture = true;

  bool _isInstructorLocked = false;

  bool _isRecurring = true;


  final List<int> _durations = [30, 45, 60, 90, 120, 180, 240];


  @override

  void initState() {

    super.initState();

    final edit = widget.lessonToEdit;


    // 1. Pre-fill Controllers

    _roomController = TextEditingController(text: edit?.room ?? '');

    _instructorController = TextEditingController(text: edit?.instructor ?? '');

    _descriptionController = TextEditingController(

      text: edit?.description ?? '',

    );


    // Format start time for the controller

    String initialTimeStr = '';

    if (edit != null) {

      final h = edit.startTimeInMinutes ~/ 60;

      final m = edit.startTimeInMinutes % 60;

      initialTimeStr =

          '${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}';

    }

    _startTimeController = TextEditingController(text: initialTimeStr);

    _courseNameController = TextEditingController(text: edit?.name ?? '');


    // 2. Pre-fill State booleans

    if (edit != null) {

      _isLecture = edit.isLecture;

      _isRecurring = edit.isRecurring;

      _selectedDuration = edit.durationInMinutes;

      if (edit.instructor.isNotEmpty) {

        _isInstructorLocked = true;

      }

    }

  }


  String _toTitleCase(String text) {

    if (text.isEmpty) return text;

    return text

        .split(' ')

        .map((word) {

          if (word.isEmpty) return '';

          return word[0].toUpperCase() + word.substring(1).toLowerCase();

        })

        .join(' ');

  }


  Future<void> _selectTime() async {

    TimeOfDay initial = TimeOfDay.now();

    if (_startTimeController.text.isNotEmpty) {

      try {

        final parts = _startTimeController.text.split(':');

        initial = TimeOfDay(

          hour: int.parse(parts[0]),

          minute: int.parse(parts[1]),

        );

      } catch (_) {}

    }


    final TimeOfDay? picked = await showTimePicker(

      context: context,

      initialTime: initial,

      builder: (context, child) =>

          Theme(data: Theme.of(context), child: child!),

    );

    if (picked != null) {

      setState(() {

        _startTimeController.text =

            '${picked.hour.toString().padLeft(2, '0')}:${picked.minute.toString().padLeft(2, '0')}';

      });

    }

  }


  void _onCourseNameChanged(String value) {

    final key = widget.courseDatabase.keys.firstWhere(

      (k) => k.toLowerCase() == value.toLowerCase(),

      orElse: () => '',

    );


    if (key.isNotEmpty) {

      if (_instructorController.text != widget.courseDatabase[key]!) {

        setState(() {

          _instructorController.text = widget.courseDatabase[key]!;

          _isInstructorLocked = true;

        });

      }

    } else {

      if (_isInstructorLocked && !_isLecture) {

        setState(() => _isInstructorLocked = false);

      }

    }

  }


  // UPDATED: Added Cancel Button logic

  Future<bool?> _showProfessionalConfirmDialog(

    BuildContext context,

    String course,

    String oldProf,

    String newProf,

  ) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final primaryColor = Theme.of(context).primaryColor;

    final highlightColor = isDark ? Colors.deepPurpleAccent : primaryColor;


    return showDialog<bool?>(

      context: context,

      barrierDismissible: false,

      builder: (ctx) => Dialog(

        backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,

        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),

        child: Container(

          padding: const EdgeInsets.all(24.0),

          child: SingleChildScrollView(

            child: Column(

              mainAxisSize: MainAxisSize.min,

              children: [

                Container(

                  padding: const EdgeInsets.all(12),

                  decoration: BoxDecoration(

                    color: highlightColor.withOpacity(0.1),

                    shape: BoxShape.circle,

                  ),

                  child: Icon(Icons.school, size: 32, color: highlightColor),

                ),

                const SizedBox(height: 16),

                Text(

                  "Professor Changed",

                  textAlign: TextAlign.center,

                  style: TextStyle(

                    fontSize: 20,

                    fontWeight: FontWeight.bold,

                    color: isDark ? Colors.white : Colors.black,

                  ),

                ),

                const SizedBox(height: 12),

                Text(

                  "Update instructor for '$course'?",

                  textAlign: TextAlign.center,

                  style: TextStyle(

                    color: isDark ? Colors.white70 : Colors.black54,

                  ),

                ),

                const SizedBox(height: 20),

                // Comparison Box

                Container(

                  padding: const EdgeInsets.all(12),

                  decoration: BoxDecoration(

                    color: isDark ? Colors.white10 : Colors.grey.shade100,

                    borderRadius: BorderRadius.circular(12),

                  ),

                  child: Row(

                    mainAxisAlignment: MainAxisAlignment.spaceAround,

                    children: [

                      Expanded(

                        child: Column(

                          children: [

                            const Text(

                              "OLD",

                              style: TextStyle(

                                fontSize: 10,

                                fontWeight: FontWeight.bold,

                                color: Colors.grey,

                              ),

                            ),

                            const SizedBox(height: 4),

                            Text(

                              oldProf,

                              textAlign: TextAlign.center,

                              overflow: TextOverflow.ellipsis,

                              maxLines: 2,

                              style: TextStyle(

                                fontWeight: FontWeight.bold,

                                color: isDark ? Colors.white70 : Colors.black87,

                              ),

                            ),

                          ],

                        ),

                      ),

                      const Padding(

                        padding: EdgeInsets.symmetric(horizontal: 8.0),

                        child: Icon(

                          Icons.arrow_forward,

                          size: 16,

                          color: Colors.grey,

                        ),

                      ),

                      Expanded(

                        child: Column(

                          children: [

                            const Text(

                              "NEW",

                              style: TextStyle(

                                fontSize: 10,

                                fontWeight: FontWeight.bold,

                                color: Colors.grey,

                              ),

                            ),

                            const SizedBox(height: 4),

                            Text(

                              newProf,

                              textAlign: TextAlign.center,

                              overflow: TextOverflow.ellipsis,

                              maxLines: 2,

                              style: TextStyle(

                                fontWeight: FontWeight.bold,

                                color: isDark ? Colors.white : Colors.black,

                              ),

                            ),

                          ],

                        ),

                      ),

                    ],

                  ),

                ),

                const SizedBox(height: 24),

                Row(

                  children: [

                    Expanded(

                      child: OutlinedButton(

                        style: OutlinedButton.styleFrom(

                          padding: const EdgeInsets.symmetric(vertical: 12),

                          side: BorderSide(

                            color: isDark

                                ? Colors.white24

                                : Colors.grey.shade300,

                          ),

                          shape: RoundedRectangleBorder(

                            borderRadius: BorderRadius.circular(12),

                          ),

                        ),

                        onPressed: () => Navigator.pop(ctx, false),

                        child: Text(

                          "Only This Class",

                          textAlign: TextAlign.center,

                          style: TextStyle(

                            color: isDark ? Colors.white70 : Colors.black87,

                            fontSize: 12,

                          ),

                        ),

                      ),

                    ),

                    const SizedBox(width: 12),

                    Expanded(

                      child: ElevatedButton(

                        style: ElevatedButton.styleFrom(

                          padding: const EdgeInsets.symmetric(vertical: 12),

                          backgroundColor: highlightColor,

                          shape: RoundedRectangleBorder(

                            borderRadius: BorderRadius.circular(12),

                          ),

                        ),

                        onPressed: () => Navigator.pop(ctx, true),

                        child: const Text(

                          "Update All",

                          textAlign: TextAlign.center,

                          style: TextStyle(

                            color: Colors.white,

                            fontWeight: FontWeight.bold,

                            fontSize: 12,

                          ),

                        ),

                      ),

                    ),

                  ],

                ),

                const SizedBox(height: 12),

                // ADDED: Cancel Button

                TextButton(

                  onPressed: () =>

                      Navigator.pop(ctx, null), // null means cancel

                  child: Text(

                    "Cancel",

                    style: TextStyle(color: Colors.grey.shade500),

                  ),

                ),

              ],

            ),

          ),

        ),

      ),

    );

  }


  void _submit() async {

    if (_courseNameController.text.isEmpty ||

        _startTimeController.text.isEmpty) {

      ScaffoldMessenger.of(

        context,

      ).showSnackBar(const SnackBar(content: Text('Missing Name or Time')));

      return;

    }


    String finalCourseName = _toTitleCase(_courseNameController.text.trim());

    final existingKey = widget.courseDatabase.keys.firstWhere(

      (k) => k.toLowerCase() == finalCourseName.toLowerCase(),

      orElse: () => '',

    );

    if (existingKey.isNotEmpty) finalCourseName = existingKey;


    String finalInstructor = _toTitleCase(_instructorController.text.trim());


    bool performGlobalUpdate = false;


    // Check for professor change

    if (existingKey.isNotEmpty && _isLecture) {

      final oldInstructor = widget.courseDatabase[existingKey]!;

      if (oldInstructor.isNotEmpty && oldInstructor != finalInstructor) {

        final result = await _showProfessionalConfirmDialog(

          context,

          finalCourseName,

          oldInstructor,

          finalInstructor,

        );


        if (result == null) {

          // User clicked Cancel, abort save

          return;

        }

        performGlobalUpdate = result;

      }

    }


    if (performGlobalUpdate) {

      widget.courseDatabase[finalCourseName] = finalInstructor;

    }


    final parts = _startTimeController.text.split(':');

    final startMin = int.parse(parts[0]) * 60 + int.parse(parts[1]);


    final dayName = DateFormat('EEEE').format(widget.selectedDate);

    final dateString = DateFormat('yyyy-MM-dd').format(widget.selectedDate);


    final newLesson = Lesson(

      id: widget.lessonToEdit?.id,

      userId: 'test_user',

      name: finalCourseName,

      room: _isLecture ? _roomController.text : '',

      instructor: _isLecture ? finalInstructor : '',

      description: _isLecture ? '' : _descriptionController.text,

      isLecture: _isLecture,

      isRecurring: _isRecurring,

      dayOfWeek: widget.lessonToEdit?.dayOfWeek ?? dayName,

      startTimeInMinutes: startMin,

      durationInMinutes: _selectedDuration,

      specificDate: _isRecurring ? '' : dateString,

      excludeDates: widget.lessonToEdit?.excludeDates ?? [],

    );


    try {

      if (performGlobalUpdate) {

        await widget.onUpdateGlobal(finalCourseName, finalInstructor);

      }

      widget.onAddLesson(newLesson);

      if (mounted) Navigator.of(context).pop();

    } catch (e) {

      debugPrint("Error saving: $e");

    }

  }


  @override

  Widget build(BuildContext context) {

    final isEditing = widget.lessonToEdit != null;

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final primaryColor = Theme.of(context).primaryColor;

    final accentColor = isDark ? Colors.deepPurpleAccent : primaryColor;

    final dayName = DateFormat('EEEE').format(widget.selectedDate);


    return AlertDialog(

      scrollable: true,

      backgroundColor: isDark ? const Color(0xFF1E1E1E) : Colors.white,

      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),

      title: Center(

        child: Text(

          isEditing ? 'Edit Event' : 'Add Event',

          style: const TextStyle(fontWeight: FontWeight.bold),

        ),

      ),

      contentPadding: const EdgeInsets.symmetric(horizontal: 24, vertical: 10),

      content: SizedBox(

        width: MediaQuery.of(context).size.width * 0.9,

        child: Column(

          mainAxisSize: MainAxisSize.min,

          children: [

            Row(

              children: [

                Expanded(

                  child: ChoiceChip(

                    label: const Center(child: Text("ðŸŽ“ Class")),

                    selected: _isLecture,

                    onSelected: (val) => setState(() => _isLecture = true),

                    selectedColor: accentColor.withOpacity(0.3),

                    backgroundColor: isDark

                        ? Colors.white10

                        : Colors.grey.shade200,

                    labelStyle: TextStyle(

                      color: _isLecture

                          ? (isDark ? Colors.white : accentColor)

                          : (isDark ? Colors.white70 : Colors.black54),

                      fontWeight: _isLecture

                          ? FontWeight.bold

                          : FontWeight.normal,

                    ),

                    shape: RoundedRectangleBorder(

                      borderRadius: BorderRadius.circular(20),

                    ),

                    side: BorderSide(

                      color: _isLecture

                          ? accentColor

                          : (isDark ? Colors.white12 : Colors.grey.shade300),

                    ),

                  ),

                ),

                const SizedBox(width: 8),

                Expanded(

                  child: ChoiceChip(

                    label: const Center(child: Text("ðŸ“ Task")),

                    selected: !_isLecture,

                    onSelected: (val) => setState(() => _isLecture = false),

                    selectedColor: accentColor.withOpacity(0.3),

                    backgroundColor: isDark

                        ? Colors.white10

                        : Colors.grey.shade200,

                    labelStyle: TextStyle(

                      color: !_isLecture

                          ? (isDark ? Colors.white : accentColor)

                          : (isDark ? Colors.white70 : Colors.black54),

                      fontWeight: !_isLecture

                          ? FontWeight.bold

                          : FontWeight.normal,

                    ),

                    shape: RoundedRectangleBorder(

                      borderRadius: BorderRadius.circular(20),

                    ),

                    side: BorderSide(

                      color: !_isLecture

                          ? accentColor

                          : (isDark ? Colors.white12 : Colors.grey.shade300),

                    ),

                  ),

                ),

              ],

            ),

            const SizedBox(height: 12),

            Container(

              width: double.infinity,

              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 12),

              decoration: BoxDecoration(

                color: isDark ? Colors.white10 : Colors.grey.shade100,

                borderRadius: BorderRadius.circular(4),

                border: Border.all(

                  color: isDark ? Colors.white24 : Colors.grey.shade400,

                ),

              ),

              child: Text(

                dayName,

                style: TextStyle(

                  fontSize: 16,

                  color: isDark ? Colors.white70 : Colors.black87,

                ),

              ),

            ),

            const SizedBox(height: 12),

            Autocomplete<String>(

              initialValue: TextEditingValue(

                text: widget.lessonToEdit?.name ?? '',

              ),

              optionsBuilder: (TextEditingValue textEditingValue) {

                if (textEditingValue.text == '') {

                  return const Iterable<String>.empty();

                }

                return widget.courseDatabase.keys.where(

                  (String option) => option.toLowerCase().contains(

                    textEditingValue.text.toLowerCase(),

                  ),

                );

              },

              onSelected: (String selection) => _onCourseNameChanged(selection),

              fieldViewBuilder:

                  (context, controller, focusNode, onFieldSubmitted) {

                    _courseNameController = controller;

                    if (widget.lessonToEdit != null &&

                        controller.text.isEmpty &&

                        _courseNameController.text.isEmpty) {

                      controller.text = widget.lessonToEdit!.name;

                    }

                    return TextField(

                      controller: controller,

                      focusNode: focusNode,

                      onChanged: _onCourseNameChanged,

                      decoration: InputDecoration(

                        labelText: _isLecture ? 'Course Name' : 'Activity Name',

                        hintText: 'e.g. Math or Gym',

                        border: const OutlineInputBorder(),

                        isDense: true,

                        suffixIcon: const Icon(

                          Icons.search,

                          size: 20,

                          color: Colors.grey,

                        ),

                      ),

                    );

                  },

            ),

            const SizedBox(height: 12),

            if (_isLecture) ...[

              TextField(

                controller: _roomController,

                decoration: const InputDecoration(

                  labelText: 'Room',

                  border: OutlineInputBorder(),

                  isDense: true,

                ),

              ),

              const SizedBox(height: 12),

              TextField(

                controller: _instructorController,

                readOnly: _isInstructorLocked,

                decoration: InputDecoration(

                  labelText: 'Instructor',

                  border: const OutlineInputBorder(),

                  isDense: true,

                  filled: _isInstructorLocked,

                  fillColor: isDark ? Colors.white10 : Colors.grey.shade200,

                  suffixIcon: _isInstructorLocked

                      ? IconButton(

                          icon: const Icon(

                            Icons.edit,

                            size: 18,

                            color: Colors.grey,

                          ),

                          onPressed: () =>

                              setState(() => _isInstructorLocked = false),

                        )

                      : null,

                ),

              ),

            ] else ...[

              TextField(

                controller: _descriptionController,

                maxLines: 2,

                decoration: const InputDecoration(

                  labelText: 'Notes',

                  border: OutlineInputBorder(),

                  isDense: true,

                ),

              ),

            ],

            const SizedBox(height: 12),

            Row(

              children: [

                Expanded(

                  child: TextField(

                    controller: _startTimeController,

                    readOnly: true,

                    onTap: _selectTime,

                    decoration: const InputDecoration(

                      labelText: 'Start',

                      border: OutlineInputBorder(),

                      isDense: true,

                    ),

                  ),

                ),

                const SizedBox(width: 8),

                Expanded(

                  child: DropdownButtonFormField<int>(

                    value: _selectedDuration,

                    items: _durations

                        .map(

                          (m) =>

                              DropdownMenuItem(value: m, child: Text('$m m')),

                        )

                        .toList(),

                    onChanged: (v) => setState(() => _selectedDuration = v!),

                    decoration: const InputDecoration(

                      labelText: 'Duration',

                      border: OutlineInputBorder(),

                      isDense: true,

                    ),

                  ),

                ),

              ],

            ),

            const SizedBox(height: 12),

            Theme(

              data: Theme.of(context).copyWith(

                checkboxTheme: CheckboxThemeData(

                  side: BorderSide(

                    color: isDark ? Colors.white70 : Colors.grey,

                    width: 2,

                  ),

                  checkColor: MaterialStateProperty.all(Colors.white),

                ),

              ),

              child: CheckboxListTile(

                contentPadding: EdgeInsets.zero,

                title: Text(

                  "Recurring Event",

                  style: TextStyle(

                    fontSize: 14,

                    color: isDark ? Colors.white70 : Colors.black87,

                  ),

                ),

                subtitle: Text(

                  "Repeat every week",

                  style: TextStyle(fontSize: 12, color: Colors.grey.shade600),

                ),

                value: _isRecurring,

                activeColor: accentColor,

                onChanged: (val) => setState(() => _isRecurring = val ?? true),

                controlAffinity: ListTileControlAffinity.leading,

              ),

            ),

            if (isEditing && widget.onDelete != null) ...[

              const SizedBox(height: 20),

              const Divider(),

              TextButton.icon(

                onPressed: () {

                  widget.onDelete!(widget.lessonToEdit!.id!);

                  Navigator.pop(context);

                },

                icon: const Icon(Icons.delete_forever, color: Colors.red),

                label: const Text(

                  "Delete Event",

                  style: TextStyle(

                    color: Colors.red,

                    fontWeight: FontWeight.bold,

                  ),

                ),

                style: TextButton.styleFrom(

                  padding: const EdgeInsets.symmetric(

                    vertical: 12,

                    horizontal: 16,

                  ),

                ),

              ),

            ],

          ],

        ),

      ),

      actions: [

        TextButton(

          onPressed: () => Navigator.pop(context),

          child: const Text('Cancel'),

        ),

        ElevatedButton(

          onPressed: _submit,

          style: ElevatedButton.styleFrom(

            backgroundColor: accentColor,

            foregroundColor: Colors.white,

            shape: RoundedRectangleBorder(

              borderRadius: BorderRadius.circular(12),

            ),

          ),

          child: Text(isEditing ? 'Save Changes' : 'Save'),

        ),

      ],

    );

  }

}


calendar_header.dart:

import 'package:flutter/material.dart';

import 'package:intl/intl.dart';


class CalendarHeader extends StatefulWidget {

  final DateTime selectedDate;

  final Function(DateTime) onDateSelected;


  const CalendarHeader({

    super.key,

    required this.selectedDate,

    required this.onDateSelected,

  });


  @override

  State<CalendarHeader> createState() => _CalendarHeaderState();

}


class _CalendarHeaderState extends State<CalendarHeader> {

  late PageController _pageController;

  final int _initialPage = 1000;


  @override

  void initState() {

    super.initState();

    final initialIndex = _calculatePageForDate(widget.selectedDate);

    _pageController = PageController(initialPage: initialIndex);

  }


  @override

  void didUpdateWidget(covariant CalendarHeader oldWidget) {

    super.didUpdateWidget(oldWidget);

    if (oldWidget.selectedDate != widget.selectedDate) {

      final targetPage = _calculatePageForDate(widget.selectedDate);

      if (_pageController.hasClients &&

          _pageController.page?.round() != targetPage) {

        _pageController.animateToPage(

          targetPage,

          duration: const Duration(milliseconds: 500),

          curve: Curves.easeInOutCubic,

        );

      }

    }

  }


  int _calculatePageForDate(DateTime date) {

    final now = DateTime.now();

    final mondayNow = now.subtract(Duration(days: now.weekday - 1));

    final mondayDate = date.subtract(Duration(days: date.weekday - 1));

    final diff = mondayDate.difference(mondayNow).inDays;

    final weeksDiff = (diff / 7).round();

    return _initialPage + weeksDiff;

  }


  @override

  void dispose() {

    _pageController.dispose();

    super.dispose();

  }


  DateTime _getMondayForPage(int index) {

    final now = DateTime.now();

    final currentMonday = now.subtract(Duration(days: now.weekday - 1));

    final weeksDiff = index - _initialPage;

    return currentMonday.add(Duration(days: weeksDiff * 7));

  }


  Future<void> _showCalendarPicker(

    BuildContext context,

    Color accentColor,

  ) async {

    final DateTime? picked = await showDatePicker(

      context: context,

      initialDate: widget.selectedDate,

      firstDate: DateTime(2020),

      lastDate: DateTime(2030),

      builder: (context, child) {

        return Theme(

          data: Theme.of(context).copyWith(

            datePickerTheme: DatePickerThemeData(

              headerBackgroundColor: accentColor,

              headerForegroundColor: Colors.white,

            ),

            colorScheme: ColorScheme.fromSeed(

              seedColor: accentColor,

              brightness: Theme.of(context).brightness,

            ),

          ),

          child: child!,

        );

      },

    );


    if (picked != null) {

      widget.onDateSelected(picked);

    }

  }


  void _handleBackToToday(Color themeColor) {

    if (DateUtils.isSameDay(widget.selectedDate, DateTime.now())) {

      ScaffoldMessenger.of(context).showSnackBar(

        SnackBar(

          content: const Text("You are already up to date!"),

          backgroundColor: themeColor,

          duration: const Duration(seconds: 1),

        ),

      );

    } else {

      widget.onDateSelected(DateTime.now());

    }

  }


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final textColor = isDark ? Colors.white : Colors.black;

    final themeColor = isDark

        ? Colors.deepPurpleAccent

        : Theme.of(context).primaryColor;


    return Column(

      children: [

        const SizedBox(height: 20), // Top Spacing

        // --- TOP ROW ---

        Padding(

          padding: const EdgeInsets.symmetric(

            horizontal: 20.0,

          ), // STRICT MARGIN

          child: SizedBox(

            height: 50,

            child: Stack(

              alignment: Alignment.center,

              children: [

                // 1. LEFT: Back Button

                Align(

                  alignment: Alignment.centerLeft,

                  child: GestureDetector(

                    onTap: () => _handleBackToToday(themeColor),

                    child: Container(

                      padding: const EdgeInsets.all(10),

                      decoration: BoxDecoration(

                        color: themeColor.withOpacity(0.2),

                        borderRadius: BorderRadius.circular(12),

                      ),

                      child: Icon(

                        Icons.undo_rounded,

                        color: themeColor,

                        size: 26,

                      ),

                    ),

                  ),

                ),


                // 2. CENTER: Date Text

                Align(

                  alignment: Alignment.center,

                  child: Text(

                    DateFormat('MMMM d').format(widget.selectedDate),

                    style: TextStyle(

                      fontSize: 24,

                      fontWeight: FontWeight.bold,

                      color: textColor,

                    ),

                  ),

                ),


                // 3. RIGHT: Calendar Picker

                Align(

                  alignment: Alignment.centerRight,

                  child: GestureDetector(

                    onTap: () => _showCalendarPicker(context, themeColor),

                    child: Container(

                      padding: const EdgeInsets.all(10),

                      decoration: BoxDecoration(

                        color: themeColor.withOpacity(0.2),

                        borderRadius: BorderRadius.circular(12),

                      ),

                      child: Icon(

                        Icons.calendar_month_rounded,

                        color: themeColor,

                        size: 26,

                      ),

                    ),

                  ),

                ),

              ],

            ),

          ),

        ),


        const SizedBox(height: 20), // Vertical Gap between Title and Days

        // --- BOTTOM ROW: Week Strip ---

        SizedBox(

          height: 70, // Standard height

          child: PageView.builder(

            controller: _pageController,

            onPageChanged: (index) {

              final mondayOfNewPage = _getMondayForPage(index);

              final currentWeekdayOffset = widget.selectedDate.weekday - 1;

              final newDate = mondayOfNewPage.add(

                Duration(days: currentWeekdayOffset),

              );

              widget.onDateSelected(newDate);

            },

            itemBuilder: (context, index) {

              final monday = _getMondayForPage(index);

              final weekDays = List.generate(

                7,

                (i) => monday.add(Duration(days: i)),

              );


              // Padding applied inside here matches the Top Row padding (20.0)

              return Padding(

                padding: const EdgeInsets.symmetric(horizontal: 20.0),

                child: Row(

                  mainAxisAlignment: MainAxisAlignment.spaceBetween,

                  children: weekDays

                      .map((date) => _buildDayItem(date, themeColor, isDark))

                      .toList(),

                ),

              );

            },

          ),

        ),

      ],

    );

  }


  Widget _buildDayItem(DateTime date, Color highlightColor, bool isDark) {

    final isSelected =

        date.year == widget.selectedDate.year &&

        date.month == widget.selectedDate.month &&

        date.day == widget.selectedDate.day;


    final isToday = DateUtils.isSameDay(date, DateTime.now());


    return Expanded(

      child: GestureDetector(

        onTap: () => widget.onDateSelected(date),

        child: Container(

          // Margin to separate bubbles

          margin: const EdgeInsets.symmetric(horizontal: 3),

          decoration: BoxDecoration(

            color: isSelected

                ? highlightColor

                : (isDark ? Colors.white10 : Colors.grey.shade100),

            borderRadius: BorderRadius.circular(16),

            border: isToday && !isSelected

                ? Border.all(color: highlightColor.withOpacity(0.5))

                : null,

          ),

          child: Column(

            mainAxisAlignment: MainAxisAlignment.center,

            children: [

              Text(

                DateFormat('E').format(date).substring(0, 3),

                style: TextStyle(

                  fontSize: 11,

                  color: isSelected ? Colors.white : Colors.grey,

                ),

              ),

              const SizedBox(height: 6),

              Text(

                date.day.toString(),

                style: TextStyle(

                  fontSize: 16,

                  fontWeight: FontWeight.bold,

                  color: isSelected

                      ? Colors.white

                      : (isDark ? Colors.white : Colors.black87),

                ),

              ),

            ],

          ),

        ),

      ),

    );

  }

}


class_card.dart:

import 'package:flutter/material.dart';

import '../../models/lesson.dart';


class ClassCard extends StatelessWidget {

  final Lesson lesson;

  final VoidCallback? onEdit; // Renamed from onDelete to onEdit


  const ClassCard({super.key, required this.lesson, this.onEdit});


  @override

  Widget build(BuildContext context) {

    final isDark = Theme.of(context).brightness == Brightness.dark;

    final primaryColor = Theme.of(context).primaryColor;

    final textColor = isDark ? Colors.white : Colors.black;

    final subTextColor = isDark ? Colors.white70 : Colors.grey.shade600;

    final cardBgColor = isDark ? const Color(0xFF1E1E1E) : Colors.white;

    final typeColor = lesson.isLecture ? primaryColor : Colors.teal;


    return Container(

      margin: const EdgeInsets.only(bottom: 16),

      child: Row(

        crossAxisAlignment: CrossAxisAlignment.start,

        children: [

          // TIME

          SizedBox(

            width: 60,

            child: Column(

              children: [

                Text(

                  lesson.startTimeString,

                  style: TextStyle(

                    fontWeight: FontWeight.bold,

                    fontSize: 16,

                    color: textColor,

                  ),

                ),

                const SizedBox(height: 4),

                Text(

                  lesson.endTimeString,

                  style: const TextStyle(fontSize: 12, color: Colors.grey),

                ),

              ],

            ),

          ),

          // LINE

          Column(

            children: [

              Container(

                margin: const EdgeInsets.only(top: 8),

                height: 12,

                width: 12,

                decoration: BoxDecoration(

                  color: typeColor,

                  shape: BoxShape.circle,

                ),

              ),

              Container(

                width: 2,

                height: 90,

                color: isDark ? Colors.grey.shade800 : Colors.grey.shade300,

              ),

            ],

          ),

          const SizedBox(width: 12),

          // CARD

          Expanded(

            child: Card(

              color: cardBgColor,

              elevation: 0,

              shape: RoundedRectangleBorder(

                borderRadius: BorderRadius.circular(16),

                side: BorderSide(

                  color: isDark ? Colors.white12 : Colors.grey.shade300,

                ),

              ),

              child: Padding(

                padding: const EdgeInsets.all(12.0),

                child: Column(

                  crossAxisAlignment: CrossAxisAlignment.start,

                  children: [

                    Row(

                      children: [

                        Expanded(

                          child: Text(

                            lesson.name,

                            style: TextStyle(

                              fontSize: 18,

                              fontWeight: FontWeight.bold,

                              color: textColor,

                            ),

                            overflow: TextOverflow.ellipsis,

                          ),

                        ),

                        // EDIT BUTTON

                        if (onEdit != null)

                          GestureDetector(

                            onTap: onEdit,

                            child: Icon(

                              Icons.edit_outlined,

                              size: 20,

                              color: Colors.grey.shade500,

                            ),

                          ),

                      ],

                    ),

                    const SizedBox(height: 8),

                    if (lesson.isLecture) ...[

                      Row(

                        children: [

                          Icon(

                            Icons.location_on,

                            size: 14,

                            color: subTextColor,

                          ),

                          const SizedBox(width: 4),

                          Text(

                            lesson.room,

                            style: TextStyle(fontSize: 14, color: subTextColor),

                          ),

                          const SizedBox(width: 16),

                          Icon(Icons.person, size: 14, color: subTextColor),

                          const SizedBox(width: 4),

                          Expanded(

                            child: Text(

                              lesson.instructor,

                              style: TextStyle(

                                fontSize: 14,

                                color: subTextColor,

                              ),

                              overflow: TextOverflow.ellipsis,

                            ),

                          ),

                        ],

                      ),

                    ] else ...[

                      if (lesson.description.isNotEmpty)

                        Text(

                          lesson.description,

                          style: TextStyle(

                            fontSize: 13,

                            color: subTextColor,

                            fontStyle: FontStyle.italic,

                          ),

                        ),

                    ],

                  ],

                ),

              ),

            ),

          ),

        ],

      ),

    );

  }

}


firebase_options.dart:

// File generated by FlutterFire CLI.

// ignore_for_file: type=lint

import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;

import 'package:flutter/foundation.dart'

    show defaultTargetPlatform, kIsWeb, TargetPlatform;


/// Default [FirebaseOptions] for use with your Firebase apps.

///

/// Example:

/// ```dart

/// import 'firebase_options.dart';

/// // ...

/// await Firebase.initializeApp(

///   options: DefaultFirebaseOptions.currentPlatform,

/// );

/// ```

class DefaultFirebaseOptions {

  static FirebaseOptions get currentPlatform {

    if (kIsWeb) {

      return web;

    }

    switch (defaultTargetPlatform) {

      case TargetPlatform.android:

        return android;

      case TargetPlatform.iOS:

        return ios;

      case TargetPlatform.macOS:

        return macos;

      case TargetPlatform.windows:

        return windows;

      case TargetPlatform.linux:

        throw UnsupportedError(

          'DefaultFirebaseOptions have not been configured for linux - '

          'you can reconfigure this by running the FlutterFire CLI again.',

        );

      default:

        throw UnsupportedError(

          'DefaultFirebaseOptions are not supported for this platform.',

        );

    }

  }


  static const FirebaseOptions web = FirebaseOptions(

    apiKey: 'AIzaSyCJXT42bw0Tq0gCm3_HZR570TYBSLdgQMg',

    appId: '1:1089895449096:web:7552a7bec7bfe0ab0707bd',

    messagingSenderId: '1089895449096',

    projectId: 'life-notebook-fd44f',

    authDomain: 'life-notebook-fd44f.firebaseapp.com',

    storageBucket: 'life-notebook-fd44f.firebasestorage.app',

    measurementId: 'G-G9Z7116CC2',

  );


  static const FirebaseOptions android = FirebaseOptions(

    apiKey: 'AIzaSyCXrL5LBoh2aqSrTAy0UKiAxD1p_doLQc0',

    appId: '1:1089895449096:android:a1d8f6b7aef839160707bd',

    messagingSenderId: '1089895449096',

    projectId: 'life-notebook-fd44f',

    storageBucket: 'life-notebook-fd44f.firebasestorage.app',

  );


  static const FirebaseOptions ios = FirebaseOptions(

    apiKey: 'AIzaSyAMEB2Unanp4pB7tD2zmjK4BXMiBPlpfxQ',

    appId: '1:1089895449096:ios:7c54961c03311a890707bd',

    messagingSenderId: '1089895449096',

    projectId: 'life-notebook-fd44f',

    storageBucket: 'life-notebook-fd44f.firebasestorage.app',

    iosBundleId: 'com.example.notDefterim',

  );


  static const FirebaseOptions macos = FirebaseOptions(

    apiKey: 'AIzaSyAMEB2Unanp4pB7tD2zmjK4BXMiBPlpfxQ',

    appId: '1:1089895449096:ios:7c54961c03311a890707bd',

    messagingSenderId: '1089895449096',

    projectId: 'life-notebook-fd44f',

    storageBucket: 'life-notebook-fd44f.firebasestorage.app',

    iosBundleId: 'com.example.notDefterim',

  );


  static const FirebaseOptions windows = FirebaseOptions(

    apiKey: 'AIzaSyCJXT42bw0Tq0gCm3_HZR570TYBSLdgQMg',

    appId: '1:1089895449096:web:101ff07c1e0b31180707bd',

    messagingSenderId: '1089895449096',

    projectId: 'life-notebook-fd44f',

    authDomain: 'life-notebook-fd44f.firebaseapp.com',

    storageBucket: 'life-notebook-fd44f.firebasestorage.app',

    measurementId: 'G-4GTBS9CZHM',

  );


}




main.dart:

import 'package:flutter/material.dart';

import 'package:firebase_core/firebase_core.dart';

import 'package:cloud_firestore/cloud_firestore.dart';

import 'firebase_options.dart';


// PAGE IMPORTS

import 'pages/health_page.dart'; // CHANGE 1: Imported HealthPage instead of GymPage

import 'pages/book_page.dart';

import 'pages/finance_page.dart';

import 'pages/schedule_page.dart';

import 'pages/dashboard_page.dart';


void main() async {

  // 1. Ensure Flutter is ready

  WidgetsFlutterBinding.ensureInitialized();


  // 2. Initialize Firebase

  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);


  runApp(const LifeNotebookApp());

}


// Global Theme Mode Controller

final ValueNotifier<ThemeMode> _themeNotifier = ValueNotifier(ThemeMode.light);


// Global Page Index Controller

final ValueNotifier<int> _pageIndexNotifier = ValueNotifier(2);


// Global Color List

const List<Color> globalPageColors = [

  Colors.deepOrange, // 0: Health (was Gym)

  Colors.blue, // 1: Books

  Colors.teal, // 2: Home

  Colors.green, // 3: Finance

  Colors.deepPurple, // 4: Schedule

];


class LifeNotebookApp extends StatefulWidget {

  const LifeNotebookApp({super.key});


  @override

  State<LifeNotebookApp> createState() => _LifeNotebookAppState();

}


class _LifeNotebookAppState extends State<LifeNotebookApp> {

  @override

  void initState() {

    super.initState();

    _loadUserTheme();

  }


  // --- Load Theme from Firestore ---

  Future<void> _loadUserTheme() async {

    try {

      final doc = await FirebaseFirestore.instance

          .collection('users')

          .doc('test_user') // Hardcoded user for now

          .get();


      if (doc.exists &&

          doc.data() != null &&

          doc.data()!.containsKey('isDarkMode')) {

        bool isDark = doc.data()!['isDarkMode'];

        _themeNotifier.value = isDark ? ThemeMode.dark : ThemeMode.light;

      }

    } catch (e) {

      print("Error loading theme: $e");

    }

  }


  @override

  Widget build(BuildContext context) {

    return ValueListenableBuilder<ThemeMode>(

      valueListenable: _themeNotifier,

      builder: (context, ThemeMode currentMode, child) {

        return ValueListenableBuilder<int>(

          valueListenable: _pageIndexNotifier,

          builder: (context, int pageIndex, _) {

            final Color activeColor = globalPageColors[pageIndex];


            return MaterialApp(

              debugShowCheckedModeBanner: false,

              title: 'Life Notebook',


              // 1. LIGHT THEME

              theme: ThemeData(

                colorScheme: ColorScheme.fromSeed(

                  seedColor: activeColor,

                  primary: activeColor,

                  brightness: Brightness.light,

                ),

                useMaterial3: true,

                scaffoldBackgroundColor: const Color(0xFFF5F5F5),

                appBarTheme: AppBarTheme(

                  backgroundColor: activeColor,

                  foregroundColor: Colors.white,

                  elevation: 0,

                ),

              ),


              // 2. DARK THEME

              darkTheme: ThemeData(

                colorScheme: ColorScheme.fromSeed(

                  seedColor: activeColor,

                  brightness: Brightness.dark,

                  primary: activeColor,

                  secondary: activeColor,

                  surface: const Color(0xFF1E1E1E),

                ),

                useMaterial3: true,

                scaffoldBackgroundColor: const Color(0xFF121212),


                appBarTheme: const AppBarTheme(

                  backgroundColor: Color(0xFF1E1E1E),

                  foregroundColor: Colors.white,

                  elevation: 0,

                ),

                iconTheme: IconThemeData(color: activeColor),

              ),


              themeMode: currentMode,

              home: const HomePage(),

            );

          },

        );

      },

    );

  }

}


class HomePage extends StatefulWidget {

  const HomePage({super.key});


  @override

  State<HomePage> createState() => _HomePageState();

}


class _HomePageState extends State<HomePage> {

  final PageController _pageController = PageController(initialPage: 2);


  @override

  void dispose() {

    _pageController.dispose();

    super.dispose();

  }


  void _onItemTapped(int index) {

    _pageIndexNotifier.value = index;

    _pageController.animateToPage(

      index,

      duration: const Duration(milliseconds: 500),

      curve: Curves.easeInOutCubic,

    );

  }


  void _onPageChanged(int index) {

    _pageIndexNotifier.value = index;

  }


  // --- Save Theme to Firestore ---

  void _toggleTheme(bool isCurrentlyDark) {

    final newMode = isCurrentlyDark ? ThemeMode.light : ThemeMode.dark;

    _themeNotifier.value = newMode;


    // Save preference to cloud

    FirebaseFirestore.instance.collection('users').doc('test_user').set({

      'isDarkMode': !isCurrentlyDark,

    }, SetOptions(merge: true));

  }


  // Your actual pages

  static const List<Widget> _pages = <Widget>[

    HealthPage(), // CHANGE 2: Used HealthPage instead of GymPage

    BookPage(), // 1

    DashboardPage(), // 2

    FinancePage(), // 3

    SchedulePage(), // 4

  ];


  @override

  Widget build(BuildContext context) {

    return ValueListenableBuilder<ThemeMode>(

      valueListenable: _themeNotifier,

      builder: (context, ThemeMode currentMode, _) {

        final bool isDark = currentMode == ThemeMode.dark;


        return ValueListenableBuilder<int>(

          valueListenable: _pageIndexNotifier,

          builder: (context, int currentIndex, _) {

            final Color activeColor = globalPageColors[currentIndex];


            return Scaffold(

              appBar: AppBar(

                title: Text(

                  'Life Notebook',

                  style: TextStyle(

                    fontWeight: FontWeight.bold,

                    color: isDark ? activeColor : Colors.white,

                  ),

                ),

                centerTitle: true,


                iconTheme: IconThemeData(

                  color: isDark ? activeColor : Colors.white,

                ),

                actions: [

                  IconButton(

                    icon: Icon(isDark ? Icons.light_mode : Icons.dark_mode),

                    color: isDark ? activeColor : Colors.white,

                    onPressed: () => _toggleTheme(isDark),

                  ),

                ],

              ),


              body: PageView(

                controller: _pageController,

                onPageChanged: _onPageChanged,

                children: _pages,

              ),


              bottomNavigationBar: BottomAppBar(

                color: isDark ? const Color(0xFF1E1E1E) : Colors.white,

                elevation: 20,

                height: 70,

                padding: EdgeInsets.zero,

                child: Row(

                  children: <Widget>[

                    Expanded(

                      child: _buildNavButton(

                        icon: Icons

                            .favorite_rounded, // You already had this correct!

                        index: 0,

                        label: 'Health',

                        activeColor: activeColor,

                        currentIndex: currentIndex,

                      ),

                    ),

                    Expanded(

                      child: _buildNavButton(

                        icon: Icons.menu_book_rounded,

                        index: 1,

                        label: 'Books',

                        activeColor: activeColor,

                        currentIndex: currentIndex,

                      ),

                    ),


                    Expanded(

                      child: Center(

                        child: _buildCenterHomeButton(

                          currentIndex: currentIndex,

                          activeColor: activeColor,

                          isDark: isDark,

                        ),

                      ),

                    ),


                    Expanded(

                      child: _buildNavButton(

                        icon: Icons.account_balance_wallet_rounded,

                        index: 3,

                        label: 'Finance',

                        activeColor: activeColor,

                        currentIndex: currentIndex,

                      ),

                    ),

                    Expanded(

                      child: _buildNavButton(

                        icon: Icons.calendar_month_rounded,

                        index: 4,

                        label: 'Schedule',

                        activeColor: activeColor,

                        currentIndex: currentIndex,

                      ),

                    ),

                  ],

                ),

              ),

            );

          },

        );

      },

    );

  }


  Widget _buildNavButton({

    required IconData icon,

    required int index,

    required String label,

    required Color activeColor,

    required int currentIndex,

  }) {

    final bool isSelected = currentIndex == index;

    final Color inactiveColor = Colors.grey;


    return InkWell(

      onTap: () => _onItemTapped(index),

      borderRadius: BorderRadius.circular(50),

      child: Container(

        padding: const EdgeInsets.symmetric(horizontal: 12.0, vertical: 8.0),

        child: Column(

          mainAxisSize: MainAxisSize.min,

          mainAxisAlignment: MainAxisAlignment.center,

          children: [

            Icon(

              icon,

              color: isSelected ? activeColor : inactiveColor,

              size: 26,

            ),

            const SizedBox(height: 2),

            Text(

              label,

              style: TextStyle(

                fontSize: 10,

                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,

                color: isSelected ? activeColor : inactiveColor,

              ),

            ),

          ],

        ),

      ),

    );

  }


  Widget _buildCenterHomeButton({

    required int currentIndex,

    required Color activeColor,

    required bool isDark,

  }) {

    final bool isSelected = currentIndex == 2;

    return GestureDetector(

      onTap: () => _onItemTapped(2),

      child: Container(

        width: 50,

        height: 50,

        decoration: BoxDecoration(

          color: isSelected ? activeColor : Colors.transparent,

          shape: BoxShape.circle,

          border: isSelected

              ? null

              : Border.all(color: Colors.grey.withOpacity(0.5), width: 2),

        ),

        child: Icon(

          Icons.home_rounded,

          color: isSelected ? Colors.white : Colors.grey,

          size: 30,

        ),

      ),

    );

  }

}


